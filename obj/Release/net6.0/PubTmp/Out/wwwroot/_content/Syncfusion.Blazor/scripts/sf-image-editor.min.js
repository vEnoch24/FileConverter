/*!*  filename: sf-image-editor.min.js 
*     version : 26.2.8 
*     Copyright Syncfusion Inc. 2001 - 2024. All rights reserved. 
*     Use of this code is subject to the terms of our license.
*     A copy of the current license can be obtained at any time by e-mailing 
*     licensing@syncfusion.com. Any infringement will be prosecuted under 
*     applicable laws. 
*/
(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{"./bundles/sf-image-editor.js":function(e,t,o){"use strict";o.r(t);o("./modules/sf-image-editor.js")},"./modules/sf-image-editor.js":function(e,t){function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}window.sfBlazor=window.sfBlazor||{},window.sfBlazor.ImageEditor=function(){"use strict";var e,t,r,i,a,s,n,l,h,p,d;!function(e){e.Png="Png",e.Jpeg="Jpeg",e.Svg="Svg"}(e||(e={})),function(e){e.Horizontal="Horizontal",e.Vertical="Vertical"}(t||(t={})),function(e){e.Rectangle="Rectangle",e.Ellipse="Ellipse",e.Line="Line",e.Arrow="Arrow",e.Path="Path",e.Text="Text",e.FreehandDraw="FreehandDraw",e.Image="Image"}(r||(r={})),function(e){e[e.MouseWheel=1]="MouseWheel",e[e.Pinch=2]="Pinch",e[e.Commands=4]="Commands",e[e.Toolbar=8]="Toolbar"}(i||(i={})),function(e){e.Bootstrap5="Bootstrap5",e.Bootstrap5Dark="Bootstrap5Dark",e.Tailwind="Tailwind",e.TailwindDark="TailwindDark",e.Fluent="Fluent",e.FluentDark="FluentDark",e.Bootstrap4="Bootstrap4",e.Bootstrap="Bootstrap",e.BootstrapDark="BootstrapDark",e.Material="Material",e.MaterialDark="MaterialDark",e.Fabric="Fabric",e.FabricDark="FabricDark",e.Highcontrast="Highcontrast",e.Fluent2="Fluent2",e.Fluent2Dark="Fluent2Dark"}(a||(a={})),function(e){e.Crop="Crop",e.Transform="Transform",e.Annotate="Annotate",e.ZoomIn="ZoomIn",e.ZoomOut="ZoomOut",e.Open="Open",e.Reset="Reset",e.Save="Save",e.Pan="Pan",e.Move="Move",e.Pen="Pen",e.Line="Line",e.Arrow="Arrow",e.Path="Path",e.Rectangle="Rectangle",e.Image="Image",e.Ellipse="Ellipse",e.Text="Text",e.CustomSelection="CustomSelection",e.CircleSelection="CircleSelection",e.SquareSelection="SquareSelection",e.RatioSelection="RatioSelection",e.RotateLeft="RotateLeft",e.RotateRight="RotateRight",e.FlipHorizontal="FlipHorizontal",e.FlipVertical="FlipVertical",e.Undo="Undo",e.Redo="Redo",e.None="None",e.Mat="Mat",e.Bevel="Bevel",e.Inset="Inset",e.Hook="Hook",e.Finetune="Finetune",e.Filter="Filter",e.Frame="Frame",e.Resize="Resize",e.HorizontalFlip="HorizontalFlip",e.VerticalFlip="VerticalFlip",e.Brightness="Brightness",e.Contrast="Contrast",e.Hue="Hue",e.Saturation="Saturation",e.Opacity="Opacity",e.Blur="Blur",e.Exposure="Exposure",e.Default="Default",e.Chrome="Chrome",e.Cold="Cold",e.Warm="Warm",e.Grayscale="Grayscale",e.Sepia="Sepia",e.Invert="Invert",e.Straightening="Straightening"}(s||(s={})),function(e){e.Default="Default",e.Chrome="Chrome",e.Cold="Cold",e.Warm="Warm",e.Grayscale="Grayscale",e.Sepia="Sepia",e.Invert="Invert"}(n||(n={})),function(e){e.Brightness="Brightness",e.Contrast="Contrast",e.Hue="Hue",e.Saturation="Saturation",e.Exposure="Exposure",e.Opacity="Opacity",e.Blur="Blur"}(l||(l={})),function(e){e.None="None",e.Arrow="Arrow",e.SolidArrow="SolidArrow",e.Circle="Circle",e.SolidCircle="SolidCircle",e.Square="Square",e.SolidSquare="SolidSquare",e.Bar="Bar"}(h||(h={})),function(e){e.None="None",e.Mat="Mat",e.Bevel="Bevel",e.Line="Line",e.Inset="Inset",e.Hook="Hook"}(p||(p={})),function(e){e.Solid="Solid",e.Dashed="Dashed",e.Dotted="Dotted"}(d||(d={}));var c,u=function(){function e(e){this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1,this.isInitCrop=!1,this.isTransformCrop=!1,this.parent=e}return e.prototype.cropping=function(e){switch(this.updateCropPvtVar(),e.prop){case"cropImg":this.cropImg(e.value.isRotateCrop);break;case"cropCircle":this.cropCircle(e.value.context,e.value.isSave,e.value.isFlip);break;case"setCurrSelPoints":this.setCurrSelPoints(e.value.isSetDimension);break;case"updateRotatePan":this.updateRotatePan();break;case"crop":this.crop(e.value.obj);break;case"calcRatio":this.calcRatio(e.value.obj,e.value.dimension);break;case"isObjInImage":this.isObjInImage(e.value.obj,e.value.object);break;case"getCurrFlipState":this.getCurrFlipState(e.value.panObj);break;case"getPreviousCropCurrentObj":e.value.obj.prevObj=this.prevCropCurrObj;break;case"setPreviousCropCurrentObj":this.prevCropCurrObj=e.value.obj;break;case"setCropDestPoints":this.cropDestPoints=e.value.point;break;case"getTempFlipPanPoint":e.value.obj.point=this.tempFlipPanPoint;break;case"setTempFlipPanPoint":sf.base.isNullOrUndefined(e.value.isAdd)?this.tempFlipPanPoint=e.value.point:(this.tempFlipPanPoint.x+=e.value.point.x,this.tempFlipPanPoint.y+=e.value.point.y);break;case"getPreventScaling":e.value.obj.bool=this.isPreventScaling;break;case"adjustStraightenForShapes":this.adjustStraightenForShapes(e.value.type,e.value.isInitialRotated);break;case"resizeWrapper":this.resizeWrapper();break;case"setTransformCrop":this.isTransformCrop=e.value.bool;break;case"setInitCrop":this.isInitCrop=e.value.bool;break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"crop"},e.prototype.updateCropPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.prevCropCurrObj=null,this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1,this.isInitCrop=!1,this.isTransformCrop=!1},e.prototype.cropImg=function(e){for(var t=this.parent,o=sf.base.isNullOrUndefined(e),r=t.element.querySelector("#"+t.element.id+"_nonaspectratio"),i=t.activeObj.activePoint,a=t.img,s=!1,n=0,l=t.rotateFlipColl.length;n<l;n++){var h=t.rotateFlipColl[n];90!==h&&-90!==h||(s=!0)}if(t.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1}),(o||r)&&(this.croppedDegree=t.transform.degree),o&&0!==t.transform.degree||s){this.updateCropObj();var p={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};t.transformModule.transform({prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:p}}),this.rotateCrop()}else if(o&&""!==t.transform.currFlipState){this.updateCropObj();p={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};t.transformModule.transform({prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:p}}),this.flipCrop()}else{this.adjustStraightenForShapes("initial",!1),t.drawModule.draw({prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:t.transform.zoomFactor}});var d=this.calcRatio();if(o||!e){this.updateCropObj(),t.drawModule.draw({prop:"resetPanPoints",onPropertyChange:!1}),t.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1});p={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};t.transformModule.transform({prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:p}}),t.currSelectionPoint=sf.base.extend({},t.activeObj,{},!0),this.cropDestPoints={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight}}var c={width:0,height:0};t.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:i.width*d.width,height:i.height*d.height,obj:c,isImgShape:null}});var u=c;this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.img={srcLeft:i.startX*d.width-a.destLeft*d.width,srcTop:i.startY*d.height-a.destTop*d.height,srcWidth:i.width*d.width,srcHeight:i.height*d.height,destLeft:(t.lowerCanvas.clientWidth-u.width)/2,destTop:(t.lowerCanvas.clientHeight-u.height+1)/2,destWidth:u.width,destHeight:u.height};var v=this.lowerContext.filter;t.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter="none";var g=sf.base.extend({},t.activeObj,{},!0);this.cropObjColl(),t.transform.straighten=0,t.activeObj=g,this.cropFreehandDrawColl(),t.shapeColl=[],t.shapeModule.shape({prop:"updateShapeColl",onPropertyChange:!1}),t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),t.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape?this.cropCircle(this.lowerContext):t.isCircleCrop=!1,this.lowerContext.filter=v,t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),t.currObjType.isCustomCrop=!1,t.pan(!1),t.transform.defaultZoomFactor=0}},e.prototype.adjustStraightenForShapes=function(e,t){for(var o=this.parent,r=o.img.destLeft+o.img.destWidth/2,i=o.img.destTop+o.img.destHeight/2,a=0,s=o.objColl;a<s.length;a++){var n=s[a];if(-1!==["rectangle","ellipse","text","image"].indexOf(n.shape)&&(t||0!==n.rotatedAngle)){var l=n.activePoint,h=l.startX,p=l.startY,d=l.width,c=l.height,u="initial"===e?n.rotatedAngle:-n.rotatedAngle,v=h+d/2-r,g=p+c/2-i,b=Math.cos(u),C=Math.sin(u),f=b*v-C*g+r-h-d/2,m=C*v+b*g+i-p-c/2;n.activePoint.startX+=f,n.activePoint.startY+=m,n.activePoint.endX+=f,n.activePoint.endY+=m}}},e.prototype.updateCropObj=function(){this.parent.afterCropActions=[];var e={currObj:{}};this.parent.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:e}});var t=e.currObj;t.straighten=this.parent.transform.straighten,this.parent.cropObj=sf.base.extend({},t,{},!0)},e.prototype.rotateCrop=function(){var e=this.parent,t=this.getCurrFlipState(),o=e.activeObj.shape||"";e.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),e.currSelectionPoint=sf.base.extend({},e.activeObj,{},!0),e.objColl.push(e.activeObj),e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0);var r=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),i=sf.base.extend({},e.currSelectionPoint,{},!0),a={bool:null};e.transformModule.transform({prop:"getPreventSelect",onPropertyChange:!1,value:{obj:a}}),e.transformModule.transform({prop:"setPreventSelect",onPropertyChange:!1,value:{bool:!0}});var s=sf.base.extend([],e.rotateFlipColl,[],!0);this.panToSelRangle(!0),r=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r}}),e.objColl.pop(),e.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj);var n=e.transform.straighten;0!==n&&(e.transform.straighten=0,e.straightenBaseImageCanvas(),e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:!1}})),this.resetZoom();var l=sf.base.extend([],e.afterCropActions,[],!0);this.revertTransform("initial",s),0!==n&&(e.transform.straighten="horizontal"===t||"vertical"===t?-n:n,e.straightenBaseImageCanvas(),e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:!1}}),e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})),r=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r}}),e.objColl.pop(),e.transform.degree=0;var h={isIntersect:null};e.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:h}});for(var p=0;0!==n&&h.isIntersect&&50!=++p;)e.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.025,zoomPoint:null,isResize:null}}),e.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:h}});this.cropImg(!0),this.revertTransform("reverse",s),e.afterCropActions=l,e.currSelectionPoint=i,e.transformModule.transform({prop:"setPreventSelect",onPropertyChange:!1,value:{bool:a.bool}}),e.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),"crop-circle"===o&&this.cropCircle(this.lowerContext),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.drawModule.draw({prop:"resetPanPoints",onPropertyChange:!1})},e.prototype.revertTransform=function(e,t){var o=this.parent,r={isRotate:!1};if("initial"===e)for(var i=t.length-1;i>=0;i--){switch(s=t[i]){case 90:o.transformModule.transform({prop:"rotate",value:{degree:-90,obj:r}});break;case-90:o.transformModule.transform({prop:"rotate",value:{degree:90,obj:r}});break;default:o.transformModule.transform({prop:"flipImage",value:{direction:o.toPascalCase(s.toString())}})}}else{this.updateFlipState();i=0;for(var a=t.length;i<a;i++){var s;switch(s=t[i]){case 90:o.transformModule.transform({prop:"rotate",value:{degree:90,obj:r}});break;case-90:o.transformModule.transform({prop:"rotate",value:{degree:-90,obj:r}});break;default:o.transformModule.transform({prop:"flipImage",value:{direction:o.toPascalCase(s.toString())}})}}}},e.prototype.updateFlipState=function(){for(var e=this.parent,t=e.objColl,o=0,r=t.length;o<r;o++)t[o].shapeFlip="";var i=e.pointColl;for(o=0;o<e.freehandCounter;o++)i[o].shapeFlip=""},e.prototype.resetZoom=function(){var e=this.parent;if(e.transform.zoomFactor>0){var t=e.transform.zoomFactor,o=e.isUndoRedo;e.zoomSettings.zoomFactor=10*t,e.transformModule.transform({prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.zoomSettings.zoomFactor}});for(var r=0;r<10*t;r++)e.isUndoRedo=!0,e.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}});e.isUndoRedo=o,e.drawModule.draw({prop:"resetPanPoints",onPropertyChange:!1})}},e.prototype.flipCrop=function(){var e=this.parent;e.transformModule.transform({prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),e.panPoint.totalPannedPoint.x+=this.tempFlipPanPoint.x,e.panPoint.totalPannedPoint.y+=this.tempFlipPanPoint.y;var t=e.transform.currFlipState,o={flipColl:null};e.transformModule.transform({prop:"getFlipColl",onPropertyChange:!1,value:{obj:o}});var r=o.flipColl;if(e.transformModule.transform({prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:[]}}),e.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj),0===e.transform.degree){var i=-e.cropObj.totalPannedPoint.x,a=-e.cropObj.totalPannedPoint.y;e.img.destLeft+=i,e.img.destTop+=a,e.transformModule.transform({prop:"drawPannImage",value:{point:{x:i,y:a}}}),e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:e.activeObj}}),e.objColl.pop(),e.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj)}this.resetZoom(),e.currSelectionPoint=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);var s=this.lowerContext.filter;e.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.updateFlipState(),e.shapeModule.shape({prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),e.freeHandDrawModule.draw({prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),e.activeObj=sf.base.extend({},e.objColl[e.objColl.length-1],{},!0),e.objColl.pop(),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.cropImg(!0),e.transformModule.transform({prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),this.lowerContext.setTransform(1,0,0,1,0,0),e.drawModule.draw({prop:"setDestPoints",onPropertyChange:!1}),e.drawModule.draw({prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),e.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=s,e.drawModule.draw({prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),e.drawModule.draw({prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),e.transform.currFlipState=t,e.transformModule.transform({prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:r}}),this.lowerContext.filter="none",this.updateFlipState(),e.shapeModule.shape({prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),e.freeHandDrawModule.draw({prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=s,(e.currSelectionPoint&&"crop-circle"===e.currSelectionPoint.shape||e.isCircleCrop)&&this.cropCircle(this.lowerContext),e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),e.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.transformModule.transform({prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}}),e.drawModule.draw({prop:"resetPanPoints",onPropertyChange:!1}),this.tempFlipPanPoint={x:0,y:0}},e.prototype.cropObjColl=function(){var e,t,o,r=this.parent;if(r.objColl.length>0)for(var i=0,a=r.objColl.length;i<a;i++){e=(o=r.objColl[i]).activePoint;var s=r.activeObj.activePoint,n=s.startX,l=s.startY,h=s.width,p=s.height;t=o.shape,o.imageRatio={startX:(e.startX-n)/h,startY:(e.startY-l)/p,endX:(e.endX-n)/h,endY:(e.endY-l)/p,width:h/e.width,height:p/e.height};var d=void 0,c=void 0;switch(t){case"text":c=0===(d=0===o.shapeDegree?r.transform.degree:r.transform.degree-o.shapeDegree)||180===Math.abs(d)?e.width:e.height,o.textSettings.fontRatio=c/o.textSettings.fontSize;break;case"line":case"arrow":this.cropPointCollection(i),"arrow"===t&&r.shapeModule.shape({prop:"updateArrowRatio",onPropertyChange:!1,value:{obj:o}});break;case"path":this.cropPointCollection(i)}}},e.prototype.cropPointCollection=function(e){var t,o,r,i,a=this.parent,s=a.objColl[e].shape,n=a.activeObj.activePoint,l=a.img,h=l.destLeft,p=l.destTop,d=l.destWidth,c=l.destHeight;"path"===s?(t=n.startX,o=n.startY,r=n.width,i=n.height):(t=h,o=p,r=d,i=c);for(var u=a.objColl[e].pointColl,v=0,g=u.length;v<g;v++)u[v].ratioX=(u[v].x-t)/r,u[v].ratioY=(u[v].y-o)/i},e.prototype.cropFreehandDrawColl=function(){for(var e=this.parent,t=e.activeObj.activePoint,o=t.startX,r=t.startY,i=t.width,a=t.height,s=0;s<e.freehandCounter;s++){e.points=sf.base.extend([],e.pointColl[s].points,[]),e.freeHandDrawModule.draw({prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});for(var n=e.points.length,l=0;l<n;l++)e.points[l].ratioX=(e.points[l].x-o)/i,e.points[l].ratioY=(e.points[l].y-r)/a}e.freeHandDrawModule.draw({prop:"updateCropPtsForSel",onPropertyChange:!1})},e.prototype.resetAnnotations=function(){var e=this.parent;e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.freeHandDrawModule.draw({prop:"resetStraightenPoint"})},e.prototype.setCurrSelPoints=function(e){var t=this.parent;t.allowDownScale=!1;var o=this.cropDestPoints,r=this.lowerContext.filter,i=t.isCropTab;t.img={srcLeft:0,srcTop:0,srcWidth:t.baseImgCanvas.width,srcHeight:t.baseImgCanvas.height,destLeft:o.startX,destTop:o.startY,destWidth:o.width,destHeight:o.height};var a=t.img,s=t.currSelectionPoint;this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),e&&t.drawModule.draw({prop:"setDestPoints",onPropertyChange:!1}),t.drawModule.draw({prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),0===this.croppedDegree&&0===t.transform.degree&&s&&"crop-circle"!==s.shape&&"crop-square"!==s.shape&&(a.destLeft=o.startX,a.destTop=o.startY,a.destWidth=o.width,a.destHeight=o.height),0===t.transform.degree&&(a.destLeft+=t.panPoint.totalPannedInternalPoint.x,a.destTop+=t.panPoint.totalPannedInternalPoint.y),t.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=r,t.drawModule.draw({prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:!0}});var n=sf.base.extend([],t.objColl,null,!0),l=sf.base.extend([],t.pointColl,null,!0),h={straightenPoint:null};if(t.freeHandDrawModule.draw({prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:h}}),this.resetAnnotations(),sf.base.isNullOrUndefined(t.activeObj.shape)&&t.cropObj.activeObj.shape&&(t.activeObj=sf.base.extend({},t.cropObj.activeObj,null,!0)),this.panToSelRangle(),t.isCropTab=i,t.objColl=n,t.pointColl=l,t.freehandCounter=t.pointColl.length,h.straightenPoint.x&&h.straightenPoint.y&&t.freeHandDrawModule.draw({prop:"setStraightenPoint",onPropertyChange:!1,value:{x:h.straightenPoint.x,y:h.straightenPoint.y,ratioX:h.straightenPoint.ratioX,ratioY:h.straightenPoint.ratioY}}),t.cropObj.activeObj.shape){var p={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};if(s&&s.activePoint){var d=s.activePoint,c=d.startX,u=d.startY,v=d.width,g=d.height;a.destLeft=c,a.destTop=u,a.destWidth=v,a.destHeight=g}t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),a.destLeft=p.startX,a.destTop=p.startY,a.destWidth=p.width,a.destHeight=p.height,t.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1}),n=sf.base.extend([],t.objColl,null,!0),l=sf.base.extend([],t.pointColl,null,!0),t.freeHandDrawModule.draw({prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:h}}),this.resetAnnotations();var b={selPointColl:null};t.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:b}});var C=b.selPointColl;t.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),t.cropObj.filter=this.lowerContext.filter;var f=sf.base.extend({},t.currSelectionPoint,null,!0);t.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:null}}),t.activeObj=sf.base.extend({},f,null,!0);var m=sf.base.extend({},t.activeObj,null,!0);if(t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),t.currSelectionPoint=null,t.isCircleCrop=!1,0!==t.transform.degree&&(sf.base.isNullOrUndefined(t.activeObj.shape)&&t.cropObj.activeObj.shape&&(t.activeObj=sf.base.extend({},t.cropObj.activeObj,null,!0)),t.transformModule.transform({prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),t.panPoint.currentPannedPoint={x:0,y:0}),t.objColl=n,t.pointColl=l,t.freehandCounter=t.pointColl.length,h.straightenPoint.x&&h.straightenPoint.y&&t.freeHandDrawModule.draw({prop:"setStraightenPoint",onPropertyChange:!1,value:{x:h.straightenPoint.x,y:h.straightenPoint.y,ratioX:h.straightenPoint.ratioX,ratioY:h.straightenPoint.ratioY}}),t.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:C}}}),t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.adjustStraightenForShapes("reverse",!1),t.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:!0}}),t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),0===t.transform.degree?t.transformModule.transform({prop:"drawPannImage",onPropertyChange:!1,value:{point:{x:0,y:0}}}):(sf.base.isNullOrUndefined(t.activeObj.shape)&&t.cropObj.activeObj.shape&&(t.activeObj=sf.base.extend({},t.cropObj.activeObj,null,!0)),t.transformModule.transform({prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),t.panPoint.currentPannedPoint={x:0,y:0}),t.activeObj=m,t.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),t.transformModule.transform({prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),this.isInitCrop||0!==t.transform.degree||""===t.cropObj.currFlipState||0===t.cropObj.cropZoom)this.isInitCrop=!1;else{this.isInitCrop=!0;var y={activeObj:null};t.drawModule.draw({prop:"getStraightenActObj",onPropertyChange:!1,value:{obj:y}}),t.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null}}),t.drawModule.draw({prop:"setStraightenActObj",onPropertyChange:!1,value:{activeObj:y.activeObj}}),t.performCropClick()}}else{this.adjustStraightenForShapes("reverse",!0),t.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:!0}});var w=this.lowerContext.filter;this.lowerContext.filter="none",t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=w,t.currSelectionPoint=null}document.querySelector(".e-ie-straighten-value-span")&&(document.querySelector(".e-ie-straighten-value-span").innerHTML=t.transform.straighten.toString()+"&#176")},e.prototype.panToSelRangle=function(e){var t=this.parent,o=t.cropObj.totalPannedClientPoint,r=0!==t.transform.degree?e?-o.x:o.x:0,i=0!==t.transform.degree?e?-o.y:o.y:0;0!==t.transform.degree&&(t.panPoint.currentPannedPoint={x:r,y:i},t.transformModule.transform({prop:"drawPannedImage",value:{xDiff:r,yDiff:i}}),t.panPoint.currentPannedPoint={x:0,y:0})},e.prototype.cropCircle=function(e,t,o){var r=this.parent,i=r.img,a=i.destLeft,s=i.destTop,n=i.destWidth,l=i.destHeight;o&&""!==r.transform.currFlipState&&r.drawModule.draw({prop:"setTransform",onPropertyChange:!1,value:{context:e,value:r.transform.currFlipState,isReverse:null}});var h=e.filter;e.filter="none",e.globalCompositeOperation="destination-in",e.beginPath();var p=sf.base.isNullOrUndefined(t)?a+n/2:e.canvas.width/2,d=sf.base.isNullOrUndefined(t)?s+l/2:e.canvas.height/2,c=t?e.canvas.width/2:n/2;e.arc(p,d,c,0,2*Math.PI),e.closePath(),e.fill(),e.restore(),e.globalCompositeOperation="source-over",r.currObjType.isActiveObj=r.isCircleCrop=!0,e.filter=h,o&&""!==r.transform.currFlipState&&r.drawModule.draw({prop:"setTransform",onPropertyChange:!1,value:{context:e,value:r.transform.currFlipState,isReverse:null}})},e.prototype.getCurrCropState=function(e,t){var o=this.parent,r="",i=[],a={flipColl:null};if(o.transformModule.transform({prop:"getFlipColl",onPropertyChange:!1,value:{obj:a}}),"initial"===e)if(180===Math.abs(o.transform.degree))r=a.flipColl.length>1?this.getCurrFlipState():o.transform.currFlipState;else{for(var s=0,n=o.rotateFlipColl.length;s<n;s++)"number"==typeof o.rotateFlipColl[s]?i.push("number"):"string"==typeof o.rotateFlipColl[s]&&i.push("string");i.length>1&&"string"===i[i.length-1]&&"number"===i[i.length-2]?"horizontal"===o.transform.currFlipState?r="vertical":"vertical"===o.transform.currFlipState&&(r="horizontal"):i.length>1&&"number"===i[i.length-1]&&"string"===i[i.length-2]&&(r=a.flipColl.length>1?this.getCurrFlipState():o.transform.currFlipState)}else r=this.getCurrFlipState(),!t&&this.isInitialRotate()||-90!==o.transform.degree&&-270!==o.transform.degree||("horizontal"===r?r="vertical":"vertical"===r&&(r="horizontal"));return""===r&&(r=a.flipColl.length>1?this.getCurrFlipState():o.transform.currFlipState),r},e.prototype.isInitialRotate=function(){var e=!1;return this.parent.rotateFlipColl.length>0&&"number"==typeof this.parent.rotateFlipColl[0]&&(e=!0),e},e.prototype.updateRotatePan=function(){var e=this.parent;if(!sf.base.isNullOrUndefined(e.panPoint.currentPannedPoint)){var t="",o=e.transform.degree,r=e.panPoint.currentPannedPoint,i=r.x,a=r.y;t=e.rotateFlipColl.length>0&&"number"==typeof e.rotateFlipColl[0]&&o<0?this.getCurrCropState("reverse",!0):this.getCurrFlipState(),o%90==0&&o%180!=0?90===o||-90===o&&("horizontal"===t||"vertical"===t)||-270===o&&(""===t||"verticalHorizontal"===t||"horizontalVertical"===t)?("horizontal"===t||""===t?e.img.destLeft+=a:e.img.destLeft-=a,""===t||"vertical"===t?e.img.destTop-=i:e.img.destTop+=i):270!==o&&(-270!==o||"horizontal"!==t&&"vertical"!==t)&&(-90!==o||""!==t&&"verticalHorizontal"!==t&&"horizontalVertical"!==t)||(""===t||"horizontal"===t?e.img.destLeft-=a:e.img.destLeft+=a,""===t||"vertical"===t?e.img.destTop+=i:e.img.destTop-=i):180!==o&&-180!==o||(""===t||"vertical"===t?e.img.destLeft-=i:e.img.destLeft+=i,""===t||"horizontal"===t?e.img.destTop-=a:e.img.destTop+=a)}},e.prototype.crop=function(e){var t=this,o=this.parent,r=o.activeObj.activePoint,i=r.startX,a=r.startY,s=r.endX,n=r.endY;if(!o.disabled&&o.isImageLoaded){var l={isCropToolbar:o.isCropToolbar};o.currObjType.isUndoAction&&!l.isCropToolbar&&o.undoRedoModule.undoRedo({prop:"refreshUrc",value:{bool:null}});var h={cancel:!1,startPoint:{x:i,y:a},endPoint:{x:s,y:n},preventScaling:!1};!l.isCropToolbar&&o.events&&!0===o.events.cropping.hasDelegate?"resize-toolbar"===o.currentToolbar?(o.dotNetRef.invokeMethodAsync("CropEventAsync","OnCrop",h,null),this.cropEvent(h,e,l)):o.dotNetRef.invokeMethodAsync("CropEventAsync","OnCrop",h,null).then((function(o){t.cropEvent(o,e,l)})):this.cropEvent(h,e,l)}},e.prototype.cropEvent=function(e,t,o){var r,i=this.parent;if(!e.cancel&&(r=i.activeObj.shape?i.activeObj.shape.split("-"):[],!i.disabled&&i.activeObj.horTopLine&&(i.currObjType.isCustomCrop||r.length>0&&"crop"===r[0]))){t.isCrop=!0;var a=sf.base.extend({},i.cropObj,{},!0),s=sf.base.extend({},this.prevCropCurrObj,{},!0);e.preventScaling?this.isPreventScaling=!0:this.isPreventScaling=!1,this.cropImg(),this.isPreventScaling&&(i.aspectWidth=i.img.destWidth,i.aspectHeight=i.img.destHeight),i.freeHandDrawModule.draw({prop:"resetStraightenPoint"}),i.isCropTab=!1,i.transform.zoomFactor=0,i.zoomSettings.zoomFactor=1,i.transformModule.transform({prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:i.zoomSettings.zoomFactor}}),sf.base.Browser.isDevice||this.updateUndoRedoColl(s,a,o),i.transformModule.transform({prop:"setCropDimension",onPropertyChange:!1,value:{width:i.cropObj.destPoints.width,height:i.cropObj.destPoints.height}});i.element.querySelector("#"+i.element.id+"_aspectratio"),i.element.querySelector("#"+i.element.id+"_nonaspectratio");i.drawModule.draw({prop:"render-image",value:{isMouseWheel:!1}}),o.isCropToolbar||"resize-toolbar"===i.currentToolbar||i.updateToolbar(i.element,"imageLoaded"),this.resizeWrapper(),sf.base.Browser.isDevice&&this.updateUndoRedoColl(s,a,o),e={startPoint:e.startPoint,endPoint:e.endPoint},!o.isCropToolbar&&i.events&&!0===i.events.cropped.hasDelegate&&i.dotNetRef.invokeMethodAsync("CropEventAsync","Cropped",null,e)}},e.prototype.updateUndoRedoColl=function(e,t,o){var r=this.parent,i={prevCurrSelectionPoint:r.prevCurrSelectionPoint};e.currSelectionPoint=sf.base.extend({},i.prevCurrSelectionPoint,{},!0),r.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"crop",previousObj:e,previousObjColl:e.objColl,previousPointColl:e.pointColl,previousSelPointColl:e.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:r.isCircleCrop}}),o.isCropToolbar||r.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})},e.prototype.resizeWrapper=function(){var e=this.parent;if(sf.base.Browser.isDevice&&!this.isTransformCrop){e.isStraightening=!1,e.update();var t=e.element.querySelector("#"+e.element.id+"_canvasWrapper");t&&(t.style.height=parseInt(t.style.height)+2+"px"),e.filterModule.filter({prop:"setAdjustmentValue",value:{adjustmentValue:e.canvasFilter}})}},e.prototype.calcRatio=function(e,t){var o=this.parent,r=o.transform.degree,i=o.img,a=i.destWidth,s=i.destHeight,n=t||o.baseImgCanvas,l=n.width,h=n.height,p=0===r||r%180==0?l/a:h/a,d=0===r||r%180==0?h/s:l/s;return e&&(e.width=p,e.height=d),{width:p,height:d}},e.prototype.isObjInImage=function(e,t){var o=this.parent.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight,n=e.activePoint,l=n.startX,h=n.endX,p=n.startY,d=n.endY,c=l>=r&&h<=r+a||l<=r&&h>=r||l<=r+a&&h>=r+a||p>=i&&d<=i+s||p<=i&&d>=i||p<=i+s&&d>=i+s;return t&&(t.isInside=c),c},e.prototype.getCurrFlipState=function(e){var t=this.parent,o={panRegion:""},r={collection:t.rotateFlipColl};t.shapeModule.shape({prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:t.rotateFlipColl,isRotateFlipCollection:!0,obj:r}}),t.rotateFlipColl=r.collection;for(var i=0,a=t.rotateFlipColl.length;i<a;i++)t.transformModule.transform({prop:"setCurrPanRegion",onPropertyChange:!1,value:{region:o.panRegion,type:t.rotateFlipColl[i],obj:o}});return e&&(e.panRegion=o.panRegion),o.panRegion},e}(),v=function(){function e(e){this.isInitialLoading=!1,this.fileName="",this.isErrorImage=!1,this.isShapeTextInserted=!1,this.isRotateZoom=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:"",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempAdjValue="",this.tempFilter="",this.tempUndoRedoStep=0,this.tempFreehandCounter=0,this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.zoomCrop={width:0,height:0},this.isImageEdited=!1,this.isFileChanged=!1,this.isNewPath=!1,this.isResizeSelect=!1,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}},this.origDim={width:0,height:0},this.isImageApply=!1,this.imgCanvasPoints=[],this.isCropSelect=!1,this.isDownScale=!1,this.preventStraightening=!1,this.tempObjColl=[],this.tempPointColl={},this.parent=e}return e.prototype.draw=function(e){switch(this.updatePrivateVariables(),e.prop){case"drawObject":this.drawObject(e.value.canvas,e.value.obj,e.value.isCropRatio,e.value.points,e.value.isPreventDrag,e.value.saveContext,e.value.isPreventSelection);break;case"updateActiveObject":this.updateActiveObject(e.value.actPoint,e.value.obj,e.value.isMouseMove,e.value.x,e.value.y);break;case"clearOuterCanvas":this.clearOuterCanvas(e.value.context);break;case"setDestPoints":this.setDestPoints();break;case"updateCurrTransState":this.updateCurrTransState(e.value.type,e.value.isPreventDestination,e.value.isRotatePan);break;case"currTransState":this.currTransState(e.value.type,e.value.isPreventDestination,e.value.context,e.value.isPreventCircleCrop);break;case"setTransform":this.setTransform(e.value.context,e.value.value,e.value.isReverse);break;case"render-image":this.renderImage(e.value.isMouseWheel,e.value.isPreventClearRect,e.value.isFrame,e.value.isStraighten);break;case"draw-image-to-canvas":this.drawImgToCanvas(e.value.dimension);break;case"update-canvas":this.updateCanvas();break;case"performCancel":this.performCancel(e.value.isContextualToolbar,e.value.isUndoRedo,e.value.isFinalCancel);break;case"updateFlipPan":this.updateFlipPan(e.value.tempSelectionObj);break;case"select":this.select(e.value.type,e.value.startX,e.value.startY,e.value.width,e.value.height,e.value.isPreventEvent);break;case"callUpdateCurrTransState":this.callUpdateCurrTransState();break;case"resetPanPoints":this.resetPanPoints();break;case"setClientTransDim":this.setClientTransDim(e.value.isPreventDimension);break;case"redrawImgWithObj":this.redrawImgWithObj();break;case"setCurrentObj":this.setCurrentObj(e.value.obj,e.value.isUndoRedo);break;case"performPointZoom":this.performPointZoom(e.value.x,e.value.y,e.value.type,e.value.isResize);break;case"open":this.open(e.value.data);break;case"isInitialLoading":this.isInitialLoading=e.value.isInitialLoading;break;case"isInitialLoaded":this.getInitialLoaded(e.value.object);break;case"fileSelect":this.fileSelect(e.value.inputElement,e.value.args);break;case"getFileName":e.value.obj.fileName=this.fileName,e.value.obj.fileType=this.fileType;break;case"getErrorImage":e.value.obj.isErrorImage=this.isErrorImage;break;case"getInitialZoomValue":e.value.obj.initialZoomValue=this.initZoomValue;break;case"setShapeTextInsert":this.isShapeTextInserted=e.value.bool;break;case"resetCurrentSelectionPoint":this.currSelPoint=null;break;case"setRotateZoom":this.isRotateZoom=e.value.isRotateZoom;break;case"setTempStrokeSettings":this.tempStrokeSettings=e.value.tempStrokeSettings;break;case"setTempTextSettings":this.tempTextSettings=e.value.tempTextSettings;break;case"setTempAdjustmentValue":this.tempAdjValue=e.value.tempAdjustmentValue;break;case"getTempAdjustmentValue":e.value.obj.value=this.tempAdjValue;break;case"setTempFilter":this.tempFilter=e.value.tempFilter;break;case"setTempUndoRedoStep":this.tempUndoRedoStep=e.value.tempUndoRedoStep;break;case"setTempFreehandCounter":this.tempFreehandCounter=e.value.tempFreehandCounter;break;case"setTempCurrentFreehandDrawIndex":this.tempCurrFhdIndex=e.value.tempCurrentFreehandDrawIndex;break;case"setTempZoomFactor":this.tempZoomFactor=e.value.tempZoomFactor;break;case"setCancelAction":this.isCancelAction=e.value.bool;break;case"getRotatedFlipCropSelection":e.value.bool.isSelected=this.rotatedFlipCropSel;break;case"getPrevActObj":e.value.obj.prevActObj=this.prevActObj;break;case"setPrevActObj":this.prevActObj=e.value.prevActObj;break;case"setZoomCropWidth":this.zoomCrop.width=e.value.width,this.zoomCrop.height=e.value.height;break;case"setImageEdited":this.isImageEdited=!0;break;case"reset":this.reset();break;case"dlgBtnClick":this.dlgBtnClick();break;case"dlgCloseBtnClick":this.dlgCloseBtnClick();break;case"setNewPath":this.isNewPath=e.value.bool;break;case"getNewPath":e.value.obj.isNewPath=this.isNewPath;break;case"getArrowDimension":e.value.obj.arrowDimension=sf.base.extend({},this.arrowDimension,{},!0);break;case"setArrowDimension":this.arrowDimension=e.value.arrowDimension;break;case"moveToSelectionRange":this.moveToSelectionRange(e.value.type,e.value.activeObj);break;case"setResizeSelect":this.isResizeSelect=e.value.bool;break;case"applyFrame":this.applyFrame(e.value.ctx,e.value.frame,e.value.preventImg);break;case"drawImage":this.drawImage();break;case"downScaleImgCanvas":this.downScaleImgCanvas(e.value.ctx,e.value.isImgAnnotation,e.value.isHFlip,e.value.isVFlip);break;case"downScale":this.downScale(e.value.canvas,e.value.width,e.value.height);break;case"resetFrameZoom":this.resetFrameZoom(e.value.isOk);break;case"triggerFrameChange":e.value.obj.frameChangeEventArgs=this.triggerFrameChange(e.value.prevFrameSettings);break;case"setImageApply":this.isImageApply=e.value.bool;break;case"zoomToSel":this.zoomToSel(e.value.activeObj,e.value.isToolbar);break;case"getStraightenActObj":e.value.obj.activeObj=this.straightenActObj;break;case"setStraightenActObj":this.straightenActObj=e.value.activeObj;break;case"updateImgCanvasPoints":this.updateImgCanvasPoints();break;case"isLinesIntersect":e.value.obj.isIntersect=this.isLinesIntersect(e.value.obj);break;case"getImageCanvasPoints":e.value.obj.points=this.imgCanvasPoints;break;case"setDestForStraighten":this.setDestForStraighten();break;case"setTempDestForStraighten":this.tempStraightenDestPoints=sf.base.extend({},this.straightenDestPoints,{},!0);break;case"getStraightenInitZoom":e.value.obj.zoomFactor=this.straightenInitZoom;break;case"setStraightenInitZoom":this.straightenInitZoom=e.value.zoomFactor;break;case"isPointsInsideImg":e.value.obj.bool="inside"!==this.checkPointPosition(e.value.x,e.value.y,this.imgCanvasPoints[0].x,this.imgCanvasPoints[0].y,this.imgCanvasPoints[1].x,this.imgCanvasPoints[1].y,this.imgCanvasPoints[2].x,this.imgCanvasPoints[2].y,this.imgCanvasPoints[3].x,this.imgCanvasPoints[3].y);break;case"setIsCropSelect":this.isCropSelect=e.value.bool;break;case"updateCropSelection":this.updateCropSelection();break;case"updateCropSelObj":this.updateCropSelObj();break;case"redrawDownScale":this.redrawDownScale();break;case"updateFinetune":this.updateFinetune();break;case"isSelOutsideImg":e.value.obj.bool=this.isSelOutsideImg();break;case"resetStraightenDestPoints":this.straightenDestPoints=null;break;case"checkPointPosition":e.value.obj.position=this.checkPointPosition(e.value.obj.x,e.value.obj.y,e.value.obj.x1,e.value.obj.y1,e.value.obj.x2,e.value.obj.y2,e.value.obj.x3,e.value.obj.y3,e.value.obj.x4,e.value.obj.y4);break;case"updateTempObjColl":this.tempObjColl=sf.base.extend([],this.parent.objColl,[],!0);break;case"resetTempObjColl":this.tempObjColl=null;break;case"updateTempPointColl":this.tempPointColl=sf.base.extend({},this.parent.pointColl,{},!0);break;case"resetTempPointColl":this.tempPointColl={}}},e.prototype.getModuleName=function(){return"draw"},e.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),sf.base.isNullOrUndefined(this.tempZoomFactor)&&(this.tempZoomFactor=e.transform.zoomFactor),""===this.tempTextSettings.fontFamily&&(this.tempTextSettings.fontFamily=e.defaultFontFamily)},e.prototype.reset=function(){this.isInitialLoading=this.isErrorImage=this.isNewPath=this.isResizeSelect=!1,this.isShapeTextInserted=!1,this.isImageApply=!1,this.initZoomValue=null,this.tempFilter="",this.origDim={width:0,height:0},this.currSelPoint=null,this.isRotateZoom=!1,this.tempAdjValue="",this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:this.parent.defaultFontFamily,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempUndoRedoStep=this.tempFreehandCounter=this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.prevActObj=null,this.tempStraightenDestPoints=null,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}},this.straightenActObj=null,this.imgCanvasPoints=[],this.straightenInitZoom=null,this.tempObjColl=[],this.tempPointColl={},this.straightenDestPoints=null,this.isCropSelect=this.isDownScale=this.preventStraightening=!1},e.prototype.redrawDownScale=function(){var e=this.parent;if(e.transform.zoomFactor&&e.transform.zoomFactor<0){var t=sf.base.extend({},e.activeObj,{},!0);e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.isDownScale=!0,this.renderImage(),this.isDownScale=!1,t.shape&&this.drawObject("duplicate",t)}},e.prototype.updateFinetune=function(){var e=this.parent;if(e.transform.zoomFactor&&e.transform.zoomFactor<0){var t=this.lowerContext.filter;this.lowerContext.filter="none",e.drawModule.draw({prop:"redrawDownScale"});var o=e.inMemoryCanvas.getContext("2d"),r=this.lowerContext,i=r.getImageData(0,0,r.canvas.width,r.canvas.height);e.inMemoryCanvas.width=i.width,e.inMemoryCanvas.height=i.height,o.putImageData(i,0,0),this.lowerContext.filter=t,e.drawModule.draw({prop:"redrawDownScale"})}},e.prototype.drawImage=function(){this.applyFrame(this.lowerContext,this.parent.frameObj.type)},e.prototype.drawObject=function(e,t,o,r,i,a,s){var n,l=this.parent,h=l.activeObj,p=l.activeObj.activePoint;(this.upperContext.clearRect(0,0,l.upperCanvas.width,l.upperCanvas.height),"original"===(e=e.toLowerCase())?n=this.lowerContext:"duplicate"===e?n=this.upperContext:a&&(n=a),!i&&h.shape&&this.setDragLimit(),l.currObjType.shape)&&("crop"===l.currObjType.shape.split("-")[0].toLowerCase()&&o&&this.drawCropRatio());if(h=l.activeObj,p=l.activeObj.activePoint,sf.base.isNullOrUndefined(h.strokeSettings)){var d={strokeSettings:{}};l.shapeModule.shape({prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:d}}),h.strokeSettings=d.strokeSettings}if(sf.base.isNullOrUndefined(h.strokeSettings.strokeWidth)&&(h.strokeSettings.strokeWidth=2),t&&(l.activeObj=sf.base.extend({},t,{},!0)),r&&r.startX&&r.startY&&r.endX&&r.endY&&r.width&&r.height&&(p.startX=r.startX,p.startY=r.startY,p.endX=r.endX,p.endY=r.endY,p.width=r.width,p.height=r.height),this.updateActiveObject(),h=l.activeObj,p=l.activeObj.activePoint,!sf.base.isNullOrUndefined(p.startX)||!sf.base.isNullOrUndefined(p.startY)){if(l.currObjType.isText){var c={keyHistory:""};l.shapeModule.shape({prop:"getKeyHistory",onPropertyChange:!1,value:{obj:c}}),h.keyHistory=c.keyHistory}var u=!1;if("original"!==e){h.shape&&"crop"===h.shape.split("-")[0]&&(u=!0),u&&(r&&r.startX&&r.startY&&r.endX&&r.endY&&r.width&&r.height?(p.startX=r.startX,p.startY=r.startY,p.endX=r.endX,p.endY=r.endY,p.width=r.width,p.height=r.height):p=h.activePoint,this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,l.lowerCanvas.width,l.lowerCanvas.height),this.upperContext.clearRect(p.startX,p.startY,p.width,p.height)),!sf.base.isNullOrUndefined(s)||n!==this.lowerContext&&n!==this.upperContext||(this.rotateContext("initial",n),this.drawOuterSelection(n),this.rotateContext("reverse",n))}l.currObjType.isActiveObj=!0;var v={keyHistory:""};l.shapeModule.shape({prop:"getKeyHistory",onPropertyChange:!1,value:{obj:v}}),t?this.drawShapeObj(e,t.shape,a,s):""!==v.keyHistory&&l.currObjType.isText?this.drawShapeObj(e,"text",a,s):h.shape?this.drawShapeObj(e,h.shape,a,s):this.drawShapeObj(e,void 0,a,s),"duplicate"===e&&u&&"crop-circle"!==h.shape&&"none"!==l.frameObj.type&&(this.applyFrame(this.upperContext,l.frameObj.type),this.drawCornerCircles(this.upperContext))}},e.prototype.rotateContext=function(e,t){var o=this.parent,r=o.activeObj,i=r.shape,a=r.rotatedAngle,s=o.img,n=s.destLeft,l=s.destTop,h=s.destWidth,p=s.destHeight,d=o.activeObj.activePoint,c=d.startX,u=d.startY,v=d.width,g=d.height;if("line"!==i&&"arrow"!==i){var b,C,f="initial"===e?a:-a;0!==o.transform.straighten||o.isCropTab?(b=n+h/2,C=l+p/2):(b=c+v/2,C=u+g/2),t.translate(b,C),t.rotate(f),t.translate(-b,-C)}},e.prototype.setDragLimit=function(){var e=this.parent,t=e.activeObj.activePoint,o=e.activeObj,r=o.shape,i=o.rotatedAngle;if(t&&"image"!==r&&"line"!==r&&0===i){var a=e.img,s=a.destLeft,n=a.destTop,l=a.destWidth,h=a.destHeight;t.startX<s?(t.startX=s,t.endX=Math.min(t.startX+t.width,s+l)):t.endX>s+l&&(t.endX=s+l,t.startX=Math.max(t.endX-t.width,s)),t.startY<n?t.startY=n:t.endY>n+h&&(t.endY=n+h,t.startY=Math.max(t.endY-t.height,n)),e.activeObj=this.updateWidthHeight(e.activeObj)}},e.prototype.drawCropRatio=function(){var e,t,o,r,i=this.parent,a=i.activeObj.activePoint,s=i.lowerCanvas.clientWidth,n=i.lowerCanvas.clientHeight+1,l=i.img,h=l.destLeft,p=l.destTop,d=l.destWidth,c=l.destHeight;if(i.transform.zoomFactor>0&&this.currSelPoint){var u=sf.base.extend({},i.activeObj,{},!0);this.drawCustomSelection("crop-custom",null,null,null,null),0!==i.transform.straighten&&(a=i.activeObj.activePoint),i.transform.degree%90==0&&i.transform.degree%180!=0?r=o=a.width<a.height?a.width:a.height:(o=h+h+d<=s?a.width:0===i.transform.straighten?s-h:a.width,r=p+p+c<=n?a.height:0===i.transform.straighten?n-p:a.height),i.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),i.activeObj=u,i.currObjType.shape=u.shape,this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.currObjType.isCustomCrop=!1}else o=d,r=c,h<0&&(o+=h),p<0&&(r+=p),h+d>i.lowerCanvas.width&&(o-=h+d-i.lowerCanvas.width),p+c>i.lowerCanvas.height&&(r-=p+c-i.lowerCanvas.height);switch(i.currObjType.shape.toLowerCase()){case"crop-square":case"crop-circle":i.selectionModule.selection({prop:"setDragDirection",onPropertyChange:!1,value:{width:o,height:r}}),a=i.activeObj.activePoint,i.lowerCanvas.width<a.endX-a.startX&&(a.startX=7.5,a.endX=i.lowerCanvas.width-7.5),i.lowerCanvas.height<a.endY-a.startY&&(a.startY=7.5,a.endY=i.lowerCanvas.height-7.5),o===d&&r===c&&(a.startX+=h,a.startY+=p,a.endX+=h,a.endY+=p),i.lowerCanvas.width>i.lowerCanvas.height?(a.height=a.endY-a.startY,a.width=a.height,a.endX=a.startX+a.width):(a.width=a.endX-a.startX,a.height=a.width,a.endY=a.startY+a.height);break;case"crop-3:2":e=3,t=2;break;case"crop-4:3":e=4,t=3;break;case"crop-5:4":e=5,t=4;break;case"crop-7:5":e=7,t=5;break;case"crop-16:9":e=16,t=9;break;case"crop-2:3":e=2,t=3;break;case"crop-3:4":e=3,t=4;break;case"crop-4:5":e=4,t=5;break;case"crop-5:7":e=5,t=7;break;case"crop-9:16":e=9,t=16;break;default:e=parseInt(i.currObjType.shape.toLowerCase().split("crop-")[1].split(":")[0]),t=parseInt(i.currObjType.shape.toLowerCase().split("crop-")[1].split(":")[1])}if(void 0!==e&&void 0!==t&&(i.selectionModule.selection({prop:"calcShapeRatio",onPropertyChange:!1,value:{x:e,y:t,imgWidth:o,imgHeight:r}}),o===d&&r===c&&this.updatePoints(),a=i.activeObj.activePoint),a.startX<h){var v=h-a.startX+7.5;a.startX+=v,a.endX+=v}if(a.startY<p){v=p-a.startY+7.5;a.startY+=v,a.endY+=v}i.activeObj=this.updateWidthHeight(i.activeObj),this.adjToCenter(),this.enlargeToImg(),0!==i.transform.straighten&&(this.adjToStraighten(),this.updateActiveObject(i.activeObj.activePoint,i.activeObj));var g={isIntersect:null,arr:null},b=0;if(a=i.activeObj.activePoint,0!==i.transform.straighten)for(;this.isLinesIntersect(g)&&b<100;){b++;v=1*a.width/100;a.startX+=v,a.endX-=v,v=1*a.height/100,a.startY+=v,a.endY-=v,a.width=a.endX-a.startX,a.height=a.endY-a.startY,this.updateActiveObject(a,i.activeObj)}this.straightenInitZoom=i.transform.zoomFactor,this.straightenActObj=sf.base.extend({},i.activeObj,{},!0),i.drawModule.draw({prop:"resetStraightenDestPoints"}),i.drawModule.draw({prop:"setDestForStraighten"})},e.prototype.adjToCenter=function(){var e=this.parent,t=e.activeObj.activePoint,o=e.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight,n=e.lowerCanvas.width/2-(t.endX-t.width/2),l=e.lowerCanvas.height/2-(t.endY-t.height/2);if(t.startX+=n,t.endX+=n,t.startY+=l,t.endY+=l,t.startX<(r>=7.5?r:7.5)){var h=(r>=7.5?r:0)-t.startX;t.startX+=h,t.endX+=h}else if(t.endX>r+a){h=t.endX-(r+a);t.startX-=h,t.endX-=h}if(t.startY<(i>=7.5?i:7.5)){h=(i>=7.5?i:0)-t.startY;t.startY+=h,t.endY+=h}else if(t.endY>i+s){h=t.endY-(i+s);t.startY-=h,t.endY-=h}},e.prototype.enlargeToImg=function(){var e=this.parent;if(0!==e.transform.straighten&&e.transform.degree%90==0&&e.transform.degree%180!=0)for(var t=e.activeObj.activePoint,o=sf.base.extend({},t,{},!0),r=0;;){r++;var i=5*t.width/100;t.startX-=i,t.endX+=i,i=5*t.height/100,t.startY-=i,t.endY+=i,t.width=t.endX-t.startX,t.height=t.endY-t.startY,this.updateActiveObject(t,e.activeObj);var a={isIntersect:null,arr:null};if(this.updateImgCanvasPoints(),this.isLinesIntersect(a),a.arr[0]||a.arr[1]||a.arr[2]||a.arr[3]||t.startX<7.5||t.startY<7.5||100===r){i=1*(t=sf.base.extend({},o,{},!0)).width/100,t.startX+=i,t.endX-=i,i=1*t.height/100,t.startY+=i,t.endY-=i,t.width=t.endX-t.startX,t.height=t.endY-t.startY,this.updateActiveObject(t,e.activeObj);break}o=sf.base.extend({},t,{},!0)}},e.prototype.updateActiveObject=function(e,t,o,r,i){var a=this.parent;e=e||sf.base.extend({},a.activeObj.activePoint,{},!0),t=t||sf.base.extend({},a.activeObj,{},!0),e.width=e.endX-e.startX,e.height=e.endY-e.startY;var s=e.startX,n=e.startY,l=e.endX,h=e.endY;r=r||0,i=i||0;var p=e.width/2,d=e.height/2;t.horTopLine={startX:s+r,startY:n-i,endX:l+r,endY:h+i},t.horBottomLine={startX:s-r,startY:h-i,endX:l-r,endY:h+i},t.verLeftLine={startX:s+r,startY:n-i,endX:s-i,endY:h-i},t.verRightLine={startX:l+r,startY:n+i,endX:l-r,endY:h+i},t.topLeftCircle={startX:s,startY:n,radius:t.horTopLine.endX?7.5:0},t.topCenterCircle={startX:s+p,startY:n,radius:t.horTopLine.endX?7.5:0},t.topRightCircle={startX:l,startY:n,radius:t.horTopLine.endX?7.5:0},t.centerLeftCircle={startX:s,startY:n+d,radius:t.horTopLine.endX?7.5:0},t.centerRightCircle={startX:l,startY:n+d,radius:t.horTopLine.endX?7.5:0},t.bottomLeftCircle={startX:s,startY:h,radius:t.horTopLine.endX?7.5:0},t.bottomCenterCircle={startX:s+p,startY:h,radius:t.horTopLine.endX?7.5:0},t.bottomRightCircle={startX:l,startY:h,radius:t.horTopLine.endX?7.5:0},0===t.rotatedAngle&&(t.rotationCirclePoint={x:t.bottomCenterCircle.startX,y:t.bottomCenterCircle.startY+25},t.rotationCirclePoint.ratioX=(t.rotationCirclePoint.x-a.img.destLeft)/a.img.destWidth,t.rotationCirclePoint.ratioY=(t.rotationCirclePoint.y-a.img.destTop)/a.img.destHeight),t.activePoint=e,sf.base.isNullOrUndefined(o)&&(a.activeObj=sf.base.extend({},t,{},!0))},e.prototype.drawOuterSelection=function(e,t){var o,r=this.parent,i=r.activeObj.activePoint,a=r.activeObj;e.lineWidth=.5;var s,n=sf.base.extend({},a,{},!0);if(a.shape&&(o=a.shape.split("-")),(o&&"crop"===o[0]||void 0===a.shape)&&!t&&(this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),this.upperContext.clearRect(i.startX,i.startY,i.width,i.height)),e.strokeStyle=r.themeColl[r.theme].primaryColor,e.fillStyle=r.themeColl[r.theme].secondaryColor,(s=0===n.shapeDegree?r.transform.degree:r.transform.degree-n.shapeDegree)<0&&(s=360+s),"arrow"===a.shape||"line"===a.shape)e.beginPath(),e.moveTo(i.startX,i.startY),e.lineTo(i.endX,i.endY),e.stroke();else if("path"===a.shape){e.beginPath();var l=sf.base.extend({},r.activeObj,{},!0);if(l.pointColl[0]&&(e.moveTo(l.pointColl[0].x,l.pointColl[0].y),l.pointColl.length>1))for(var h=1,p=l.pointColl.length;h<p;h++)i.endX=l.pointColl[h].x,i.endY=l.pointColl[h].y,e.lineTo(i.endX,i.endY);var d={shape:null};r.selectionModule.selection({prop:"getCurrentDrawingShape",value:{obj:d}}),"path"===d.shape&&(r.activeObj=a=l),e.lineTo(i.endX,i.endY),e.stroke()}else this.drawCornerCircles(e);if(r.selectionSettings.showCircle&&(void 0===o||"crop"!==o[0])){var c=e.strokeStyle,u=e.fillStyle;e.strokeStyle=r.selectionSettings.strokeColor,e.fillStyle=r.selectionSettings.fillColor,"text"===a.shape?(e.lineWidth*=2,e.beginPath(),this.drawRotationArcLine(e),e.lineTo(a.rotationCirclePoint.x,a.rotationCirclePoint.y),e.stroke(),e.fill(),e.closePath(),e.beginPath(),e.moveTo(a.rotationCirclePoint.x,a.rotationCirclePoint.y),e.arc(a.rotationCirclePoint.x,a.rotationCirclePoint.y,a.bottomCenterCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),e.lineWidth/=2):this.drawCenterCircles(e),e.strokeStyle=c,e.fillStyle=u}n.rotationCircleLine=a.rotationCircleLine,r.activeObj=sf.base.extend({},n,{},!0)},e.prototype.drawArrowHead=function(e,t){switch(t?this.parent.activeObj.start:this.parent.activeObj.end){case"arrowSolid":t?this.arrowSolid(e,!0):this.arrowSolid(e,!1);break;case"arrow":t?this.arrow(e,!0):this.arrow(e,!1);break;case"circleSolid":t?this.arrowCircleSolid(e,!0):this.arrowCircleSolid(e,!1);break;case"circle":t?this.arrowCircle(e,!0):this.arrowCircle(e,!1);break;case"bar":t?this.arrowBar(e,!0):this.arrowBar(e,!1);break;case"square":case"squareSolid":t?this.arrowSquareStart(e):this.arrowSquareEnd(e)}},e.prototype.drawShapeObj=function(e,t,o,r){var i,a=this.parent,s=a.activeObj.activePoint,n=a.activeObj,l=n.strokeSettings,h=l.strokeColor,p=l.fillColor,d=l.strokeWidth,c=void 0!==t?t:a.currObjType.shape;a.currObjType.shape=c,"original"===e.toLowerCase()?i=this.lowerContext:"duplicate"===e.toLowerCase()?i=this.upperContext:o&&(i=o);var u=a.currObjType.shape.toLowerCase();-1!==["rectangle","ellipse","line","arrow","path","image"].indexOf(u)&&(n.shape=a.currObjType.shape),i.strokeStyle=h,i.fillStyle="text"===t||"freehanddraw"===t?h:p;var v,g=s.width/3,b=s.height/3,C=s.endX-s.startX,f=s.endY-s.startY;this.rotateContext("initial",i);var m,y=i.fillStyle;switch(a.currObjType.shape.toLowerCase()){case"rectangle":this.drawSquareLines(i),sf.base.isNullOrUndefined(r)&&i===this.upperContext&&this.drawOuterSelection(i);break;case"ellipse":C=Math.abs(C),f=Math.abs(f),i.beginPath(),i.ellipse(s.startX+C/2,s.startY+f/2,C/2,f/2,0,0,2*Math.PI,!1),""!==p&&(i.fillStyle=p,i.fill()),i.ellipse(s.startX+C/2,s.startY+f/2,Math.abs(C/2-d),Math.abs(f/2-d),0,0,2*Math.PI,!1),i.fillStyle=h,i.fill("evenodd"),i.closePath(),sf.base.isNullOrUndefined(r)&&i===this.upperContext&&this.drawOuterSelection(i);break;case"crop-circle":i===this.lowerContext&&(i=this.upperContext),this.shapeCircle(i,C,f);break;case"line":this.shapeLine(i,s.startX,s.startY,s.endX,s.endY),sf.base.isNullOrUndefined(r)&&i===this.upperContext&&this.drawOuterSelection(i);break;case"arrow":(v=0===n.shapeDegree?a.transform.degree:a.transform.degree-n.shapeDegree)<0&&(v=360+v),i.fillStyle=i.strokeStyle,sf.base.isNullOrUndefined(n.triangleDirection)&&(n.triangleDirection="right"),sf.base.isNullOrUndefined(n.start)&&(n.start="none"),sf.base.isNullOrUndefined(n.end)&&(n.end="arrowSolid"),this.drawArrowHead(i,!0),this.drawArrowHead(i,!1),"none"===n.end&&this.shapeLine(i,s.startX,s.startY,s.endX,s.endY),i.fillStyle=y,sf.base.isNullOrUndefined(r)&&i===this.upperContext&&this.drawOuterSelection(i);break;case"path":if((m=sf.base.extend({},a.activeObj,{},!0)).pointColl.length>1){var w={shape:null};if(a.selectionModule.selection({prop:"getCurrentDrawingShape",value:{obj:w}}),"path"===w.shape)for(var P={x:0,y:0},j=0,x=m.pointColl.length;j<x;j++)sf.base.isNullOrUndefined(m.pointColl[j+1])?(P.x=m.activePoint.endX,P.y=m.activePoint.endY):(P.x=m.pointColl[j+1].x,P.y=m.pointColl[j+1].y),s.startX=m.pointColl[j].x,s.startY=m.pointColl[j].y,s.endX=P.x,s.endY=P.y,a.activeObj=this.updateWidthHeight(a.activeObj),this.shapeLine(i,s.startX,s.startY,s.endX,s.endY);else for(j=1,x=m.pointColl.length;j<x;j++)s.startX=m.pointColl[j-1].x,s.startY=m.pointColl[j-1].y,s.endX=m.pointColl[j].x,s.endY=m.pointColl[j].y,a.activeObj=this.updateWidthHeight(a.activeObj),this.shapeLine(i,s.startX,s.startY,s.endX,s.endY);a.activeObj=n=m}else this.shapeLine(i,s.startX,s.startY,s.endX,s.endY);i===this.upperContext&&this.drawOuterSelection(i);break;case"text":this.shapeText(i);break;case"image":this.shapeImage(i),sf.base.isNullOrUndefined(r)&&i===this.upperContext&&this.drawOuterSelection(i);break;case"crop-square":case"crop-3:4":case"crop-4:3":case"crop-6:9":case"crop-9:6":case"crop-9:16":case"crop-16:9":i===this.lowerContext&&(i=this.upperContext),this.drawSelection(g,b),a.currObjType.shape="";break;default:this.drawSelection(g,b)}this.rotateContext("reverse",i)},e.prototype.updatePoints=function(){var e=this.parent,t=e.activeObj.activePoint,o=e.img,r=o.destLeft,i=o.destTop;t.startX+=r,t.startY+=i,t.endX+=r,t.endY+=i,e.activeObj=this.updateWidthHeight(e.activeObj)},e.prototype.updateWidthHeight=function(e){var t=e.activePoint,o=t.startX,r=t.startY,i=t.endX,a=t.endY;return e.activePoint.width=i-o,e.activePoint.height=a-r,e},e.prototype.drawCornerCircles=function(e){var t=this.parent,o=t.activeObj;if(e.beginPath(),e.rect(o.activePoint.startX,o.activePoint.startY,o.activePoint.width,o.activePoint.height),e.stroke(),e.closePath(),t.selectionSettings.showCircle){var r=e.strokeStyle,i=e.fillStyle;e.strokeStyle=t.selectionSettings.strokeColor,e.fillStyle=t.selectionSettings.fillColor,e.lineWidth*=2,e.beginPath(),e.moveTo(o.topLeftCircle.startX,o.topLeftCircle.startY),e.arc(o.topLeftCircle.startX,o.topLeftCircle.startY,o.topLeftCircle.radius,0,2*Math.PI),e.moveTo(o.topRightCircle.startX,o.topRightCircle.startY),e.arc(o.topRightCircle.startX,o.topRightCircle.startY,o.topRightCircle.radius,0,2*Math.PI),e.moveTo(o.bottomLeftCircle.startX,o.bottomLeftCircle.startY),e.arc(o.bottomLeftCircle.startX,o.bottomLeftCircle.startY,o.bottomLeftCircle.radius,0,2*Math.PI),e.moveTo(o.bottomRightCircle.startX,o.bottomRightCircle.startY),e.arc(o.bottomRightCircle.startX,o.bottomRightCircle.startY,o.bottomRightCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),e.lineWidth/=2,e.strokeStyle=r,e.fillStyle=i}},e.prototype.drawCenterCircles=function(e){var t=this.parent,o=t.activeObj.activePoint,r=t.activeObj;if(e.lineWidth*=2,e.beginPath(),"arrow"===r.shape||"line"===r.shape)e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,r.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,r.bottomCenterCircle.radius,0,2*Math.PI);else if("path"===r.shape){var i=sf.base.extend({},t.activeObj,{},!0);if(i.pointColl.length>1)for(var a=1,s=i.pointColl.length;a<s;a++)o.startX=i.pointColl[a-1].x,o.startY=i.pointColl[a-1].y,o.endX=i.pointColl[a].x,o.endY=i.pointColl[a].y,e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,r.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,r.bottomCenterCircle.radius,0,2*Math.PI);var n={shape:null};t.selectionModule.selection({prop:"getCurrentDrawingShape",value:{obj:n}}),"path"===n.shape&&(t.activeObj=r=i),e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,r.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,r.bottomCenterCircle.radius,0,2*Math.PI)}else this.drawRotationArcLine(e),e.lineTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y);e.stroke(),e.fill(),e.closePath(),"arrow"!==r.shape&&"line"!==r.shape&&"path"!==r.shape&&(e.beginPath(),e.moveTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y),e.arc(r.rotationCirclePoint.x,r.rotationCirclePoint.y,r.bottomCenterCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath()),e.lineWidth/=2},e.prototype.drawRotationArcLine=function(e){var t,o=this.parent,r=o.activeObj;sf.base.isNullOrUndefined(r.rotationCircleLine)&&(r.rotationCircleLine=22.5);var i=!1,a=!1;if((t=0===r.shapeDegree?o.transform.degree:o.transform.degree-r.shapeDegree)<0&&(t=360+t),r.flipObjColl)for(var s=0,n=r.flipObjColl.length;s<n;s++){var l=r.flipObjColl[s].toLowerCase();"horizontal"===l?i=!0:"vertical"===l&&(a=!0)}switch(t){case 0:case 360:a?(r.rotationCirclePoint={x:r.topCenterCircle.startX,y:r.topCenterCircle.startY-r.rotationCircleLine},e.moveTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y+r.rotationCircleLine)):(r.rotationCirclePoint={x:r.bottomCenterCircle.startX,y:r.bottomCenterCircle.startY+r.rotationCircleLine},e.moveTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y-r.rotationCircleLine));break;case 90:case-270:i?(r.rotationCirclePoint={x:r.centerRightCircle.startX+r.rotationCircleLine,y:r.centerLeftCircle.startY},e.moveTo(r.rotationCirclePoint.x-r.rotationCircleLine,r.rotationCirclePoint.y)):(r.rotationCirclePoint={x:r.centerLeftCircle.startX-r.rotationCircleLine,y:r.centerLeftCircle.startY},e.moveTo(r.rotationCirclePoint.x+r.rotationCircleLine,r.rotationCirclePoint.y));break;case 180:case-180:a?(r.rotationCirclePoint={x:r.bottomCenterCircle.startX,y:r.bottomCenterCircle.startY+r.rotationCircleLine},e.moveTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y-r.rotationCircleLine)):(r.rotationCirclePoint={x:r.topCenterCircle.startX,y:r.topCenterCircle.startY-r.rotationCircleLine},e.moveTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y+r.rotationCircleLine));break;case 270:case-90:i?(r.rotationCirclePoint={x:r.centerLeftCircle.startX-r.rotationCircleLine,y:r.centerLeftCircle.startY},e.moveTo(r.rotationCirclePoint.x+r.rotationCircleLine,r.rotationCirclePoint.y)):(r.rotationCirclePoint={x:r.centerRightCircle.startX+r.rotationCircleLine,y:r.centerLeftCircle.startY},e.moveTo(r.rotationCirclePoint.x-r.rotationCircleLine,r.rotationCirclePoint.y))}},e.prototype.drawSquareLines=function(e){var t,o=this.parent.activeObj,r=o.activePoint,i=r.startX,a=r.startY,s=r.width,n=r.height,l=o.strokeSettings,h=l.fillColor,p=l.strokeColor,d=l.strokeWidth;o.shape&&(t=o.shape.split("-")),"crop"===t[0]?e.strokeStyle="#fff":e.strokeStyle=p,e.beginPath(),e.rect(i,a,s,n),""!==h&&(e.fillStyle=h,e.fill()),e.rect(i+d,a+d,s-2*d,n-2*d),e.fillStyle=p,e.fill("evenodd"),e.closePath()},e.prototype.drawSelection=function(e,t){var o=this.parent,r=o.activeObj,i=r.activePoint,a=i.startX,s=i.startY,n=i.endX,l=i.endY;this.upperContext.strokeStyle=o.themeColl[o.theme].primaryColor,this.upperContext.beginPath(),r.horTopInnerLine={startX:a,startY:s+t,endX:n,endY:l+t},r.horBottomInnerLine={startX:a,startY:s+2*t,endX:n,endY:l+2*t},r.verLeftInnerLine={startX:a+e,startY:s,endX:a+e,endY:l},r.verRightInnerLine={startX:a+2*e,startY:s,endX:a+2*e,endY:l},this.upperContext.moveTo(r.horTopInnerLine.startX,r.horTopInnerLine.startY),this.upperContext.lineTo(r.horTopInnerLine.endX,r.horTopInnerLine.startY),this.upperContext.moveTo(r.horBottomInnerLine.startX,r.horBottomInnerLine.startY),this.upperContext.lineTo(r.horBottomInnerLine.endX,r.horBottomInnerLine.startY),this.upperContext.moveTo(r.verLeftInnerLine.startX,r.verLeftInnerLine.startY),this.upperContext.lineTo(r.verLeftInnerLine.endX,r.verLeftInnerLine.endY),this.upperContext.moveTo(r.verRightInnerLine.startX,r.verRightInnerLine.startY),this.upperContext.lineTo(r.verRightInnerLine.endX,r.verRightInnerLine.endY),this.upperContext.stroke(),this.upperContext.closePath()},e.prototype.shapeCircle=function(e,t,o){var r=this.parent,i=r.activeObj.activePoint,a=i.startX,s=i.startY,n=i.endX,l=i.endY,h=i.width;e.strokeStyle=r.themeColl[r.theme].primaryColor,e.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),e.fillStyle="rgb(0, 0, 0, 0.25)",e.fillRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height);var p=e.lineWidth;e.lineWidth=2,e.beginPath(),e.ellipse(r.activeObj.horTopLine.startX+t/2,r.activeObj.horTopLine.startY+o/2,t/2,o/2,0,0,2*Math.PI,!1),e.stroke(),e.closePath(),e.save(),e.beginPath(),e.arc((n-a)/2+a,(l-s)/2+s,h/2,0,2*Math.PI),e.closePath(),e.clip(),e.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),e.restore(),e.lineWidth=p,this.drawOuterSelection(e,!0),r.currObjType.shape=""},e.prototype.shapeLine=function(e,t,o,r,i){var a=e.lineWidth;e.lineWidth=this.parent.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.moveTo(t,o),e.lineTo(r,i),e.stroke(),e.lineWidth=a},e.prototype.manipulateSaveCtx=function(e,t,o){if(e!==this.lowerContext&&e!==this.upperContext){var r={width:0,height:0};this.parent.cropModule.cropping({prop:"calcRatio",onPropertyChange:!1,value:{obj:r,dimension:{width:e.canvas.width,height:e.canvas.height}}});t&&(t*=r.width),o&&(o*=r.height)}return{x:t,y:o}},e.prototype.arrow=function(e,t){var o=this.parent.activeObj,r=o.activePoint,i=r.startX,a=r.startY,s=r.endX,n=r.endY,l=o.strokeSettings.strokeWidth;e.lineWidth=l;var h=this.arrowDimension.arrow.width,p=this.arrowDimension.arrow.height,d=this.manipulateSaveCtx(e,h,p);h=d.x+l,p=d.y+l,this.dx=s-i,this.dy=n-a,e.fillStyle=o.strokeSettings.strokeColor;var c=Math.atan2(this.dy,this.dx),u="arrow"===o.start,v="arrow"===o.end,g="circle"===o.end||"square"===o.end;((t&&"left"===o.triangleDirection||"right"===o.triangleDirection)&&(u&&"none"===o.end||u&&!g)||!t&&(v&&"none"===o.start||!u&&!g))&&this.shapeLine(e,i,a,s,n),t&&"left"===o.triangleDirection||!t&&"right"===o.triangleDirection?(e.translate(s,n),e.rotate(c),this.shapeLine(e,0,0,-h,p/2),this.shapeLine(e,0,0,-h,-p/2),e.rotate(-c),e.translate(-s,-n)):(t&&"right"===o.triangleDirection||!t&&"left"===o.triangleDirection)&&(e.translate(i,a),e.rotate(c),this.shapeLine(e,0,0,h,p/2),this.shapeLine(e,0,0,h,-p/2),e.rotate(-c),e.translate(-i,-a))},e.prototype.arrowSolid=function(e,t){var o=this.parent.activeObj,r=o.strokeSettings.strokeWidth,i=o.activePoint,a=i.startX,s=i.startY,n=i.endX,l=i.endY,h=this.arrowDimension.arrowSolid.width,p=this.arrowDimension.arrowSolid.height,d=this.manipulateSaveCtx(e,h,p);h=d.x+r,p=d.y+r,this.dx=n-a,this.dy=l-s;var c=Math.atan2(this.dy,this.dx),u="arrowSolid"===o.start,v="arrowSolid"===o.end,g="circle"===o.end||"square"===o.end;(t&&u&&"none"===o.end||u&&!g||!t&&(v&&"none"===o.start||!u&&!g))&&this.shapeLine(e,a,s,n,l),t&&"left"===o.triangleDirection||!t&&"right"===o.triangleDirection?(e.translate(n,l),e.rotate(c),e.beginPath(),e.moveTo(r,0),e.lineTo(p/2-h,p/2),e.lineTo(p/2-h,-p/2),e.closePath(),e.fill(),e.rotate(-c),e.translate(-n,-l),o.rotatedAngle=c):(t&&"right"===o.triangleDirection||!t&&"left"===o.triangleDirection)&&(e.translate(a,s),e.rotate(c),e.beginPath(),e.moveTo(0-r,0),e.lineTo(h-p/2,p/2),e.lineTo(h-p/2,-p/2),e.closePath(),e.fill(),e.rotate(-c),e.translate(-a,-s),o.rotatedAngle=c)},e.prototype.arrowSquareStart=function(e){var t=this.parent.activeObj,o=t.strokeSettings.strokeWidth,r=t.activePoint,i=r.startX,a=r.startY,s=r.endX,n=r.endY,l="square"===t.start,h="circle"===t.end,p="squareSolid"===t.start,d="circleSolid"===t.end;(l&&"none"===t.end||l&&!h&&"square"!==t.start||p&&d)&&this.shapeLine(e,i,a,s,n),e.lineWidth=o,e.beginPath(),e.fillStyle=t.strokeSettings.strokeColor;var c=this.arrowDimension.square.width,u=this.arrowDimension.square.height,v=this.manipulateSaveCtx(e,c,u);c=v.x+o,u=v.y+o,this.dx=s-i,this.dy=n-a;var g=Math.atan2(this.dy,this.dx);"left"===t.triangleDirection?(e.translate(s,n),e.rotate(g),"squareSolid"===t.start&&e.fillRect(u/2-c,-u/2,c,u),e.strokeRect(u/2-c,-u/2,c,u),e.rotate(-g),e.translate(-s,-n),this.squareStartIntersectX1=s-u/2*Math.cos(g),this.squareStartIntersectY1=n-u/2*Math.sin(g),"square"===t.start&&"square"!==t.end&&"circle"!==t.end?this.shapeLine(e,i,a,this.squareStartIntersectX1,this.squareStartIntersectY1):"square"===t.start&&"circle"===t.end?this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1):"squareSolid"===t.start&&"squareSolid"===t.end&&this.shapeLine(e,i,a,s,n)):"right"===t.triangleDirection&&(e.lineWidth=o,e.fillStyle=t.strokeSettings.strokeColor,"squareSolid"===t.start&&"squareSolid"===t.end&&this.shapeLine(e,i,a,s,n),e.translate(i,a),e.rotate(g),"squareSolid"===t.start&&e.fillRect(u/2-c,-u/2,c,u),e.strokeRect(u/2-c,-u/2,c,u),e.rotate(-g),e.translate(-i,-a),t.rotatedAngle=g,this.squareStartIntersectX1=i+u/2*Math.cos(g),this.squareStartIntersectY1=a+u/2*Math.sin(g),"square"===t.start&&"square"!==t.end&&"circle"!==t.end&&this.shapeLine(e,s,n,this.squareStartIntersectX1,this.squareStartIntersectY1),"square"===t.start&&"circle"===t.end&&this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1))},e.prototype.arrowSquareEnd=function(e){var t=this.parent.activeObj,o=t.activePoint,r=o.startX,i=o.startY,a=o.endX,s=o.endY,n=t.strokeSettings.strokeWidth,l=this.arrowDimension.square.width,h=this.arrowDimension.square.height,p=this.manipulateSaveCtx(e,l,h);l=p.x+n,h=p.y+n,this.dx=a-r,this.dy=s-i;var d=Math.atan2(this.dy,this.dx);e.lineWidth=n,"right"===t.triangleDirection?(e.fillStyle=t.strokeSettings.strokeColor,"squareSolid"===t.end&&"none"===t.start&&this.shapeLine(e,r,i,a,s),e.translate(a,s),e.rotate(d),"squareSolid"===t.end&&e.fillRect(h/2-l,-h/2,l,h),e.strokeRect(h/2-l,-h/2,l,h),e.rotate(-d),e.translate(-a,-s),t.rotatedAngle=d,this.squareEndIntersectX1=a-h/2*Math.cos(d),this.squareEndIntersectY1=s-h/2*Math.sin(d),"square"===t.end&&"square"!==t.start&&"circle"!==t.start?this.shapeLine(e,r,i,this.squareEndIntersectX1,this.squareEndIntersectY1):"circle"===t.start&&"square"===t.end?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"square"===t.start&&"square"===t.end&&this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1)):"left"===t.triangleDirection&&(e.translate(r,i),e.rotate(d),"squareSolid"===t.end&&e.fillRect(h/2-l,-h/2,l,h),e.strokeRect(h/2-l,-h/2,l,h),e.rotate(-d),e.translate(-r,-i),t.rotatedAngle=d,this.squareEndIntersectX1=r+h/2*Math.cos(d),this.squareEndIntersectY1=i+h/2*Math.sin(d),"square"===t.end&&"square"!==t.start&&"circle"!==t.start?this.shapeLine(e,a,s,this.squareEndIntersectX1,this.squareEndIntersectY1):"circle"===t.start&&"square"===t.end?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"square"===t.start&&"square"===t.end&&this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1))},e.prototype.arrowCircle=function(e,t){var o=this.parent,r=o.activeObj,i=r.activePoint,a=i.startX,s=i.startY,n=i.endX,l=i.endY,h=r.strokeSettings.strokeWidth;if(t&&"left"===r.triangleDirection||!t&&"right"===r.triangleDirection){e.lineWidth=h;var p=this.arrowDimension.circle.width;p=this.manipulateSaveCtx(e,p,null).x+h,e.beginPath(),e.arc(n,l,p,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=n-a,this.dy=l-s;var d=this.dx*this.dx+this.dy*this.dy;if((C=(b=2*(this.dx*(a-n)+this.dy*(s-l)))*b-4*d*((a-n)*(a-n)+(s-l)*(s-l)-p*p))>=0){e.fillStyle=r.strokeSettings.strokeColor;var c=(-b-Math.sqrt(C))/(2*d),u=a+this.dx*c,v=s+this.dy*c;t?(this.startCircleIntersectX1=u,this.startCircleIntersectY1=v,this.endCircleIntersectX1=n-this.dx*c,this.endCircleIntersectY1=l-this.dy*c,e.beginPath(),e.fill(),e.beginPath(),"circle"===r.start&&"circle"===r.end?this.shapeLine(e,this.startCircleIntersectX1,this.startCircleIntersectY1,this.endCircleIntersectX1,this.endCircleIntersectY1):"circle"===r.start&&"circle"!==r.end&&"square"!==r.end&&this.shapeLine(e,a,s,this.startCircleIntersectX1,this.startCircleIntersectY1),e.stroke(),e.closePath()):(this.endCircleIntersectX1=u,this.endCircleIntersectY1=v,"circle"===r.end&&"circle"!==r.start&&"square"!==r.start&&this.shapeLine(e,a,s,this.endCircleIntersectX1,this.endCircleIntersectY1))}var g=Math.atan2(this.dy,this.dx);o.activeObj.rotatedAngle=g}else if(t&&"right"===r.triangleDirection||!t&&"left"===r.triangleDirection){e.lineWidth=h;p=this.arrowDimension.circle.width;p=this.manipulateSaveCtx(e,p,null).x+h,e.beginPath(),e.arc(a,s,p,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=a-n,this.dy=s-l;var b,C;d=this.dx*this.dx+this.dy*this.dy;if((C=(b=2*(this.dx*(n-a)+this.dy*(l-s)))*b-4*d*((n-a)*(n-a)+(l-s)*(l-s)-p*p))>=0){e.fillStyle=r.strokeSettings.strokeColor;c=(-b-Math.sqrt(C))/(2*d),u=n+this.dx*c,v=l+this.dy*c;t?(this.startCircleIntersectX1=u,this.startCircleIntersectY1=v,this.endCircleIntersectX1=a-this.dx*c,this.endCircleIntersectY1=s-this.dy*c,"circle"===r.start&&"circle"===r.end?this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"circle"===r.start&&"circle"!==r.end&&"square"!==r.end&&this.shapeLine(e,n,l,this.startCircleIntersectX1,this.startCircleIntersectY1)):(this.endCircleIntersectX1=u,this.endCircleIntersectY1=v,e.beginPath(),e.fill(),e.beginPath(),"circle"===r.end&&"circle"!==r.start&&"square"!==r.start&&this.shapeLine(e,n,l,this.endCircleIntersectX1,this.endCircleIntersectY1))}g=Math.atan2(this.dy,this.dx);o.activeObj.rotatedAngle=g}},e.prototype.arrowCircleSolid=function(e,t){var o=this.parent.activeObj,r=o.activePoint,i=r.startX,a=r.startY,s=r.endX,n=r.endY,l="circleSolid"===o.start,h=o.strokeSettings.strokeWidth;if(t&&"left"===o.triangleDirection||!t&&"right"===o.triangleDirection){e.lineWidth=h,e.beginPath(),e.fillStyle=o.strokeSettings.strokeColor,(t&&l&&"none"===o.end||l&&"circle"!==o.end&&"square"!==o.end||!t&&"circleSolid"===o.end&&"none"===o.start)&&this.shapeLine(e,i,a,s,n);var p=this.arrowDimension.circle.width;p=this.manipulateSaveCtx(e,p,null).x+h,this.dx=s-i,this.dy=n-a,e.save(),e.beginPath(),e.arc(s,n,p,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),o.rotatedAngle=Math.atan2(this.dy,this.dx)}else if(t&&"right"===o.triangleDirection||!t&&"left"===o.triangleDirection){e.lineWidth=h,e.beginPath(),e.fillStyle=o.strokeSettings.strokeColor,(t&&l&&"none"===o.end||l&&"circle"!==o.end&&"square"!==o.end||!t&&"circleSolid"===o.end&&"none"===o.start)&&this.shapeLine(e,i,a,s,n);p=this.arrowDimension.circle.width;p=this.manipulateSaveCtx(e,p,null).x+h,this.dx=s-i,this.dy=n-a,e.save(),e.beginPath(),e.arc(i,a,p,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),o.rotatedAngle=Math.atan2(this.dy,this.dx)}},e.prototype.arrowBar=function(e,t){var o=this.parent,r=o.activeObj,i=r.activePoint,a=i.startX,s=i.startY,n=i.endX,l=i.endY,h=r.strokeSettings.strokeWidth;if(t&&"left"===r.triangleDirection||!t&&"right"===r.triangleDirection){e.lineWidth=h,e.beginPath(),e.fillStyle=r.strokeSettings.strokeColor,(t&&"bar"===r.start&&"none"===r.end||"bar"===r.start&&"circle"!==r.end&&"square"!==r.end||!t&&("bar"===r.end&&"none"===r.start||"bar"===r.end&&"circle"!==r.start&&"square"!==r.start))&&this.shapeLine(e,a,s,n,l);var p=this.arrowDimension.bar.width,d=this.arrowDimension.bar.height;p=(u=this.manipulateSaveCtx(e,p,d)).x+h,d=u.y+h,this.dx=n-a,this.dy=l-s;var c=Math.atan2(this.dy,this.dx);e.translate(n,l),e.rotate(c),e.fillRect(d/4-p,-d/2,p,d),e.rotate(-c),e.translate(-n,-l),r.rotatedAngle=c}else if(t&&"right"===r.triangleDirection||!t&&"left"===r.triangleDirection){e.lineWidth=h,e.beginPath(),e.fillStyle=r.strokeSettings.strokeColor,(t&&"bar"===r.start&&"none"===r.end||"bar"===r.start&&"circle"!==r.end&&"square"!==r.end||!t&&"bar"===r.end&&"none"===r.start)&&this.shapeLine(e,a,s,n,l);var u;p=this.arrowDimension.bar.width,d=this.arrowDimension.bar.height;p=(u=this.manipulateSaveCtx(e,p,d)).x+h,d=u.y+h,this.dx=n-a,this.dy=l-s;c=Math.atan2(this.dy,this.dx);e.translate(a,s),e.rotate(c),e.fillRect(d/4-p,-d/2,p,d),e.rotate(-c),e.translate(-a,-s),o.activeObj.rotatedAngle=c}},e.prototype.shapeImage=function(e){var t=this.parent,o=t.activeObj,r=o.activePoint,i=r.startX,a=r.startY,s=r.width,n=r.height,l=o.imageCanvas.getContext("2d");if(e===this.lowerContext&&this.isImageApply){var h={width:0,height:0};t.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o.imageElement.width,height:o.imageElement.height,obj:h,isImgShape:null}}),(s<h.width/5||n<h.height/5)&&(l.clearRect(0,0,o.imageCanvas.width,o.imageCanvas.height),t.selectionModule.selection({prop:"applyTransformToImg",onPropertyChange:!1,value:{ctx:l}}),t.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.selectionModule.selection({prop:"setImageClarity",onPropertyChange:!1,value:{bool:!1}}),this.isImageApply=!1)}var p={startX:0,startY:0,width:0,height:0};p.width=s,p.height=n,4===o.flipObjColl.length&&(o.flipObjColl=[],o.shapeFlip=""),p.startX=(s-p.width)/2+i,p.startY=(n-p.height)/2+a;var d=e.globalAlpha;e.globalAlpha=o.opacity,o.rotateFlipColl&&o.rotateFlipColl.length>0?this.rotateImage(e):e.drawImage(o.imageCanvas,p.startX,p.startY,p.width,p.height),e.globalAlpha=d,t.currObjType.isText=!1},e.prototype.shapeText=function(e){var t=this.parent,o=e.filter,r=t.activeObj,i=r.activePoint,a=i.startX,s=i.startY,n=i.width,l=i.height,h=r.keyHistory.split("\n"),p=r.textSettings,d=p.fontFamily,c=p.bold,u=p.italic,v=r.textSettings.fontSize,g=((v+.25*v)*h.length-v*h.length)/h.length;e.filter="none";for(var b=0;b<h.length;b++){var C=h[b],f=(b+1)*v*.85+b*g;-360===t.transform.degree&&(t.transform.degree=0),0===t.transform.degree||180===t.transform.degree?v>l&&(v=r.textSettings.fontSize=l-.1*l):v>n&&(v=r.textSettings.fontSize=n-.1*n),e.strokeStyle=r.strokeSettings.strokeColor,e.fillStyle=r.strokeSettings.strokeColor;var m="";c&&(m="bold "),u&&(m="italic "),c&&u&&(m="italic bold "),e.font=m+v+"px "+d,4===r.flipObjColl.length&&(r.flipObjColl=[],r.shapeFlip=""),r.rotateFlipColl&&r.rotateFlipColl.length>0?this.rotateText(e):e.fillText(C,a+.1*v,s+f)}e.filter=o,t.currObjType.isText=!1},e.prototype.updateActPoint=function(e,t){var o=this.parent,r=o.activeObj,i=r.activePoint;return"horizontal"===e.toLowerCase()?i.startX<=t.canvas.width/2?(i.startX=t.canvas.width/2+(t.canvas.width/2-i.endX),i.endX=i.startX+i.width,this.updateActiveObject(i,r),o.activeObj=r):i.startX>=t.canvas.width/2&&(i.startX=t.canvas.width-i.endX,i.endX=i.startX+i.width,this.updateActiveObject(i,r),o.activeObj=r):"vertical"===e.toLowerCase()&&(i.startY<=t.canvas.height/2?(i.startY=t.canvas.height/2+(t.canvas.height/2-i.endY),i.endY=i.startY+i.height,this.updateActiveObject(i,r),o.activeObj=r):i.startY>=t.canvas.height/2&&(i.startY=t.canvas.height-i.endY,i.endY=i.startY+i.height,this.updateActiveObject(i,r),o.activeObj=r)),i},e.prototype.rotateImage=function(e){var t,o=this.parent,r=o.activeObj,i=sf.base.extend({},o.activeObj,null,!0);-450===(t=0===r.shapeDegree?o.transform.degree:o.transform.degree-r.shapeDegree)&&(t=-90),t<0&&(t=360+t);var a={startX:0,startY:0,width:0,height:0};a.width=t%90==0&&t%180!=0?r.activePoint.height:r.activePoint.width,a.height=t%90==0&&t%180!=0?r.activePoint.width:r.activePoint.height,a.startX=r.activePoint.startX,a.startY=r.activePoint.startY;var s,n=a.startX,l=a.startY;e.save();for(var h=0,p=r.rotateFlipColl.length;h<p;h++){var d=r.rotateFlipColl[h];"number"==typeof d?(-450===(s=0===r.shapeDegree?d:d-r.shapeDegree)&&(s=-90),s<0&&(s=360+s),a.width=s%90==0&&s%180!=0?r.activePoint.height:r.activePoint.width,a.height=s%90==0&&s%180!=0?r.activePoint.width:r.activePoint.height,e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*d),e.translate(-e.canvas.height/2,-e.canvas.width/2),s%90==0&&s%270!=0||0===s?(l=e.canvas.width-(r.activePoint.startX+r.activePoint.width),l+=(r.activePoint.width-a.height)/2,n=a.startY):s%270==0&&(n=e.canvas.height-(r.activePoint.startY+r.activePoint.height),n+=(r.activePoint.height-a.width)/2,l=a.startX),a.startX=n,a.startY=l,r.activePoint.startX=n,r.activePoint.startY=l,r.activePoint.endX=r.activePoint.startX+a.width,r.activePoint.endY=r.activePoint.startY+a.height,r=this.updateWidthHeight(r)):("horizontal"===d&&t%90==0&&t%180!=0?d="vertical":"vertical"===d&&t%90==0&&t%180!=0&&(d="horizontal"),"horizontal"===d?(e.translate(e.canvas.width,0),e.scale(-1,1),r.activePoint=this.updateActPoint("horizontal",e)):"vertical"===d&&(e.translate(0,e.canvas.height),e.scale(1,-1),r.activePoint=this.updateActPoint("vertical",e)),a.startX=r.activePoint.startX,a.startY=r.activePoint.startY),a.startX=r.activePoint.startX,a.startY=r.activePoint.startY,n=a.startX,l=a.startY}0!==r.rotatedAngle&&o.shapeModule.shape({prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:r}}),e.drawImage(r.imageCanvas,a.startX,a.startY,a.width,a.height),e.restore(),o.activeObj=i,360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},e.prototype.rotateText=function(e){var t,o=this.parent,r=o.activeObj,i=sf.base.extend({},o.activeObj,null,!0),a=o.activeObj.activePoint;-450===(t=0===r.shapeDegree?o.transform.degree:o.transform.degree-r.shapeDegree)&&(t=-90),t<0&&(t=360+t);var s={startX:0,startY:0,width:0,height:0};s.width=t%90==0&&t%180!=0?a.height:a.width,s.height=t%90==0&&t%180!=0?a.width:a.height,s.startX=a.startX,s.startY=a.startY;var n,l=s.startX,h=s.startY;e.save();for(var p=0,d=r.rotateFlipColl.length;p<d;p++){var c=r.rotateFlipColl[p];"number"==typeof c?(-450===(n=0===r.shapeDegree?c:c-r.shapeDegree)&&(n=-90),n<0&&(n=360+n),s.width=n%90==0&&n%180!=0?a.height:a.width,s.height=n%90==0&&n%180!=0?a.width:a.height,e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*c),e.translate(-e.canvas.height/2,-e.canvas.width/2),n%90==0&&n%270!=0||0===n?(h=e.canvas.width-a.endX,l=a.startY):n%270==0&&(l=e.canvas.height-a.endY,h=a.startX),s.startX=l,s.startY=h,a.startX=l,a.startY=h,a.endX=a.startX+s.width,a.endY=a.startY+s.height,r=this.updateWidthHeight(r)):("horizontal"===c&&t%90==0&&t%180!=0?c="vertical":"vertical"===c&&t%90==0&&t%180!=0&&(c="horizontal"),"horizontal"===c?(e.translate(e.canvas.width,0),e.scale(-1,1)):"vertical"===c&&(e.translate(0,e.canvas.height),e.scale(1,-1)),r.activePoint=a=this.updateActPoint(c,e),s.startX=a.startX,s.startY=a.startY),s.startX=a.startX,s.startY=a.startY,l=s.startX,h=s.startY}0!==r.rotatedAngle&&o.shapeModule.shape({prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:r}}),h+=.4*r.textSettings.fontSize,this.textFlipDegree(e,l,h),e.restore(),o.activeObj=i,360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},e.prototype.textFlipDegree=function(e,t,o){for(var r=this.parent.activeObj,i=r.keyHistory.split("\n"),a=r.textSettings.fontSize,s=.85*a+(a*i.length-a*i.length)/i.length,n=0,l=i.length;n<l;n++){var h=i[n];n>0&&(1===n&&(s-=.85*a),s+=a+.15*a),e.fillText(h,t+.15*a,o+s+(n>0?.25*a:.35*-a))}},e.prototype.clearOuterCanvas=function(e){var t=this.parent,o=t.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight,n=r>0?r:0,l=i>0?i:0;e.clearRect(0,0,n,t.lowerCanvas.height),e.clearRect(r+a,0,t.lowerCanvas.width-(r+a),t.lowerCanvas.height),e.clearRect(0,0,t.lowerCanvas.width,l),e.clearRect(0,i+s,t.lowerCanvas.width,t.lowerCanvas.height-(i+s)),""!==t.transform.currFlipState&&(t.img.destLeft=r,t.img.destTop=i)},e.prototype.setDestPoints=function(){var e,t=this.parent,o=t.transform,r=o.degree,i=o.zoomFactor;if(r%90==0&&r%180!=0){var a={width:0,height:0};t.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.img.srcHeight,height:t.img.srcWidth,obj:a,isImgShape:null}}),e=a,this.isRotateZoom&&(e.width+=e.width*i,e.height+=e.height*i,t.img.destWidth=e.height,t.img.destHeight=e.width),t.img.destLeft=(t.lowerCanvas.clientWidth-e.height)/2,t.img.destTop=(t.lowerCanvas.clientHeight-e.width)/2,t.img.destWidth=e.height,t.img.destHeight=e.width}else{a={width:0,height:0};t.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.img.srcWidth,height:t.img.srcHeight,obj:a,isImgShape:null}}),e=a,this.isRotateZoom&&(e.width+=e.width*i,e.height+=e.height*i,t.img.destWidth=e.width,t.img.destHeight=e.height),t.img.destLeft=(t.lowerCanvas.clientWidth-e.width)/2,t.img.destTop=0===r?(t.lowerCanvas.clientHeight-e.height+1)/2:(t.lowerCanvas.clientHeight-e.height)/2,t.img.destWidth=e.width,t.img.destHeight=e.height}},e.prototype.updateCurrTransState=function(e,t,o,r){var i=this.parent,a=i.img.destLeft,s=i.img.destTop;"initial"===e&&(this.lowerContext.setTransform(1,0,0,1,0,0),sf.base.isNullOrUndefined(t)&&this.setDestPoints()),i.isCircleCrop||i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape?(this.currTransState(e,!0,null,o),0===i.transform.degree&&""===i.transform.currFlipState&&0===i.transform.straighten&&sf.base.isNullOrUndefined(r)&&(i.img.destLeft=a,i.img.destTop=s),o&&(i.img.destLeft+=i.panPoint.totalPannedClientPoint.x,i.img.destTop+=i.panPoint.totalPannedClientPoint.y),i.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o&&(i.img.destLeft-=i.panPoint.totalPannedClientPoint.x,i.img.destTop-=i.panPoint.totalPannedClientPoint.y)):(this.currTransState(e,null,null,o),0===i.transform.degree&&""===i.transform.currFlipState&&0===i.transform.straighten&&sf.base.isNullOrUndefined(r)&&(i.img.destLeft=a,i.img.destTop=s))},e.prototype.currTransState=function(e,t,o,r){var i=this.parent;o=o||this.lowerContext,"initial"===e?this.setTransformColl(o,e):"reverse"===e&&(this.setTransformColl(o,e),this.setClientTransDim(t),(i.isCircleCrop||i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape&&sf.base.isNullOrUndefined(r))&&(r&&(i.img.destLeft+=i.panPoint.totalPannedClientPoint.x,i.img.destTop+=i.panPoint.totalPannedClientPoint.y),i.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r&&(i.img.destLeft-=i.panPoint.totalPannedClientPoint.x,i.img.destTop-=i.panPoint.totalPannedClientPoint.y)))},e.prototype.setTransformColl=function(e,t){var o=this.parent;if("initial"===t)for(var r=0,i=o.rotateFlipColl.length;r<i;r++)this.setTransform(e,o.rotateFlipColl[r]);else if("reverse"===t)for(r=o.rotateFlipColl.length-1;r>=0;r--)this.setTransform(e,o.rotateFlipColl[r],!0)},e.prototype.setTransform=function(e,t,o){var r=this.parent;switch(o&&90===t?t=-90:o&&-90===t&&(t=90),"horizontal"===t&&r.transform.degree%90==0&&r.transform.degree%180!=0?t="vertical":"vertical"===t&&r.transform.degree%90==0&&r.transform.degree%180!=0&&(t="horizontal"),r.transformModule.transform({prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),r.transformModule.transform({prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),sf.base.isNullOrUndefined(o)&&e.clearRect(0,0,e.canvas.width,e.canvas.height),t){case 90:case-90:e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*t),e.translate(-e.canvas.width/2,-e.canvas.height/2);break;case"horizontal":e.translate(e.canvas.width,0),e.scale(-1,1);break;case"vertical":e.translate(0,e.canvas.height),e.scale(1,-1)}r.transformModule.transform({prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!1}}),r.transformModule.transform({prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}})},e.prototype.drawImgToCanvas=function(e){var t=this.parent;this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.img.destWidth=e.width,t.img.destHeight=e.height,this.isInitialLoading&&(t.filterModule.filter({prop:"initFilter",onPropertyChange:!1}),this.isInitialLoading=!1);var o=this.lowerContext.filter;this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.drawImage(),(t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape||t.isCircleCrop)&&t.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.lowerContext.filter=o},e.prototype.renderImage=function(e,t,o,r){var i=this.parent;this.lowerContext.filter;i.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),sf.base.isNullOrUndefined(t)&&(this.upperContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height)),e?this.setTransformColl(this.lowerContext,"initial"):(0!==i.transform.zoomFactor&&(this.isRotateZoom=!0),this.updateCurrTransState("initial",null,null,r)),i.transformModule.transform({prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),i.transformModule.transform({prop:"setDestPointsForFlipState",onPropertyChange:!1}),e?this.setTransformColl(this.lowerContext,"reverse"):(this.updateCurrTransState("reverse",null,null,r),this.isRotateZoom=!1),o?i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}):i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.clearOuterCanvas(this.lowerContext),(i.isCircleCrop||i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape)&&i.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},e.prototype.imageOnLoad=function(e){var t=this,o=this.parent,r=this;o.baseImg.src=e,o.baseImg.onload=function(){o.imgSrc=e,o.filterModule.filter({prop:"update-finetunes",onPropertyChange:!1}),r.lowerContext.drawImage(o.baseImg,0,0,r.parent.lowerCanvas.width,r.parent.lowerCanvas.height),sf.popups.hideSpinner(o.element),o.element.style.opacity="1",r.updateBaseImgCanvas();var i={fileName:t.fileName,fileType:t.fileType,isValidImage:!0};r.updateCanvas(),o.currObjType.isUndoZoom&&(o.currObjType.isUndoZoom=!1,r.parent.lowerCanvas.style.display="block"),o.isUndoRedo=t.isErrorImage=!1,o.updateToolbar(o.element,"imageLoaded","initial"),sf.base.Browser.isDevice&&(o.element.querySelector(".e-bottom-toolbar-area").style.display="block",o.element.querySelector(".e-canvas-wrapper").style.height=o.element.offsetHeight-2*o.toolbarHeight-1+"px"),o.isImageLoaded&&"0.5"!==o.element.style.opacity&&o.events&&!0===o.events.fileOpened.hasDelegate&&o.dotNetRef.invokeMethodAsync("FileOpenEventAsync","FileOpened",i)},o.baseImg.onerror=function(){sf.popups.hideSpinner(o.element),r.isErrorImage=!0,r.errorLoading()}},e.prototype.errorLoading=function(){var e=this.parent;e.events&&!0===e.events.fileOpened.hasDelegate&&e.dotNetRef.invokeMethodAsync("FileOpenEventAsync","FileOpened",{fileName:null,fileType:null,isValidImage:!1})},e.prototype.updateBaseImgCanvas=function(){var e=this.parent;e.baseImgCanvas.width=e.baseImg.width,e.baseImgCanvas.height=e.baseImg.height,e.baseImgCanvas.getContext("2d").drawImage(e.baseImg,0,0)},e.prototype.updateCanvas=function(){var e=this.parent;e.img.srcWidth=e.baseImgCanvas.width,e.img.srcHeight=e.baseImgCanvas.height;var t={width:0,height:0};e.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:e.img.srcWidth,height:e.img.srcHeight,obj:t,isImgShape:null}});var o=t;e.img.destLeft=(e.lowerCanvas.clientWidth-o.width)/2,e.img.destTop=(e.lowerCanvas.clientHeight-o.height+1)/2,this.drawImgToCanvas(o),this.origDim.width=e.img.destWidth,this.origDim.height=e.img.destHeight,this.zoomCrop.width=e.img.destWidth,this.zoomCrop.height=e.img.destHeight,e.transformModule.transform({prop:"setCropDimension",onPropertyChange:!1,value:{width:e.img.destWidth,height:e.img.destHeight}});var r={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};e.cropModule.cropping({prop:"setCropDestPoints",onPropertyChange:!1,value:{point:r}});var i=this.lowerContext.filter;this.lowerContext.filter="none",e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=i,e.img.destWidth>0&&e.img.destHeight>0&&(e.isImageLoaded=!0),e.isUndoRedo&&""!==e.transform.currFlipState&&e.transformModule.transform({prop:"flipImage",onPropertyChange:!1,value:{direction:e.toPascalCase(e.transform.currFlipState)}}),e.disabled&&e.element.setAttribute("class","e-disabled"),(1!==e.zoomSettings.zoomFactor||e.zoomSettings.zoomPoint)&&e.zoom(e.zoomSettings.zoomFactor,e.zoomSettings.zoomPoint),sf.base.isNullOrUndefined(this.initZoomValue)&&(this.initZoomValue=e.zoomSettings.zoomFactor),this.isImageEdited=!1},e.prototype.resetFrameZoom=function(e){var t=this.parent;if(!sf.base.isNullOrUndefined(t.tempFrameZoomLevel)){var o=t.tempFrameZoomLevel;t.tempFrameZoomLevel=null,t.transformModule.transform({prop:"resetZoom",onPropertyChange:!1}),t.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:o,zoomPoint:null,isResize:!0}});var r=t.cancelCropSelection;e&&r&&(r.previousObj.frameObj=sf.base.extend({},t.frameObj,null,!0),r.currentObj.frameObj=sf.base.extend({},t.frameObj,null,!0),r.previousObj.frame=r.currentObj.frame=t.frameObj.type),this.updateCropSelObj(),t.cancelCropSelection=null}},e.prototype.performCancel=function(e,t,o){var r=this.parent;o&&(r.noPushUndo=!1);var i=r.isStraightening;e=e||!1;var a={bool:!1};if(r.allowDownScale=!0,r.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:a}}),sf.base.isNullOrUndefined(t)&&JSON.stringify(r.frameObj)!==JSON.stringify(r.tempFrameObj)&&(sf.base.extend(r.frameObj,r.tempFrameObj),this.renderImage(null,null,!0)),this.resetFrameZoom(!1),a.bool)r.freeHandDrawModule.draw({prop:"cancelFhd",onPropertyChange:!1}),r.updateToolbar(r.element,"destroyQuickAccessToolbar"),r.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}});else if("block"===r.textArea.style.display||"inline-block"===r.textArea.style.display)r.textArea.style.display="none",r.textArea.value="",r.textArea.style.transform="",this.prevActObj?(r.activeObj=this.prevActObj,this.prevActObj=null):(r.activeObj.strokeSettings=this.tempStrokeSettings,r.activeObj.textSettings=this.tempTextSettings),r.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"cancel"}}),this.isShapeTextInserted&&r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),r.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),r.updateToolbar(r.element,"imageLoaded"),r.selectionModule.selection({prop:"setTempActObj",onPropertyChange:!1,value:{obj:r.activeObj}}),r.drawingShape&&r.enableShapeDrawing(r.toPascalCase(r.drawingShape),!0);else if(!r.element.querySelector(".e-ie-contextual-slider").classList.contains("e-hidden")||r.currObjType.isFiltered){this.lowerContext.filter=this.tempAdjValue,r.canvasFilter=this.tempAdjValue,r.filterModule.filter({prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.tempAdjValue}}),r.initialAdjustmentValue=this.tempAdjValue,this.lowerContext.filter.split(" ").length>1&&"1"===this.lowerContext.filter.split(" ")[0].split("(")[1].split(")")[0]&&r.filterModule.filter({prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:!1}}),r.currentFilter=this.tempFilter,r.filterModule.filter({prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}}),this.lowerContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),this.redrawImgWithObj(),r.currObjType.isFiltered=!1;var s={tempAdjustmentLevel:null};r.filterModule.filter({prop:"getTempAdjustmentLevel",onPropertyChange:!1,value:{obj:s}}),r.filterModule.filter({prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:sf.base.extend({},s.tempAdjustmentLevel,{},!0)}}),r.undoRedoModule.undoRedo({prop:"setUndoRedoStep",onPropertyChange:!1,value:{step:this.tempUndoRedoStep}}),r.upperCanvas.style.cursor=r.cursor="default",r.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.clearOuterCanvas(this.lowerContext),(r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape||r.isCircleCrop)&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.updateToolbar(r.element,"imageLoaded"),r.activeObj.shape&&"image"===r.activeObj.shape&&r.updateToolbar(r.element,"destroyQuickAccessToolbar"),r.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"cancel"}}),r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height)}else e&&(!sf.base.Browser.isDevice||sf.base.Browser.isDevice&&!i)?r.updateToolbar(r.element,"imageLoaded"):(this.cancelItems(),r.transform.zoomFactor>0?(r.togglePan=!0,r.selectionModule.selection({prop:"setDragCanvas",value:{bool:!0}})):(r.togglePan=!1,r.selectionModule.selection({prop:"setDragCanvas",value:{bool:!1}})));this.isShapeTextInserted=!1,this.isNewPath=!1,o&&(r.noPushUndo=!1),r.drawingShape=null,r.drawModule.draw({prop:"resetTempObjColl"}),r.drawModule.draw({prop:"resetTempPointColl"})},e.prototype.cancelItems=function(){var e,t=this.parent,o=!1,r=t.element.id,i=t.element.querySelector("#"+r+"_aspectratio"),a=t.element.querySelector("#"+r+"_nonaspectratio");if(void 0!==t.activeObj.shape&&(e=t.activeObj.shape.split("-")),(void 0===e&&t.currObjType.isCustomCrop||void 0!==e&&"crop"===e[0])&&(o=!0),o&&t.isCropTab&&(t.isCropTab=!1,t.transform.zoomFactor=t.transform.defaultZoomFactor),t.isResize&&(i||a||"resize-toolbar"===t.currentToolbar)){var s={width:null,height:null};t.selectionModule.selection({prop:"getNumTextValue",onPropertyChange:!1,value:{obj:s}});var n={x:s.width,y:s.height},l=t.element.querySelector("#"+t.element.id+"_aspectratio"),h=t.element.querySelector(".e-ie-toolbar-aspect-ratio-btn");if(n&&n.x&&n.y&&!sf.base.isNullOrUndefined(t.aspectWidth))if(l||h&&!h.classList.contains("e-hidden"))t.transformModule.transform({prop:"resizeImage",value:{width:t.aspectWidth,height:t.aspectHeight}});else{var p=t.currObjType.isUndoAction;t.currObjType.isUndoAction=!1,t.transformModule.transform({prop:"resizeCrop",value:{width:t.aspectWidth,height:t.aspectHeight}}),t.currObjType.isUndoAction=p}var d={prevCropObj:t.prevCropObj},c={prevObj:t.prevObj};if(d.prevCropObj&&c.prevObj){t.objColl=[],t.pointColl=[],t.freehandCounter=0,t.cropObj=sf.base.extend({},d.prevCropObj,{},!0),this.setCurrentObj(c.prevObj),t.objColl=c.prevObj.objColl,t.pointColl=c.prevObj.pointColl,t.freehandCounter=t.pointColl.length,t.transform.straighten=0,t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}});var u=t.currSelectionPoint?sf.base.extend({},t.currSelectionPoint,{},!0):null;t.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-t.transform.zoomFactor,zoomPoint:null,isResize:!0}}),t.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:c.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),t.currSelectionPoint=u,c.prevObj.zoomFactor&&(t.zoomSettings.zoomFactor=c.prevObj.zoomFactor),t.transformModule.transform({prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:t.zoomSettings.zoomFactor}})}t.isResize=!1,t.transformModule.transform({prop:"setResizedImgAngle",onPropertyChange:!1,value:{angle:null}});var v=t.isCropTab;t.isCropTab=!1,this.updateCropSelObj(),t.cancelCropSelection=null,t.isCropTab=v}switch(!0){case t.togglePen:this.cancelPen();break;case"text"===t.activeObj.shape:this.cancelText(o);break;case-1!==["rectangle","ellipse","line","arrow","path","image"].indexOf(t.activeObj.shape):this.cancelShape();break;case o:this.cancelSelection();break;default:t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"cancel"}})}t.selectionModule.selection({prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),t.upperCanvas.style.cursor=t.cursor="default",t.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},t.updateToolbar(t.element,"imageLoaded")},e.prototype.cancelPen=function(){var e=this.parent;this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default";var t=sf.base.extend([],e.pointColl,[],!0);e.pointColl={};for(var o=0;o<this.tempFreehandCounter;o++)e.pointColl[o]=t[o];e.freehandCounter=this.tempFreehandCounter,e.freeHandDrawModule.draw({prop:"setCurrentFreehandDrawIndex",value:{value:this.tempCurrFhdIndex}}),e.activeObj.strokeSettings=this.tempStrokeSettings,e.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:e.activeObj.strokeSettings,strokeColor:null,fillColor:null,strokeWidth:null}}),e.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"cancel"}}),e.selectionModule.selection({prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),e.objColl=sf.base.extend([],this.tempObjColl,[],!0),e.pointColl=sf.base.extend([],this.tempPointColl,[],!0),e.freehandCounter=e.pointColl.length,this.tempPointColl={},this.renderImage(),e.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},e.prototype.cancelText=function(e){var t=this.parent;if(t.shapeModule.shape({prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:this.tempTextSettings,fontFamily:null,fontSize:null}}),t.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null}}),sf.base.isNullOrUndefined(t.activeObj.currIndex))t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height);else{var o={appliedUndoRedoColl:[]};t.undoRedoModule.undoRedo({prop:"getAppliedUndoRedoColl",value:{obj:o}});var r=o.appliedUndoRedoColl.length,i=o.appliedUndoRedoColl[r-1];this.prevActObj&&i&&i.currentObjColl.length&&i.currentObjColl[i.currentObjColl.length-1].currIndex===this.prevActObj.currIndex?(t.activeObj=this.prevActObj,this.prevActObj=null):(t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height)),t.activeObj.shape&&"Enter Text"===t.activeObj.keyHistory?(t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.shapeModule.shape({prop:"draw-shape-text"}),t.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"cancel"}}),t.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):t.activeObj.shape&&(t.shapeModule.shape({prop:"redraw-text"}),t.selectionModule.selection({prop:"redrawShape",onPropertyChange:!1,value:{obj:t.activeObj}}),e||void 0===t.activeObj.topLeftCircle||t.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),t.clearSelection())}t.updateToolbar(t.element,"destroyQuickAccessToolbar"),this.tempTextSettings={text:"Enter Text",fontFamily:t.defaultFontFamily,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},t.objColl=sf.base.extend([],this.tempObjColl,[],!0),t.pointColl=sf.base.extend([],this.tempPointColl,[],!0),this.renderImage(),this.tempObjColl=[],t.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},e.prototype.cancelShape=function(){var e=this.parent;if(e.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null}}),sf.base.isNullOrUndefined(e.activeObj.currIndex))e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);else if(this.isNewPath)e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.renderImage();else{var t={appliedUndoRedoColl:[]};e.undoRedoModule.undoRedo({prop:"getAppliedUndoRedoColl",value:{obj:t}});for(var o=void 0,r=0,i=t.appliedUndoRedoColl.length;r<i;r++)for(var a=t.appliedUndoRedoColl[r].currentObjColl,s=0,n=a.length;s<n;s++)if(this.prevActObj&&this.prevActObj.currIndex&&a[s].currIndex===this.prevActObj.currIndex){o=a[0];break}this.prevActObj&&o?(e.activeObj=this.prevActObj,this.prevActObj=null,e.selectionModule.selection({prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}}),e.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"cancel"}}),e.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):(e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height));var l={undoRedoStep:null};e.undoRedoModule.undoRedo({prop:"getUndoRedoStep",value:{obj:l}}),t.appliedUndoRedoColl[l.undoRedoStep-1]?e.objColl=sf.base.extend([],t.appliedUndoRedoColl[l.undoRedoStep-1].currentObjColl,[],!0):e.objColl=[],this.renderImage()}e.currObjType.isDragging=!1,e.updateToolbar(e.element,"destroyQuickAccessToolbar"),e.objColl=sf.base.extend([],this.tempObjColl,[],!0),e.pointColl=sf.base.extend([],this.tempPointColl,[],!0),this.renderImage(),this.tempObjColl=[],e.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},e.prototype.cancelSelection=function(){var e=this.parent;if(e.cancelCropSelection){var t={value:e.tempStraighten};e.transform.straighten=t.value,e.straightenBaseImageCanvas(),e.freeHandDrawModule.draw({prop:"resetStraightenPoint"}),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:!1}}),e.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:e.activeObj}}),e.cropModule.cropping({prop:"resizeWrapper"}),this.updateCropSelObj(),this.tempStraightenDestPoints&&JSON.stringify(this.tempStraightenDestPoints)!==JSON.stringify(this.straightenDestPoints)&&(this.straightenDestPoints=sf.base.extend({},this.tempStraightenDestPoints,{},!0))}},e.prototype.updateCropSelObj=function(){var e=this.parent;e.cancelCropSelection&&(e.cropObj=sf.base.extend({},e.cancelCropSelection.previousCropObj,{},!0),e.afterCropActions=e.cancelCropSelection.previousObj.afterCropActions,e.undoRedoModule.undoRedo({prop:"undoDefault",onPropertyChange:!1,value:{obj:e.cancelCropSelection}}),e.currSelectionPoint=sf.base.extend({},e.cancelCropSelection.previousCropObj.activeObj,!0),e.currSelectionPoint&&sf.base.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),this.clearOuterCanvas(this.lowerContext),(e.isCircleCrop||e.currSelectionPoint&&"crop-circle"===e.currSelectionPoint.shape)&&e.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}))},e.prototype.updateCropSelection=function(){var e=this.parent,t={currObj:{}};e.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}});var o=t.currObj;o.objColl=sf.base.extend([],e.objColl,[],!0),o.pointColl=sf.base.extend([],e.pointColl,[],!0),o.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var r={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),o.selPointColl=sf.base.extend([],r.selPointColl,[],!0),e.cancelCropSelection={operation:"cropTransform",previousObj:o,currentObj:o,previousObjColl:o.objColl,currentObjColl:o.objColl,previousPointColl:o.pointColl,currentPointColl:o.pointColl,previousSelPointColl:o.selPointColl,currentSelPointColl:o.selPointColl,previousCropObj:sf.base.extend({},e.cropObj,{},!0),currentCropObj:sf.base.extend({},e.cropObj,{},!0),previousText:null,currentText:null,filter:null,isCircleCrop:e.isCircleCrop}},e.prototype.updateFlipPan=function(e){var t=this.parent;if(""!==t.transform.currFlipState){var o=this.lowerContext.filter;t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),t.transformModule.transform({prop:"rotatedFlip",onPropertyChange:!1}),this.lowerContext.filter="none",t.freeHandDrawModule.draw({prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=o,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),e&&this.drawObject("duplicate",e)}},e.prototype.select=function(e,t,o,r,i,a){var s=this.parent;if(e=e.toLowerCase(),!s.disabled&&s.isImageLoaded){s.allowDownScale=!1;var n={currObj:{}};s.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var l=n.currObj;l.objColl=sf.base.extend([],s.objColl,[],!0),l.pointColl=sf.base.extend([],s.pointColl,[],!0),l.afterCropActions=s.afterCropActions;var h={selPointColl:null};s.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),l.selPointColl=sf.base.extend([],h.selPointColl,[],!0),s.cropModule.cropping({prop:"setPreviousCropCurrentObj",onPropertyChange:!1,value:{obj:l}}),s.transform.zoomFactor>0&&s.activeObj.shape&&"crop"===s.activeObj.shape.split("-")[0]&&sf.base.isNullOrUndefined(this.currSelPoint)&&(this.currSelPoint=sf.base.extend({},s.activeObj,{},!0));var p=!1,d=void 0;void 0!==s.activeObj.shape&&(d=s.activeObj.shape.split("-")),(void 0===d&&s.currObjType.isCustomCrop||void 0!==d&&"crop"===d[0])&&(p=!0);var c={currObj:{}};s.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:c}});var u=c.currObj;if(u.objColl=sf.base.extend([],s.objColl,[],!0),u.pointColl=sf.base.extend([],s.pointColl,[],!0),u.afterCropActions=sf.base.extend([],s.afterCropActions,[],!0),s.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),s.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),s.shapeModule.shape({prop:"setKeyHistory",onPropertyChange:!1,value:{keyHistory:""}}),this.upperContext.clearRect(0,0,s.upperCanvas.width,s.upperCanvas.height),s.upperCanvas.style.display="block",s.currSelectionPoint||0!==s.transform.defaultZoomFactor||0!==s.transform.degree&&0!==s.panPoint.totalPannedInternalPoint.x&&0!==s.panPoint.totalPannedInternalPoint.y&&!p){if(s.isCircleCrop=!1,0!==s.transform.defaultZoomFactor&&!this.isResizeSelect){var v=s.isCropTab;s.isCropTab=!1,s.transformModule.transform({prop:"resetZoom",onPropertyChange:!1}),s.isCropTab=v,this.resetPanPoints()}s.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1}),s.isCropTab=!0,s.isCircleCrop=!1,this.isResizeSelect||s.cropModule.cropping({prop:"setCurrSelPoints",onPropertyChange:!1,value:{isSetDimension:!0}}),s.transform.zoomFactor=s.transform.cropZoomFactor,sf.base.isNullOrUndefined(s.cropObj.activeObj.shape)&&(s.currObjType.shape="crop-"+e,this.drawNewSelection(e,t,o,r,i,a))}else this.isCropSelect?this.isCropSelect=!1:(s.cropModule.cropping({prop:"adjustStraightenForShapes",onPropertyChange:!1,value:{type:"reverse",isInitialRotated:!0}}),s.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1}),this.renderImage()),"custom"===e&&(s.currObjType.shape=""),this.drawNewSelection(e,t,o,r,i,a)}},e.prototype.drawNewSelection=function(e,t,o,r,i,a){var s,n=this.parent,l="crop-"+e.toLowerCase();"crop-custom"===l?""!==n.currObjType.shape&&"crop-custom"!==n.currObjType.shape||(this.drawCustomSelection("crop-custom",t,o,r,i),this.adjToStraighten(),this.updateSelectionInsert(null,a),n.isStraightening&&(this.straightenActObj=sf.base.extend({},n.activeObj,{},!0),this.straightenInitZoom=n.transform.zoomFactor)):"crop-canvas"===l?(n.upperCanvas.style.display="block",n.selectionModule.selection({prop:"setDragCanvas",value:{bool:!0}})):(n.currObjType.isCustomCrop=!1,n.currObjType.shape=l,r&&i?s={startX:t,startY:o,endX:t+r,endY:o+i,width:r,height:i}:r&&"crop-circle"===l&&(s={startX:t,startY:o,endX:t+r,endY:o+r,width:r,height:r}),n.activeObj.shape=l,this.updateSelectionInsert(s,a))},e.prototype.updateSelectionInsert=function(e,t){var o=this;void 0===t&&(t=!1);var r=this.parent,i=r.activeObj.activePoint,a={shapeSettingsObj:{}};r.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var s={type:r.getSelectionType(a.shapeSettingsObj.type),startX:a.shapeSettingsObj.startX,startY:a.shapeSettingsObj.startY,width:a.shapeSettingsObj.width,height:a.shapeSettingsObj.height},n={action:"insert",previousSelectionSettings:s,currentSelectionSettings:s};r.events&&!0===r.events.onSelectionResizeStart.hasDelegate&&!t?r.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeStart",n).then((function(t){r.shapeModule.shape({prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:t.currentSelectionSettings}}),"Custom"===t.currentSelectionSettings.type?o.drawObject("duplicate",r.activeObj,null,null,!0):(0===i.startX&&0===i.startY&&0===i.width&&0===i.height||(e={startX:i.startX,startY:i.startY,endX:i.endX,endY:i.endY,width:i.width,height:i.height}),o.drawObject("duplicate",null,!0,e))})):(r.shapeModule.shape({prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:n.currentSelectionSettings}}),"Custom"===n.currentSelectionSettings.type?this.drawObject("duplicate",r.activeObj,null,null,!0):(0===i.startX&&0===i.startY&&0===i.width&&0===i.height||(e={startX:i.startX,startY:i.startY,endX:i.endX,endY:i.endY,width:i.width,height:i.height}),this.drawObject("duplicate",null,!0,e)))},e.prototype.drawCustomSelection=function(e,t,o,r,i){var a=this.parent,s=a.activeObj.activePoint;if(a.currObjType.isCustomCrop=!0,this.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),a.currObjType.shape=a.activeObj.shape=e.toLowerCase(),sf.base.isNullOrUndefined(t)||sf.base.isNullOrUndefined(o)||sf.base.isNullOrUndefined(r)||sf.base.isNullOrUndefined(i))if(r&&i){var n=a.img,l=n.destLeft,h=n.destTop,p=n.destWidth,d=n.destHeight;s.width=r,s.height=i,s.startX=l+(p/2-r/2),s.startY=h+(d/2-i/2)}else{if(sf.base.isNullOrUndefined(a.transform.zoomFactor)||0===a.transform.zoomFactor){var c=a.img,u=c.destLeft,v=c.destTop,g=c.destWidth,b=c.destHeight,C=a.lowerCanvas.width,f=a.lowerCanvas.height,m=s;u>=0&&v>=0?(m.startX=u,m.startY=v,m.endX=u+g,m.endY=v+b):u>=0?(m.startX=u,m.startY=7.5,m.endX=u+g,m.endY=f-15):v>=0?(m.startX=7.5,m.startY=v,m.endX=C-15,m.endY=v+b):(m.startX=7.5,m.startY=7.5,m.endX=C-15,m.endY=f-15)}else{var y=a.img,w=y.destLeft,P=y.destTop,j=y.destWidth,x=y.destHeight,O=a.lowerCanvas.width,S=a.lowerCanvas.height,M=s;M.startX=Math.max(w>0?w:7.5,w),M.startY=Math.max(P>0?P:7.5,P),M.endX=Math.min(w+j+15<O?w+j-15:O-15,w+j),M.endY=Math.min(P+x+15<S?P+x-15:S-15,P+x)}var T=a.img,A=(l=T.destLeft,h=T.destTop,p=T.destWidth,d=T.destHeight,a.lowerCanvas.clientWidth),F=a.lowerCanvas.clientHeight,k=s;if(k.startX=Math.max(k.startX,l),k.startY=Math.max(k.startY,h),k.endX=Math.min(k.endX,l+p),k.endY=Math.min(k.endY,h+d),a.transform.straighten>0?(this.imgCanvasPoints[0].x>k.startX&&(k.startX=this.imgCanvasPoints[0].x),this.imgCanvasPoints[0].y>k.startY&&(k.startY=this.imgCanvasPoints[0].y),this.imgCanvasPoints[2].x<k.endX&&(k.endX=this.imgCanvasPoints[2].x),this.imgCanvasPoints[2].y<k.endY&&(k.endY=this.imgCanvasPoints[2].x)):a.transform.straighten<0&&(this.imgCanvasPoints[3].x>k.startX&&(k.startX=this.imgCanvasPoints[3].x),this.imgCanvasPoints[3].y<k.startY&&(k.startY=this.imgCanvasPoints[3].y),this.imgCanvasPoints[1].x<k.endX&&(k.endX=this.imgCanvasPoints[1].x),this.imgCanvasPoints[1].y>k.endY&&(k.endY=this.imgCanvasPoints[1].x)),k.startX===l&&l+p>A&&(k.endX=A-15),k.startY===h&&h+d>F&&(k.endY=F-15),a.activeObj.activePoint.startX>a.activeObj.activePoint.endX){var R=a.activeObj.activePoint.startX;a.activeObj.activePoint.startX=a.activeObj.activePoint.endX,a.activeObj.activePoint.endX=R}if(a.activeObj.activePoint.startY>a.activeObj.activePoint.endY){R=a.activeObj.activePoint.startY;a.activeObj.activePoint.startY=a.activeObj.activePoint.endY,a.activeObj.activePoint.endY=R}a.activeObj=this.updateWidthHeight(a.activeObj),this.updateActiveObject(s,a.activeObj),this.adjActObj()}else s.startX=t,s.startY=o,s.endX=t+r,s.endY=o+i,s.width=r,s.height=i;this.updateSelectionInsert(null,!0)},e.prototype.adjToStraighten=function(){var e=this.parent;if(0!==e.transform.straighten&&e.isStraightening){var t=e.activeObj.activePoint;t.startX+=7.5,t.startY+=7.5,t.endX-=7.5,t.endY-=7.5,e.activeObj=this.updateWidthHeight(e.activeObj)}},e.prototype.adjActObj=function(){var e=this.parent;if(0!==e.transform.straighten)for(var t=e.activeObj.activePoint,o=sf.base.extend({},t,{},!0),r=0;;){r++;var i={isIntersect:null,arr:null};if(e.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:i}}),i.arr[0]||i.arr[1]||i.arr[2]||i.arr[3]||100===r){t=sf.base.extend({},o,{},!0);break}o=sf.base.extend({},t,{},!0),t.startX-=5,t.endX+=5,t.width=t.endX-t.startX,this.updateActiveObject(t,e.activeObj)}},e.prototype.callUpdateCurrTransState=function(){var e=this.parent,t=sf.base.extend([],e.objColl,[],!0),o=sf.base.extend({},e.activeObj,{},!0);e.objColl=[],e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.isRotateZoom=!0,this.updateCurrTransState("initial"),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),0===e.transform.degree&&e.rotateFlipColl.length>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y;var r=this.lowerContext.filter;0===e.transform.degree&&e.transformModule.transform({prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),this.updateCurrTransState("reverse"),0===e.transform.degree&&e.rotateFlipColl.length>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),this.isRotateZoom=!1,e.objColl=t;var i=e.togglePen;e.togglePen=!1,this.lowerContext.filter="none",e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y,e.img.destLeft-=e.panPoint.totalPannedInternalPoint.x,e.img.destTop-=e.panPoint.totalPannedInternalPoint.y,e.togglePen=i,this.lowerContext.filter=r,e.activeObj=o},e.prototype.resetPanPoints=function(){this.parent.panPoint.totalPannedPoint={x:0,y:0},this.parent.panPoint.totalPannedClientPoint={x:0,y:0},this.parent.panPoint.totalPannedInternalPoint={x:0,y:0}},e.prototype.setClientTransDim=function(e){var t=this.parent;if(t.transform.degree%90==0&&t.transform.degree%180!=0){t.img.destLeft=(t.lowerCanvas.clientWidth-t.img.destHeight)/2,t.img.destTop=(t.lowerCanvas.clientHeight-t.img.destWidth+1)/2;var o=t.img.destWidth;t.img.destWidth=t.img.destHeight,t.img.destHeight=o}else sf.base.isNullOrUndefined(e)&&(t.img.destLeft=(t.lowerCanvas.clientWidth-t.img.destWidth)/2,t.img.destTop=(t.lowerCanvas.clientHeight-t.img.destHeight+1)/2)},e.prototype.redrawImgWithObj=function(){var e=this.parent,t={canvasFilter:e.canvasFilter};if(this.lowerContext.filter=t.canvasFilter,0!==e.rotateFlipColl.length){var o=sf.base.extend({},e.panPoint.totalPannedInternalPoint,{},!0),r={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};this.callUpdateCurrTransState(),e.panPoint.totalPannedInternalPoint=o,e.img.destLeft=r.startX,e.img.destTop=r.startY,e.img.destWidth=r.width,e.img.destHeight=r.height}else this.callUpdateCurrTransState();e.isCircleCrop&&e.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},e.prototype.setCurrentObj=function(e,t){var o=this.parent,r=!!e;r||(o.cropObj.aspectWidth=o.aspectWidth,o.cropObj.aspectHeight=o.aspectHeight,o.cropObj.frame=o.frameObj.type),e=e||o.cropObj,o.transform.cropZoomFactor=e.cropZoom,o.transform.defaultZoomFactor=e.defaultZoom,this.straightenInitZoom=e.straightenZoom,r?e.activeObj.shape&&"crop"===e.activeObj.shape.split("-")[0]?o.transform.zoomFactor=e.cropZoom:o.transform.zoomFactor=e.defaultZoom:o.transform.zoomFactor=e.cropZoom,o.zoomSettings.zoomFactor=e.zoomFactor,o.transformModule.transform({prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.previousZoomValue}}),o.panPoint.totalPannedPoint=sf.base.extend({},e.totalPannedPoint,{},!0),o.panPoint.totalPannedClientPoint=sf.base.extend({},e.totalPannedClientPoint,{},!0),o.panPoint.totalPannedInternalPoint=sf.base.extend({},e.totalPannedInternalPoint,{},!0);var i=sf.base.extend({},e.tempFlipPanPoint,{},!0);o.cropModule.cropping({prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:i}}),o.rotateFlipColl=sf.base.extend([],e.rotateFlipColl,[],!0),o.transform.degree=e.degree,o.frameObj.type=e.frame,o.transform.currFlipState=e.currFlipState,o.filterModule.filter({prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:e.adjustmentLevel}}),o.filterModule.filter({prop:"setTempAdjVal"}),o.currentFilter=e.currentFilter,o.filterModule.filter({prop:"setTempFilVal"}),(o.transform.straighten!==e.straighten||t)&&(o.transform.straighten=e.straighten,o.straightenBaseImageCanvas()),o.img={destLeft:e.destPoints.startX,destTop:e.destPoints.startY,destWidth:e.destPoints.width,destHeight:e.destPoints.height,srcLeft:e.srcPoints.startX,srcTop:e.srcPoints.startY,srcWidth:e.srcPoints.width,srcHeight:e.srcPoints.height},o.aspectWidth=e.aspectWidth,o.aspectHeight=e.aspectHeight,e.afterCropActions&&(o.afterCropActions=e.afterCropActions),this.lowerContext.filter=e.filter,o.filterModule.filter({prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:e.isBrightAdjust}});var a,s=o.isCircleCrop;sf.base.isNullOrUndefined(o.currSelectionPoint)?a=null:(a=sf.base.extend({},o.currSelectionPoint,{},!0),o.currSelectionPoint=null),o.isCircleCrop=!1,this.drawCropSelectionImage(e,!1),0!==o.transform.degree&&(""===o.transform.currFlipState?o.transformModule.transform({prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}):o.transformModule.transform({prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),o.img.destLeft=e.destPoints.startX,o.img.destTop=e.destPoints.startY,o.panPoint.totalPannedClientPoint=sf.base.extend({},e.totalPannedClientPoint,{},!0),o.panPoint.totalPannedInternalPoint=sf.base.extend({},e.totalPannedInternalPoint,{},!0)),o.activeObj=sf.base.extend({},e.activeObj,{},!0),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),0!==o.activeObj.activePoint.width&&0!==o.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0);var n=sf.base.extend({},e.activeObj,{},!0),l=!1;if(o.afterCropActions.length>0){var h={collection:o.afterCropActions};o.shapeModule.shape({prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:o.afterCropActions,isRotateFlipCollection:null,obj:h}}),o.afterCropActions=h.collection}var p=sf.base.extend([],o.afterCropActions,[],!0);if(!r&&p.length>0){l=!0;for(var d=0,c=p.length;d<c;d++)"horizontalflip"!==p[d]&&"verticalflip"!==p[d]||(o.activeObj=sf.base.extend({},a,{},!0),this.rotatedFlipCropSel=!0),o.transformModule.transform({prop:"updateTransform",onPropertyChange:!1,value:{text:p[d]}});n=sf.base.extend({},o.activeObj,{},!0),this.resetPanPoints(),o.activeObj=n,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),0!==o.activeObj.activePoint.width&&0!==o.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0),e.degree!==o.transform.degree&&(o.transform.cropZoomFactor=null,o.transform.zoomFactor=0),o.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1}),this.rotatedFlipCropSel&&(this.rotatedFlipCropSel=!1)}o.afterCropActions=p,this.isCancelAction||l||(o.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1}),o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),o.img.destLeft=e.destPoints.startX,o.img.destTop=e.destPoints.startY),o.activeObj=n,o.isCircleCrop=s,sf.base.isNullOrUndefined(a)?o.currSelectionPoint=null:(o.currSelectionPoint=sf.base.extend({},a,{},!0),o.currSelectionPoint&&sf.base.isNullOrUndefined(o.currSelectionPoint.shape)&&(o.currSelectionPoint=null))},e.prototype.drawCropSelectionImage=function(e,t){var o=this.parent,r=this.lowerContext.filter;o.clearContext(this.lowerContext),o.clearContext(this.upperContext),this.lowerContext.setTransform(1,0,0,1,0,0),t?this.updateCurrTransState("initial"):this.setTransformColl(this.lowerContext,"initial"),o.transformModule.transform({prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),t?this.updateCurrTransState("reverse"):this.setTransformColl(this.lowerContext,"reverse"),o.img.destLeft=o.cropObj.destPoints.startX,o.img.destTop=o.cropObj.destPoints.startY;var i=sf.base.extend({},e.activeObj,{},!0);if(this.lowerContext.filter="none",o.img={destLeft:e.destPoints.startX,destTop:e.destPoints.startY,destWidth:e.destPoints.width,destHeight:e.destPoints.height,srcLeft:e.srcPoints.startX,srcTop:e.srcPoints.startY,srcWidth:e.srcPoints.width,srcHeight:e.srcPoints.height},0!==e.activeObj.activePoint.width&&0!==e.activeObj.activePoint.height){var a={startX:o.img.destLeft,startY:o.img.destTop,width:o.img.destWidth,height:o.img.destHeight};o.img.destLeft=e.activeObj.activePoint.startX,o.img.destTop=e.activeObj.activePoint.startY,o.img.destWidth=e.activeObj.activePoint.width,o.img.destHeight=e.activeObj.activePoint.height,o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),o.img.destLeft=a.startX,o.img.destTop=a.startY,o.img.destWidth=a.width,o.img.destHeight=a.height}o.activeObj=i,this.lowerContext.filter=r},e.prototype.performPointZoom=function(e,t,o,r,i){var a=this.parent,s=a.img,n=s.destLeft,l=s.destTop,h=(e-n)/s.destWidth,p=(t-l)/s.destHeight,d=a.isUndoRedo;a.isUndoRedo=!0,a.zoomSettings.zoomPoint={x:e,y:t};var c=i||("zoomIn"===o?.1:-.1);a.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:c,zoomPoint:null,isResize:r}}),a.isUndoRedo=d,this.panToPoint(e,t,h,p)},e.prototype.panToPoint=function(e,t,o,r){var i=this.parent;if(i.transform.zoomFactor>0){var a=i.img.destLeft,s=i.img.destTop,n=sf.base.extend({},i.activeObj,{},!0);if(0===i.transform.degree)i.img.destLeft=e-o*i.img.destWidth,i.img.destTop=t-r*i.img.destHeight,this.drawZoomPanImage(i.img.destLeft-a,i.img.destTop-s);else{var l=i.isCropTab;i.isCropTab=!0;var h=sf.base.extend([],i.objColl,[],!0),p=sf.base.extend([],i.pointColl,[],!0),d={straightenPoint:null};i.freeHandDrawModule.draw({prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:d}}),i.objColl=[],i.pointColl=[],i.freehandCounter=0,i.freeHandDrawModule.draw({prop:"setStraightenPoint",onPropertyChange:!1,value:{x:null,y:null,ratioX:null,ratioY:null}});var c={selPointColl:null};i.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:c}});var u=c.selPointColl;i.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),i.panPoint.currentPannedPoint={x:e-o*i.img.destWidth-a,y:t-r*i.img.destHeight-s},i.transformModule.transform({prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),i.isCropTab=l,i.objColl=h,i.pointColl=p,i.freehandCounter=i.pointColl.length,d.straightenPoint.x&&d.straightenPoint.y&&i.freeHandDrawModule.draw({prop:"setStraightenPoint",onPropertyChange:!1,value:{x:d.straightenPoint.x,y:d.straightenPoint.y,ratioX:d.straightenPoint.ratioX,ratioY:d.straightenPoint.ratioY}}),i.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:u}}}),i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:i.panPoint.currentPannedPoint.x,y:i.panPoint.currentPannedPoint.y,panRegion:""}})}this.adjustPanning(n),i.activeObj=n,0!==i.activeObj.activePoint.width&&0!==i.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0)}},e.prototype.adjustPanning=function(e){var t=this.parent,o=e.activePoint,r=o.startX,i=o.startY,a=o.width,s=o.height;if(0!==a&&0!==s){var n=t.img,l=n.destLeft,h=n.destTop,p=n.destWidth,d=n.destHeight,c={x:0,y:0};if(l>r?c.x=l-r:l+p<r+a&&(c.x=l+p-(r+a)),h>i?c.y=h-i:h+d<i+s&&(c.y=h+d-(i+s)),0===t.transform.degree)t.img.destLeft-=c.x,t.img.destTop-=c.y,this.drawZoomPanImage(t.img.destLeft-l,t.img.destTop-h);else{var u=t.isCropTab;t.isCropTab=!0;var v=sf.base.extend([],t.objColl,[],!0),g=sf.base.extend([],t.pointColl,[],!0);t.objColl=[],t.pointColl=[],t.freehandCounter=0;var b={selPointColl:null};t.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:b}});var C=b.selPointColl;t.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),t.img.destLeft-=c.x,t.img.destTop-=c.y,t.panPoint.currentPannedPoint={x:t.img.destLeft-l,y:t.img.destTop-h},t.transformModule.transform({prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),t.isCropTab=u,t.objColl=v,t.pointColl=g,t.freehandCounter=t.pointColl.length,t.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:C}}}),t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:t.panPoint.currentPannedPoint.x,y:t.panPoint.currentPannedPoint.y,panRegion:""}})}}},e.prototype.panToSel=function(){var e=this.parent,t=sf.base.extend({},e.activeObj,{},!0),o=(e.img,t.activePoint),r=o.startX,i=o.startY,a=o.width,s=o.height,n={straightenPoint:null};if(e.freeHandDrawModule.draw({prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:n}}),n.straightenPoint.x&&n.straightenPoint.y){var l=r+a/2-n.straightenPoint.x,h=i+s/2-n.straightenPoint.y;0===e.transform.degree?(e.img.destLeft+=l,e.img.destTop+=h,e.transformModule.transform({prop:"drawPannImage",value:{point:{x:l,y:h}}})):(e.panPoint.currentPannedPoint={x:l,y:h},e.transformModule.transform({prop:"drawPannedImage",value:{xDiff:l,yDiff:h}}),e.panPoint.currentPannedPoint={x:0,y:0},e.transformModule.transform({prop:"setTempPanMove",value:{point:null}})),e.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t}});var p=e.img,d=p.destLeft,c=p.destTop,u=p.destWidth,v=p.destHeight,g=this.imgCanvasPoints;g.forEach((function(e){e.x=e.ratioX*u+d,e.y=e.ratioY*v+c})),this.imgCanvasPoints=g;var b=0;if(5===e.transform.straighten&&!this.preventStraightening){this.preventStraightening=!0;var C=e.prevStraightenedDegree;e.prevStraightenedDegree=e.transform.straighten,e.setStraighten(0),e.setStraighten(5),e.prevStraightenedDegree=C,this.preventStraightening=!1}for(;this.isLinesIntersect()&&0!==e.transform.straighten&&360!==e.transform.straighten&&b<100;)b++,this.performPointZoom(e.activeObj.activePoint.startX+e.activeObj.activePoint.width/2,e.activeObj.activePoint.startY+e.activeObj.activePoint.height/2,"zoomIn",!1,.025),this.updateImgCanvasPoints()}},e.prototype.drawZoomPanImage=function(e,t){var o=this.parent;o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:e,y:t,panRegion:""}}),this.renderImage(!0);var r={width:0,height:0};o.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o.img.srcWidth,height:o.img.srcHeight,obj:r,isImgShape:null}});var i=r;i.width+=i.width*o.transform.zoomFactor,i.height+=i.height*o.transform.zoomFactor,o.panPoint.totalPannedPoint.x+=e,o.panPoint.totalPannedPoint.y+=t,o.cropModule.cropping({prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:{x:0,y:0}}})},e.prototype.openNewImage=function(){var e=this.parent,t=e.element.id,r=e.inMemoryCanvas.getContext("2d");sf.popups.showSpinner(e.element),e.element.style.opacity="0.5";var i=document.querySelector("#"+t+"_currPos");if(i&&(i.style.display="none"),e.element.querySelector("#"+t+"_toolbarArea")&&(e.toolbarHeight=e.element.querySelector("#"+t+"_toolbarArea").clientHeight),e.reset(),e.update(),e.transform.degree=0,e.transform.zoomFactor=0,e.isImageLoaded=!1,e.currSelectionPoint=null,"string"===o(this.openURL)){var a=this.openURL.split(".");if(a.length>1?(a=a[a.length-2].split("/"),this.fileName=a[a.length-1]):this.fileName="SfImageEditor",this.fileType=this.getFileExtensionFromURL(this.openURL),this.fileType){this.fileType=e.toPascalCase(this.fileType);var s=this.fileType.toLowerCase();"jpg"!==s&&"jpeg"!==s||(this.fileType="Jpeg",s="jpeg"),"jpeg"!==s&&"png"!==s&&"svg"!==s&&(this.fileType="Png")}this.imageOnLoad(this.openURL)}else this.fileName="SfImageEditor",this.fileType="Png",e.lowerCanvas=document.querySelector("#"+t+"_lowerCanvas"),e.upperCanvas=document.querySelector("#"+t+"_upperCanvas"),this.lowerContext=e.lowerCanvas.getContext("2d"),this.upperContext=e.upperCanvas.getContext("2d"),e.clearContext(this.lowerContext),e.clearContext(this.upperContext),e.clearContext(r),e.inMemoryCanvas.width=this.openURL.width,e.inMemoryCanvas.height=this.openURL.height,r.putImageData(this.openURL,0,0),e.baseImg.src=e.inMemoryCanvas.toDataURL()},e.prototype.dlgBtnClick=function(){this.parent.export(),this.applyDialogOption()},e.prototype.dlgCloseBtnClick=function(){this.applyDialogOption()},e.prototype.applyDialogOption=function(){var e=this.parent;this.isFileChanged?(e.isImageLoaded=this.isFileChanged=!1,e.reset(),this.checkToolbarTemplate(this.inputElem,this.openURL)):(this.reset(),this.openNewImage()),this.isImageEdited=!1},e.prototype.restoreOldImage=function(){this.parent.isImageLoaded?(this.reset(),this.openNewImage()):this.openNewImage()},e.prototype.open=function(e){document.getElementById(this.parent.element.id+"_dropArea")&&(document.getElementById(this.parent.element.id+"_dropArea").style.display="none"),this.parent.disabled||(this.openURL=e,this.restoreOldImage())},e.prototype.getInitialLoaded=function(e){e.isInitialLoaded=this.isInitialLoading},e.prototype.getFileExtensionFromURL=function(e){var t=e.lastIndexOf(".");return-1!==t?e.slice(t+1).toLowerCase():-1!==e.indexOf("base64")?e.slice(e.indexOf("/")+1,e.indexOf(";")).toLowerCase():null},e.prototype.fileSelect=function(e,t){var o=this.parent;if(document.getElementById(o.element.id+"_dropArea")&&(document.getElementById(o.element.id+"_dropArea").style.display="none"),!o.disabled){var r=void 0,i=void 0;t.target?i=r=t.target.files[0]:r=i=t.filesData[0].rawFile;var a=void 0;if(i.name){var s=i.name.split(".");a=s[s.length-1].toLowerCase()}if(a&&-1===["jpg","jpeg","png","svg"].indexOf(a))return void this.errorLoading();if(sf.popups.showSpinner(o.element),o.element.style.opacity="0.5",this.inputElem=e,a=i.name&&i.name.split(".")[1]){var n=o.toPascalCase(a);this.fileType="JPG"===n||"Jpg"===n?"Jpeg":n}else this.fileType=null;var l=window.URL.createObjectURL(r);this.openURL=l,o.isImageLoaded&&!o.isChangesSaved&&(this.isImageEdited||o.pointColl.length>0||o.objColl.length>0)?(this.isFileChanged=!0,o.dotNetRef.invokeMethodAsync("UpdateDialog",!0)):this.checkToolbarTemplate(e,l)}},e.prototype.checkToolbarTemplate=function(e,t){var o=this.parent;sf.base.isNullOrUndefined(o.toolbarTemplate)&&(o.reset(),o.update()),this.fileName=e.value.split("\\")[e.value.split("\\").length-1],this.fileName=this.fileName.split(".")[0],this.imageOnLoad(t.toString()),e.value=""},e.prototype.moveToSelectionRange=function(e,t){var o=this.parent;if(o.activeObj.shape){for(var r=!1,i=0,a=o.rotateFlipColl.length;i<a;i++){var s=o.rotateFlipColl[i];if(90===s||-90===s){r=!0;break}}if(r){if(0===o.transform.degree)return;var n=o.transform.zoomFactor;o.objColl.push(o.activeObj),o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1});var l=o.objColl[o.objColl.length-1];if("rotateleft"===e||"rotateright"===e)if(o.transform.degree%90==0&&o.transform.degree%180!=0)if(l.activePoint.width<t.activePoint.height)for(i=2;i<o.zoomSettings.maxZoomFactor;i++){if(l.activePoint.width>=t.activePoint.height||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){sf.base.isNullOrUndefined(n)||o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}});break}n+=.1,o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:n,zoomPoint:null,isResize:null}})}else for(i=2;i<o.zoomSettings.maxZoomFactor;i++){if(l.activePoint.width>=t.activePoint.height||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){sf.base.isNullOrUndefined(n)||o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}});break}n-=.1,o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:n,zoomPoint:null,isResize:null}})}else if(l.activePoint.height<t.activePoint.width)for(i=2;i<o.zoomSettings.maxZoomFactor;i++){if(l.activePoint.height>=t.activePoint.width||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){sf.base.isNullOrUndefined(n)||o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}});break}n+=.1,o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:n,zoomPoint:null,isResize:null}})}else for(i=2;i<o.zoomSettings.maxZoomFactor;i++){if(l.activePoint.height>=t.activePoint.width||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){sf.base.isNullOrUndefined(n)||o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}});break}n-=.1,o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:n,zoomPoint:null,isResize:null}})}var h=o.lowerCanvas.clientWidth/2-(l.activePoint.startX+l.activePoint.width/2),p=(o.lowerCanvas.clientHeight+1)/2-(l.activePoint.startY+l.activePoint.height/2);sf.base.isNullOrUndefined(o.activeObj.shape)&&(o.activeObj=sf.base.extend({},t,{},!0)),0===o.transform.degree?(o.img.destLeft+=h,o.img.destTop+=p,o.transformModule.transform({prop:"drawPannImage",value:{point:{x:h,y:p}}})):(o.panPoint.currentPannedPoint={x:h,y:p},o.transformModule.transform({prop:"drawPannedImage",value:{xDiff:h,yDiff:p}}),o.panPoint.currentPannedPoint={x:0,y:0}),o.transformModule.transform({prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),o.activeObj=sf.base.extend({},o.objColl[o.objColl.length-1]),o.objColl.pop(),o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}})}}},e.prototype.isSelectionBiggerThanCanvas=function(e){var t=!1,o=this.parent,r=e.activePoint,i=r.startX,a=r.startY,s=r.endX,n=r.endY,l=o.img,h=l.destLeft,p=l.destTop,d=l.destWidth,c=l.destHeight;return(i<=h||a<=p||s>=h+d||n>=p+c)&&(t=!0),t},e.prototype.isSelectionOutsideCanvas=function(e){var t=!1,o=this.parent;return(e.activePoint.height<o.lowerCanvas.height-o.toolbarHeight||e.activePoint.width<o.lowerCanvas.width)&&(t=!0),t},e.prototype.downScaleImgCanvas=function(e,t,o,r){var i=this.parent,a=t?i.activeObj.imageCanvas:i.baseImgCanvas,s=t?i.activeObj.imageElement:i.baseImg,n=t?i.activeObj.activePoint.width:i.img.destWidth,l=t?i.activeObj.activePoint.height:i.img.destHeight,h={width:0,height:0};if(i.transform.degree%90==0&&i.transform.degree%180!=0?i.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:s.height,height:s.width,obj:h,isImgShape:t}}):i.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:s.width,height:s.height,obj:h,isImgShape:t}}),t||i.allowDownScale&&!i.isCropTab&&!i.isCropToolbar&&0!==s.width&&0!==s.height&&.75*h.width>n&&.75*h.height>l){var p=sf.base.createElement("canvas",{id:i.element.id+"_downScaleCanvas",attrs:{name:"canvasImage"}});p.width=t?s.width:i.img.srcWidth,p.height=t?s.height:i.img.srcHeight,t?p.getContext("2d").drawImage(s,0,0,p.width,p.height):p.getContext("2d").drawImage(a,i.img.srcLeft,i.img.srcTop,i.img.srcWidth,i.img.srcHeight,0,0,p.width,p.height),(t||this.isDownScale)&&this.downScale(p,n,l,t),t?(e.canvas.width=p.width,e.canvas.height=p.height,o&&r?(e.translate(i.activeObj.imageCanvas.width,0),e.scale(-1,1),e.translate(0,i.activeObj.imageCanvas.height),e.scale(1,-1)):o?(sf.base.isNullOrUndefined(i.activeObj.isHorImageFlip)||!i.activeObj.isHorImageFlip?(i.activeObj.isHorImageFlip=!0,e.translate(i.activeObj.imageCanvas.width,0),e.scale(-1,1)):i.activeObj.isHorImageFlip&&(i.activeObj.isHorImageFlip=!1),i.activeObj.isVerImageFlip&&(e.translate(0,i.activeObj.imageCanvas.height),e.scale(1,-1))):r&&(sf.base.isNullOrUndefined(i.activeObj.isVerImageFlip)||!i.activeObj.isVerImageFlip?(i.activeObj.isVerImageFlip=!0,e.translate(0,i.activeObj.imageCanvas.height),e.scale(1,-1)):i.activeObj.isVerImageFlip&&(i.activeObj.isVerImageFlip=!1),i.activeObj.isHorImageFlip&&(e.translate(i.activeObj.imageCanvas.width,0),e.scale(-1,1))),e.drawImage(p,0,0),e.setTransform(1,0,0,1,0,0)):i.isFinetuning?(e.save(),e.setTransform(1,0,0,1,0,0),e.drawImage(i.inMemoryCanvas,0,0),e.restore()):e.drawImage(p,0,0,p.width,p.height,i.img.destLeft,i.img.destTop,p.width,p.height)}else!sf.base.isNullOrUndefined(t)&&t||0===i.baseImgCanvas.width||0===i.baseImgCanvas.height||e.drawImage(i.baseImgCanvas,i.img.srcLeft,i.img.srcTop,i.img.srcWidth,i.img.srcHeight,i.img.destLeft,i.img.destTop,i.img.destWidth,i.img.destHeight)},e.prototype.downScale=function(e,t,o,r){var i=this.parent;if(!r||!i.isStraightening){for(var a=e.width,s=e.height,n=a/(t=Math.round(t)),l=s/(o=Math.round(o)),h=Math.ceil(n/2),p=Math.ceil(l/2),d=e.getContext("2d"),c=d.getImageData(0,0,a,s),u=d.createImageData(t,o),v=c.data,g=u.data,b=0;b<o;b++)for(var C=0;C<t;C++){for(var f=4*(C+b*t),m=0,y=0,w=0,P=0,j=0,x=0,O=0,S=(b+.5)*l,M=Math.floor(b*l),T=Math.ceil((b+1)*l),A=M;A<T;A++)for(var F=Math.abs(S-(A+.5))/p,k=(C+.5)*n,R=F*F,I=Math.floor(C*n),z=Math.ceil((C+1)*n),D=I;D<z;D++){var X=Math.abs(k-(D+.5))/h,Y=Math.sqrt(R+X*X);if(!(Y>=1)){var L=4*(D+A*a);O+=(m=2*Y*Y*Y-3*Y*Y+1)*v[L+3],w+=m,P+=(m=m*v[L+3]/250)*v[L],j+=m*v[L+1],x+=m*v[L+2],y+=m}}g[f]=P/y,g[f+1]=j/y,g[f+2]=x/y,g[f+3]=O/w}e.width=r?i.activeObj.activePoint.width:i.lowerCanvas.width,e.height=r?i.activeObj.activePoint.height:i.lowerCanvas.height,d.putImageData(u,0,0)}},e.prototype.drawImgToCtx=function(e,t){var o=this.parent;e.canvas.id!==o.element.id+"_tempCanvas"&&e!==this.upperContext&&sf.base.isNullOrUndefined(t)&&this.downScaleImgCanvas(e,null,null,null)},e.prototype.getFrameColor=function(e,t,o){var r=this.parent.frameObj.color;if(e.gradientColor){var i=t.createLinearGradient(o.startX,o.startY,o.startX+o.width,o.startY+o.height);i.addColorStop(0,e.color),i.addColorStop(1,e.gradientColor),r=i}else r=e.color;return r},e.prototype.applyFrame=function(e,t,o){var r,i=this.parent;i.frameObj.type=t;var a={width:1,height:1},s={startX:i.img.destLeft-e.lineWidth,startY:i.img.destTop-e.lineWidth,width:i.img.destWidth+2*e.lineWidth,height:i.img.destHeight+2*e.lineWidth},n={type:i.frameObj.type,color:i.frameObj.color,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset/2,radius:i.frameObj.radius,amount:i.frameObj.amount,border:i.frameObj.border,gradientColor:i.frameObj.gradientColor},l=i.transform.zoomFactor;if(e.canvas.id===i.element.id+"_tempCanvas"){var h=e.canvas.width,p=e.canvas.height,d={width:0,height:0};i.cropModule.cropping({prop:"calcRatio",onPropertyChange:!1,value:{obj:d,dimension:{width:h,height:p}}}),a=d,n.size*=(a.width+a.height)/2,n.inset*=(a.width+a.height)/2,n.offset*=(a.width+a.height)/2,n.radius*=(a.width+a.height)/2,s={startX:0,startY:0,width:e.canvas.width,height:e.canvas.height},i.exportModule.export({prop:"updateSaveContext",onPropertyChange:!1,value:{context:e}})}else e===this.upperContext&&i.activeObj.shape?s={startX:i.activeObj.activePoint.startX-e.lineWidth,startY:i.activeObj.activePoint.startY-e.lineWidth,width:i.activeObj.activePoint.width+2*e.lineWidth,height:i.activeObj.activePoint.height+2*e.lineWidth}:sf.base.isNullOrUndefined(o)&&e.clearRect(0,0,e.canvas.width,e.canvas.height);var c=(a.width+a.height)/2*40,u=(a.width+a.height)/2*50;if(e!==this.upperContext&&(n.size+=n.size*l,n.inset+=n.inset*l,n.offset+=n.offset*l,n.radius+=n.radius*l,c+=c*l,u+=u*l),e!==this.upperContext||!i.activeObj.shape||!("mat"===t&&(s.width-2*n.size<0||s.height-2*n.size<0)||"bevel"===t&&(s.width-2*n.size<40||s.height-2*n.size<40)||"inset"===t&&(s.startX+s.width-n.offset-(s.startX+n.offset)<0||s.startY+s.height-n.offset-(s.startY+n.offset)<0)||"hook"===t&&(s.width-2*n.size<50||s.height-2*n.size<50))){var v={bevelFilter:e.filter},g=e.filter;if(i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape||i.isCircleCrop||e===this.lowerContext&&i.isCropTab)this.drawImgToCtx(e,o);else{switch(t){case"none":this.drawImgToCtx(e,o);break;case"mat":for(this.drawImgToCtx(e,o);(s.width-2*n.size<0||s.height-2*n.size<0)&&n.size>0;)n.size-=20;e.filter="none",e.fillStyle=this.getFrameColor(n,e,s),e.beginPath(),e.rect(s.startX,s.startY,s.width,s.height),e.rect(s.startX+n.size,s.startY+n.size,s.width-2*n.size,s.height-2*n.size),e.fill("evenodd"),e.closePath();break;case"bevel":for(e.filter="none",e.fillStyle=this.getFrameColor(n,e,s),e.beginPath(),e.fillRect(s.startX,s.startY,s.width,s.height),e.closePath(),s.startX+=n.size,s.startY+=n.size,s.width-=2*n.size,s.height-=2*n.size;(s.width-2*n.size<40||s.height-2*n.size<40)&&n.size>0;)s.startX-=n.size,s.startY-=n.size,s.width+=2*n.size,s.height+=2*n.size,n.size-=20,s.startX+=n.size,s.startY+=n.size,s.width-=2*n.size,s.height-=2*n.size;e.fillStyle=this.getFrameColor(n,e,s),e.save(),e.beginPath(),e.moveTo(s.startX+c,s.startY),e.lineTo(s.startX+s.width-c,s.startY),e.quadraticCurveTo(s.startX+s.width,s.startY,s.startX+s.width,s.startY+c),e.lineTo(s.startX+s.width,s.startY+s.height-c),e.quadraticCurveTo(s.startX+s.width,s.startY+s.height,s.startX+s.width-c,s.startY+s.height),e.lineTo(s.startX+c,s.startY+s.height),e.quadraticCurveTo(s.startX,s.startY+s.height,s.startX,s.startY+s.height-c),e.lineTo(s.startX,s.startY+c),e.quadraticCurveTo(s.startX,s.startY,s.startX+c,s.startY),e.closePath(),e.clip(),e.filter="none"===g?i.canvasFilter:g,e.canvas.id===i.element.id+"_tempCanvas"?(o=null,e.filter="none",e.drawImage(i.inMemoryCanvas,0,0),e.filter="none"===g?i.canvasFilter:g):(e.clearRect(0,0,e.canvas.width,e.canvas.height),o?(o=null,0!==i.transform.zoomFactor&&(this.isRotateZoom=!0),i.filterModule.filter({prop:"getBevelFilter",onPropertyChange:!1,value:{obj:v}}),e.filter=v.bevelFilter,this.updateCurrTransState("initial"),this.drawImgToCtx(e,o),this.updateCurrTransState("reverse"),this.isRotateZoom=!1,i.frameObj.type="none",e.filter="none",i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:e,shape:"iterate",pen:"iterate",isPreventApply:null}}),i.frameObj.type="bevel",e.filter="none"===g?i.canvasFilter:g):(i.filterModule.filter({prop:"getBevelFilter",onPropertyChange:!1,value:{obj:v}}),e.filter=v.bevelFilter,this.drawImgToCtx(e,o))),e.restore();break;case"line":this.drawImgToCtx(e,o),r=e.lineWidth,e.lineWidth=n.size/10;for(var b=0;b<i.frameObj.amount;b++){b>0&&(s.startX+=n.offset,s.startY+=n.offset,s.width-=2*n.offset,s.height-=2*n.offset);var C=s.startY+s.height-n.inset-n.radius,f=s.startY+n.inset+n.radius,m=s.startX+s.width-n.inset-n.radius,y=s.startX+n.inset+n.radius,w=s.startX+n.inset+n.radius,P=s.startX+s.width-n.inset-n.radius,j=s.startY+n.inset+n.radius,x=s.startY+s.height-n.inset-n.radius;C>=f&&m>=y&&w<=P&&j<=x&&(e.filter="none",e.strokeStyle=this.getFrameColor(n,e,s),"dashed"===n.border?e.setLineDash([2.5*e.lineWidth,1.5*e.lineWidth]):"dotted"===n.border&&e.setLineDash([e.lineWidth,e.lineWidth]),e.beginPath(),e.moveTo(s.startX+n.inset+n.radius,s.startY+n.inset),e.lineTo(s.startX+s.width-n.inset-n.radius,s.startY+n.inset),e.arcTo(s.startX+s.width-n.inset,s.startY+n.inset,s.startX+s.width-n.inset,s.startY+n.inset+n.radius,n.radius),e.lineTo(s.startX+s.width-n.inset,s.startY+s.height-n.inset-n.radius),e.arcTo(s.startX+s.width-n.inset,s.startY+s.height-n.inset,s.startX+s.width-n.inset-n.radius,s.startY+s.height-n.inset,n.radius),e.lineTo(s.startX+n.inset+n.radius,s.startY+s.height-n.inset),e.arcTo(s.startX+n.inset,s.startY+s.height-n.inset,s.startX+n.inset,s.startY+s.height-n.inset-n.radius,n.radius),e.lineTo(s.startX+n.inset,s.startY+n.inset+n.radius),e.arcTo(s.startX+n.inset,s.startY+n.inset,s.startX+n.inset+n.radius,s.startY+n.inset,n.radius),e.closePath(),e.stroke(),e.setLineDash([]))}e.lineWidth=r;break;case"inset":this.drawImgToCtx(e,o),e.filter="none",e.strokeStyle=this.getFrameColor(n,e,s),r=e.lineWidth,e.lineWidth=n.size/10,e.beginPath(),e.moveTo(s.startX+n.offset,s.startY+n.inset),e.lineTo(s.startX+s.width-n.offset,s.startY+n.inset),e.moveTo(s.startX+s.width-n.inset,s.startY+n.offset),e.lineTo(s.startX+s.width-n.inset,s.startY+s.height-n.offset),e.moveTo(s.startX+s.width-n.offset,s.startY+s.height-n.inset),e.lineTo(s.startX+n.offset,s.startY+s.height-n.inset),e.moveTo(s.startX+n.inset,s.startY+s.height-n.offset),e.lineTo(s.startX+n.inset,s.startY+n.offset),e.stroke(),e.closePath(),e.lineWidth=r;break;case"hook":this.drawImgToCtx(e,o),e.filter="none",e.strokeStyle=this.getFrameColor(n,e,s),r=e.lineWidth,e.lineWidth=n.size/10,e.beginPath(),e.moveTo(s.startX+n.inset+u,s.startY+n.inset),e.lineTo(s.startX+n.inset,s.startY+n.inset),e.lineTo(s.startX+n.inset,s.startY+n.inset+u),e.moveTo(s.startX+s.width-n.inset-u,s.startY+n.inset),e.lineTo(s.startX+s.width-n.inset,s.startY+n.inset),e.lineTo(s.startX+s.width-n.inset,s.startY+n.inset+u),e.moveTo(s.startX+s.width-n.inset-u,s.startY+s.height-n.inset),e.lineTo(s.startX+s.width-n.inset,s.startY+s.height-n.inset),e.lineTo(s.startX+s.width-n.inset,s.startY+s.height-n.inset-u),e.moveTo(s.startX+n.inset+u,s.startY+s.height-n.inset),e.lineTo(s.startX+n.inset,s.startY+s.height-n.inset),e.lineTo(s.startX+n.inset,s.startY+s.height-n.inset-u),e.stroke(),e.lineWidth=r}(i.isCircleCrop||i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape)&&i.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:e,isSave:e.canvas.id===i.element.id+"_tempCanvas"||null,isFlip:null}}),e.filter=g}}},e.prototype.triggerFrameChange=function(e){var t=this,o=this.parent,r={cancel:!1,previousFrameSetting:e,currentFrameSetting:{type:o.toPascalCase(o.frameObj.type),color:o.frameObj.color,gradientColor:o.frameObj.gradientColor,size:o.frameObj.size,inset:o.frameObj.inset,offset:o.frameObj.offset,borderRadius:o.frameObj.radius,frameLineStyle:o.toPascalCase(o.frameObj.border),lineCount:o.frameObj.amount}};return o.events&&!0===o.events.frameChanging.hasDelegate?o.dotNetRef.invokeMethodAsync("OnFrameChangingAsync","FrameChanging",r,null).then((function(e){if(!e.cancel){t.setFrameObj(e.currentFrameSetting);var r={currObj:{}};if(o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),o.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:r.currObj,previousObjColl:r.currObj.objColl,previousPointColl:r.currObj.pointColl,previousSelPointColl:r.currObj.selPointColl,previousCropObj:sf.base.extend({},o.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.element.querySelector(".e-ie-toolbar-e-frame-color")&&(o.element.querySelector(".e-ie-toolbar-e-frame-color"+o.DDBPREVIEW).style.background=o.frameObj.color),o.element.querySelector(".e-ie-toolbar-e-frame-gradient")){var i=document.querySelector(".e-dropdown-popup.e-frame-gradient-dd-btn");i&&i.querySelector(".e-nocolor-item").classList.remove("e-selected"),o.element.querySelector(".e-ie-toolbar-e-frame-gradient"+o.DDBPREVIEW).classList.remove("e-nocolor-item"),""===o.frameObj.gradientColor?o.element.querySelector(".e-ie-toolbar-e-frame-gradient"+o.DDBPREVIEW).classList.add("e-nocolor-item"):o.element.querySelector(".e-ie-toolbar-e-frame-gradient"+o.DDBPREVIEW).style.background=o.frameObj.gradientColor}o.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),o.curFrameObjEvent={currentFrameSetting:e.currentFrameSetting},o.isFrameBtnClick=!0}})):r.cancel||this.setFrameObj(r.currentFrameSetting),r},e.prototype.setFrameObj=function(e){var t=this.parent;t.frameObj.type=e.type.toLowerCase(),t.frameObj.color=e.color,t.frameObj.gradientColor=e.gradientColor,t.frameObj.size=e.size,t.frameObj.inset=e.inset,t.frameObj.offset=e.offset,t.frameObj.radius=e.borderRadius,t.frameObj.border=e.frameLineStyle.toLowerCase(),t.frameObj.amount=e.lineCount},e.prototype.zoomToSel=function(e,t){var o=this.parent;if(this.straightenActObj&&JSON.stringify(this.straightenActObj.activePoint)===JSON.stringify(e.activePoint))if(o.activeObj=sf.base.extend({},this.straightenActObj,null,!0),0===o.transform.straighten){var r=o.img.destWidth,i=o.img.destHeight;for(o.transform.straighten=360;;){if(sf.base.isNullOrUndefined(this.straightenInitZoom)||!(Math.round(o.transform.zoomFactor*Math.pow(10,3))/Math.pow(10,3)>Math.round(this.straightenInitZoom*Math.pow(10,3))/Math.pow(10,3))){this.performDummyZoom();break}if(this.setZoomPan("out"),r===o.img.destWidth&&i===o.img.destHeight){this.performDummyZoom();break}0===o.transform.degree&&(o.transform.zoomFactor-=.025,o.transform.cropZoomFactor-=.025)}o.transform.straighten=0,o.img={destLeft:o.img.destLeft,destTop:o.img.destTop,destWidth:o.img.destWidth,destHeight:o.img.destHeight,srcLeft:o.img.srcLeft,srcTop:o.img.srcTop,srcWidth:o.img.srcWidth,srcHeight:o.img.srcHeight}}else sf.base.isNullOrUndefined(this.straightenInitZoom)&&(this.straightenInitZoom=o.transform.zoomFactor),this.straightenInitZoom-o.transform.zoomFactor>0?o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-(this.straightenInitZoom-o.transform.zoomFactor),zoomPoint:null,isResize:!0}}):this.straightenInitZoom-o.transform.zoomFactor<0&&o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:this.straightenInitZoom-o.transform.zoomFactor,zoomPoint:null,isResize:!0}}),o.activeObj=sf.base.extend({},e,null,!0),o.transform.zoomFactor+=.001,this.calcStraightenedPoints(t);else this.straightenActObj=sf.base.extend({},e,null,!0),o.activeObj=sf.base.extend({},this.straightenActObj,null,!0),this.straightenInitZoom=o.transform.zoomFactor,this.calcStraightenedPoints(t)},e.prototype.isDestPointSmall=function(){var e=this.parent,t=e.img,o={startX:t.destLeft,startY:t.destTop,width:t.destWidth,height:t.destHeight};e.shapeModule.shape({prop:"straightenShapes",onPropertyChange:!1});var r=!1;return this.straightenDestPoints.destWidth&&this.straightenDestPoints.destHeight&&(t.destWidth<this.straightenDestPoints.destWidth||t.destHeight<this.straightenDestPoints.destHeight)&&(r=!0),t.destLeft=o.startX,t.destTop=o.startY,t.destWidth=o.width,t.destHeight=o.height,e.img=t,r},e.prototype.calcStraightenedPoints=function(e){var t=this.parent,o=t.img.destWidth,r=t.img.destHeight;sf.base.isNullOrUndefined(t.transform.zoomFactor)&&(t.transform.zoomFactor+=.025),this.updateImgCanvasPoints();for(var i=function(){if(!(a.isLinesIntersect()||a.isSelOutsideImg()||e&&a.isDestPointSmall()))return a.performDummyZoom(),"break";if(t.activeObj=sf.base.extend({},a.straightenActObj,null,!0),a.setZoomPan("in"),o===t.img.destWidth&&r===t.img.destHeight)return a.performDummyZoom(),"break";0===t.transform.degree&&(t.transform.zoomFactor+=.025,t.transform.cropZoomFactor+=.025);var i=a.imgCanvasPoints,s=t.img.destLeft,n=t.img.destTop,l=t.img.destWidth,h=t.img.destHeight;i.forEach((function(e){e.x=e.ratioX*l+s,e.y=e.ratioY*h+n})),a.imgCanvasPoints=i},a=this;;){if("break"===i())break}},e.prototype.performDummyZoom=function(){var e=this.parent;e.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.025,zoomPoint:null,isResize:!0}}),e.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.025,zoomPoint:null,isResize:!0}});var t=10*e.transform.zoomFactor;t<1&&(t=1+t/10),e.zoomSettings.zoomFactor=t,e.transformModule.transform({prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:t}}),this.panToSel()},e.prototype.setZoomPan=function(e){var t=this.parent,o={maxDimension:null};0===t.transform.degree?(t.transformModule.transform({prop:"cropZoom",onPropertyChange:!1,value:{value:"in"===e?.025:-.025,selectionObj:t.activeObj,obj:o}}),t.img.destWidth=o.maxDimension.width,t.img.destHeight=o.maxDimension.height):(t.transform.zoomFactor+="in"===e?.025:-.025,t.transform.cropZoomFactor+="in"===e?.025:-.025,this.updateCurrTransState("initial"),this.isRotateZoom=!0,this.setDestPoints(),this.isRotateZoom=!1,this.updateCurrTransState("reverse"))},e.prototype.updateImgCanvasPoints=function(){var e=this.parent,t=this.getImagePoints(),o={width:0,height:0},r=e.baseImgCanvas.width,i=e.baseImgCanvas.height;e.cropModule.cropping({prop:"calcRatio",onPropertyChange:!1,value:{obj:o,dimension:{width:r,height:i}}});var a,s,n,l,h=o;r=e.transform.degree%90==0&&e.transform.degree%180!=0?h.height:h.width,i=e.transform.degree%90==0&&e.transform.degree%180!=0?h.width:h.height;var p=e.img,d=p.destLeft,c=p.destTop,u=p.destWidth,v=p.destHeight;e.transform.straighten>0?(a={x:d+t[0].x/r,y:c},s={x:d+u,y:c+t[1].y/i},n={x:d+u-t[0].x/r,y:c+v},l={x:d,y:c+v-t[1].y/i}):(a={x:d,y:c+t[0].y/i},s={x:d+t[1].x/r,y:c},n={x:d+u,y:c+v-t[0].y/i},l={x:d+u-t[1].x/r,y:c+v}),a.ratioX=(a.x-d)/u,a.ratioY=(a.y-c)/v,s.ratioX=(s.x-d)/u,s.ratioY=(s.y-c)/v,n.ratioX=(n.x-d)/u,n.ratioY=(n.y-c)/v,l.ratioX=(l.x-d)/u,l.ratioY=(l.y-c)/v,this.imgCanvasPoints=[a,s,n,l]},e.prototype.isLinesIntersect=function(e){var t=this.parent.activeObj.activePoint,o=this.imgCanvasPoints,r=this.doIntersect({x:t.startX,y:t.startY},{x:t.endX,y:t.startY},o[0],o[1]),i=this.doIntersect({x:t.endX,y:t.startY},{x:t.endX,y:t.endY},o[1],o[2]),a=this.doIntersect({x:t.startX,y:t.endY},{x:t.endX,y:t.endY},o[2],o[3]),s=this.doIntersect({x:t.startX,y:t.startY},{x:t.startX,y:t.endY},o[3],o[0]),n=this.isInsideRect(o[0]),l=this.isInsideRect(o[1]),h=this.isInsideRect(o[2]),p=this.isInsideRect(o[3]);return e&&(e.arr=[r,i,a,s]),r||i||a||s||n||l||h||p||o[0].x>t.startX&&o[1].x<t.endX&&o[2].x<t.endX&&o[3].x>t.startX&&o[0].y<t.startY&&o[1].y<t.startY&&o[2].y>t.endY&&o[3].y>t.endY||o[0].x<t.startX&&o[1].x>t.endX&&o[2].x>t.endX&&o[3].x<t.startX&&o[0].y>t.startY&&o[1].y>t.startY&&o[2].y<t.endY&&o[3].y<t.endY},e.prototype.isSelOutsideImg=function(){var e=this.parent,t=this.imgCanvasPoints,o=e.activeObj.activePoint;return"inside"!==this.checkPointPosition(o.startX,o.startY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)||"inside"!==this.checkPointPosition(o.endX,o.startY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)||"inside"!==this.checkPointPosition(o.startX,o.endY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)||"inside"!==this.checkPointPosition(o.endX,o.endY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)},e.prototype.calcTriangleArea=function(e,t,o,r,i,a){return Math.abs((e*(r-a)+o*(a-t)+i*(t-r))/2)},e.prototype.checkPointPosition=function(e,t,o,r,i,a,s,n,l,h){var p=this.calcTriangleArea(e,t,o,r,l,h),d=this.calcTriangleArea(e,t,l,h,s,n),c=this.calcTriangleArea(e,t,s,n,i,a),u=this.calcTriangleArea(e,t,i,a,o,r),v=this.calcTriangleArea(o,r,i,a,s,n)+this.calcTriangleArea(s,n,l,h,o,r);return p+d+c+u>v?"outside":p+d+c+u!==v||0!==p&&0!==d&&0!==c&&0!==u?"inside":"on"},e.prototype.getImagePoints=function(){var e=[],t=this.parent,o=t.transform.degree,r=t.baseImg.width,i=t.baseImg.height,a={dim:null,width:i,height:r,angle:t.transform.straighten};a.dim=t.getRotatedCanvasDim(a.width,a.height,a.angle);var s=o%90==0&&o%180!=0?i:r,n=o%90==0&&o%180!=0?r:i,l=(o%90==0&&o%180!=0?a.dim.width:t.baseImgCanvas.width)/2,h=(o%90==0&&o%180!=0?a.dim.height:t.baseImgCanvas.height)/2,p=l-s/2,d=h-n/2,c=l+s/2,u=h+n/2,v=l,g=h,b=t.transform.straighten*(Math.PI/180),C={x:Math.cos(b)*(p-v)-Math.sin(b)*(d-g)+v,y:Math.sin(b)*(p-v)+Math.cos(b)*(d-g)+g},f={x:Math.cos(b)*(c-v)-Math.sin(b)*(d-g)+v,y:Math.sin(b)*(c-v)+Math.cos(b)*(d-g)+g},m={x:Math.cos(b)*(c-v)-Math.sin(b)*(u-g)+v,y:Math.sin(b)*(c-v)+Math.cos(b)*(u-g)+g},y={x:Math.cos(b)*(p-v)-Math.sin(b)*(u-g)+v,y:Math.sin(b)*(p-v)+Math.cos(b)*(u-g)+g};return e.push(C),e.push(f),e.push(m),e.push(y),e},e.prototype.doIntersect=function(e,t,o,r){var i=this.initiation(e,t,o),a=this.initiation(e,t,r),s=this.initiation(o,r,e),n=this.initiation(o,r,t);return i!==a&&s!==n||(!(0!==i||!this.onSegment(e,o,t))||(!(0!==a||!this.onSegment(e,r,t))||(!(0!==s||!this.onSegment(o,e,r))||!(0!==n||!this.onSegment(o,t,r)))))},e.prototype.initiation=function(e,t,o){var r=(t.y-e.y)*(o.x-t.x)-(t.x-e.x)*(o.y-t.y);return 0===r?0:r>0?1:2},e.prototype.onSegment=function(e,t,o){return t.x<=Math.max(e.x,o.x)&&t.x>=Math.min(e.x,o.x)&&t.y<=Math.max(e.y,o.y)&&t.y>=Math.min(e.y,o.y)},e.prototype.isInsideRect=function(e){var t=this.parent.activeObj.activePoint,o=!1;return e.x>=t.startX&&e.x<=t.endX&&e.y>=t.startY&&e.y<=t.endY&&(o=!0),o},e.prototype.setDestForStraighten=function(){var e=this.parent;if(sf.base.isNullOrUndefined(this.straightenDestPoints)){var t=e.img,o=t.destLeft,r=t.destTop,i=t.destWidth,a=t.destHeight;e.shapeModule.shape({prop:"straightenShapes",onPropertyChange:!1}),this.straightenDestPoints=sf.base.extend({},e.img,{},!0),e.img.destLeft=o,e.img.destTop=r,e.img.destWidth=i,e.img.destHeight=a}},e}(),g=function(){function e(e){this.parent=e}return e.prototype.export=function(e){var t={shape:""};switch(this.parent.selectionModule.selection({prop:"getCurrentDrawingShape",onPropertyChange:!1,value:{obj:t}}),""!==t.shape&&(this.parent.selectionModule.selection({prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),this.parent.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1})),this.updatePvtVar(),e.prop){case"export":this.exportImg(e.value.type,e.value.fileName,e.value.imgQuality);break;case"exportToCanvas":this.exportToCanvas(e.value.object);break;case"updateSaveContext":this.updateSaveContext(e.value.context);break;case"setImageQuality":this.imageQuality=e.value.value}},e.prototype.getModuleName=function(){return"export"},e.prototype.updatePvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},e.prototype.exportImg=function(e,t,o){var r=this,i=this.parent,a={fileName:""};i.drawModule.draw({prop:"getFileName",onPropertyChange:!1,value:{obj:a}});var s=a.fileName;if(!i.disabled&&i.isImageLoaded){var n={bool:!1};i.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),n.bool&&i.freeHandDrawModule.draw({prop:"applyFhd",onPropertyChange:!1}),i.togglePen&&(i.currObjType.isZoomed=!0,i.shapeModule.shape({prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}})),"block"!==i.textArea.style.display&&"inline-block"!==i.textArea.style.display||i.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),i.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}});var l={canvasFilter:this.parent.canvasFilter};this.lowerContext.filter=l.canvasFilter,e=e||"Png",i.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}});var h={cancel:!1,fileName:t||s,fileType:e,imageQuality:o};i.events&&!0===i.events.saving.hasDelegate?i.dotNetRef.invokeMethodAsync("BeforeSaveEventAsync","BeforeSave",h).then((function(i){r.beforeSaveEvent(i,e,t,s,o)})):this.beforeSaveEvent(h,e,t,s,o)}},e.prototype.beforeSaveEvent=function(e,t,o,r,i){var a=this.parent;if(!e.cancel){a.currObjType.isSave=!0,o=e.fileName?e.fileName:o;var s=t.toLowerCase();o=o||r,"svg"===s?this.toSVGImg(o):this.toBlobFn(o,s,e.imageQuality||i),a.lowerCanvas.style.left=a.upperCanvas.style.left="",a.lowerCanvas.style.top=a.upperCanvas.style.top="",a.lowerCanvas.style.maxWidth=a.upperCanvas.style.maxWidth="",a.lowerCanvas.style.maxHeight=a.upperCanvas.style.maxHeight=""}},e.prototype.toSVGImg=function(e){var t=this.parent;sf.popups.showSpinner(t.element),t.element.style.opacity="0.5";var o=this.exportToCanvas(),r=o.toDataURL();sf.popups.hideSpinner(t.element),t.element.style.opacity="1";var i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("width",o.style.maxWidth),i.setAttribute("height",o.style.maxHeight);var a=document.createElementNS("http://www.w3.org/2000/svg","image");a.setAttributeNS(null,"height",o.height.toString()),a.setAttributeNS(null,"width",o.width.toString()),a.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",r),i.appendChild(a);var s='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+o.width+'" height="'+o.height+'">',n=i.innerHTML,l="data:image/svg+xml;base64,"+btoa(s+n+"</svg>");return null===e?l:(this.downloadImg(l,e+".svg"),null)},e.prototype.toBlobFn=function(e,t,o){var r=this,i=this.parent;sf.popups.showSpinner(i.element),i.element.style.opacity="0.5",sf.base.isNullOrUndefined(o)||(o=o>1?1:o<=0?.01:o,this.imageQuality=o||null);var a=this.exportToCanvas(),s="jpeg"!=t?"image/png":"image/jpeg";a.toBlob((function(o){var a=URL.createObjectURL(o);r.downloadImg(a,e+"."+t),sf.popups.hideSpinner(i.element),i.element.style.opacity="1"}),s,this.imageQuality?this.imageQuality:null)},e.prototype.exportToCanvas=function(e){var t,o,r=this.parent,i=sf.base.extend({},r.cropObj,{},!0),a={currObj:{}};r.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var s=a.currObj;s.objColl=sf.base.extend([],r.objColl,[],!0),s.pointColl=sf.base.extend([],r.pointColl,[],!0),s.afterCropActions=sf.base.extend([],r.afterCropActions,[],!0);var n={selPointColl:null};r.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),this.parent.aspectWidth?(r.undoRedoModule.undoRedo({prop:"setPreventUR",value:{bool:!0}}),r.performResizeClick(),r.currentToolbar="resize-toolbar",r.okBtn(),r.transform.degree%90==0&&r.transform.degree%180!=0?(t=this.parent.aspectHeight,o=this.parent.aspectWidth):(t=this.parent.aspectWidth,o=this.parent.aspectHeight),r.undoRedoModule.undoRedo({prop:"setPreventUR",value:{bool:!1}})):r.currSelectionPoint?(t=r.img.srcWidth,o=r.img.srcHeight):(t=r.baseImgCanvas.width,o=r.baseImgCanvas.height);var l={width:0,height:0};r.cropModule.cropping({prop:"calcRatio",onPropertyChange:!1,value:{obj:l,dimension:{width:t,height:o}}});var h=l,p=this.lowerContext.filter;if("none"!==this.lowerContext.filter){var d=this.lowerContext.filter.split(" "),c=parseFloat(d[5].split("(")[1]);c*=(h.width+h.height)/2,d[5]="blur("+c+"px)",this.lowerContext.filter=d.join(" ")}var u=sf.base.createElement("canvas",{id:r.element.id+"_tempCanvas",attrs:{name:"canvasImage"}}),v=u.getContext("2d");u.width=t,u.height=o;var g={width:0,height:0};r.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t,height:o,obj:g}});var b=g;u.style.maxWidth=b.width+"px",u.style.maxHeight=b.height+"px";var C=this.lowerContext.filter;return v.filter=this.lowerContext.filter,this.downScaleImgCanvas(v,t,o),this.lowerContext.filter=C,0===r.transform.degree&&""===r.transform.currFlipState&&0===r.transform.straighten||(this.updateSaveContext(v),this.exportTransformedImage(v)),this.drawAnnotation(v,h),r.isCircleCrop&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:v,isSave:!0,isFlip:null}}),this.updateFrame(v,!0),this.lowerContext.filter=p,r.canvasFilter=p,e&&(e.canvas=u),r.aspectWidth&&(r.objColl=[],r.pointColl=[],r.freehandCounter=0,r.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),r.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:s}}),s.selPointColl=sf.base.extend([],n.selPointColl,[],!0),r.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:s.selPointColl}}}),r.cropObj=i,r.objColl=sf.base.extend([],s.objColl,[],!0),r.pointColl=sf.base.extend([],s.pointColl,[],!0),r.freehandCounter=r.pointColl.length,r.transform.straighten=0,this.lowerContext.filter="none",r.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=s.filter,r.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(r.isCircleCrop||r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape)&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})),u},e.prototype.drawAnnotation=function(e,t){for(var o=this.parent,r=sf.base.extend([],o.objColl,[],!0),i=sf.base.extend([],o.pointColl,[],!0),a=0;a<o.shapeColl.length;a++)o.shapeColl[a].order&&(o.shapeColl[a].currIndex&&o.shapeColl[a].currIndex.indexOf("shape")>-1?(o.objColl=[],o.objColl.push(sf.base.extend({},o.shapeColl[a],{},!0)),this.drawShape(e,t)):o.shapeColl[a].id&&o.shapeColl[a].id.indexOf("pen")>-1&&(o.pointColl=[],o.freehandCounter=0,o.pointColl.push(sf.base.extend({},o.shapeColl[a],{},!0)),o.freehandCounter=o.pointColl.length,this.drawPen(e,t)));o.objColl=r,o.pointColl=i,o.freehandCounter=o.pointColl.length},e.prototype.drawShape=function(e,t){var o=this.parent;if(o.objColl.length>0){var r=e.filter;e.filter="none";var i={index:null};o.shapeModule.shape({prop:"getSmallestIndex",onPropertyChange:!1,value:{obj:i}});for(var a=i.index,s=sf.base.extend([],o.objColl,[],!0),n=sf.base.extend([],o.objColl,[],!0);s.length>0;){for(var l=!1,h=0;h<s.length;h++){var p=s[h];if(sf.base.isNullOrUndefined(p.order))s.splice(h,1),h--;else if(p.order===a){var d=e.filter;e.filter="none";var c=s[h],u=c.activePoint;if(u.startX-=o.img.destLeft,u.startY-=o.img.destTop,u.endX-=o.img.destLeft,u.endY-=o.img.destTop,u.width=u.endX-u.startX,u.height=u.endY-u.startY,u.startX*=t.width,u.startY*=t.height,u.endX*=t.width,u.endY*=t.height,u.width=u.endX-u.startX,u.height=u.endY-u.startY,c.strokeSettings.strokeWidth*=(t.width+t.height)/2,"text"===c.shape)c.textSettings.fontSize*=(t.width+t.height)/2;else if("path"===c.shape)for(var v=0;v<c.pointColl.length;v++)c.pointColl[v].x=(c.pointColl[v].x-o.img.destLeft)*t.width,c.pointColl[v].y=(c.pointColl[v].y-o.img.destTop)*t.height;else"image"===c.shape&&(o.activeObj=sf.base.extend({},s[h],{},!0),o.selectionModule.selection({prop:"upgradeImageQuality",onPropertyChange:!1}),s[h]=sf.base.extend({},o.activeObj,{},!0));o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"saveContext",obj:s[h],isCropRatio:null,points:null,isPreventDrag:!0,saveContext:e,isPreventSelection:null}}),e.filter=d,o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),a++;var g={bool:!1};o.shapeModule.shape({prop:"isIndexInObjColl",onPropertyChange:!1,value:{obj:g,index:a}}),g.bool||a++,s.splice(h,1),l=!0;break}}if(!l)break}e.filter=r,o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),o.objColl=n}},e.prototype.drawPen=function(e,t){var o=this.parent;if(o.freehandCounter>0){var r={penStrokeWidth:null};o.freeHandDrawModule.draw({prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:r}});for(var i=sf.base.extend({},o.pointColl,{},!0),a=0;a<o.freehandCounter;a++){o.points=sf.base.extend([],o.pointColl[a].points,[]),o.freeHandDrawModule.draw({prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});var s=o.points.length;o.pointColl[a].strokeWidth*=(t.width+t.height)/2;for(var n=0;n<s;n++)o.points[n].x=(o.points[n].x-o.img.destLeft)*t.width,o.points[n].y=(o.points[n].y-o.img.destTop)*t.height}o.freeHandDrawModule.draw({prop:"freehandRedraw",onPropertyChange:!1,value:{context:e,points:null}}),o.pointColl=i,o.freeHandDrawModule.draw({prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:r.penStrokeWidth}})}},e.prototype.downScaleImgCanvas=function(e,t,o){var r=this.parent,i=r.baseImgCanvas,a=r.baseImg,s={width:0,height:0};if(r.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:a.width,height:a.height,obj:s,isImgShape:null}}),s.width>t&&s.height>o){var n=sf.base.createElement("canvas",{id:r.element.id+"_downScaleCanvas",attrs:{name:"canvasImage"}});n.width=this.parent.img.srcWidth,n.height=this.parent.img.srcHeight,n.getContext("2d").drawImage(i,r.img.srcLeft,r.img.srcTop,r.img.srcWidth,r.img.srcHeight,0,0,n.width,n.height),r.drawModule.draw({prop:"downScale",value:{canvas:n,width:t,height:o}}),e.drawImage(n,0,0)}else e.drawImage(r.baseImgCanvas,r.img.srcLeft,r.img.srcTop,r.img.srcWidth,r.img.srcHeight,0,0,t,o)},e.prototype.updateFrame=function(e,t){if("none"!==this.parent.frameObj.type){var o=e.filter;e.filter="none",this.parent.drawModule.draw({prop:"applyFrame",value:{ctx:e,frame:this.parent.frameObj.type,preventImg:t}}),e.filter=o}},e.prototype.downloadImg=function(e,t){var o=document.createElement("a");o.href=e,o.target="_parent",o.download=t,(document.body||document.documentElement).appendChild(o),o.click(),o.parentNode.removeChild(o)},e.prototype.exportTransformedImage=function(e){var t=this.parent,o=t.transform.degree;if(t.rotateFlipColl.length>0)for(var r=0,i=t.rotateFlipColl.length;r<i;r++){var a=t.rotateFlipColl[r];"number"==typeof a?this.exportRotate(e,a):"horizontal"===a?this.exportFlip(e,!0,!1):"vertical"===a&&this.exportFlip(e,!1,!0)}t.transform.degree=o},e.prototype.exportRotate=function(e,t){var o=this.parent;e.clearRect(0,0,e.canvas.width,e.canvas.height),this.setMaxDim(o.transform.degree,e.canvas),e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*t),e.drawImage(o.inMemoryCanvas,-e.canvas.height/2,-e.canvas.width/2,e.canvas.height,e.canvas.width),this.updateSaveContext(e)},e.prototype.exportFlip=function(e,t,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),t&&(e.translate(e.canvas.width,0),e.scale(-1,1)),o&&(e.translate(0,e.canvas.height),e.scale(1,-1)),e.drawImage(this.parent.inMemoryCanvas,0,0),this.updateSaveContext(e)},e.prototype.updateSaveContext=function(e){var t=this.parent.inMemoryCanvas.getContext("2d");e.setTransform(1,0,0,1,0,0);var o=e.getImageData(0,0,e.canvas.width,e.canvas.height);this.parent.inMemoryCanvas.width=o.width,this.parent.inMemoryCanvas.height=o.height,t.putImageData(o,0,0)},e.prototype.setMaxDim=function(e,t){var o,r;e%90==0&&e%180!=0?sf.base.isNullOrUndefined(this.parent.currSelectionPoint)?(o=this.parent.baseImgCanvas.height,r=this.parent.baseImgCanvas.width):(o=this.parent.img.srcHeight,r=this.parent.img.srcWidth):e%180!=0&&0!==e||(sf.base.isNullOrUndefined(this.parent.currSelectionPoint)?(o=this.parent.baseImgCanvas.width,r=this.parent.baseImgCanvas.height):(o=this.parent.img.srcWidth,r=this.parent.img.srcHeight)),sf.base.isNullOrUndefined(this.parent.aspectWidth)||(o=this.parent.aspectWidth,r=this.parent.aspectHeight),t.width=o,t.height=r;var i={width:0,height:0};this.parent.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o,height:r,obj:i,isImgShape:null}});var a=i;t.style.maxWidth=a.width+"px",t.style.maxHeight=a.height+"px"},e}(),b=function(){function e(e){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.adjustmentValue="",this.isBrightnessAdjusted=!1,this.bevelFilter="none",this.tempAdjVal={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempFilVal="",this.parent=e}return e.prototype.filter=function(e){switch(this.updatePrivateVariables(),e.prop){case"finetuneImage":this.finetuneImage(e.value.option,e.value.value);break;case"applyImageFilter":this.setFilter(e.value.option);break;case"update-finetunes":this.updateFinetunes();break;case"set-adjustment":this.setAdjustment(e.value.operation);break;case"initFilter":this.initFilter();break;case"setCurrAdjValue":this.setCurrAdjValue(e.value.type,e.value.value);break;case"updateAdj":this.updateAdj(e.value.type,e.value.value,e.value.isPreview,e.value.ctx);break;case"getCurrentObj":this.getCurrentObj(e.value.object);break;case"getAdjustmentLevel":sf.base.isNullOrUndefined(this.parent.activeObj.opacity)?this.adjustmentLevel.transparency=100:this.adjustmentLevel.transparency=100*this.parent.activeObj.opacity,e.value.obj.adjustmentLevel=this.adjustmentLevel;break;case"setAdjustmentLevel":this.adjustmentLevel=e.value.adjustmentLevel;break;case"getTempAdjustmentLevel":e.value.obj.tempAdjustmentLevel=this.tempAdjustmentLevel;break;case"setTempAdjustmentLevel":this.tempAdjustmentLevel=e.value.tempAdjustmentLevel;break;case"setAdjustmentValue":this.adjustmentValue=e.value.adjustmentValue;break;case"getBrightnessAdjusted":e.value.obj.isBrightnessAdjusted=this.isBrightnessAdjusted;break;case"setBrightnessAdjusted":this.isBrightnessAdjusted=e.value.isBrightnessAdjusted,this.parent.currentFilter.split("_")&&"cold"===this.parent.currentFilter.split("_")[1]&&(this.isBrightnessAdjusted=!1);break;case"getBevelFilter":e.value.obj.bevelFilter=this.bevelFilter;break;case"setBevelFilter":this.bevelFilter=e.value.bevelFilter;break;case"setTempAdjVal":this.tempAdjVal=sf.base.extend({},this.adjustmentLevel,{},!0);break;case"setTempFilVal":this.tempFilVal=this.parent.currentFilter;break;case"reset":this.reset()}},e.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},e.prototype.getModuleName=function(){return"filter"},e.prototype.reset=function(){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.adjustmentValue=this.parent.getDefaultFilter(),this.isBrightnessAdjusted=!1,this.bevelFilter="none",this.tempFilVal="",this.tempAdjVal={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1}},e.prototype.updateFinetunes=function(){var e=this,t=this.parent,o=t.finetuneSettings;if(o){["brightness","contrast","hue","saturation","exposure","opacity","blur"].forEach((function(t){o[t]&&(e.adjustmentLevel[t]=o[t].defaultValue,e.tempAdjustmentLevel[t]=o[t].defaultValue)})),t.drawModule.draw({prop:"isInitialLoading",onPropertyChange:!1,value:{isInitialLoading:!0}}),t.drawModule.draw()}},e.prototype.initFilter=function(){this.setFilterAdj("brightness",this.adjustmentLevel.brightness),this.setFilterAdj("contrast",this.adjustmentLevel.contrast),this.setFilterAdj("hue",this.adjustmentLevel.hue),this.setFilterAdj("saturation",this.adjustmentLevel.saturation),this.setFilterAdj("exposure",this.adjustmentLevel.exposure),this.setFilterAdj("opacity",this.adjustmentLevel.opacity),this.setFilterAdj("blur",this.adjustmentLevel.blur)},e.prototype.updateAdj=function(e,t,o,r){var i=this.parent;this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height);var a,s,n,l,h,p=this.lowerContext.filter.split(" "),d=[],c=this.getFilterValue(this.adjustmentLevel.brightness);if(-1===["brightness","contrast","hue","saturation","exposure","opacity","blur"].indexOf(e)&&sf.base.isNullOrUndefined(o)&&(this.adjustmentLevel.sharpen||this.adjustmentLevel.bw)){i.isUndoRedo=!0;var u=this.lowerContext.filter;this.lowerContext.filter="none",i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=u,i.isUndoRedo=!1}switch(e){case"brightness":t=this.getFilterValue(this.adjustmentLevel.exposure)+.005*t,p[0]="brightness("+t+")",0!==this.adjustmentLevel.brightness?(t=this.adjustmentLevel.opacity/100-.3*this.adjustmentLevel.opacity/100,p[4]="opacity("+t+")"):(t=this.adjustmentLevel.opacity/100,p[4]="opacity("+t+")"),this.adjustmentValue=p.join(" ");break;case"contrast":p[1]="contrast("+t+"%)",this.adjustmentValue=p.join(" ");break;case"hue":p[2]="hue-rotate("+t+"deg)",this.adjustmentValue=p.join(" ");break;case"saturation":p[3]="saturate("+t+"%)",this.adjustmentValue=p.join(" ");break;case"opacity":1!==parseFloat(p[0].split("(")[1])&&(t-=.2),t<0&&(t=0),p[4]="opacity("+t+")",this.adjustmentValue=p.join(" ");break;case"blur":p[5]="blur("+t+"px)",this.adjustmentValue=p.join(" ");break;case"exposure":t>1?(t-=1,t+=c):t<1&&(t=c-(t=1-t)),p[0]="brightness("+t+")",this.adjustmentValue=p.join(" ");break;case"chrome":a=this.getSaturationFilterValue(this.adjustmentLevel.saturation),t=(a*=100)+.4*a,p[3]="saturate("+t+"%)",d=this.adjustmentValue.split(" "),p[0]=d[0],p[1]=d[1],p[2]=d[2],p[4]=d[4],p[5]=d[5],p[6]="sepia(0%)",p[7]="grayscale(0%)",p[8]="invert(0%)";break;case"cold":s=this.getFilterValue(this.adjustmentLevel.brightness),t=.9*(s*=100),t*=.01,p[0]="brightness("+t+")",l=this.getFilterValue(this.adjustmentLevel.contrast),t=(l*=100)+.5*l,p[1]="contrast("+t+"%)",h=this.getSaturationFilterValue(this.adjustmentLevel.saturation),t=h*=100,p[3]="saturate("+t+"%)",d=this.adjustmentValue.split(" "),p[2]=d[2],p[4]=d[4],p[5]=d[5],p[6]="sepia(0%)",p[7]="grayscale(0%)",p[8]="invert(0%)";break;case"warm":n=this.getSaturationFilterValue(this.adjustmentLevel.saturation),t=(n*=100)+.4*n,p[3]="saturate("+t+"%)",p[6]="sepia(25%)",d=this.adjustmentValue.split(" "),p[0]=d[0],p[1]=d[1],p[2]=d[2],p[4]=d[4],p[5]=d[5],p[7]="grayscale(0%)",p[8]="invert(0%)";break;case"grayscale":p[7]="grayscale(100%)",d=this.adjustmentValue.split(" "),p[0]=d[0],p[1]=d[1],p[2]=d[2],p[3]=d[3],p[4]=d[4],p[5]=d[5],p[6]="sepia(0%)",p[8]="invert(0%)";break;case"sepia":p[6]="sepia(100%)",d=this.adjustmentValue.split(" "),p[0]=d[0],p[1]=d[1],p[2]=d[2],p[3]=d[3],p[4]=d[4],p[5]=d[5],p[7]="grayscale(0%)",p[8]="invert(0%)";break;case"invert":p[8]="invert(100%)",d=this.adjustmentValue.split(" "),p[0]=d[0],p[1]=d[1],p[2]=d[2],p[3]=d[3],p[4]=d[4],p[5]=d[5],p[6]="sepia(0%)",p[7]="grayscale(0%)"}if("sharpen"!==e&&"blackandwhite"!==e){sf.base.isNullOrUndefined(o)&&("default"===e&&(p=this.getDefaultCurrentFilter(p)),this.lowerContext.filter=p.join(" ")),p=this.setTempFilterValue(c,o,p,e),i.drawModule.draw({prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),i.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var v=void 0;"bevel"===i.frameObj.type&&(v=this.lowerContext.filter,this.bevelFilter=v),0===i.transform.degree&&i.rotateFlipColl.length>0&&(i.img.destLeft+=i.panPoint.totalPannedPoint.x,i.img.destTop+=i.panPoint.totalPannedPoint.y),i.img.destLeft+=i.panPoint.totalPannedInternalPoint.x,i.img.destTop+=i.panPoint.totalPannedInternalPoint.y,0===i.transform.degree&&i.transformModule.transform({prop:"setDestPointsForFlipState",onPropertyChange:!1}),i.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),i.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),i.drawModule.draw({prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),0===i.transform.degree&&i.rotateFlipColl.length>0&&(i.img.destLeft+=i.panPoint.totalPannedPoint.x,i.img.destTop+=i.panPoint.totalPannedPoint.y),p=this.setTempFilterValue(c,o,p,e),sf.base.isNullOrUndefined(o)&&(this.lowerContext.filter=p.join(" ")),i.initialAdjustmentValue=p.join(" "),v=this.lowerContext.filter,this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",this.bevelFilter=v,i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=v,i.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape||i.isCircleCrop)&&i.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.isBrightnessAdjusted=1!==c}var g=p.join(" ");r&&(r.filter=g)},e.prototype.setTempFilterValue=function(e,t,o,r){if(t)if("default"===r)o=this.getDefaultCurrentFilter(o);else if(1!==e){var i=this.lowerContext.filter.split(" ");i[4]=o[4],this.lowerContext.filter=i.join(" ")}return o},e.prototype.getDefaultCurrentFilter=function(e){var t=this.adjustmentValue.split(" ");return[t[0],t[1],t[2],t[3],t[4],t[5],"sepia(0%)","grayscale(0%)","invert(0%)"]},e.prototype.getFilterValue=function(e){return 0===e?1:1+.5*e/100},e.prototype.getSaturationFilterValue=function(e){return 0===e?1:1+e/100},e.prototype.setFilterAdj=function(e,t){var o=this.parent;switch(o.freeHandDrawModule.draw({prop:"apply-pen-draw",onPropertyChange:!1}),this.adjustmentLevel[""+e]=t,e){case"contrast":case"exposure":t=this.getFilterValue(t),"contrast"===e&&(t*=100);break;case"hue":t*=3;break;case"saturation":t=100*this.getSaturationFilterValue(t);break;case"opacity":t<10&&(t+=1),t/=100;break;case"blur":0!==t&&(t/=20,t+=.5)}var r=sf.base.extend({},o.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],o.objColl,[],!0),i.pointColl=sf.base.extend([],o.pointColl,[],!0),i.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var a={selPointColl:null};o.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.updateAdj(e,t),o.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})},e.prototype.setFilter=function(e){var t=this.parent;e=e.toLowerCase(),t.freeHandDrawModule.draw({prop:"apply-pen-draw",onPropertyChange:!1});var o={currentFilter:this.parent.currentFilter}.currentFilter,r=sf.base.extend({},t.cropObj,{},!0),i=this.getCurrentObj();i.objColl=sf.base.extend([],t.objColl,[],!0),i.pointColl=sf.base.extend([],t.pointColl,[],!0),i.afterCropActions=sf.base.extend([],t.afterCropActions,[],!0);var a={selPointColl:null};t.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.updateAdj(e,null),t.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1}),t.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:o,isCircleCrop:null}})},e.prototype.setAdjustment=function(e){var t,o,r=this.lowerContext.filter.split(" ");switch(e){case"brightness":o=r[0].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.brightness=this.setFilterValue(t);break;case"contrast":o=r[1].split("("),t=parseFloat(o[1].split(")")[0]),t/=100,this.adjustmentLevel.contrast=this.setFilterValue(t);break;case"hue":o=r[2].split("("),t=parseFloat(o[1].split(")")[0]),t/=3,this.adjustmentLevel.hue=t;break;case"saturation":o=r[3].split("("),t=parseFloat(o[1].split(")")[0]),t/=100,this.adjustmentLevel.saturation=this.setSaturationFilterValue(t);break;case"opacity":o=r[4].split("("),.45===(t=parseFloat(o[1].split(")")[0]))?t=40:.4===t?t=30:.35===t?t=20:.3===t?t=10:.25===t?t=0:t*=100,this.adjustmentLevel.opacity=t;break;case"blur":o=r[5].split("("),t=parseFloat(o[1].split(")")[0]),t*=20,this.adjustmentLevel.blur=t;break;case"exposure":o=r[0].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.exposure=this.setFilterValue(t)}},e.prototype.setFilterValue=function(e){return Math.round(1===e?0:100*(e-1)/.5)},e.prototype.setSaturationFilterValue=function(e){return Math.round(1===e?0:100*(e-1))},e.prototype.finetuneImage=function(e,t){var o=this.parent;if(!o.disabled&&o.isImageLoaded){switch(e.toLowerCase()){case"brightness":this.setFilterAdj("brightness",t);break;case"contrast":this.setFilterAdj("contrast",t);break;case"hue":this.setFilterAdj("hue",t);break;case"saturation":this.setFilterAdj("saturation",t);break;case"opacity":this.setFilterAdj("opacity",t);break;case"blur":this.setFilterAdj("blur",t);break;case"exposure":this.setFilterAdj("exposure",t)}this.parent.canvasFilter=this.lowerContext.filter,o.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})}},e.prototype.setCurrAdjValue=function(e,t){var o=this.parent;switch(this.parent.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1}),e){case"brightness":this.setFilterAdj("brightness",t);break;case"contrast":this.setFilterAdj("contrast",t);break;case"hue":this.setFilterAdj("hue",t);break;case"saturation":this.setFilterAdj("saturation",t);break;case"opacity":this.setFilterAdj("opacity",t);break;case"blur":this.setFilterAdj("blur",t);break;case"exposure":this.setFilterAdj("exposure",t)}o.isFinetuneBtnClick=!0,o.curFinetuneObjEvent={finetune:o.toPascalCase(e),value:t}},e.prototype.getCurrentObj=function(e){var t=this.parent,o={point:null};t.cropModule.cropping({prop:"getTempFlipPanPoint",value:{obj:o}});var r={previousZoomValue:null};t.transformModule.transform({prop:"getPreviousZoomValue",value:{obj:r}});var i={zoomFactor:null};t.drawModule.draw({prop:"getStraightenInitZoom",value:{obj:i}});var a={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",zoomFactor:0,previousZoomValue:0,straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:this.isBrightnessAdjusted,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:sf.base.extend({},this.tempAdjVal,{},!0),currentFilter:this.tempFilVal};return a.cropZoom=t.transform.cropZoomFactor,a.defaultZoom=t.transform.defaultZoomFactor,a.zoomFactor=t.zoomSettings.zoomFactor,a.previousZoomValue=r.previousZoomValue,a.straightenZoom=i.zoomFactor,a.totalPannedPoint=sf.base.extend({},t.panPoint.totalPannedPoint,{},!0),a.totalPannedClientPoint=sf.base.extend({},t.panPoint.totalPannedClientPoint,{},!0),a.totalPannedInternalPoint=sf.base.extend({},t.panPoint.totalPannedInternalPoint,{},!0),a.tempFlipPanPoint=sf.base.extend({},o.point,{},!0),a.activeObj=sf.base.extend({},t.activeObj,{},!0),a.rotateFlipColl=sf.base.extend([],t.rotateFlipColl,[],!0),a.degree=t.transform.degree,a.straighten=t.cropObj.straighten,a.currFlipState=t.transform.currFlipState,a.destPoints={startX:t.img.destLeft,startY:t.img.destTop,endX:0,endY:0,width:t.img.destWidth,height:t.img.destHeight},a.srcPoints={startX:t.img.srcLeft,startY:t.img.srcTop,endX:0,endY:0,width:t.img.srcWidth,height:t.img.srcHeight},a.filter=this.lowerContext.filter,a.aspectWidth=t.aspectWidth,a.aspectHeight=t.aspectHeight,a.frame=t.frameObj.type,a.frameObj=sf.base.extend({},t.frameObj),e&&(e.currObj=a),a},e}(),C=function(){function e(e){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=!1,this.freehandDownPoint={x:0,y:0},this.isFreehandPointMoved=!1,this.pointCounter=0,this.selPointColl={},this.currFHDIdx=0,this.selPoints=[],this.dummyPoints=[],this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.straightenPointAngle=0,this.parent=e}return e.prototype.draw=function(e){switch(this.updateFhdPvtVar(),e.prop){case"hoverFhd":this.hoverFhd(e.value.strokeColor,e.value.strokeWidth);break;case"freehandDownHandler":this.freehandDownHandler(e.value.e,e.value.canvas);break;case"freehandUpHandler":this.freehandUpHandler(e.value.e,e.value.canvas,e.value.context);break;case"handle-freehand-draw":var t=parseInt(e.value.id.split("_")[1],10)-1;this.isFHDIdx(t)&&this.deleteFhd(t,!0);break;case"freehandRedraw":this.freehandRedraw(e.value.context,e.value.points);break;case"deleteFhd":t=parseInt(e.value.id.split("_")[1],10)-1;this.deleteFhd(t,!0);break;case"selectFhd":t=null;e.value.id&&(t=parseInt(e.value.id.split("_")[1],10)-1),this.selectFhd(t);break;case"applyFhd":this.applyFhd();break;case"cancelFhd":this.cancelFhd();break;case"updateFHDCurPts":this.updateFHDCurPts();break;case"rotateFhdColl":this.rotateFhdColl();break;case"flipFHDColl":this.flipFHDColl(e.value.value);break;case"panFHDColl":this.panFHDColl(e.value.xDiff,e.value.yDiff,e.value.panRegion);break;case"updateFHDColl":e.value&&e.value.isPreventApply?this.updateFHDColl(e.value.isPreventApply):this.updateFHDColl();break;case"zoomFHDColl":this.zoomFHDColl(e.value.isPreventApply);break;case"apply-pen-draw":this.applyPenDraw();break;case"freeHandDraw":this.freeHandDraw(e.value.value);break;case"isFHDIdx":this.isFHDIdx(e.value.index,e.value.obj);break;case"getSqPtFD":this.getSqPtFD(e.value.idx,e.value.obj);break;case"getSelPointColl":e.value.obj.selPointColl=sf.base.extend([],this.selPointColl);break;case"setSelPointColl":this.selPointColl=sf.base.extend([],e.value.obj.selPointColl);break;case"setFreehandDrawHoveredIndex":this.fhdHovIdx=e.value.index;break;case"getFreehandDrawHoveredIndex":e.value.obj.index=this.fhdHovIdx;break;case"setPointCounter":this.pointCounter=e.value.value;break;case"getPenStrokeWidth":e.value.obj.penStrokeWidth=this.penStrokeWidth;break;case"setPenStrokeWidth":this.penStrokeWidth=e.value.value;break;case"getCurrentFreehandDrawIndex":e.value.obj.currentFreehandDrawIndex=this.currFHDIdx;break;case"setCurrentFreehandDrawIndex":this.currFHDIdx=e.value.value;break;case"updateCropPtsForSel":this.updateCropPtsForSel();break;case"getFreehandDrawSelectedId":e.value.obj.freehandDrawSelectedId=this.fhdSelID;break;case"resetFreehandDrawSelectedId":this.fhdSelID=null;break;case"getTempFreeHandDrawEditingStyles":e.value.obj.tempFreeHandDrawEditingStyles=this.tempFHDStyles;break;case"setFreehandSelectedIndex":this.fhdSelIdx=e.value.index;break;case"getFreehandSelectedIndex":e.value.obj.freehandSelectedIndex=this.fhdSelIdx;break;case"setCenterSelPoints":this.setCenterSelPoints();break;case"getStraightenPoint":e.value.obj.straightenPoint=sf.base.extend({},this.straightenPoint,{},!0);break;case"setStraightenPoint":this.straightenPoint.x=e.value.x,this.straightenPoint.y=e.value.y,e.value.ratioX&&e.value.ratioY&&(this.straightenPoint.ratioX=e.value.ratioX,this.straightenPoint.ratioY=e.value.ratioY);break;case"resetStraightenPoint":this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.prevStraightenObj=null,this.straightenPointAngle=0;break;case"getStraightenPointAngle":e.value.obj.angle=this.straightenPointAngle;break;case"reset":this.reset()}},e.prototype.updateFhdPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=this.isFreehandPointMoved=!1,this.selPoints=[],this.dummyPoints=[],this.freehandDownPoint={x:0,y:0},this.selPointColl={},this.straightenPointAngle=0,this.fhdHovIdx=null,this.pointCounter=0,this.fhdSelID=null,this.penStrokeWidth=void 0,this.currFHDIdx=0,this.fhdSelIdx=null,this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.prevStraightenObj=null},e.prototype.getModuleName=function(){return"freehand-draw"},e.prototype.hoverFhd=function(e,t){var o=this.parent,r=this.upperContext,i=-1;i=this.fhdHovIdx>-1?this.fhdHovIdx:this.fhdSelIdx,o.points=sf.base.extend([],o.pointColl[i].points),this.pointCounter=0;var a,s,n,l,h,p,d=o.points.length;r.fillStyle=e||o.pointColl[i].strokeColor,r.strokeStyle=r.fillStyle,h=p=this.penStrokeWidth=t||o.pointColl[i].strokeWidth,1===d&&(a=s=n=l=o.points[0],this.startDraw(r,a,s,n,l,h,p));for(var c=0;c<d-3;c++)o.points[c+1]&&o.points[c+2]&&o.points[c+2]&&(a=this.calcCurveCP(o.points[c+0],o.points[c+1],o.points[c+2]).controlPoint2,s=this.calcCurveCP(o.points[c+1],o.points[c+2],o.points[c+3]).controlPoint1,n=0===c?o.points[c]:o.points[c+1],l=o.points[c+2],this.startDraw(r,a,s,n,l,h,p));r.closePath();var u=this.getSqPtFD(i),v=r.lineWidth;r.lineWidth=2,r.strokeStyle=o.themeColl[o.theme].primaryColor,r.beginPath(),r.rect(u.startX,u.startY,u.width,u.height),r.stroke(),r.closePath(),r.lineWidth=v},e.prototype.freehandDownHandler=function(e,t){var o=this.parent;o.lowerCanvas=document.querySelector("#"+o.element.id+"_lowerCanvas"),this.lowerContext=o.lowerCanvas.getContext("2d"),o.upperCanvas=document.querySelector("#"+o.element.id+"_upperCanvas"),this.upperContext=o.upperCanvas.getContext("2d"),this.fhdObj.time=(new Date).getTime(),this.isFreehandDrawing=!0,"mousedown"===e.type?this.freehandDownPoint={x:e.clientX,y:e.clientY}:this.freehandDownPoint={x:e.touches[0].clientX,y:e.touches[0].clientY},this.isFreehandPointMoved=!1,sf.base.EventHandler.add(t,"mousemove touchmove",this.freehandMoveHandler,this);var i={id:"pen_"+(this.currFHDIdx+1),type:r.FreehandDraw,startX:this.freehandDownPoint.x,startY:this.freehandDownPoint.y,strokeColor:o.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,points:null,index:o.objColl.length+o.freehandCounter+1},a={cancel:!1,action:"draw-start",previousShapeSettings:i,currentShapeSettings:i};this.triggerShapeChanging(a)},e.prototype.freehandUpHandler=function(e,t,o){var i=t.getBoundingClientRect(),a=this.parent;sf.base.EventHandler.remove(t,"mousemove touchmove",this.freehandMoveHandler),0===a.points.length&&("mouseup"===e.type?this.processPoint(e.clientX-i.left,e.clientY-i.top,!0,o):"touchend"===e.type&&e.changedTouches?this.processPoint(e.changedTouches[0].clientX-i.left,e.changedTouches[0].clientY-i.top,!0,o):this.isFreehandPointMoved||this.processPoint(this.freehandDownPoint.x-i.left,this.freehandDownPoint.y-i.top,!0,o)),o.closePath();var s=sf.base.extend({},a.cropObj,{},!0),n={currObj:{}};a.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var l=n.currObj;l.objColl=sf.base.extend([],a.objColl,[],!0),l.pointColl=sf.base.extend([],a.pointColl,[],!0),l.afterCropActions=sf.base.extend([],a.afterCropActions,[],!0);var h={selPointColl:null};a.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),l.selPointColl=sf.base.extend([],h.selPointColl,[],!0);var p=a.freehandCounter,d=a.objColl.length+a.freehandCounter+1;a.pointColl[p]={points:sf.base.extend([],a.points),strokeColor:a.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,flipState:a.transform.currFlipState,id:"pen_"+(this.currFHDIdx+1),order:d},a.points=[],this.dummyPoints=[],this.selPointColl[p]={points:sf.base.extend([],this.selPoints)},this.selPoints=[],this.pointCounter=0,a.freehandCounter++,this.isFreehandDrawing=!1,a.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehand-draw",previousObj:l,previousObjColl:l.objColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:s,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}});var c={id:"pen_"+(this.currFHDIdx+1),type:r.FreehandDraw,startX:this.freehandDownPoint.x,startY:this.freehandDownPoint.y,strokeColor:a.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,points:a.pointColl[this.currFHDIdx].points,index:d},u={cancel:!1,action:"draw-end",previousShapeSettings:c,currentShapeSettings:c};this.triggerShapeChanging(u),this.currFHDIdx++},e.prototype.freehandMoveHandler=function(e){this.isFreehandPointMoved=!0;var t,o,r=this.parent.upperCanvas.getBoundingClientRect();"mousemove"===e.type?(t=e.clientX-r.left,o=e.clientY-r.top):(t=e.touches[0].clientX-r.left,o=e.touches[0].clientY-r.top),this.isFreehandDrawing&&(this.upperContext.fillStyle=this.parent.activeObj.strokeSettings.strokeColor,this.processPoint(t,o,!1,this.upperContext))},e.prototype.processPoint=function(e,t,o,r){var i,a,s,n,l=this.parent,h=this.point(e,t,(new Date).getTime()),p=!!(h=l.points.length>0&&l.points[l.points.length-1])&&this.distanceTo(h)<=5;if(this.selPoints.push({x:e,y:t,ratioX:(e-l.img.destLeft)/l.img.destWidth,ratioY:(t-l.img.destTop)/l.img.destHeight,time:this.fhdObj.time}),!h||!h||!p||o){if(this.fhdObj.time=(new Date).getTime(),l.points.push({x:e,y:t,ratioX:(e-l.img.destLeft)/l.img.destWidth,ratioY:(t-l.img.destTop)/l.img.destHeight,time:this.fhdObj.time}),this.dummyPoints.push({x:e,y:t,ratioX:(e-l.img.destLeft)/l.img.destWidth,ratioY:(t-l.img.destTop)/l.img.destHeight,time:this.fhdObj.time}),this.dummyPoints.length>2){3===this.dummyPoints.length&&this.dummyPoints.unshift(this.dummyPoints[0]);var d=this.dummyPoints[0],c=this.dummyPoints[1],u=this.dummyPoints[2],v=this.dummyPoints[3];i=this.calcCurveCP(d,c,u).controlPoint2,a=this.calcCurveCP(c,u,v).controlPoint1,s=this.dummyPoints[1],n=this.dummyPoints[2];var g=.5,b=5;sf.base.isNullOrUndefined(this.penStrokeWidth)||(g=b=this.penStrokeWidth),this.startDraw(r,i,a,s,n,g,b),this.pointCounter++,this.dummyPoints.shift()}if(o){i=a=s=n={x:e,y:t,time:(new Date).getTime()};g=.5,b=5;sf.base.isNullOrUndefined(this.penStrokeWidth)||(g=b=this.penStrokeWidth),this.startDraw(r,i,a,s,n,g,b)}}},e.prototype.calcCurveCP=function(e,t,o){t||(t=e),o||(o=t);var r=e.x-t.x,i=e.y-t.y,a=t.x-o.x,s=t.y-o.y,n=(e.x+t.x)/2,l=(e.y+t.y)/2,h=(t.x+o.x)/2,p=(t.y+o.y)/2,d=Math.sqrt(r*r+i*i),c=Math.sqrt(a*a+s*s),u=c/(d+c),v=h+(n-h)*u,g=p+(l-p)*u,b=t.x-v,C=t.y-g;return{controlPoint1:this.point(n+b,l+C,0),controlPoint2:this.point(h+b,p+C,0)}},e.prototype.point=function(e,t,o){return this.fhdObj.pointX=e,this.fhdObj.pointY=t,{x:this.fhdObj.pointX,y:this.fhdObj.pointY,time:o}},e.prototype.startDraw=function(e,t,o,r,i,a,s){var n;n=.7*(n=this.pointVelocity(r))+(1-.7)*this.fhdObj.lastVelocity;var l=Math.max(s/1.7,a);this.drawCurve(this.fhdObj.time,l,e,t,o,r,i,s),this.fhdObj.lastVelocity=n,this.fhdObj.time=l},e.prototype.pointVelocity=function(e){return this.fhdObj.time!==e.time?this.distanceTo(e)/(this.fhdObj.time-e.time):0},e.prototype.distanceTo=function(e){return Math.sqrt(Math.pow(this.fhdObj.pointX-e.x,2)+Math.pow(this.fhdObj.pointY-e.y,2))},e.prototype.drawCurve=function(e,t,o,r,i,a,s,n){var l,h,p,d,c,u,v,g,b,C,f=t-e,m=this.bezierLength(r,i,a,s),y=2*Math.ceil(m);for(o.beginPath(),h=0;h<y;h++)c=(d=(p=h/y)*p)*p,b=(g=(v=(u=1-p)*u)*u)*a.x,b+=3*v*p*r.x,b+=3*u*d*i.x,b+=c*s.x,C=g*a.y,C+=3*v*p*r.y,C+=3*u*d*i.y,C+=c*s.y,l=Math.min(e+c*f,n),this.drawArc(b,C,l,o);o.closePath(),o.fill()},e.prototype.bezierLength=function(e,t,o,r){var i,a,s,n,l,h,p,d,c=0;for(i=0;i<=10;i++)a=i/10,s=this.bezierPoint(a,o.x,e.x,t.x,r.x),n=this.bezierPoint(a,o.y,e.y,t.y,r.y),i>0&&(p=s-l,d=n-h,c+=Math.sqrt(p*p+d*d)),l=s,h=n;return c},e.prototype.bezierPoint=function(e,t,o,r,i){return t*(1-e)*(1-e)*(1-e)+3*o*(1-e)*(1-e)*e+3*r*(1-e)*e*e+i*e*e*e},e.prototype.drawArc=function(e,t,o,r){var i=this.parent.img;(e>i.destLeft&&t>i.destTop&&e<i.destLeft+i.destWidth&&t<i.destTop+i.destHeight||r!==this.lowerContext&&r!==this.upperContext)&&(r.moveTo(e,t),r.arc(e,t,o,0,2*Math.PI,!1))},e.prototype.freehandRedraw=function(e,t){var o=this.parent,r=e.filter;if(e.filter="none",t&&(o.pointColl[o.freehandCounter]={points:t,strokeColor:o.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,flipState:o.transform.currFlipState},this.selPointColl[o.freehandCounter]=sf.base.extend({},o.pointColl[o.freehandCounter],{},!0),o.freehandCounter++),o.freehandCounter>0){for(var i=0;i<o.freehandCounter;i++){o.points=sf.base.extend([],o.pointColl[i].points),this.pointCounter=0;var a=o.points.length,s=void 0,n=void 0,l=void 0,h=void 0,p=void 0,d=void 0;a>0&&(e.fillStyle=o.pointColl[i].strokeColor,p=d=this.penStrokeWidth=o.pointColl[i].strokeWidth),1===a&&(s=n=l=h=o.points[0],this.startDraw(e,s,n,l,h,p,d));for(var c=0;c<a-3;c++)o.points[c+1]&&o.points[c+2]&&o.points[c+2]&&(s=this.calcCurveCP(o.points[c+0],o.points[c+1],o.points[c+2]).controlPoint2,n=this.calcCurveCP(o.points[c+1],o.points[c+2],o.points[c+3]).controlPoint1,l=0===c?o.points[c]:o.points[c+1],h=o.points[c+2],this.startDraw(e,s,n,l,h,p,d));e.closePath()}e===this.lowerContext&&(o.drawModule.draw({prop:"applyFrame",value:{ctx:this.lowerContext,frame:o.frameObj.type,preventImg:!0}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height))}e.filter=r},e.prototype.getSqPtFD=function(e,t){var o={startX:0,startY:0,endX:0,endY:0,width:0,height:0},r=sf.base.extend([],this.selPointColl[e].points,[]);this.parent.points=sf.base.extend([],this.parent.pointColl[e].points),this.pointCounter=0;for(var i=r.length,a=0;a<i;a++)0===o.startX&&0===o.startY&&0===o.endX&&0===o.endY?(o.startX=r[a].x,o.startY=r[a].y,o.endX=r[a].x,o.endY=r[a].y):(o.startX=Math.min(o.startX,r[a].x),o.startY=Math.min(o.startY,r[a].y),o.endX=Math.max(o.endX,r[a].x),o.endY=Math.max(o.endY,r[a].y));return o.startX-=this.penStrokeWidth,o.startY-=this.penStrokeWidth,o.endX+=this.penStrokeWidth,o.endY+=this.penStrokeWidth,o.width=o.endX-o.startX,o.height=o.endY-o.startY,t&&(t.activePoint=o),o},e.prototype.applyPenDraw=function(){var e=this.parent;"freehanddraw"===e.currObjType.shape&&(e.shapeModule.shape({prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),e.upperCanvas.style.cursor=e.cursor="default",e.currObjType.shape=""),e.shapeModule.shape({prop:"clearActObj"})},e.prototype.applyFhd=function(){var e=this.parent,t=e.pointColl[this.fhdSelIdx];"#42a5f5"===t.strokeColor&&(t.strokeColor=this.tempFHDStyles.strokeColor),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),t&&(t.isSelected=!1),e.selectionModule.selection({prop:"resetFreehandDrawVariables"}),this.fhdHovIdx=this.fhdSelIdx=null},e.prototype.cancelFhd=function(){var e=this.parent,t=e.pointColl[this.fhdSelIdx];this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.pointCounter=0,t&&(t.strokeColor=this.tempFHDStyles.strokeColor,t.strokeWidth=this.tempFHDStyles.strokeWidth,t.isSelected=!1),this.fhdHovIdx=this.fhdSelIdx=this.fhdSelID=null,e.selectionModule.selection({prop:"resetFreehandDrawVariables"}),e.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor,e.activeObj.strokeSettings.strokeWidth=this.penStrokeWidth=this.tempFHDStyles.strokeWidth,this.tempFHDStyles={strokeColor:null,strokeWidth:null,fillColor:null},e.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),e.updateToolbar(e.element,"imageLoaded")},e.prototype.selectFhd=function(e){var t=this.parent,o=sf.base.extend({},this.tempFHDStyles,{},!0);if(t.selectionModule.selection({prop:"setFreehandDrawEditing",onPropertyChange:!1,value:{bool:!0}}),e||0===e){if(!this.isFHDIdx(e))return;this.fhdSelIdx=this.fhdHovIdx=e,this.hoverFhd(),t.upperCanvas.style.cursor=t.cursor="pointer"}this.fhdSelIdx=this.fhdHovIdx;var i=t.pointColl[this.fhdSelIdx];i.isSelected=!0,this.fhdSelID=i.id,"#42a5f5"!==i.strokeColor&&(t.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor=i.strokeColor),t.activeObj.strokeSettings.strokeWidth=this.tempFHDStyles.strokeWidth=t.pointColl[this.fhdHovIdx].strokeWidth;var a={bool:!1};if(t.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:a}}),a.bool){var s={id:"pen_"+(this.fhdSelIdx+1),type:r.FreehandDraw,startX:i.points[0].x,startY:i.points[0].y,strokeColor:i.strokeColor,strokeWidth:i.strokeWidth,points:i.points,opacity:i.opacity,index:i.order},n={cancel:!1,action:"select",previousShapeSettings:s,currentShapeSettings:s};this.triggerShapeChanging(n)}else t.okBtn(null,!0);t.isUndoRedoStack&&(this.tempFHDStyles=o),t.getShapeValue("pen")},e.prototype.deleteFhd=function(e,t){var o=this.parent;if(this.isFHDIdx(e)){this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height);var r=sf.base.extend({},o.pointColl,{},!0),i=sf.base.extend({},this.selPointColl,{},!0);o.pointColl={},this.selPointColl={};var a=0;if(sf.base.isNullOrUndefined(t))for(var s=0;s<o.freehandCounter;s++)s!==e&&(o.pointColl[a]=r[s],this.selPointColl[a]=i[s],a++);else for(s=0;s<o.freehandCounter;s++)parseInt(r[s].id.split("_")[1],10)-1!==e&&(o.pointColl[a]=r[s],this.selPointColl[a]=i[s],a++);o.freehandCounter-=1,this.fhdHovIdx=this.fhdSelIdx=null,o.selectionModule.selection({prop:"resetFreehandDrawVariables"}),o.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}})}},e.prototype.zoomX=function(e){return e*this.parent.img.destWidth+this.parent.img.destLeft},e.prototype.zoomY=function(e){return e*this.parent.img.destHeight+this.parent.img.destTop},e.prototype.zoomFHDColl=function(e){var t=this.parent,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.shapeModule.shape({prop:"straightenShapes",onPropertyChange:!1});for(var r=0;r<t.freehandCounter;r++){t.points=sf.base.extend([],t.pointColl[r].points,[]),this.pointCounter=0;for(var i=t.points.length,a=0;a<i;a++){var s=t.points[a];s.x=this.zoomX(s.ratioX),s.y=this.zoomY(s.ratioY)}}this.updateFHDCurPts(),this.straightenPoint.x&&this.straightenPoint.y&&(this.straightenPoint.x=this.zoomX(this.straightenPoint.ratioX),this.straightenPoint.y=this.zoomY(this.straightenPoint.ratioY)),0!==t.transform.straighten&&t.shapeModule.shape({prop:"straightenFHD",onPropertyChange:!1}),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height,sf.base.isNullOrUndefined(e)&&this.freehandRedraw(this.lowerContext,null)},e.prototype.updateFHDCurPts=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++)if(this.selPointColl[t]){this.selPoints=sf.base.extend([],this.selPointColl[t].points,[]),this.pointCounter=0;for(var o=this.selPoints.length,r=0;r<o;r++){var i=this.selPoints[r];i.x=this.zoomX(i.ratioX),i.y=this.zoomY(i.ratioY)}}},e.prototype.rotateFhdColl=function(){for(var e=this.parent,t=e.img,o=t.destLeft,r=t.destTop,i=t.destWidth,a=t.destHeight,s=0;s<e.freehandCounter;s++){e.points=sf.base.extend([],e.pointColl[s].points,[]),this.pointCounter=0;for(var n=e.points.length,l=0;l<n;l++){(h=e.points[l]).y=r+a*h.ratioX,h.x=o+i-i*h.ratioY,h.ratioX=(h.x-o)/i,h.ratioY=(h.y-r)/a}}for(s=0;s<e.freehandCounter;s++)if(this.selPointColl[s]){this.selPoints=sf.base.extend([],this.selPointColl[s].points,[]),this.pointCounter=0;for(n=this.selPoints.length,l=0;l<n;l++){var h;(h=this.selPoints[l]).y=r+a*h.ratioX,h.x=o+i-i*h.ratioY,h.ratioX=(h.x-o)/i,h.ratioY=(h.y-r)/a}}this.updateFHDCurPts()},e.prototype.flipFHDColl=function(e){var t=e.toLowerCase();if("horizontal"===t)this.pointsHorizontalFlip();else if("vertical"===t)this.pointsVerticalFlip();else{this.pointsHorizontalFlip();for(var o=0;o<this.parent.freehandCounter;o++)this.parent.pointColl[o].shapeFlip="";this.pointsVerticalFlip()}},e.prototype.pointsHorizontalFlip=function(){for(var e=this.parent,t=e.img,o=t.destLeft,r=t.destTop,i=t.destWidth,a=t.destHeight,s=0;s<e.freehandCounter;s++)if(e.pointColl[s].shapeFlip!==e.transform.currFlipState){e.points=sf.base.extend([],e.pointColl[s].points,[]),this.pointCounter=0;for(var n=e.points.length,l=0;l<n;l++){(h=e.points[l]).x<=o+i/2?h.x=o+i-(h.x-o):h.x>=o+i/2&&(h.x=o+(o+i-h.x)),h.ratioX=(h.x-o)/i,h.ratioY=(h.y-r)/a}e.pointColl[s].shapeFlip=e.transform.currFlipState}for(s=0;s<e.freehandCounter;s++)if(this.selPointColl[s]&&this.selPointColl[s].shapeFlip!==e.transform.currFlipState){this.selPoints=sf.base.extend([],this.selPointColl[s].points,[]),this.pointCounter=0;for(n=this.selPoints.length,l=0;l<n;l++){var h;(h=this.selPoints[l]).x<=o+i/2?h.x=o+i-(h.x-o):h.x>=o+i/2&&(h.x=o+(o+i-h.x)),h.ratioX=(h.x-o)/i,h.ratioY=(h.y-r)/a}}this.updateFHDCurPts()},e.prototype.pointsVerticalFlip=function(){for(var e=this.parent,t=e.img,o=t.destLeft,r=t.destTop,i=t.destWidth,a=t.destHeight,s=0;s<e.freehandCounter;s++)if(e.pointColl[s].shapeFlip!==e.transform.currFlipState){e.points=sf.base.extend([],e.pointColl[s].points,[]),this.pointCounter=0;for(var n=e.points.length,l=0;l<n;l++){(h=e.points[l]).y<=r+a/2?h.y=r+a-(h.y-r):h.y>=r+a/2&&(h.y=r+(r+a-h.y)),h.ratioX=(h.x-o)/i,h.ratioY=(h.y-r)/a}e.pointColl[s].shapeFlip=e.transform.currFlipState}for(s=0;s<e.freehandCounter;s++)if(this.selPointColl[s]&&this.selPointColl[s].shapeFlip!==e.transform.currFlipState){this.selPoints=sf.base.extend([],this.selPointColl[s].points,[]),this.pointCounter=0;for(n=this.selPoints.length,l=0;l<n;l++){var h;(h=this.selPoints[l]).y<=r+a/2?h.y=r+a-(h.y-r):h.y>=r+a/2&&(h.y=r+(r+a-h.y)),h.ratioX=(h.x-o)/i,h.ratioY=(h.y-r)/a}}this.updateFHDCurPts()},e.prototype.updateFHDColl=function(e){var t=this.parent,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.shapeModule.shape({prop:"straightenShapes",onPropertyChange:!1});for(var r=t.img,i=r.destLeft,a=r.destTop,s=r.destWidth,n=r.destHeight,l=0,h=t.objColl.length;l<h;l++){var p=t.objColl[l];if("line"===p.shape||"arrow"===p.shape)t.shapeModule.shape({prop:"straightenShapePoints",value:{obj:p,isReverse:!0}});else if("path"===p.shape){var d=t.transform.straighten;t.transform.straighten=-t.transform.straighten,t.shapeModule.shape({prop:"straightenPath",onPropertyChange:!1,value:{obj:p}}),t.transform.straighten=d}if(p.imageRatio={startX:(p.activePoint.startX-i)/s,startY:(p.activePoint.startY-a)/n,endX:(p.activePoint.endX-i)/s,endY:(p.activePoint.endY-a)/n,width:s/p.activePoint.width,height:n/p.activePoint.height},"path"===p.shape)for(var c=0,u=p.pointColl.length;c<u;c++)p.pointColl[c].ratioX=(p.pointColl[c].x-i)/s,p.pointColl[c].ratioY=(p.pointColl[c].y-a)/n;t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1})}if(t.freehandCounter>0&&0!==t.transform.straighten){d=t.transform.straighten;t.transform.straighten=-t.transform.straighten,t.shapeModule.shape({prop:"straightenFHD",onPropertyChange:!1}),t.transform.straighten=d}for(var v=0;v<t.freehandCounter;v++){t.points=sf.base.extend([],t.pointColl[v].points,[]),this.pointCounter=0;for(var g=t.points.length,b=0;b<g;b++){(C=t.points[b]).ratioX=(C.x-i)/s,C.ratioY=(C.y-a)/n}}for(v=0;v<t.freehandCounter;v++)if(this.selPointColl[v]){this.selPoints=sf.base.extend([],this.selPointColl[v].points,[]),this.pointCounter=0;for(g=this.selPoints.length,b=0;b<g;b++){var C;(C=this.selPoints[b]).ratioX=(C.x-i)/s,C.ratioY=(C.y-a)/n}}this.straightenPoint.x&&this.straightenPoint.y&&(this.straightenPoint.ratioX=(this.straightenPoint.x-i)/s,this.straightenPoint.ratioY=(this.straightenPoint.y-a)/n),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height,t.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:e}})},e.prototype.panFHDColl=function(e,t,o){for(var r=this.parent,i=0;i<r.freehandCounter;i++){r.points=sf.base.extend([],r.pointColl[i].points,[]),this.pointCounter=0;for(var a=r.points.length,s=0;s<a;s++){var n=r.points[s];""===o||"vertical"===o?n.x+=e:n.x-=e,""===o||"horizontal"===o?n.y+=t:n.y-=t}}for(i=0;i<r.freehandCounter;i++)if(this.selPointColl[i]){this.selPoints=sf.base.extend([],this.selPointColl[i].points,[]),this.pointCounter=0;for(a=this.selPoints.length,s=0;s<a;s++){n=this.selPoints[s];""===o||"vertical"===o?n.x+=e:n.x-=e,""===o||"horizontal"===o?n.y+=t:n.y-=t}}this.straightenPoint.x&&this.straightenPoint.y&&(""===o||"vertical"===o?this.straightenPoint.x+=e:this.straightenPoint.x-=e,""===o||"horizontal"===o?this.straightenPoint.y+=t:this.straightenPoint.y-=t),this.freehandRedraw(this.lowerContext,null)},e.prototype.freeHandDraw=function(e){var t=this.parent;if(e){if(t.points=[],this.dummyPoints=[],t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),t.togglePen=!0,t.upperCanvas.style.cursor=t.cursor="crosshair",t.upperCanvas.style.display="block",sf.base.isNullOrUndefined(t.activeObj.strokeSettings)){var o={strokeSettings:{}};t.shapeModule.shape({prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:o}}),t.activeObj.strokeSettings=o.strokeSettings}sf.base.isNullOrUndefined(t.activeObj.strokeSettings.strokeWidth)&&(t.activeObj.strokeSettings.strokeWidth=2),t.updateToolbar(t.element,"pen")}else{t.upperCanvas.style.cursor=t.cursor="default";var r=this.penStrokeWidth;t.shapeModule.shape({prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),t.updateToolbar(t.element,"imageLoaded"),t.selectionModule.selection({prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),this.penStrokeWidth=r}},e.prototype.isFHDIdx=function(e,t){for(var o=!1,r=0;r<this.parent.freehandCounter;r++)if(this.parent.pointColl[r].id&&parseInt(this.parent.pointColl[r].id.split("_")[1],10)-1===e){o=!0;break}return t&&(t.isIndex=o),o},e.prototype.updateCropPtsForSel=function(){for(var e=this.parent,t=e.activeObj.activePoint,o=0;o<e.freehandCounter;o++){var r={selPointColl:sf.base.extend([],this.selPointColl)};if(r.selPointColl[o]){this.selPoints=sf.base.extend([],r.selPointColl[o].points,[]),this.pointCounter=0;for(var i=this.selPoints.length,a=0;a<i;a++){var s=this.selPoints[a];s.ratioX=(s.x-t.startX)/t.width,s.ratioY=(s.y-t.startY)/t.height}}}},e.prototype.triggerShapeChanging=function(e){var t=this,o=this.parent,r=o.pointColl[this.fhdSelIdx];if(o.events&&!0===o.events.shapeChanging.hasDelegate)o.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",e,null).then((function(e){if(-1===e.currentShapeSettings.id.indexOf("pen_")&&("draw-end"===e.action||"select"===e.action)){var i="pen_"+e.currentShapeSettings.id;t.fhdSelIdx?o.pointColl[t.fhdSelIdx].id=i:o.pointColl[o.freehandCounter-1].id=i}if(t.penStrokeWidth=e.currentShapeSettings.strokeWidth,o.activeObj.strokeSettings.strokeColor!==e.currentShapeSettings.strokeColor){o.activeObj.strokeSettings.strokeColor=e.currentShapeSettings.strokeColor;var a=o.element.querySelector(".e-ie-toolbar-e-pen-color .e-dropdownbtn-preview");a&&(a.style.background=e.currentShapeSettings.strokeColor)}t.fhdSelID&&r&&e.currentShapeSettings&&(r.strokeColor=e.currentShapeSettings.strokeColor,r.strokeWidth=e.currentShapeSettings.strokeWidth,r.points=e.currentShapeSettings.points,r.opacity=e.currentShapeSettings.opacity),"select"===e.action&&(t.freehandRedraw(t.upperContext),o.updateToolbar(o.element,"imageLoaded"),o.updateToolbar(o.element,"pen"))}));else{if(-1===e.currentShapeSettings.id.indexOf("pen_")&&("draw-end"===e.action||"select"===e.action)){var i="pen_"+e.currentShapeSettings.id;this.fhdSelIdx?o.pointColl[this.fhdSelIdx].id=i:o.pointColl[o.freehandCounter-1].id=i}this.penStrokeWidth=e.currentShapeSettings.strokeWidth,o.activeObj.strokeSettings.strokeColor!==e.currentShapeSettings.strokeColor&&(o.activeObj.strokeSettings.strokeColor=e.currentShapeSettings.strokeColor),this.fhdSelID&&r&&e.currentShapeSettings&&(r.strokeColor=e.currentShapeSettings.strokeColor,r.strokeWidth=e.currentShapeSettings.strokeWidth,r.points=e.currentShapeSettings.points,r.opacity=e.currentShapeSettings.opacity),"select"===e.action&&this.freehandRedraw(this.upperContext)}},e.prototype.setCenterSelPoints=function(){var e=this.parent,t={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};e.shapeModule.shape({prop:"straightenShapes",onPropertyChange:!1});var o=e.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight,n=e.activeObj.activePoint;(sf.base.isNullOrUndefined(this.prevStraightenObj)||JSON.stringify(this.prevStraightenObj.activePoint)!==JSON.stringify(n))&&(this.straightenPoint={x:n.startX+n.width/2,y:n.startY+n.height/2,ratioX:(n.startX+n.width/2-r)/a,ratioY:(n.startY+n.height/2-i)/s},this.prevStraightenObj=sf.base.extend({},e.activeObj,{},!0),this.straightenPointAngle=e.transform.straighten),e.img.destLeft=t.startX,e.img.destTop=t.startY,e.img.destWidth=t.width,e.img.destHeight=t.height},e}(),f=function(){function e(e){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=!1,this.isObjSelected=!1,this.isFhdPoint=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.isShapeInserted=!1,this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null},this.isFirstMove=!1,this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.cursorTargetId="",this.isPreventDragging=!1,this.dragElement="",this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.isFhdEditing=!1,this.currentDrawingShape="",this.initialPrevObj={},this.touchTime=0,this.resizedElement="",this.isImageClarity=!0,this.isPinching=!1,this.isSliding=!1,this.mouseDown="",this.isSliderActive=!1,this.preventDrag=!1,this.arrowShape=[h.None,h.SolidArrow],this.parent=e}return e.prototype.selection=function(e){var t=this.parent;switch(this.updatePrivateVariables(),e.prop){case"setCursor":this.setCursor(e.value.x,e.value.y);break;case"updateActivePoint":this.updateActivePoint(e.value.x,e.value.y,e.value.isCropSelection);break;case"updateCursorStyles":this.updateCursorStyles(e.value.x,e.value.y,e.value.type);break;case"setTextSelection":this.setTextSelection(e.value.width,e.value.height);break;case"setActivePoint":this.setActivePoint(e.value.startX,e.value.startY);break;case"clearSelection":this.clearSelection(e.value.resetCrop);break;case"calcShapeRatio":this.calcShapeRatio(e.value.x,e.value.y,e.value.imgWidth,e.value.imgHeight);break;case"tab":this.performTabAction();break;case"setDragDirection":this.setDragDirection(e.value.width,e.value.height);break;case"clearUpperCanvas":this.isTouch&&setTimeout((function(){t.upperCanvas.getContext("2d").clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height)}),550);break;case"resetFreehandDrawVariables":this.isFhdEditing=this.isFhdPoint=!1;break;case"isShapeInserted":this.isShapeInserted=e.value.bool;break;case"redrawShape":this.redrawShape(e.value.obj);break;case"setTextBoxStylesToActObj":this.setTextBoxStylesToActObj();break;case"mouseDownEventHandler":this.mouseDownEventHandler(e.value.e);break;case"mouseMoveEventHandler":this.mouseMoveEventHandler(e.value.e);break;case"mouseUpEventHandler":this.mouseUpEventHandler(e.value.e);break;case"canvasMouseDownHandler":this.canvasMouseDownHandler(e.value.e);break;case"canvasMouseMoveHandler":this.canvasMouseMoveHandler(e.value.e);break;case"canvasMouseUpHandler":this.canvasMouseUpHandler(e.value.e);break;case"touchStartHandler":this.touchStartHandler(e.value.e);break;case"keyDownEventHandler":this.keyDownEventHandler(e.value.e);break;case"handleScroll":this.handleScroll(e.value.e);break;case"textKeyDown":setTimeout(this.textKeyDown.bind(this),1,e.value.e);break;case"deleteItem":this.deleteItem();break;case"updatePrevShapeSettings":this.updatePrevShapeSettings(e.value.obj);break;case"getZoomType":e.value.obj.zoomType=this.zoomType;break;case"setZoomType":this.zoomType=e.value.zoomType;break;case"setInitialTextEdit":this.isInitialTextEdited=e.value.bool;break;case"setDragCanvas":this.dragCanvas=e.value.bool;break;case"setFreehandDrawCustomized":this.isFhdCustomized=e.value.isFreehandDrawCustomized;break;case"setTouchEndPoint":this.touchEndPoint.x=e.value.x,this.touchEndPoint.y=e.value.y;break;case"getPanDown":e.value.obj.panDown=this.panDown;break;case"setPanDown":this.panDown=e.value.panDown;break;case"getFreehandDrawEditing":e.value.obj.bool=this.isFhdEditing;break;case"setFreehandDrawEditing":this.isFhdEditing=e.value.bool;break;case"getTempActObj":e.value.obj.tempObj=this.tempActiveObj;break;case"setTempActObj":this.tempActiveObj=e.value.obj;break;case"isInside":this.isInside(e.value.x,e.value.y,e.value.z1,e.value.z2,e.value.z3,e.value.z4);break;case"setDragElement":this.dragElement=e.value.value;break;case"setObjSelected":this.isObjSelected=e.value.bool;break;case"adjustActObjForLineArrow":this.adjustActObjForLineArrow(e.value.obj);break;case"findTarget":this.findTarget(e.value.x,e.value.y,e.value.type);break;case"getCurrentFlipState":this.getCurrentFlipState();break;case"setDragWidth":this.setDragWidth(e.value.width);break;case"setDragHeight":this.setDragHeight(e.value.setDragHeight);break;case"annotate":this.currentDrawingShape=e.value.shape,"text"===e.value.shape?(t.activeObj.textSettings.fontSize=11,t.activeObj.keyHistory="Enter Text",t.shapeModule.shape({prop:"initializeTextShape",onPropertyChange:!1,value:{text:null,fontFamily:null,fontSize:null,bold:null,italic:null,strokeColor:null}})):"path"===e.value.shape&&(t.activeObj.pointColl=[]);break;case"getCurrentDrawingShape":e.value.obj.shape=this.currentDrawingShape;break;case"setCurrentDrawingShape":this.currentDrawingShape=e.value.value;break;case"getTransRotationPoint":this.getTransRotationPoint(e.value.obj,e.value.object);break;case"adjustNEPoints":this.adjustNEPoints(e.value.rectangle,e.value.x,e.value.y,e.value.angle);break;case"adjustRotationPoints":this.adjustRotationPoints(e.value.rectangle,e.value.x,e.value.y,e.value.angle,e.value.type,e.value.elem);break;case"getResizeDirection":this.getResizeDirection(e.value.rectangle,e.value.x,e.value.y,e.value.angle);break;case"setResizedElement":this.resizedElement=e.value.value;break;case"reset":this.reset();break;case"unWireEvent":this.unwireEvent();break;case"updPtCollForShpRot":this.updPtCollForShpRot(e.value.obj);break;case"findImageRatio":this.findImageRatio(e.value.width,e.value.height,e.value.obj);break;case"getNumTextValue":this.getNumTextValue(e.value.obj);break;case"setImageClarity":this.isImageClarity=e.value.bool;break;case"upgradeImageQuality":this.upgradeImageQuality();break;case"triggerShapeChange":this.triggerShapeChange(e.value.shapeResizingArgs,e.value.shapeMovingArgs,e.value.type);break;case"applyTransformToImg":this.applyTransformToImg(e.value.ctx);break;case"findTargetObj":e.value.obj.bool=this.findTargetObj(e.value.x,e.value.y,e.value.isCrop);break;case"setSliding":this.isSliding=e.value.bool;break;case"setSliderActive":this.isSliderActive=e.value.bool;break;case"getArrowType":e.value.obj.type=this.getArrowType(e.value.type);break;case"setArrowShape":"initial"===e.value.type?this.arrowShape[0]=e.value.shape:this.arrowShape[1]=e.value.shape}},e.prototype.getModuleName=function(){return"selection"},e.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=this.isObjSelected=this.isFhdPoint=this.isShapeInserted=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null},this.isFirstMove=!1,this.cursorTargetId=this.dragElement="",this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.isPreventDragging=!1,this.timer=void 0,this.tempObjColl=void 0,this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=this.isPinching=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.panDown=null,this.isSliding=!1,this.isFhdEditing=!1,this.pathAdjustedIndex=null,this.touchTime=0,this.isImageClarity=!0,this.currentDrawingShape="",this.initialPrevObj={},this.resizedElement="",this.mouseDown="",this.isSliderActive=!1,this.arrowShape=[h.None,h.SolidArrow]},e.prototype.performTabAction=function(){var e=this.parent;if("block"===e.textArea.style.display||"inline-block"===e.textArea.style.display){var t=this.applyCurrShape(!1);e.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),t&&e.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})}},e.prototype.selMouseUpEvent=function(){this.oldPoint.x=void 0,this.oldPoint.y=void 0},e.prototype.getMouseCursor=function(e,t,o,r,i){var a=this.getTransRotationPoint(e),s=e.bottomCenterCircle.radius,n=i?0:2*e.topLeftCircle.radius;return t>=e.topLeftCircle.startX-n&&t<=e.topLeftCircle.startX+n&&o>=e.topLeftCircle.startY-n&&o<=e.topLeftCircle.startY+n?"nw-resize":t>=e.topLeftCircle.startX-n&&t<=e.topRightCircle.startX-n&&o>=e.topCenterCircle.startY-n&&o<=e.topCenterCircle.startY+n?"n-resize":t>=e.topRightCircle.startX-n&&t<=e.topRightCircle.startX+n&&o>=e.topRightCircle.startY-n&&o<=e.topRightCircle.startY+n?"ne-resize":t>=e.centerLeftCircle.startX-n&&t<=e.centerLeftCircle.startX+n&&o>=e.topLeftCircle.startY-n&&o<=e.bottomLeftCircle.startY-n?"w-resize":t>=e.centerRightCircle.startX-n&&t<=e.centerRightCircle.startX+n&&o>=e.topRightCircle.startY-n&&o<=e.bottomRightCircle.startY-n?"e-resize":t>=e.bottomLeftCircle.startX-n&&t<=e.bottomLeftCircle.startX+n&&o>=e.bottomLeftCircle.startY-n&&o<=e.bottomLeftCircle.startY+n?"sw-resize":t>=e.bottomLeftCircle.startX-n&&t<=e.bottomRightCircle.startX-n&&o>=e.bottomCenterCircle.startY-n&&o<=e.bottomCenterCircle.startY+n?"s-resize":t>=e.bottomRightCircle.startX-n&&t<=e.bottomRightCircle.startX+n&&o>=e.bottomRightCircle.startY-n&&o<=e.bottomRightCircle.startY+n?"se-resize":t>=e.activePoint.startX&&t<=e.activePoint.endX&&o>=e.activePoint.startY&&o<=e.activePoint.endY?r?"grab":"move":a&&!i&&t>=a.x-(s+2)&&t<=a.x+(s+2)&&o>=a.y-(s+2)&&o<=a.y+(s+2)?"grabbing":"default"},e.prototype.setCursor=function(e,t){var o=this.parent;o.upperCanvas.style.cursor=o.cursor="default";if(o.isResize||this.isSliding)o.upperCanvas.style.cursor="default";else{if(o.currObjType.isDragging)""===this.dragElement?o.upperCanvas.style.cursor=o.cursor="move":o.upperCanvas.style.cursor=o.cursor=this.dragElement;else if(o.togglePen)o.upperCanvas.style.cursor=o.cursor="crosshair";else{if(o.activeObj.shape&&this.setCursorForActObj(void 0,!1,e,t),"default"===o.cursor||"grab"===o.cursor){for(var r=this.getHighestOrder(),i=sf.base.extend([],o.shapeColl,[],!0),a=sf.base.extend([],o.objColl,[],!0),s=!1;r>0;){s=!1;for(var n=i.length-1;n>=0;n--)if(i[n].order===r)if(s=!0,i[n].id&&i[n].id.indexOf("pen")>-1){if(o.pointColl[0]&&(o.cursor,1)&&!o.currObjType.isDragging&&!o.currObjType.isResize){var l=sf.base.extend([],o.points,[],!0);this.setCursorForFreehandDrawing(e,t,o.upperCanvas,i[n].id),o.points=l}}else{o.objColl=[],o.objColl.push(sf.base.extend({},i[n],null,!0));var h=o.upperCanvas.style.cursor;o.objColl.length>0&&(o.cursor,1)&&this.setCursorFromObj(e,t,o.objColl,o.upperCanvas,!1),"grab"===h&&"default"===o.cursor&&(o.upperCanvas.style.cursor=o.cursor="grab")}else sf.base.isNullOrUndefined(i[n].order)&&(s=!0);if("default"!==o.cursor&&"grab"!==o.cursor)break;if(s)for(var p=!1;!p&&r>0;){for(var d=0;d<i.length;d++)if(i[d].order===r-1){p=!0;break}r--,p||r--}}o.objColl=a,"default"!==o.cursor&&"grab"!==o.cursor||o.togglePan&&(o.lowerCanvas.style.cursor=o.upperCanvas.style.cursor=o.cursor="grab")}""===this.currentDrawingShape||"default"!==o.cursor&&"grab"!==o.cursor||(o.upperCanvas.style.cursor=o.cursor="crosshair")}}},e.prototype.getHighestOrder=function(){for(var e=0,t=0;t<this.parent.shapeColl.length;t++)this.parent.shapeColl[t].order>e&&(e=this.parent.shapeColl[t].order);return e},e.prototype.setCursorForActObj=function(e,t,o,r){var i=this.parent;if(void 0!==i.activeObj.horTopLine){void 0!==i.activeObj.shape&&(e=i.activeObj.shape.split("-")),(void 0===e&&i.currObjType.isCustomCrop||void 0!==e&&"crop"===e[0])&&(t=!0),!t&&i.togglePan&&(i.lowerCanvas.style.cursor=i.upperCanvas.style.cursor=i.cursor="grab");var a=i.upperCanvas.style.cursor,s=sf.base.extend({},i.activeObj,{},!0);this.cursorTargetId=s.currIndex;var n=void 0;if((n=0===s.shapeDegree?i.transform.degree:i.transform.degree-s.shapeDegree)<0&&(n=360+n),"line"===s.shape||"arrow"===s.shape)this.setCursorForLineArrow(s,o,r,i.upperCanvas);else if("path"===s.shape)this.setCursorForPath(s,o,r,i.upperCanvas);else if(sf.base.isNullOrUndefined(s.rotatedAngle)||0===s.rotatedAngle){i.upperCanvas.style.cursor=i.cursor=this.getMouseCursor(s,o,r,t,!1);"text"===s.shape&&["n-resize","s-resize","e-resize","w-resize"].indexOf(i.cursor)>-1&&(i.upperCanvas.style.cursor=i.cursor="move")}else this.setCursorForRotatedObject(s,o,r,i.upperCanvas);"default"===a&&"default"===i.cursor&&t&&(i.upperCanvas.style.cursor=i.cursor="grab"),"grab"===a&&"default"===i.cursor&&(i.upperCanvas.style.cursor=i.cursor="grab")}else i.togglePan&&!i.togglePen?i.lowerCanvas.style.cursor=i.upperCanvas.style.cursor=i.cursor="grab":i.currObjType.isCustomCrop||i.togglePen?i.upperCanvas.style.cursor=i.cursor="crosshair":i.upperCanvas.style.cursor=i.cursor="default"},e.prototype.setCursorForPath=function(e,t,o,r){this.setCursorForLineArrow(e,t,o,r);var i=this.parent;if("default"===i.cursor)for(var a=sf.base.extend({},e,null,!0),s=!1,n=1,l=e.pointColl.length;n<l&&!s;n++){a.activePoint.startX=e.pointColl[n-1].x,a.activePoint.startY=e.pointColl[n-1].y,a.activePoint.endX=e.pointColl[n].x,a.activePoint.endY=e.pointColl[n].y,i.shapeModule.shape({prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:a}});for(var h=e.topLeftCircle.radius,p=0,d=a.pointColl.length;p<d;p++){var c=a.pointColl[p];if(!sf.base.isNullOrUndefined(c.x-2*h)&&!sf.base.isNullOrUndefined(c.x+2*h)&&!sf.base.isNullOrUndefined(c.y-2*h)&&!sf.base.isNullOrUndefined(c.y+2*h)&&t>=c.x-2*h&&t<=c.x+2*h&&o>=c.y-2*h&&o<=c.y+2*h){r.style.cursor=i.cursor="move",s=!0;break}r.style.cursor=i.cursor="default"}}return i.cursor},e.prototype.setCursorForLineArrow=function(e,t,o,r){var i,a=e.topLeftCircle.radius;if(sf.base.isNullOrUndefined(e.pointColl))return i;for(var s=0,n=e.pointColl.length;s<n;s++){var l=e.pointColl[s];if(t>=l.x-2*a&&t<=l.x+2*a&&o>=l.y-2*a&&o<=l.y+2*a){r.style.cursor=this.parent.cursor="move",i=s;break}r.style.cursor=this.parent.cursor="default"}return i},e.prototype.setCursorForRotatedObject=function(e,t,o,r){this.resizedElement="";var i=this.parent,a=e.bottomCenterCircle.radius,s=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length/2)],n=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length-1)],l=e.verLeftLinePointColl[Math.round(e.verLeftLinePointColl.length/2)],h=e.verRightLinePointColl[Math.round(e.verRightLinePointColl.length/2)],p=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length/2)],d=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length-1)],c=e.rotationCirclePointColl,u=e.horTopLinePointColl[0],v=e.horBottomLinePointColl[0];if(t>=u.x-(a+2)&&t<=u.x+(a+2)&&o>=u.y-(a+2)&&o<=u.y+(a+2))r.style.cursor=i.cursor="nw-resize";else if(t>=s.x-5&&t<=s.x+5&&o>=s.y-5&&o<=s.y+5)r.style.cursor=i.cursor=this.resizedElement="n-resize";else if(t>=n.x-(a+2)&&t<=n.x+(a+2)&&o>=n.y-(a+2)&&o<=n.y+(a+2))r.style.cursor=i.cursor="ne-resize";else if(t>=l.x-5&&t<=l.x+5&&o>=l.y-5&&o<=l.y+5)r.style.cursor=i.cursor=this.resizedElement="w-resize";else if(t>=h.x-5&&t<=h.x+5&&o>=h.y-5&&o<=h.y+5)r.style.cursor=i.cursor=this.resizedElement="e-resize";else if(t>=v.x-(a+2)&&t<=v.x+(a+2)&&o>=v.y-(a+2)&&o<=v.y+(a+2))r.style.cursor=i.cursor="sw-resize";else if(t>=p.x-5&&t<=p.x+5&&o>=p.y-5&&o<=p.y+5)r.style.cursor=i.cursor=this.resizedElement="s-resize";else if(t>=d.x-(a+2)&&t<=d.x+(a+2)&&o>=d.y-(a+2)&&o<=d.y+(a+2))r.style.cursor=i.cursor="se-resize";else if(c&&t>=c.x-(a+2)&&t<=c.x+(a+2)&&o>=c.y-(a+2)&&o<=c.y+(a+2))r.style.cursor=i.cursor="grabbing";else{r.style.cursor=i.cursor="default",this.getRectanglePoints(e.activePoint.startX,e.activePoint.startY,e.activePoint.width,e.activePoint.height,e.rotatedAngle*(180/Math.PI),t,o)&&(r.style.cursor=i.cursor="move")}if("default"===i.cursor)for(var g=0,b=e.horTopLinePointColl.length;g<b;g++){var C=e.horTopLinePointColl[g];if(t>=C.x-5&&t<=C.x+5&&o>=C.y-5&&o<=C.y+5){r.style.cursor=i.cursor=this.resizedElement="n-resize";break}}if("default"===i.cursor)for(g=0,b=e.horBottomLinePointColl.length;g<b;g++){var f=e.horBottomLinePointColl[g];if(t>=f.x-5&&t<=f.x+5&&o>=f.y-5&&o<=f.y+5){r.style.cursor=i.cursor=this.resizedElement="s-resize";break}}if("default"===i.cursor)for(g=0,b=e.verLeftLinePointColl.length;g<b;g++){var m=e.verLeftLinePointColl[g];if(t>=m.x-5&&t<=m.x+5&&o>=m.y-5&&o<=m.y+5){r.style.cursor=i.cursor=this.resizedElement="w-resize";break}}if("default"===i.cursor)for(g=0,b=e.verRightLinePointColl.length;g<b;g++){var y=e.verRightLinePointColl[g];if(t>=y.x-5&&t<=y.x+5&&o>=y.y-5&&o<=y.y+5){r.style.cursor=i.cursor=this.resizedElement="e-resize";break}}return this.adjustCursorStylesForRotatedState(e),i.cursor},e.prototype.adjustCursorStylesForRotatedState=function(e){var t=this.parent,o=e.rotatedAngle*(180/Math.PI);if((o=o>0?Math.floor(o):Math.ceil(o))>=92&&o<=182||o>=-178&&o<=-88){var r={"nw-resize":"ne-resize","n-resize":"s-resize","ne-resize":"nw-resize","w-resize":"e-resize","e-resize":"w-resize","sw-resize":"se-resize","s-resize":"n-resize","se-resize":"sw-resize"};t.cursor in r&&(t.cursor=r[t.cursor])}return t.upperCanvas.style.cursor=this.getResizeElement(e.rotatedAngle*(180/Math.PI),t.cursor),t.cursor},e.prototype.getResizeElement=function(e,t){var o=[];switch(t){case"nw-resize":o=[[337.5,22.5,"nw-resize"],[22.5,67.5,"n-resize"],[67.5,112.5,"ne-resize"],[112.5,157.5,"e-resize"],[157.5,202.5,"se-resize"],[202.5,247.5,"s-resize"],[247.5,292.5,"sw-resize"],[292.5,337.5,"w-resize"]];break;case"n-resize":o=[[337.5,22.5,"n-resize"],[22.5,67.5,"ne-resize"],[67.5,112.5,"e-resize"],[112.5,157.5,"se-resize"],[157.5,202.5,"s-resize"],[202.5,247.5,"sw-resize"],[247.5,292.5,"w-resize"],[292.5,337.5,"nw-resize"]];break;case"ne-resize":o=[[337.5,22.5,"ne-resize"],[22.5,67.5,"e-resize"],[67.5,112.5,"se-resize"],[112.5,157.5,"s-resize"],[157.5,202.5,"sw-resize"],[202.5,247.5,"w-resize"],[247.5,292.5,"nw-resize"],[292.5,337.5,"n-resize"]];break;case"e-resize":o=[[337.5,22.5,"e-resize"],[22.5,67.5,"se-resize"],[67.5,112.5,"s-resize"],[112.5,157.5,"sw-resize"],[157.5,202.5,"w-resize"],[202.5,247.5,"nw-resize"],[247.5,292.5,"n-resize"],[292.5,337.5,"ne-resize"]];break;case"se-resize":o=[[337.5,22.5,"se-resize"],[22.5,67.5,"s-resize"],[67.5,112.5,"sw-resize"],[112.5,157.5,"w-resize"],[157.5,202.5,"nw-resize"],[202.5,247.5,"n-resize"],[247.5,292.5,"ne-resize"],[292.5,337.5,"e-resize"]];break;case"s-resize":o=[[337.5,22.5,"s-resize"],[22.5,67.5,"sw-resize"],[67.5,112.5,"w-resize"],[112.5,157.5,"nw-resize"],[157.5,202.5,"n-resize"],[202.5,247.5,"ne-resize"],[247.5,292.5,"e-resize"],[292.5,337.5,"se-resize"]];break;case"sw-resize":o=[[337.5,22.5,"sw-resize"],[22.5,67.5,"w-resize"],[67.5,112.5,"nw-resize"],[112.5,157.5,"n-resize"],[157.5,202.5,"ne-resize"],[202.5,247.5,"e-resize"],[247.5,292.5,"se-resize"],[292.5,337.5,"s-resize"]];break;case"w-resize":o=[[337.5,22.5,"w-resize"],[22.5,67.5,"nw-resize"],[67.5,112.5,"n-resize"],[112.5,157.5,"ne-resize"],[157.5,202.5,"e-resize"],[202.5,247.5,"se-resize"],[247.5,292.5,"s-resize"],[292.5,337.5,"sw-resize"]]}for(var r=e<0?360-Math.abs(e):e,i=0,a=o;i<a.length;i++){var s=a[i],n=s[0],l=s[1],h=s[2];if(r>n&&r<=l||r+360>n&&r+360<=l)return h}return t},e.prototype.setCursorForFreehandDrawing=function(e,t,o,r){var i,a=o.getContext("2d"),s=this.parent,n=document.querySelector("#"+s.element.id+"_textArea"),l=!1;s.freeHandDrawModule.draw({prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:-1}});for(var h=0;h<s.freehandCounter;h++)if(!r||r===s.pointColl[h].id){var p={selPointColl:{}};s.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:p}}),i=sf.base.extend([],p.selPointColl[h].points,[]),s.points=sf.base.extend([],s.pointColl[h].points,[]);var d=s.pointColl[h];s.freeHandDrawModule.draw({prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});for(var c=i.length,u=0;u<c;u++)if(0!==u){var v=!1;if(i[u-1]&&i[u]&&(v=this.isInside(e,t,i[u-1].x,i[u-1].y,i[u].x,i[u].y)),v){this.isFhdPoint=!0,s.freeHandDrawModule.draw({prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:h}}),s.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.style.cursor=s.cursor="pointer",l=!0;break}if(!this.isFhdEditing||d.isSelected){if((this.isFhdPoint||this.isFhdEditing)&&(a.clearRect(0,0,o.width,o.height),s.activeObj.shape&&"none"===n.style.display&&s.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:s.activeObj}})),this.isFhdEditing){var g={freehandSelectedIndex:-1};s.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:g}});var b=s.pointColl[g.freehandSelectedIndex].strokeColor,C=s.pointColl[g.freehandSelectedIndex].strokeWidth;s.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:b,strokeWidth:C}})}else s.freeHandDrawModule.draw({prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:null}});this.isFhdPoint=!1}}else{var f=s.points[u];if(e>f.x-d.strokeWidth&&e<f.x+d.strokeWidth&&t>f.y-d.strokeWidth&&t<f.y+d.strokeWidth){this.isFhdPoint=!0,s.freeHandDrawModule.draw({prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:h}}),s.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.style.cursor=s.cursor="pointer",l=!0;break}if(!this.isFhdEditing||d.isSelected){if((this.isFhdPoint||this.isFhdEditing)&&(a.clearRect(0,0,o.width,o.height),s.activeObj.shape&&"none"===n.style.display&&s.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:s.activeObj}})),this.isFhdEditing){g={freehandSelectedIndex:-1};s.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:g}});b=s.pointColl[g.freehandSelectedIndex].strokeColor,C=s.pointColl[g.freehandSelectedIndex].strokeWidth;s.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:b,strokeWidth:C}})}this.isFhdPoint=!1}}if(l)break}},e.prototype.setCursorFromObj=function(e,t,o,r,i){for(var a=this.parent,s=0,n=o.length;s<n;s++){if("move"===a.cursor)return;var l=sf.base.extend({},o[s],{},!0);if(0===l.activePoint.width&&0===l.activePoint.height)return void o.splice(s,1);this.cursorTargetId=l.currIndex,"line"===l.shape||"arrow"===l.shape?this.setCursorForLineArrow(l,e,t,r):"path"===l.shape?this.setCursorForPath(l,e,t,r):sf.base.isNullOrUndefined(l.rotatedAngle)||0===l.rotatedAngle?r.style.cursor=a.cursor=this.getMouseCursor(l,e,t,i,!0):this.setCursorForRotatedObject(l,e,t,r)}},e.prototype.isInside=function(e,t,o,r,i,a){var s=Math.min(o,i),n=Math.max(o,i),l=Math.min(r,a),h=Math.max(r,a);return s<=e&&e<=n&&l<=t&&t<=h},e.prototype.updateActivePoint=function(e,t,o){var r=this.parent,i={width:0,height:0},a=r.activeObj.activePoint,s=a.startX,n=a.startY,l=a.endX,h=a.endY,p=r.activeObj.activePoint,d=p.width,c=p.height;r.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:d,height:c,obj:i,isImgShape:null}});var u,v=i,g=this.updatePrevShapeSettings(),b={cancel:!1,action:"resize",previousShapeSettings:g},C={cancel:!1,action:"move",previousShapeSettings:g};if(this.shapeResizingArgs=b,this.shapeMovingArgs=C,"text"===r.activeObj.shape&&""!==this.dragElement&&r.shapeModule.shape({prop:"updateFontRatio",onPropertyChange:!1,value:{obj:r.activeObj,isTextArea:null}}),""!==this.currentDrawingShape&&(""===this.dragElement||"move"===this.dragElement)&&r.isShapeDrawing){["line","arrow","path"].indexOf(r.activeObj.shape)>-1?this.dragElement="e-resize":e>s&&t>n?this.dragElement="se-resize":e<s&&t>n?this.dragElement="sw-resize":e>s&&t<n?this.dragElement="ne-resize":e<s&&t<n&&(this.dragElement="nw-resize")}"arrow"===r.activeObj.shape&&(Math.atan2(e-r.lowerCanvas.width/2,t-r.lowerCanvas.height/2)>0?r.activeObj.rotatedAngle=-Math.atan2(e-r.lowerCanvas.width/2,t-r.lowerCanvas.height/2):r.activeObj.rotatedAngle=Math.abs(Math.atan2(e-r.lowerCanvas.width/2,t-r.lowerCanvas.height/2)));var f=!1,m=!1;if(!o||0===r.transform.straighten||!this.isMouseOutsideImg(e,t))switch(this.dragElement.toLowerCase()){case"nw-resize":this.updateNWPoints(e,t,v),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"n-resize":this.updateNPoints(e,t),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"ne-resize":this.updateNEPoints(e,t,v),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"w-resize":this.updateWPoints(e,t),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"e-resize":this.updateEPoints(e,t),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"sw-resize":this.updateSWPoints(e,t,v),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"s-resize":this.updateSPoints(e,t),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"se-resize":this.updateSEPoints(e,t,v),r.shapeModule.shape({prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(b,C,"resize");break;case"grabbing":Math.atan2(e-(s+d/2),t-(n+c/2))>0?r.activeObj.rotatedAngle=-Math.atan2(e-(s+d/2),t-(n+c/2)):r.activeObj.rotatedAngle=Math.abs(Math.atan2(e-(s+d/2),t-(n+c/2))),(u=0===r.activeObj.shapeDegree?r.transform.degree:r.transform.degree-r.activeObj.shapeDegree)<0&&(u=360+u);for(var y=0,w=r.activeObj.flipObjColl.length;y<w;y++)"horizontal"===r.activeObj.flipObjColl[y].toLowerCase()?f=!0:"vertical"===r.activeObj.flipObjColl[y].toLowerCase()&&(m=!0);r.activeObj.rotatedAngle-=u*(Math.PI/180),0===u||360===u?m&&(r.activeObj.rotatedAngle-=Math.PI/180*180):90===u||-270===u?f&&(r.activeObj.rotatedAngle-=Math.PI/180*180):180===u||-180===u?m&&(r.activeObj.rotatedAngle-=Math.PI/180*180):270!==u&&-90!==u||f&&(r.activeObj.rotatedAngle-=Math.PI/180*180);break;case"pathdrag":sf.base.isNullOrUndefined(this.pathAdjustedIndex)||(r.activeObj.pointColl[this.pathAdjustedIndex].x=e,r.activeObj.pointColl[this.pathAdjustedIndex].y=t);break;default:if(!o&&!r.currObjType.isCustomCrop){var P=r.activeObj.activePoint;if(this.dragPoint.startX){var j=this.dragPoint.endX-this.previousPoint.x,x=this.dragPoint.endY-this.previousPoint.y;if(P.startX+=j,P.endX+=j,P.startY+=x,P.endY+=x,s=P.startX,n=P.startY,l=P.endX,h=P.endY,"line"!==r.activeObj.shape&&"arrow"!==r.activeObj.shape&&r.activeObj.rotationCirclePointColl&&(r.activeObj.rotationCirclePointColl.x+=j,r.activeObj.rotationCirclePointColl.y+=x,r.activeObj.rotationCirclePoint.x+=j,r.activeObj.rotationCirclePoint.y+=x),"path"===r.activeObj.shape)for(y=0,w=r.activeObj.pointColl.length;y<w;y++)r.activeObj.pointColl[y].x+=j,r.activeObj.pointColl[y].y+=x;!this.isPreventDragging&&"line"!==r.activeObj.shape&&0===r.activeObj.rotatedAngle&&(s<r.img.destLeft||n<r.img.destTop||l>r.img.destLeft+r.img.destWidth||h>r.img.destTop+r.img.destHeight)&&(P.startX-=j,P.endX-=j,P.startY-=x,P.endY-=x,"line"!==r.activeObj.shape&&"arrow"!==r.activeObj.shape&&r.activeObj.rotationCirclePointColl&&(r.activeObj.rotationCirclePointColl.x-=j,r.activeObj.rotationCirclePointColl.y-=x,r.activeObj.rotationCirclePoint.x-=j,r.activeObj.rotationCirclePoint.y-=x),this.setDragWidth(j),this.setDragHeight(x))}else P.startX=e<this.mouseDownPoint.x?e:this.mouseDownPoint.x,P.startY=t<this.mouseDownPoint.y?t:this.mouseDownPoint.y,e=e<this.mouseDownPoint.x?this.mouseDownPoint.x:e,t=t<this.mouseDownPoint.y?this.mouseDownPoint.y:t,P.endX=e,P.endY=t;this.triggerShapeChange(b,C,"move")}}},e.prototype.triggerShapeChange=function(e,t,o){var r=this,i=this.parent,a=i.activeObj.activePoint;a.width=a.endX-a.startX,a.height=a.endY-a.startY;var s=this.updatePrevShapeSettings();if(sf.base.isNullOrUndefined(this.shapeResizingArgs)||sf.base.isNullOrUndefined(this.shapeMovingArgs)?(e.currentShapeSettings=s,t.currentShapeSettings=s):(e.currentShapeSettings=this.shapeResizingArgs.currentShapeSettings=s,t.currentShapeSettings=this.shapeMovingArgs.currentShapeSettings=s),"resize"===o){this.isCropSelection=!1;var n=void 0;if(void 0!==i.activeObj.shape&&(n=i.activeObj.shape.split("-")),void 0!==n&&"crop"===n[0]&&(this.isCropSelection=!0),!this.isCropSelection&&"resize"!==i.eventType&&i.events&&!0===i.events.onShapeResizeStart.hasDelegate)e.action=""!==this.currentDrawingShape?"drawing":"resize-start",i.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeResizeStart",e,null).then((function(e){"resize-start"===e.action&&(r.isPreventResize=e.cancel),i.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}));else if(this.isCropSelection){var l={action:e.action,previousSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:e.previousShapeSettings.startX,startY:e.previousShapeSettings.startY,width:e.previousShapeSettings.width,height:e.previousShapeSettings.height},currentSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:e.currentShapeSettings.startX,startY:e.currentShapeSettings.startY,width:e.currentShapeSettings.width,height:e.currentShapeSettings.height}};this.selectionResizingArgs=l,i.shapeModule.shape({prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:l.currentSelectionSettings}})}else""!==this.currentDrawingShape&&"crosshair"===i.upperCanvas.style.cursor&&(e.action="drawing"),i.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}else"mouse-down"===o||"mouse-up"===o?i.events&&!0===i.events.shapeChanging.hasDelegate?i.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",e,null).then((function(e){i.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})})):i.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}}):((sf.base.isNullOrUndefined(i.eventType)||!sf.base.isNullOrUndefined(i.eventType)&&"mouse-up"===i.eventType)&&i.events&&!0===i.events.onShapeDragStart.hasDelegate?(t.action="drag-start",i.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeDragStart",t,null).then((function(e){r.isPreventDraging=e.cancel,i.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}))):i.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:t.currentShapeSettings}}),(sf.base.isNullOrUndefined(i.eventType)||!sf.base.isNullOrUndefined(i.eventType)&&"mouse-up"===i.eventType)&&(this.isDragging=!0));i.eventType=o},e.prototype.setDragWidth=function(e){var t=this.parent,o=t.activeObj.activePoint,r=t.img,i=r.destLeft,a=r.destWidth,s=e;if(s>=0)for(var n=0;n<s&&(e=s-n,o.startX+=e,o.endX+=e,!(o.startX>=i&&o.endX<=i+a));n++)o.startX-=e,o.endX-=e;else for(n=1;n<Math.abs(s)&&(e=s+n,o.startX+=e,o.endX+=e,!(o.startX>=i&&o.endX<=i+a));n++)o.startX-=e,o.endX-=e},e.prototype.setDragHeight=function(e){var t=this.parent,o=t.activeObj.activePoint,r=t.img,i=r.destTop,a=r.destHeight,s=e;if(s>=0)for(var n=1;n<s&&(e=s-n,o.startY+=e,o.endY+=e,!(o.startY>=i&&o.endY<=i+a));n++)o.startY-=e,o.endY-=e;else for(n=0;n<Math.abs(s)&&(e=s+n,o.startY+=e,o.endY+=e,!(o.startY>=i&&o.endY<=i+a));n++)o.startY-=e,o.endY-=e},e.prototype.limitDrag=function(e){var t=!1,o=this.parent,r=o.img,i=r.destLeft,a=r.destTop,s=r.destWidth,n=r.destHeight,l=o.activeObj.activePoint,h=e?l.startX:l.endX,p=e?l.startY:l.endY,d=e?l.endX:l.startX,c=e?l.endY:l.startY;if(h<i&&(h=i),p<a&&(p=a),d>i+s&&(d=i+s),c>a+n&&(c=a+n),0!==o.transform.straighten){var u={isIntersect:null,arr:null};o.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),o.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:u}}),(u.arr[0]||u.arr[1]||u.arr[2]||u.arr[3])&&(t=!0)}return e?(l.startX=h,l.startY=p,l.endX=d,l.endY=c):(l.startX=d,l.startY=c,l.endX=h,l.endY=p),t},e.prototype.isMouseOutsideImg=function(e,t){var o={bool:!1};return this.parent.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),this.parent.drawModule.draw({prop:"isPointsInsideImg",value:{obj:o,x:e,y:t}}),o.bool},e.prototype.preventDraggingInvertly=function(){var e=!1,t=this.parent;if("image"===t.activeObj.shape)return e;if(!this.isPreventDragging&&0===t.activeObj.rotatedAngle){e=this.limitDrag(!0);["line","arrow","path"].indexOf(t.activeObj.shape)>-1&&(e=this.limitDrag(!1))}return e},e.prototype.preventTextDraggingInvertly=function(){var e=this.parent,t=!1,o=e.activeObj.activePoint,r=e.img,i=r.destLeft,a=r.destTop,s=r.destWidth,n=r.destHeight;return this.isPreventDragging||(o.startX<i||o.startY<a||o.endX>i+s||o.endY>a+n)&&(t=!0),t},e.prototype.preventInverseResize=function(e){var t=this.parent.activeObj.activePoint;t.width<0&&(t.width=0,t.startX=e.activePoint.startX,t.endX=e.activePoint.endX),t.height<0&&(t.height=0,t.startY=e.activePoint.startY,t.endY=e.activePoint.endY)},e.prototype.getScaleRatio=function(e){var t=this.parent,o={x:e,y:e};if(t.activeObj.shape&&"crop-custom"!==t.activeObj.shape&&"crop-circle"!==t.activeObj.shape&&"crop-square"!==t.activeObj.shape){var r="image"===t.activeObj.shape||"text"===t.activeObj.shape?this.findImageRatio(t.activeObj.activePoint.width,t.activeObj.activePoint.height).split("-"):t.activeObj.shape.split("-");if(r.length>1||"image"===t.activeObj.shape||"text"===t.activeObj.shape){r="image"===t.activeObj.shape||"text"===t.activeObj.shape?r[0].split(":"):r[1].split(":");var i=e/parseInt(r[1],10);o.x=i*parseInt(r[0],10),o.y=i*parseInt(r[1],10)}}return o},e.prototype.findImageRatio=function(e,t,o){var r=function(e,t){return 0===t?e:r(t,e%t)},i=r(e,t),a=e/i+":"+t/i;return o&&(o.ratio=a),a},e.prototype.revertResizing=function(e){var t=this.parent.activeObj.activePoint;this.preventDraggingInvertly()&&(t.startX=e.activePoint.startX,t.startY=e.activePoint.startY,t.endX=e.activePoint.endX,t.endY=e.activePoint.endY)},e.prototype.updateNWPoints=function(e,t,o){var r,i,a,s=this.parent,n=s.activeObj.activePoint,l=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)this.resizeImg(e,t,"nw-resize",l),s.shapeModule.shape({prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var h=void 0;if(void 0!==s.activeObj.shape&&(h=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==h[0]){if("image"===s.activeObj.shape?this.resizeImg(e,t,"nw-resize",l):this.adjustNWPoints(n,e,t,s.activeObj.rotatedAngle),n.startX>n.endX){var p=n.startX;n.startX=n.endX,n.endX=p,this.dragElement=s.upperCanvas.style.cursor=s.cursor="ne-resize"}if(n.startY>n.endY){p=n.startY;n.startY=n.endY,n.endY=p,this.dragElement=s.upperCanvas.style.cursor=s.cursor="sw-resize"}this.revertResizing(l)}else{var d=s.img,c=d.destLeft,u=d.destTop;d.destWidth,d.destHeight;if(n.startX<e&&n.startY<t){r=e-n.startX,i=t-n.startY,a=Math.min(r,i);var v=this.getScaleRatio(a);n.startX+=v.x,n.startY+=v.y;var g=c>0?c:0,b=u>0?u:0;(n.startX<g||n.startY<b)&&(n.startX-=v.x,n.startY-=v.y)}else{r=n.startX-e,i=t-n.endY,a=Math.max(r,i);v=this.getScaleRatio(a);n.startX-=v.x,n.startY-=v.y;g=c>0?c:0;var C=u>0?u:0;(n.startX<g||n.startY<C)&&(n.startX+=v.x,n.startY+=v.y)}n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.revertResizing(l)}n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.preventInverseResize(l)}},e.prototype.updateNPoints=function(e,t){var o,r,i,a=this.parent,s=a.activeObj.activePoint,n=sf.base.extend({},a.activeObj,null,!0);if("text"!==a.activeObj.shape){var l=void 0;if(a.activeObj.shape&&(l=a.activeObj.shape.split("-")),"crop-custom"===a.activeObj.shape||a.activeObj.shape&&"crop"!==l[0]){if("line"!==a.activeObj.shape&&"arrow"!==a.activeObj.shape&&"path"!==a.activeObj.shape&&0!==a.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,r=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(s,o,r,a.activeObj.rotatedAngle)):(s.startY=t,s.height=s.endY-s.startY),s.startY>s.endY){var h=s.startY;s.startY=s.endY,s.endY=h,this.dragElement=this.resizedElement="s-resize"}this.revertResizing(n)}else{var p=a.img,d=p.destLeft,c=p.destTop,u=p.destWidth;p.destHeight;if(s.endX>e&&s.startY<t){o=s.endX-e,r=t-s.startY,i=Math.min(o,r);var v=this.getScaleRatio(i);s.endX-=v.x,s.startY+=v.y,(s.endX>d+u||s.startY<c)&&(s.endX+=v.x,s.startY-=v.y)}else{o=e-s.endX,r=s.startY-t,i=Math.max(o,r);v=this.getScaleRatio(i);s.endX+=v.x,s.startY-=v.y,(s.endX>d+u||s.startY<c)&&(s.endX-=v.x,s.startY+=v.y)}s.width=s.endX-s.startX,s.height=s.endY-s.startY,this.revertResizing(n)}}},e.prototype.updateNEPoints=function(e,t,o){var r,i,a,s=this.parent,n=s.activeObj.activePoint,l=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)this.resizeImg(e,t,"ne-resize",l),s.shapeModule.shape({prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var h=void 0;if(s.activeObj.shape&&(h=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==h[0]){if("image"===s.activeObj.shape?this.resizeImg(e,t,"ne-resize",l):this.adjustNEPoints(n,e,t,s.activeObj.rotatedAngle),n.endX<n.startX){var p=n.endX;n.endX=n.startX,n.startX=p,this.dragElement=s.upperCanvas.style.cursor=s.cursor="nw-resize"}if(n.startY>n.endY){p=n.startY;n.startY=n.endY,n.endY=p,this.dragElement=s.upperCanvas.style.cursor=s.cursor="se-resize"}this.revertResizing(l)}else{var d=s.img,c=d.destLeft,u=d.destTop,v=d.destWidth;d.destHeight;if(n.endX>e&&n.startY<t){r=n.endX-e,i=t-n.startY,a=Math.min(r,i);var g=this.getScaleRatio(a);n.endX-=g.x,n.startY+=g.y;var b=c+v<s.lowerCanvas.width?c+v:s.lowerCanvas.width,C=u>0?u:0;(n.endX>b||n.startY<C)&&(n.endX+=g.x,n.startY-=g.y)}else{r=e-n.endX,i=n.startY-t,a=Math.max(r,i);g=this.getScaleRatio(a);n.endX+=g.x,n.startY-=g.y;b=c+v<s.lowerCanvas.width?c+v:s.lowerCanvas.width,C=u>0?u:0;(n.endX>b||n.startY<C)&&(n.endX-=g.x,n.startY+=g.y)}n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.revertResizing(l)}n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.preventInverseResize(l)}},e.prototype.updateWPoints=function(e,t){var o,r,i,a=this.parent,s=a.activeObj.activePoint,n=sf.base.extend({},a.activeObj,null,!0);if("text"!==a.activeObj.shape){var l=void 0;if(a.activeObj.shape&&(l=a.activeObj.shape.split("-")),"crop-custom"===a.activeObj.shape||a.activeObj.shape&&"crop"!==l[0]){if("line"!==a.activeObj.shape&&"arrow"!==a.activeObj.shape&&"path"!==a.activeObj.shape&&0!==a.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,r=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(s,o,r,a.activeObj.rotatedAngle)):(s.startX=e,s.width=s.endX-s.startX),"line"===a.activeObj.shape||"arrow"===a.activeObj.shape||"path"===a.activeObj.shape)s.startY=t,s.height=s.endY-s.startY,this.adjustActObjForLineArrow()&&(this.dragElement="e-resize","right"===a.activeObj.triangleDirection?a.activeObj.triangleDirection="left":"left"===a.activeObj.triangleDirection&&(a.activeObj.triangleDirection="right"));else if(s.startX>s.endX){var h=s.startX;s.startX=s.endX,s.endX=h,this.dragElement=this.resizedElement="e-resize"}this.revertResizing(n)}else{var p=a.img,d=p.destLeft,c=p.destTop,u=(p.destWidth,p.destHeight);if(s.startX<e&&s.endY>t){o=e-s.startX,r=s.endY-t,i=Math.min(o,r);var v=this.getScaleRatio(i);s.startX+=v.x,s.endY-=v.y,(s.startX<d||s.endY>c+u)&&(s.startX-=v.x,s.endY+=v.y)}else{o=s.startX-e,r=t-s.endY,i=Math.max(o,r);v=this.getScaleRatio(i);s.startX-=v.x,s.endY+=v.y,(s.startX<d||s.endY>c+u)&&(s.startX+=v.x,s.endY-=v.y)}s.width=s.endX-s.startX,s.height=s.endY-s.startY,this.revertResizing(n)}}},e.prototype.updateEPoints=function(e,t){var o,r,i,a=this.parent,s=a.activeObj.activePoint,n=sf.base.extend({},a.activeObj,null,!0);if("text"!==a.activeObj.shape){var l=void 0;if(a.activeObj.shape&&(l=a.activeObj.shape.split("-")),"crop-custom"===a.activeObj.shape||a.activeObj.shape&&"crop"!==l[0]){if("line"!==a.activeObj.shape&&"arrow"!==a.activeObj.shape&&"path"!==a.activeObj.shape&&0!==a.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,r=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(s,o,r,a.activeObj.rotatedAngle)):(s.endX=e,s.width=s.endX-s.startX),"line"===a.activeObj.shape||"arrow"===a.activeObj.shape||"path"===a.activeObj.shape)s.endY=t,s.height=s.endY-s.startY,this.adjustActObjForLineArrow()&&(this.dragElement="w-resize","right"===a.activeObj.triangleDirection?a.activeObj.triangleDirection="left":"left"===a.activeObj.triangleDirection&&(a.activeObj.triangleDirection="right"));else if(s.endX<s.startX){var h=s.endX;s.endX=s.startX,s.startX=h,this.dragElement=this.resizedElement="w-resize"}this.revertResizing(n)}else{var p=a.img,d=p.destLeft,c=p.destTop,u=p.destWidth,v=p.destHeight;if(s.endX>e&&s.endY>t){o=s.endX-e,r=s.endY-t,i=Math.min(o,r);var g=this.getScaleRatio(i);s.endX-=g.x,s.endY-=g.y,(s.endX>d+u||s.endY>c+v)&&(s.endX+=g.x,s.endY+=g.y)}else{o=e-s.endX,r=t-s.endY,i=Math.max(o,r);g=this.getScaleRatio(i);s.endX+=g.x,s.endY+=g.y,(s.endX>d+u||s.endY>c+v)&&(s.endX-=g.x,s.endY-=g.y)}s.width=s.endX-s.startX,s.height=s.endY-s.startY,this.revertResizing(n)}}},e.prototype.updateSWPoints=function(e,t,o){var r,i,a,s=this.parent,n=s.activeObj.activePoint,l=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)this.resizeImg(e,t,"sw-resize",l),s.shapeModule.shape({prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var h=void 0;if(void 0!==s.activeObj.shape&&(h=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==h[0]){if("image"===s.activeObj.shape?this.resizeImg(e,t,"sw-resize",l):this.adjustSWPoints(n,e,t,s.activeObj.rotatedAngle),n.startX>n.endX){var p=n.startX;n.startX=n.endX,n.endX=p,this.dragElement=s.upperCanvas.style.cursor=s.cursor="se-resize"}if(n.endY<n.startY){p=n.endY;n.endY=n.startY,n.startY=p,this.dragElement=s.upperCanvas.style.cursor=s.cursor="nw-resize"}this.revertResizing(l)}else{var d=s.img,c=d.destLeft,u=d.destTop,v=(d.destWidth,d.destHeight);if(n.startX<e&&n.endY>t){r=e-n.startX,i=n.endY-t,a=Math.min(r,i);var g=this.getScaleRatio(a);n.startX+=g.x,n.endY-=g.y;var b=c>0?c:0,C=u+v<s.lowerCanvas.height?u+v:s.lowerCanvas.height;(n.startX<b||n.endY>C)&&(n.startX-=g.x,n.endY+=g.y)}else{r=n.startX-e,i=t-n.endY,a=Math.max(r,i);g=this.getScaleRatio(a);n.startX-=g.x,n.endY+=g.y;b=c>0?c:0,C=u+v<s.lowerCanvas.height?u+v:s.lowerCanvas.height;(n.startX<b||n.endY>C)&&(n.startX+=g.x,n.endY-=g.y)}n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.revertResizing(l)}n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.preventInverseResize(l)}},e.prototype.updateSPoints=function(e,t){var o,r,i,a=this.parent,s=a.activeObj.activePoint,n=sf.base.extend({},a.activeObj,null,!0);if("text"!==a.activeObj.shape){var l=void 0;if(a.activeObj.shape&&(l=a.activeObj.shape.split("-")),"crop-custom"===a.activeObj.shape||a.activeObj.shape&&"crop"!==l[0]){if("line"!==a.activeObj.shape&&"arrow"!==a.activeObj.shape&&"path"!==a.activeObj.shape&&0!==a.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),o=this.dragPoint.endX-this.previousPoint.x,r=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(s,o,r,a.activeObj.rotatedAngle)):(s.endY=t,s.height=s.endY-s.startY),s.endY<s.startY){var h=s.endY;s.endY=s.startY,s.startY=h,this.dragElement=this.resizedElement="n-resize"}this.revertResizing(n)}else{var p=a.img,d=p.destLeft,c=p.destTop,u=p.destWidth,v=p.destHeight;if(s.endX>e&&s.endY>t){o=s.endX-e,r=s.endY-t,i=Math.min(o,r);var g=this.getScaleRatio(i);s.endX-=g.x,s.endY-=g.y,(s.endX>d+u||s.endY>c+v)&&(s.endX+=g.x,s.endY+=g.y)}else{o=e-s.endX,r=t-s.endY,i=Math.max(o,r);g=this.getScaleRatio(i);s.endX+=g.x,s.endY+=g.x,(s.endX>d+u||s.endY>c+v)&&(s.endX-=g.x,s.endY-=g.y)}s.width=s.endX-s.startX,s.height=s.endY-s.startY,this.revertResizing(n)}}},e.prototype.updateSEPoints=function(e,t,o){var r,i,a,s=this.parent,n=s.activeObj.activePoint,l=sf.base.extend({},s.activeObj,null,!0);if("text"===s.activeObj.shape)this.resizeImg(e,t,"se-resize",l),s.shapeModule.shape({prop:"updateFontSize",onPropertyChange:!1,value:{obj:s.activeObj}});else{var h=void 0,p=void 0;if(void 0!==s.activeObj.shape&&(h=s.activeObj.shape.split("-")),"crop-custom"===s.activeObj.shape||void 0!==s.activeObj.shape&&"crop"!==h[0]){if("image"===s.activeObj.shape?this.resizeImg(e,t,"se-resize",l):this.adjustSEPoints(n,e,t,s.activeObj.rotatedAngle),n.endX<n.startX){var d=n.endX;n.endX=n.startX,n.startX=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="sw-resize"}if(n.endY<n.startY){d=n.endY;n.endY=n.startY,n.startY=d,this.dragElement=s.upperCanvas.style.cursor=s.cursor="ne-resize"}this.revertResizing(l)}else{var c=s.img,u=c.destLeft,v=c.destTop,g=c.destWidth,b=c.destHeight;if(n.endX>e&&n.endY>t){r=n.endX-e,i=n.endY-t,a=Math.min(r,i),p=this.getScaleRatio(a),n.endX-=p.x,n.endY-=p.y;var C=u+g<s.lowerCanvas.width?u+g:s.lowerCanvas.width,f=v+b<s.lowerCanvas.height?v+b:s.lowerCanvas.height;(n.endX>C||n.endY>f)&&(n.endX+=p.x,n.endY+=p.y)}else{r=e-n.endX,i=t-n.endY,a=Math.max(r,i),p=this.getScaleRatio(a),n.endX+=p.x,n.endY+=p.y;C=u+g<s.lowerCanvas.width?u+g:s.lowerCanvas.width,f=v+b<s.lowerCanvas.height?v+b:s.lowerCanvas.height;(n.endX>C||n.endY>f)&&(n.endX-=p.x,n.endY-=p.y)}n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.revertResizing(l)}this.preventInverseResize(l)}},e.prototype.resizeImg=function(e,t,o,r){var i,a,s=this.parent,n=s.activeObj.activePoint;if(0!==this.previousPoint.x&&0!==this.previousPoint.y){if("text"===this.currentDrawingShape&&(this.setCursor(e,t),0===s.activeObj.textSettings.fontSize)){s.activeObj.textSettings.fontSize=11,s.shapeModule.shape({prop:"updateFontRatio",onPropertyChange:!1,value:{obj:s.activeObj,isTextArea:null}}),s.activeObj.textSettings.text=s.activeObj.keyHistory="Enter Text",s.shapeModule.shape({prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}});var l=this.upperContext.measureText(s.activeObj.textSettings.text).width+.5*s.activeObj.textSettings.fontSize;n.endX=n.startX+l,n.endY=n.startY+s.activeObj.textSettings.fontSize,n.width=n.endX-n.startX,n.height=n.endY-n.startY,r=sf.base.extend({},s.activeObj,null,!0),s.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:s.activeObj.activePoint,obj:s.activeObj,isMouseMove:null,x:null,y:null}})}switch(s.upperCanvas.style.cursor){case"se-resize":case"s-resize":this.previousPoint.x>e||this.previousPoint.y>t?(i=(this.previousPoint.x-e+(this.previousPoint.y-t))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,-Math.abs(a.x),-Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(i=(e-this.previousPoint.x+(t-this.previousPoint.y))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,Math.abs(a.x),Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o));break;case"sw-resize":this.previousPoint.x<e||this.previousPoint.y>t?(i=(e-this.previousPoint.x+(this.previousPoint.y-t))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,-Math.abs(a.x),-Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(i=(this.previousPoint.x-e+(t-this.previousPoint.y))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,Math.abs(a.x),Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o));break;case"w-resize":case"nw-resize":this.previousPoint.x<e||this.previousPoint.y<t?(i=(e-this.previousPoint.x+(t-this.previousPoint.y))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,-Math.abs(a.x),-Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(i=(this.previousPoint.x-e+(this.previousPoint.y-t))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,Math.abs(a.x),Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o));break;case"n-resize":case"ne-resize":this.previousPoint.x>e||this.previousPoint.y<t?(i=(this.previousPoint.x-e+(t-this.previousPoint.y))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,-Math.abs(a.x),-Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(i=(e-this.previousPoint.x+(this.previousPoint.y-t))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,Math.abs(a.x),Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o));break;case"e-resize":this.previousPoint.x>e||this.previousPoint.y>t?(i=(this.previousPoint.x-e+(this.previousPoint.y-t))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,-Math.abs(a.x),-Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(i=(e-this.previousPoint.x+(t-this.previousPoint.y))/2,a=this.getScaleRatio(i),this.adjustRotationPoints(n,Math.abs(a.x),Math.abs(a.y),s.activeObj.rotatedAngle,"img-resize",o))}n.width=n.endX-n.startX,n.height=n.endY-n.startY,(n.width<10||n.height<10||"text"===s.activeObj.shape&&0===s.activeObj.rotatedAngle&&this.preventTextDraggingInvertly())&&(s.activeObj=sf.base.extend({},r,null,!0))}this.previousPoint={x:e,y:t}},e.prototype.adjustNWPoints=function(e,t,o,r){var i=e.startX+e.width/2,a=e.startY+e.height/2,s=this.rotatePoints(e.endX,e.endY,i,a,r),n=[(s[0]+t)/2,(s[1]+o)/2],l=this.rotatePoints(s[0],s[1],n[0],n[1],-r),h=this.rotatePoints(t,o,n[0],n[1],-r);return e.endX=l[0],e.endY=l[1],e.startY=h[1],e.startX=h[0],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},e.prototype.adjustNEPoints=function(e,t,o,r){var i=e.startX+e.width/2,a=e.startY+e.height/2,s=this.rotatePoints(e.startX,e.endY,i,a,r),n=[(s[0]+t)/2,(s[1]+o)/2],l=this.rotatePoints(s[0],s[1],n[0],n[1],-r),h=this.rotatePoints(t,o,n[0],n[1],-r);return e.startX=l[0],e.endY=l[1],e.width=h[0]-l[0],e.height=l[1]-h[1],e.endX=e.startX+e.width,e.startY=e.endY-e.height,e},e.prototype.adjustSWPoints=function(e,t,o,r){var i=e.startX+e.width/2,a=e.startY+e.height/2,s=this.rotatePoints(e.endX,e.startY,i,a,r),n=[(s[0]+t)/2,(s[1]+o)/2],l=this.rotatePoints(s[0],s[1],n[0],n[1],-r),h=this.rotatePoints(t,o,n[0],n[1],-r);return e.endX=l[0],e.startY=l[1],e.startX=h[0],e.endY=h[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},e.prototype.adjustSEPoints=function(e,t,o,r){var i=e.startX+e.width/2,a=e.startY+e.height/2,s=this.rotatePoints(e.startX,e.startY,i,a,r),n=[(s[0]+t)/2,(s[1]+o)/2],l=this.rotatePoints(s[0],s[1],n[0],n[1],-r),h=this.rotatePoints(t,o,n[0],n[1],-r);return e.startX=l[0],e.startY=l[1],e.width=h[0]-l[0],e.height=h[1]-l[1],e.endX=e.startX+e.width,e.endY=e.startY+e.height,e},e.prototype.adjustRotationPoints=function(e,t,o,r,i,a){var s=e.startX+e.width/2,n=e.startY+e.height/2;this.getResizeDirection(e,t,o,r,i,a);var l=this.rotatePoints(e.startX,e.startY,s,n,r),h=this.rotatePoints(e.endX,e.startY,s,n,r),p=this.rotatePoints(e.endX,e.endY,s,n,r),d=this.rotatePoints(e.startX,e.endY,s,n,r),c=[(l[0]+p[0])/2,(l[1]+p[1])/2],u=this.rotatePoints(l[0],l[1],c[0],c[1],-r),v=this.rotatePoints(d[0],d[1],c[0],c[1],-r),g=this.rotatePoints(h[0],h[1],c[0],c[1],-r);return e.startX=u[0],e.startY=u[1],e.endX=g[0],e.endY=v[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},e.prototype.rotatePoints=function(e,t,o,r,i){return[(e-o)*Math.cos(i)-(t-r)*Math.sin(i)+o,(e-o)*Math.sin(i)+(t-r)*Math.cos(i)+r]},e.prototype.setResizedValue=function(e,t,o,r){switch(e){case"x":t+=o;break;case"y":t+=r;break;case"abs-x":t+=o>0?-o:Math.abs(o);break;case"abs-y":t+=r>0?-r:Math.abs(r);break;case"y-abs-x":t+=r+(o>0?-o:Math.abs(o))/2;break;case"abs-x-abs-y":t+=(o>0?-o:Math.abs(o))+(r>0?-r:Math.abs(r))/2;break;case"abs-y-x":t+=(r>0?-r:Math.abs(r))+o/2;break;case"x-y":t+=o+r/2;break;case"y-x":t+=r+o/2;break;case"img-resize-x":t+=o;break;case"img-resize-y":t+=r}return t},e.prototype.getResizeDirection=function(e,t,o,r,i,a){var s=r*(180/Math.PI),n=this.getResizedElement(s,this.resizedElement);"e-resize"===this.resizedElement?(e.width=this.setResizedValue(n,e.width,t,o),e.endX=e.width+e.startX):"n-resize"===this.resizedElement?(e.startY=this.setResizedValue(n,e.startY,t,o),e.height=e.endY-e.startY):"w-resize"===this.resizedElement?(e.startX=this.setResizedValue(n,e.startX,t,o),e.width=e.startX+e.endX):"s-resize"===this.resizedElement?(e.height=this.setResizedValue(n,e.height,t,o),e.endY=e.height+e.startY):i&&"img-resize"===i?(e.width=this.setResizedValue("img-resize-x",e.width,t,o),e.height=this.setResizedValue("img-resize-y",e.height,t,o),"se-resize"===a?(e.endX=e.width+e.startX,e.endY=e.height+e.startY):"sw-resize"===a?(e.startX=e.endX-e.width,e.endY=e.height+e.startY):"ne-resize"===a?(e.endX=e.width+e.startX,e.startY=e.endY-e.height):"nw-resize"===a&&(e.startX=e.endX-e.width,e.startY=e.endY-e.height)):i&&"text"===i&&("widthHeight"===a?(e.width=this.setResizedValue("x-y",e.width,t,o),e.endX=e.width+e.startX,e.height=this.setResizedValue("y-x",e.height,t,o),e.endY=e.height+e.startY):"width"===a?(e.width=this.setResizedValue("x-y",e.width,t,o),e.endX=e.width+e.startX):"height"===a&&(e.height=this.setResizedValue("y-abs-x",e.height,t,o),e.endY=e.height+e.startY))},e.prototype.getResizedElement=function(e,t){var o=[];"n-resize"===t?o=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:"e-resize"===t?o=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]:"s-resize"===t?o=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:"w-resize"===t&&(o=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]);for(var r=e<0?360-Math.abs(e):e,i=0,a=o;i<a.length;i++){var s=a[i],n=s[0],l=s[1],h=s[2];if(r>n&&r<=l||r+360>n&&r+360<=l)return h}return t},e.prototype.updateCursorStyles=function(e,t,o){var r=this.parent,i=!1;""===r.activeObj.keyHistory||void 0!==r.activeObj.shape||r.currObjType.isCustomCrop||r.currObjType.isLine||!r.currObjType.isText||(r.activeObj.shape="text");var a=sf.base.extend({},r.activeObj,{},!0);if(!sf.base.isNullOrUndefined(a.topLeftCircle)){var s;if((s=0===a.shapeDegree?r.transform.degree:r.transform.degree-a.shapeDegree)<0&&(s=360+s),this.isObjSelected)if("line"===a.shape||"arrow"===a.shape)i=this.updateCursorStylesForLineArrow(e,t,a);else if("path"===a.shape)i=this.updateCursorStylesForPath(e,t,a);else if(a.rotatedAngle)this.setCursorForRotatedObject(a,e,t,r.upperCanvas),"grabbing"===r.cursor?(r.upperCanvas.style.cursor=r.cursor="grabbing",this.dragElement=r.cursor):"move"===r.cursor?(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t):"default"!==r.cursor&&(i=!0,this.dragElement=r.cursor,r.currObjType.isResize=!0);else{var n=this.getTransRotationPoint(a),l=a.topLeftCircle.radius;e>=a.topLeftCircle.startX-2*l&&e<=a.topLeftCircle.startX+2*l&&t>=a.topLeftCircle.startY-2*l&&t<=a.topLeftCircle.startY+2*l&&"nw-resize"!==this.dragElement?(a.topLeftCircle.startX=a.topLeftCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="nw-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.topLeftCircle.startX-2*l&&e<=a.topRightCircle.startX-2*l&&t>=a.topCenterCircle.startY-2*l&&t<=a.topCenterCircle.startY+2*l&&"n-resize"!==this.dragElement?(a.topCenterCircle.startX=a.topCenterCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="n-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.topRightCircle.startX-2*l&&e<=a.topRightCircle.startX+2*l&&t>=a.topRightCircle.startY-2*l&&t<=a.topRightCircle.startY+2*l&&"ne-resize"!==this.dragElement?(a.topRightCircle.startX=a.topRightCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="ne-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.centerLeftCircle.startX-2*l&&e<=a.centerLeftCircle.startX+2*l&&t>=a.topLeftCircle.startY-2*l&&t<=a.bottomLeftCircle.startY-2*l&&"w-resize"!==this.dragElement?(a.centerLeftCircle.startX=a.centerLeftCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="w-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.centerRightCircle.startX-2*l&&e<=a.centerRightCircle.startX+2*l&&t>=a.topRightCircle.startY-2*l&&t<=a.bottomRightCircle.startY-2*l&&"e-resize"!==this.dragElement?(a.centerRightCircle.startX=a.centerRightCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="e-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.bottomLeftCircle.startX-2*l&&e<=a.bottomLeftCircle.startX+2*l&&t>=a.bottomLeftCircle.startY-2*l&&t<=a.bottomLeftCircle.startY+2*l&&"sw-resize"!==this.dragElement?(a.bottomLeftCircle.startX=a.bottomLeftCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="sw-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.bottomLeftCircle.startX-2*l&&e<=a.bottomRightCircle.startX-2*l&&t>=a.bottomCenterCircle.startY-2*l&&t<=a.bottomCenterCircle.startY+2*l&&"s-resize"!==this.dragElement?(a.bottomCenterCircle.startX=a.bottomCenterCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="s-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.bottomRightCircle.startX-2*l&&e<=a.bottomRightCircle.startX+2*l&&t>=a.bottomRightCircle.startY-2*l&&t<=a.bottomRightCircle.startY+2*l&&"se-resize"!==this.dragElement?(a.bottomRightCircle.startX=a.bottomRightCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="se-resize",i=!0,this.dragElement=r.upperCanvas.style.cursor):n&&e>=n.x-2*l&&e<=n.x+2*l&&t>=n.y-2*l&&t<=n.y+2*l&&"grabbing"!==this.dragElement?(r.upperCanvas.style.cursor=r.cursor="grabbing",this.dragElement=r.upperCanvas.style.cursor):(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t),"text"!==a.shape||"n-resize"!==r.cursor&&"s-resize"!==r.cursor&&"e-resize"!==r.cursor&&"w-resize"!==r.cursor||(r.upperCanvas.style.cursor=r.cursor="move",this.dragElement="",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t)}else this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t;this.previousPoint.x=this.previousPoint.y=this.diffPoint.x=this.diffPoint.y=0,"touchstart"===o?i||e>=a.activePoint.startX&&e<=a.activePoint.endX&&t>=a.activePoint.startY&&t<=a.activePoint.endY||"grabbing"===this.dragElement?r.currObjType.isDragging=!0:"line"===a.shape||"arrow"===a.shape?(this.setCursorForLineArrow(a,e,t,r.upperCanvas),"move"===r.cursor&&(r.currObjType.isDragging=!0)):"path"===a.shape&&(this.setCursorForPath(a,e,t,r.upperCanvas),"move"===r.cursor&&(r.currObjType.isDragging=!0)):r.currObjType.isDragging=!0,0===a.rotatedAngle||"e-resize"!==this.dragElement&&"w-resize"!==this.dragElement&&"n-resize"!==this.dragElement&&"s-resize"!==this.dragElement||(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t)}},e.prototype.updateCursorStylesForLineArrow=function(e,t,o){for(var r,i=!1,a=this.parent,s=o.topLeftCircle.radius,n=0;n<5;n++)if(e>=(r=o.pointColl[n]).x-2*s&&e<=r.x+2*s&&t>=r.y-2*s&&t<=r.y+2*s){o.centerLeftCircle.startX=o.centerLeftCircle.startY=0,this.dragElement="w-resize",i=!0;break}if(!i)for(n=1;n<6;n++)if(e>=(r=o.pointColl[o.pointColl.length-n]).x-2*s&&e<=r.x+2*s&&t>=r.y-2*s&&t<=r.y+2*s){o.centerRightCircle.startX=o.centerRightCircle.startY=0,this.dragElement="e-resize",i=!0;break}if(!i)for(n=0;n<o.pointColl.length;n++){if(e>=(r=o.pointColl[n]).x-2*s&&e<=r.x+2*s&&t>=r.y-2*s&&t<=r.y+2*s){a.upperCanvas.style.cursor=a.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t;break}a.upperCanvas.style.cursor=a.cursor="default"}return i},e.prototype.updateCursorStylesForPath=function(e,t,o){var r=!1,i=this.parent;return this.pathAdjustedIndex=this.setCursorForLineArrow(o,e,t,i.upperCanvas),"move"===i.cursor&&(r=!0,this.dragElement="pathDrag"),r||(i.upperCanvas.style.cursor=i.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t),r},e.prototype.setTextSelection=function(e,t){var o=this.parent,r=o.activeObj.activePoint,i=o.transform.degree;(i=0===o.activeObj.shapeDegree?o.transform.degree:o.transform.degree-o.activeObj.shapeDegree)<0&&(i=360+i);for(var a=0,s=o.activeObj.flipObjColl.length;a<s;a++){var n=o.activeObj.flipObjColl[a].toLowerCase();switch(i){case 0:switch(n){case"horizontal":r={startX:r.endX-e,startY:r.startY,endX:r.endX,endY:r.startY+(t||0)};break;case"vertical":r.startY=r.endY-t,r={startX:r.startX,startY:r.startY,endX:r.startX+(e||0),endY:r.endY};break;default:r={startX:r.startX,startY:r.startY,endX:r.startX+(e||0),endY:r.startY+(t||0)}}break;case 90:switch(n){case"horizontal":r.endX=r.startX+t,r={startX:r.startX,startY:r.startY,endX:r.endX,endY:r.startY+(e||0)};break;case"vertical":r.startX=r.endX-t,r={startX:r.startX,startY:r.endY-e,endX:r.endX,endY:r.endY};break;default:r.startX=r.endX-t,r={startX:r.startX,startY:r.startY,endX:r.endX,endY:r.startY+(e||0)}}break;case 180:switch(n){case"horizontal":r.startY=r.endY-t,r={startX:r.startX,startY:r.startY,endX:r.startX+e,endY:r.endY};break;case"vertical":r.endY=r.startY+t,r={endX:r.endX,endY:r.endY,startX:r.endX-(e||0),startY:r.startY};break;default:r={endX:r.endX,endY:r.endY,startX:r.endX-(e||0),startY:r.endY-(t||0)}}break;case 270:switch(n){case"horizontal":r.startX=r.endX-t,r={startX:r.startX,startY:r.endY-(e||0),endX:r.endX,endY:r.endY};break;case"vertical":r={startX:r.startX,startY:r.startY,endX:r.startX+t,endY:r.startY+(e||0)};break;default:r.endX=r.startX+t,r={startX:r.startX,startY:r.endY-(e||0),endX:r.endX,endY:r.endY}}}}if(0===o.activeObj.flipObjColl.length)switch(i){case 0:r={startX:r.startX,startY:r.startY,endX:r.startX+(e||0),endY:r.startY+(t||0)};break;case 90:r.startX=r.endX-t,r={startX:r.startX,startY:r.startY,endX:r.endX,endY:r.startY+(e||0)};break;case 180:r={endX:r.endX,endY:r.endY,startX:r.endX-(e||0),startY:r.endY-(t||0)};break;case 270:r.endX=r.startX+t,r={startX:r.startX,startY:r.endY-(e||0),endX:r.endX,endY:r.endY}}r.width=r.endX-r.startX,r.height=r.endY-r.startY,o.activeObj.activePoint=r,360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},e.prototype.setActivePoint=function(e,t){var o=this.parent,r=o.activeObj.activePoint;if(!sf.base.isNullOrUndefined(r))if(o.currObjType.isText){var i=e||0,a=t||o.activeObj.textSettings.fontSize;void 0===o.activeObj.textSettings.fontSize&&(o.activeObj.textSettings.fontSize=.1*Math.abs(o.baseImgCanvas.width-o.baseImgCanvas.height)),this.setTextSelection(i,a),this.mouseDownPoint.x=r.endX,this.mouseDownPoint.y=r.endY,void 0!==o.activeObj.horTopLine&&(o.activeObj.activePoint=sf.base.extend({},r,{},!0)),o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})}else if(e&&t)r.startX=this.mouseDownPoint.x=e,r.startY=this.mouseDownPoint.y=t,o.currObjType.isDragging=!0;else{var s=o.activeObj;(r={startX:s.horTopLine.startX,startY:s.horTopLine.startY,endX:s.horTopLine.endX,endY:s.horTopLine.endY}).width=r.endX-r.startX,r.height=r.endY-r.startY}},e.prototype.mouseDownEventHandler=function(e){var t=this,o=this.parent;if(this.preventDrag=!1,this.mouseDown=e.currentTarget===o.lowerCanvas||e.currentTarget===o.upperCanvas?"canvas":"","touchstart"===e.type?this.isTouch=!0:this.isTouch=!1,"touchstart"!==e.type||e.currentTarget!==o.lowerCanvas||o.isImageLoaded){var r;if(this.isCropSelection=!1,this.isPan=!0,void 0!==o.activeObj.shape&&(r=o.activeObj.shape.split("-")),void 0!==r&&"crop"===r[0]&&(this.isCropSelection=!0),this.isCropSelection&&(this.dragCanvas=o.togglePan=!0),"default"!==o.upperCanvas.style.cursor&&"crop-toolbar"===o.currentToolbar){var i=this.updatePrevShapeSettings(),a={cancel:!1,action:"resize-start",previousShapeSettings:i,currentShapeSettings:i};o.events&&!0===o.events.onSelectionResizeStart.hasDelegate&&o.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeStart",a).then((function(e){e.cancel&&(t.preventDrag=!0)}))}if("grabbing"===o.cursor&&o.events&&!0===o.events.onShapeResizeStart.hasDelegate){this.isGrabbing=!0;var s=this.updatePrevShapeSettings();a={cancel:!1,action:"rotate-start",previousShapeSettings:s,currentShapeSettings:s};o.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeResizeStart",a,null).then((function(e){t.isPreventResize=e.cancel,o.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}))}var n={point:this.setXYPoints(e)};o.events&&!0===o.events.clicked.hasDelegate?o.dotNetRef.invokeMethodAsync("ClickEventAsync","click",n).then((function(o){t.clickEvent(o,e)})):this.clickEvent(n,e)}},e.prototype.getImagePoints=function(e,t){var o=this.parent.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight;return e<r?e=r:e>r+a&&(e=r+a),t<i?t=i:t>i+s&&(t=i+s),{x:e,y:t}},e.prototype.clickEvent=function(e,t){var o=this.parent,i=o.activeObj.activePoint,a=e.point.x,s=e.point.y,n=o.activeObj.shape&&"text"===o.activeObj.shape?o.cursor:"default";if(o.isResize)return this.performEnterAction(),void(o.upperCanvas.style.cursor="default");if(JSON.stringify(o.frameObj)!==JSON.stringify(o.tempFrameObj))o.okBtn();else if(""!==this.currentDrawingShape&&(this.isTouch&&!this.isShapeTouch(t,this.isCropSelection)||"crosshair"===o.upperCanvas.style.cursor||o.isShapeDrawing)){o.drawingShape&&!o.isShapeDrawing&&(o.okBtn(),o.enableShapeDrawing(o.toPascalCase(o.drawingShape),!0)),i=o.activeObj.activePoint;var l={currObj:{}};o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}}),this.initialPrevObj=l.currObj,this.initialPrevObj.objColl=sf.base.extend([],o.objColl,[],!0),this.initialPrevObj.pointColl=sf.base.extend([],o.pointColl,[],!0),this.initialPrevObj.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var h={selPointColl:null};if(o.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),this.initialPrevObj.selPointColl=sf.base.extend([],h.selPointColl,[],!0),this.setActivePoint(a,s),i=o.activeObj.activePoint,"path"===this.currentDrawingShape){var p=this.getImagePoints(a,s);o.activeObj.pointColl.push({x:p.x,y:p.y}),0!==i.width&&0!==i.height&&(i.width=0,i.height=0,i.startX=o.activeObj.pointColl[o.activeObj.pointColl.length-1].x,i.startY=o.activeObj.pointColl[o.activeObj.pointColl.length-1].y)}if(i.endX=i.startX,i.endY=i.startY,"text"===this.currentDrawingShape){o.activeObj.textSettings.fontSize=11,this.previousPoint.x=i.startX,this.previousPoint.y=i.startY,o.shapeModule.shape({prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}});var d=this.upperContext.measureText(o.activeObj.textSettings.text).width+.5*o.activeObj.textSettings.fontSize;i.endX=i.startX+d,i.endY=i.startY+o.activeObj.textSettings.fontSize,i.width=i.endX-i.startX,i.height=i.endY-i.startY}else"arrow"===this.currentDrawingShape&&(o.activeObj.start=this.arrowShape[0],o.activeObj.end=this.arrowShape[1]);o.currObjType.isDragging=!0;var c=this.updatePrevShapeSettings(),u={cancel:!1,action:"draw-start",previousShapeSettings:c},v={cancel:!1,action:"move",previousShapeSettings:c};return this.shapeResizingArgs=u,this.shapeMovingArgs=v,this.triggerShapeChange(u,v,"mouse-down"),o.activeObj.activePoint=i,void(o.isShapeDrawing=!0)}o.drawModule.draw({prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!0}}),this.isCropSelection&&this.dragCanvas&&(this.setCursor(a,s),"move"!==o.cursor&&"crosshair"!==o.cursor&&"default"!==o.cursor&&"grab"!==o.cursor&&(this.isPan=!1)),o.activeObj.shape?this.isObjSelected=!0:this.isObjSelected=!1;var g={currObj:{}};o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:g}});var b=g.currObj,C=sf.base.extend({},o.activeObj,null,!0),f=this.isShapeTouch(t,this.isCropSelection),m=this.isFreehandDrawTouch(t,this.isCropSelection),y=f||this.isShapeClick(t,this.isCropSelection),w=this.applyCurrShape(y),P="none"!==o.textArea.style.display;if(this.isTouch&&!f&&C.shape&&!this.isCropSelection){this.applyObj(a,s)&&(o.okBtn(!0),o.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}));var j=sf.base.extend({},o.cropObj,{},!0);o.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:b,previousObjColl:b.objColl,previousPointColl:b.pointColl,previousSelPointColl:b.selPointColl,previousCropObj:j,previousText:null,currentText:null,previousFilter:null,isCircleCrop:o.isCircleCrop}}),w&&o.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})}if(f||o.togglePen||this.isCropSelection||o.updateToolbar(o.element,"imageLoaded","okBtnClick"),!this.dragCanvas||!this.isPan||"grab"!==o.cursor&&!this.isTouch||f||m||o.togglePen){var x=!1;!o.activeObj.shape||"line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape||(x=!0);var O=this.setXYPoints(t),S=O.x,M=O.y;if(this.applyObj(S,M)){if(o.okBtn(!0),w){var T=o.cursor;o.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),o.cursor=T}o.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})}o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:S,y:M,isMouseDown:!0}});var A={index:null};o.freeHandDrawModule.draw({prop:"getFreehandDrawHoveredIndex",onPropertyChange:!1,value:{obj:A}});var F={freehandSelectedIndex:null};if(o.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:F}}),this.isFhdPoint||this.isFhdCustomized&&!o.togglePen){if(!sf.base.isNullOrUndefined(F.freehandSelectedIndex)&&F.freehandSelectedIndex!==A.index){var k=A.index;if(o.okBtn(),this.isFhdCustomized=!1,o.freeHandDrawModule.draw({prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:k}}),A.index>-1){var R=o.pointColl[A.index].strokeColor;o.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:R,strokeWidth:o.pointColl[A.index].strokeWidth}})}}F.freehandSelectedIndex=null,o.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:F}});var I=sf.base.extend([],o.objColl,[],!0);if(!sf.base.isNullOrUndefined(A.index)&&A.index>-1)o.freeHandDrawModule.draw({prop:"selectFhd",value:{type:"ok"}}),o.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.updateToolbar(o.element,"pen"),o.updateToolbar(o.element,"quickAccessToolbar","pen");else if(F.freehandSelectedIndex){o.okBtn();R=o.pointColl[F.freehandSelectedIndex].strokeColor;o.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:R,strokeWidth:o.pointColl[F.freehandSelectedIndex].strokeWidth}})}else this.findTargetObj(S,M,!1)&&(o.objColl=I,this.findTarget(S,M,t.type),o.drawModule.draw({prop:"redrawDownScale"}))}else{if(this.isFhdEditing){o.apply();var z=document.getElementById(o.element.id+"_quickAccessToolbarArea");z&&(z.style.display="none");p=o.pointColl[F.freehandSelectedIndex];var D={id:"pen_"+(F.freehandSelectedIndex+1),type:r.FreehandDraw,startX:p.points[0].x,startY:p.points[0].y,strokeColor:p.strokeColor,strokeWidth:p.strokeWidth,points:p.points,opacity:p.opacity,index:p.order},X={action:"apply",currentShapeSettings:sf.base.extend({},D,{},!0)};o.triggerShapeChanged(X)}if(this.isFhdEditing=!1,x?this.setCursor(S,M):"default"!==n&&(o.upperCanvas.style.cursor=o.cursor=n),"crosshair"===o.cursor||sf.base.Browser.isDevice&&o.togglePen){if(o.togglePen){if(sf.base.isNullOrUndefined(o.activeObj.strokeSettings)){var Y={strokeSettings:{}};o.shapeModule.shape({prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:Y}}),o.activeObj.strokeSettings=Y.strokeSettings}var L={penStrokeWidth:null};o.freeHandDrawModule.draw({prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:L}}),sf.base.isNullOrUndefined(L.penStrokeWidth)&&o.freeHandDrawModule.draw({prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:2}}),this.upperContext.strokeStyle=o.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=o.activeObj.strokeSettings.strokeColor,o.freeHandDrawModule.draw({prop:"freehandDownHandler",onPropertyChange:!1,value:{e:t,canvas:o.upperCanvas}})}else o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height);o.currObjType.isActiveObj=!1,this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0}"crosshair"!==o.cursor&&"touchstart"===t.type.toLowerCase()||o.currObjType.isActiveObj&&"default"!==o.cursor&&!o.togglePen?(o.drawModule.draw({prop:"updateTempObjColl"}),o.drawModule.draw({prop:"updateTempPointColl"}),this.findTarget(S,M,t.type),o.drawModule.draw({prop:"redrawDownScale"})):""!==o.currObjType.shape&&!o.currObjType.isCustomCrop||o.togglePen||"default"===o.cursor||this.setActivePoint(S,M),P&&o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}})}}else{if(this.applyObj(a,s)){if(o.okBtn(!0),w){var H=o.cursor;o.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),o.cursor=H}o.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})}this.isFhdEditing&&(o.freeHandDrawModule.draw({prop:"applyFhd",onPropertyChange:!1}),this.isFhdCustomized=!1);var E=o.activeObj.shape;E&&["rectangle","ellipse","line","arrow","path","text","image"].indexOf(E)>-1&&(o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),o.updateToolbar(o.element,"imageLoaded")),this.canvasMouseDownHandler(t)}this.isShapeInserted=!1,this.tempActiveObj=sf.base.extend({},o.activeObj,{},!0)},e.prototype.mouseMoveEventHandler=function(e){var t=this.parent,o=t.cursor,r=t.upperCanvas.style.cursor;if(e.preventDefault(),!(this.preventDrag||this.isPreventResize||this.isPreventDraging)){this.timer&&this.timer>0&&(this.timer=0);var a=t.lowerCanvas.getBoundingClientRect();if("touchmove"!==e.type||2!==e.touches.length){var s,n;"mousemove"===e.type?(s=e.clientX,n=e.clientY):(this.touchEndPoint.x=s=e.touches[0].clientX,this.touchEndPoint.y=n=e.touches[0].clientY),s-=a.left,n-=a.top,this.canvasMouseMoveHandler(e);var l,h=!1;void 0!==t.activeObj.shape&&(l=t.activeObj.shape.split("-")),void 0!==l&&"crop"===l[0]&&(h=!0),h&&t.transformModule.transform({prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),t.upperCanvas.style.cursor=r,t.cursor=o,(t.currObjType.isActiveObj&&(void 0!==t.activeObj.activePoint||t.objColl.length>0)&&!this.dragCanvas||void 0!==t.activeObj.activePoint)&&""===this.dragElement&&(this.setCursor(s,n),t.activeObj.activePoint&&(0===t.activeObj.activePoint.width||!sf.base.isNullOrUndefined(t.activeObj.currIndex)&&this.cursorTargetId!==t.activeObj.currIndex)&&"default"!==t.cursor&&"move"!==t.cursor&&"crosshair"!==t.cursor&&"grab"!==t.cursor&&"pointer"!==t.cursor&&(t.upperCanvas.style.cursor=t.cursor="move"),this.findTarget(s,n,e.type));var p=t.img,d=p.destLeft,c=p.destTop,u=p.destWidth,v=p.destHeight;t.currObjType.isDragging&&(this.upperContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.updateActivePoint(s,n,h),t.shapeModule.shape({prop:"updateTrianglePoints",onPropertyChange:!1,value:{obj:t.activeObj}}),this.isPreventDragging?(t.activeObj.activePoint.startX>d&&t.activeObj.activePoint.endX<d+u&&t.activeObj.activePoint.startY>c&&t.activeObj.activePoint.endY<c+v&&(this.isPreventDragging=!1),t.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})):t.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:null,saveContext:null,isPreventSelection:null}}),h&&(this.dragCanvas=t.togglePan=!0))}else{if(this.isFirstMove)this.startTouches=this.targetTouches(e.touches),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft-a.left,y:(e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop)-a.top}),this.tempTouches.push({x:(e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft)-a.left,y:(e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop)-a.top});else{var g=(e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft)-a.left,b=(e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop)-a.top,C=(e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft)-a.left,f=(e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop)-a.top,m={x:g<C?C-(C-g)/2:g-(g-C)/2,y:b<f?f-(f-b)/2:b-(b-f)/2};if(this.currMousePoint.x!==m.x&&this.currMousePoint.y!==m.y){var y="";if("touchmove"===e.type&&(t.zoomSettings.zoomTrigger&i.Pinch)===i.Pinch){this.zoomType="Pinch";var w=this.calculateScale(this.startTouches,this.targetTouches(e.touches));this.startTouches=this.targetTouches(e.touches),w>1?y="zoomIn":w<1&&(y="zoomOut")}""!==y&&t.drawModule.draw({prop:"performPointZoom",onPropertyChange:!1,value:{x:m.x,y:m.y,type:y,isResize:null}}),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft,y:e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop}),this.tempTouches.push({x:e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft,y:e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop}),this.currMousePoint.x=m.x,this.currMousePoint.y=m.y,this.isPinching=!0}}this.isFirstMove=!1}}},e.prototype.mouseUpEventHandler=function(e){var t=this.parent,o=t.element.id;if(sf.base.Browser.isDevice||!(t.element.querySelector("#"+o+"_contextualToolbar")&&!t.element.querySelector("#"+o+"_contextualToolbar").parentElement.classList.contains("e-hide")||t.element.querySelector("#"+o+"_headWrapper")&&!t.element.querySelector("#"+o+"_headWrapper").parentElement.classList.contains("e-hide")))if("grabbing"===t.cursor&&this.isGrabbing&&!this.isPreventResize&&t.events&&!0===t.events.onShapeResizeEnd.hasDelegate&&(this.shapeResizingArgs.currentShapeSettings=this.updatePrevShapeSettings(),this.shapeResizingArgs.action="rotate-end",t.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeResizeEnd",this.shapeResizingArgs,null).then((function(e){t.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}))),this.isGrabbing=!1,this.isPreventDraging)this.isPreventDraging=!1;else if(this.isPreventResize)this.isPreventResize=!1;else if(!this.preventDrag&&("canvas"===this.mouseDown||this.isSliderActive||e.target.closest(".e-image-editor")||e.target.closest(".e-ie-ddb-popup"))){"touchstart"===e.type?this.isTouch=!1:"touchend"===e.type&&e.stopImmediatePropagation(),e.preventDefault(),t.togglePan&&this.canvasMouseUpHandler(e);var r=void 0,i=void 0;"mouseup"===e.type?(r=e.clientX,i=e.clientY):(r=this.touchEndPoint.x,i=this.touchEndPoint.y);var a=t.lowerCanvas.getBoundingClientRect();r-=a.left,i-=a.top;var s=void 0,n=this.currentDrawingShape,l=!1;if("touchend"===e.type&&(this.startTouches=this.tempTouches=[],this.isFirstMove=!1,"none"===t.textArea.style.display&&(this.timer=0),this.isPinching))return this.isPinching=!1,t.drawModule.draw({prop:"redrawDownScale"}),(t.isCropTab||t.activeObj.shape)&&(t.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),t.freeHandDrawModule.draw({prop:"resetStraightenPoint"})),void(t.isStraightening&&(t.drawModule.draw({prop:"resetStraightenDestPoints"}),t.drawModule.draw({prop:"setDestForStraighten"})));var h=!1,p=void 0;if(void 0!==t.activeObj.shape&&(p=t.activeObj.shape.split("-")),void 0!==p&&"crop"===p[0]&&(h=!0),t.eventType&&e.currentTarget===t.upperCanvas)if("pan"===t.eventType)t.events&&!0===t.events.onPanEnd.hasDelegate&&t.dotNetRef.invokeMethodAsync("PanEventAsync","OnPanEnd",t.panEventArgs);else if("resize"===t.eventType){if(!this.isCropSelection&&t.events&&!0===t.events.onShapeResizeEnd.hasDelegate)this.shapeResizingArgs.currentShapeSettings=this.updatePrevShapeSettings(),this.shapeResizingArgs.action=""!==this.currentDrawingShape?"drawing":"resize-end",t.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeResizeEnd",this.shapeResizingArgs,null).then((function(e){t.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})}));else if(this.shapeResizingArgs&&this.selectionResizingArgs&&t.events&&!0===t.events.onSelectionResizeEnd.hasDelegate){var d={type:t.activeObj.shape,startX:this.shapeResizingArgs.currentShapeSettings.startX,startY:this.shapeResizingArgs.currentShapeSettings.startY,width:this.shapeResizingArgs.currentShapeSettings.width,height:this.shapeResizingArgs.currentShapeSettings.height};this.selectionResizingArgs.currentSelectionSettings=d,this.selectionResizingArgs.action="resize-end",t.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeEnd",this.selectionResizingArgs).then((function(e){t.shapeModule.shape({prop:"updateSelectionChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:e.currentSelectionSettings}})}))}}else"move"===t.cursor&&this.isDragging&&this.shapeMovingArgs&&t.events&&!0===t.events.onShapeDragEnd.hasDelegate&&(this.shapeMovingArgs.currentShapeSettings=this.updatePrevShapeSettings(),this.shapeMovingArgs.action="drag-end",t.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShapeDragEnd",this.shapeMovingArgs,null).then((function(e){t.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}})})));if(this.isDragging=!1,this.shapeResizingArgs=null,this.shapeMovingArgs=null,t.panEventArgs=null,t.eventType=null,"path"===this.currentDrawingShape&&t.isShapeDrawing){var c=e.srcElement,u=c.parentElement.id,v=t.element.id;return void(e.currentTarget!==t.upperCanvas&&e.currentTarget!==t.lowerCanvas&&t.activeObj.pointColl.length>0&&(c.classList.contains("e-upload-icon")||u===v+"_zoomIn"||u===v+"_zoomOut"||u===v+"_annotationBtn"||u===v+"_borderColorBtn"||u===v+"_borderWidthBtn"||u===v+"_saveBtn")&&(t.shapeModule.shape({prop:"stopPathDrawing",onPropertyChange:!1,value:{e:e,isApply:!0}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}})))}if(e.currentTarget===t.upperCanvas&&!t.isResize){if(this.pathAdjustedIndex=null,""!==this.currentDrawingShape){if("text"===this.currentDrawingShape){var g=sf.base.extend({},t.cropObj,{},!0);t.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.initialPrevObj,previousObjColl:this.initialPrevObj.objColl,previousPointColl:this.initialPrevObj.pointColl,previousSelPointColl:this.initialPrevObj.selPointColl,previousCropObj:g,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}else t.undoRedoModule.undoRedo({prop:"updateUrObj",onPropertyChange:!1,value:{objColl:this.initialPrevObj.objColl,operation:"shapeInsert"}});this.isShapeInserted=!0,this.currentDrawingShape="",(t.activeObj.shape&&"path"===t.activeObj.shape&&0===t.activeObj.pointColl.length||(!t.activeObj.shape||"path"!==t.activeObj.shape)&&0===t.activeObj.activePoint.width&&0===t.activeObj.activePoint.height)&&(l=!0,t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height));var b=this.updatePrevShapeSettings();if(""!==b.type){var C={cancel:!1,action:"draw-end",previousShapeSettings:b},f={cancel:!1,action:"move",previousShapeSettings:b};this.shapeResizingArgs=C,this.shapeMovingArgs=f,this.triggerShapeChange(C,f,"mouse-up")}}this.adjustActObjForLineArrow(),this.updPtCollForShpRot(),t.currObjType.shape=t.currObjType.shape.toLowerCase();var m=sf.base.extend({},t.cropObj,{},!0),y={currObj:{}};t.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:y}});var w=y.currObj;w.objColl=sf.base.extend([],t.objColl,[],!0),w.pointColl=sf.base.extend([],t.pointColl,[],!0),w.afterCropActions=sf.base.extend([],t.afterCropActions,[],!0);var P={selPointColl:null};if(t.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:P}}),w.selPointColl=sf.base.extend([],P.selPointColl,[],!0),!t.togglePen&&!h){if(this.tempObjColl&&0!==t.activeObj.activePoint.width){t.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),JSON.stringify(t.activeObj.activePoint)!==JSON.stringify(this.tempActiveObj.activePoint)&&t.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:w,previousObjColl:this.tempObjColl,previousPointColl:w.pointColl,previousSelPointColl:w.selPointColl,previousCropObj:m,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}});var j=sf.base.extend({},t.objColl[t.objColl.length-1],{},!0);t.objColl.pop(),this.redrawShape(j),this.tempObjColl=void 0}this.isFhdEditing||(this.applyCurrActObj(r,i),t.currObjType.isResize=!1)}if(t.activeObj){var x;void 0!==t.activeObj.shape&&(x=t.activeObj.shape.split("-")),void 0===x&&(t.currObjType.isCustomCrop||t.togglePen)||void 0!==x&&x[0];var O=t.activeObj.shape;s=O;["rectangle","ellipse","line","arrow","path","image"].indexOf(O)>-1?t.updateToolbar(t.element,t.activeObj.shape):"text"===t.activeObj.shape&&"none"===t.textArea.style.display&&t.updateToolbar(t.element,"text")}}void 0!==t.activeObj.shape&&(p=t.activeObj.shape.split("-")),void 0!==p&&"crop"===p[0]&&(h=!0),t.activeObj.shape&&!h&&e.currentTarget===t.upperCanvas&&"none"===t.textArea.style.display&&t.updateToolbar(t.element,"quickAccessToolbar",t.activeObj.shape);var S={freehandDrawSelectedId:null};if(t.freeHandDrawModule.draw({prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:S}}),t.togglePen&&e.currentTarget===t.upperCanvas&&!S.freehandDrawSelectedId?(t.freeHandDrawModule.draw({prop:"freehandUpHandler",onPropertyChange:!1,value:{e:e,canvas:t.upperCanvas,context:this.upperContext}}),t.togglePen&&(t.okBtn(),t.freeHandDraw(!0))):t.currObjType.shape="",!this.isFhdEditing&&e.currentTarget===t.upperCanvas&&(t.activeObj.shape&&"text"===t.activeObj.shape&&11===t.activeObj.textSettings.fontSize&&55===Math.floor(t.activeObj.activePoint.width)&&11===Math.floor(t.activeObj.activePoint.height)&&(t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),document.getElementById(this.parent.element.id+"_quickAccessToolbarArea")&&(document.getElementById(this.parent.element.id+"_quickAccessToolbarArea").style.display="none")),!h))if(this.adjustActObjForLineArrow(),t.isShapeDrawing){var M=this.currentDrawingShape;t.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1}),this.currentDrawingShape=M}else t.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1});this.dragElement="",this.mouseDown="",this.isSliderActive=!1,t.currObjType.isInitialLine=t.currObjType.isDragging=!1,this.selMouseUpEvent(),sf.base.isNullOrUndefined(t.drawingShape)&&s&&""!==n&&(t.drawingShape=s),t.drawingShape&&(this.currentDrawingShape=t.drawingShape.toLowerCase(),l&&(t.enableShapeDrawing(t.toPascalCase(t.drawingShape),!0),t.upperCanvas.style.cursor="crosshair")),t.isShapeDrawing=!1}},e.prototype.adjustActObjForLineArrow=function(e){var t=!1,o=this.parent;if((e=e||o.activeObj).shape&&("line"===e.shape||"arrow"===o.activeObj.shape)){var r=void 0;if(("e-resize"===this.dragElement&&e.activePoint.endX<e.activePoint.startX||"w-resize"===this.dragElement&&e.activePoint.startX>e.activePoint.endX)&&(t=!0,r=e.activePoint.startX,e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=r,r=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=r),e.activePoint.width=Math.abs(e.activePoint.endX-e.activePoint.startX),e.activePoint.height=Math.abs(e.activePoint.endY-e.activePoint.startY),"path"!==o.activeObj.shape){o.shapeModule.shape({prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:e}});for(var i=0;i<e.pointColl.length;i++)e.pointColl[i].ratioX=(e.pointColl[i].x-o.img.destLeft)/o.img.destWidth,e.pointColl[i].ratioY=(e.pointColl[i].y-o.img.destTop)/o.img.destHeight}}return t},e.prototype.updPtCollForShpRot=function(e){var t=this.parent;if((e=e||t.activeObj).shape&&0!==e.rotatedAngle){t.shapeModule.shape({prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:e}});var o=t.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight,n=e.horTopLinePointColl,l=e.horBottomLinePointColl,h=e.verLeftLinePointColl,p=e.verRightLinePointColl,d=function(e){e.ratioX=(e.x-r)/a,e.ratioY=(e.y-i)/s};n.forEach(d),l.forEach(d),h.forEach(d),p.forEach(d)}},e.prototype.setXYPoints=function(e){var t,o;e.preventDefault(),"mousedown"===e.type?(t=e.clientX,o=e.clientY):(this.touchEndPoint.x=t=e.touches[0].clientX,this.touchEndPoint.y=o=e.touches[0].clientY);var r=this.parent.lowerCanvas.getBoundingClientRect();return{x:t-=r.left,y:o-=r.top}},e.prototype.getCurrentIndex=function(){for(var e,t=this.parent,o=0,r=t.objColl.length;o<r;o++)if(t.activeObj.currIndex===t.objColl[o].currIndex){e=o;break}return e},e.prototype.isShapeClick=function(e,t){var o=this.parent,r=!1;if(o.togglePen)return r;if(o.activeObj.shape&&"text"===o.activeObj.shape&&this.isShapeInserted){var i="block"===o.textArea.style.display||"inline-block"===o.textArea.style.display,a=sf.base.extend({},o.activeObj,null,!0);o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var s=this.setXYPoints(e),n=s.x,l=s.y;if(r=this.findTargetObj(n,l,t),t||(this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),r&&o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}})),i){o.textArea.value=o.objColl[o.objColl.length-1].keyHistory,o.textArea.style.display="block",o.activeObj=a;var h=this.getCurrentIndex();sf.base.isNullOrUndefined(h)?o.objColl.pop():o.objColl.splice(h,1)}else if(!r&&a.shape){o.activeObj=a;h=this.getCurrentIndex();sf.base.isNullOrUndefined(h)||JSON.stringify(o.activeObj.activePoint)!==JSON.stringify(o.objColl[h].activePoint)?sf.base.isNullOrUndefined(o.activeObj.currIndex)&&o.objColl.pop():o.objColl.splice(h,1)}}return r},e.prototype.isShapeTouch=function(e,t){var o=this.parent,r=!1;if("touchstart"===e.type&&!o.togglePen){o.activeObj&&"text"===o.activeObj.shape&&(this.timer=setTimeout(this.setTimer.bind(this),1e3,e));var i="block"===o.textArea.style.display||"inline-block"===o.textArea.style.display,a=sf.base.extend({},o.activeObj,null,!0);o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var s=this.setXYPoints(e),n=s.x,l=s.y;if(r=this.findTargetObj(n,l,t),t||this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),i){o.textArea.value=o.objColl[o.objColl.length-1].keyHistory,o.textArea.style.display="block",o.activeObj=a;var h=this.getCurrentIndex();sf.base.isNullOrUndefined(h)?o.objColl.pop():o.objColl.splice(h,1)}else if(!r&&a.shape){o.activeObj=a;h=this.getCurrentIndex();t||(sf.base.isNullOrUndefined(h)||JSON.stringify(o.activeObj.activePoint)!==JSON.stringify(o.objColl[h].activePoint)?sf.base.isNullOrUndefined(o.activeObj.currIndex)&&o.objColl.pop():o.objColl.splice(h,1))}}return r},e.prototype.isFreehandDrawTouch=function(e,t){var o=this.parent,r=!1;if("touchstart"===e.type&&!t&&!o.togglePen){var i="block"===o.textArea.style.display||"inline-block"===o.textArea.style.display,a=sf.base.extend({},o.activeObj,null,!0);o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var s=this.setXYPoints(e),n=s.x,l=s.y;if(this.setCursor(n,l),this.isFhdPoint&&(r=!0),i){o.textArea.value=o.objColl[o.objColl.length-1].keyHistory,o.textArea.style.display="block",o.activeObj=a;var h=this.getCurrentIndex();sf.base.isNullOrUndefined(h)?o.objColl.pop():o.objColl.splice(h,1)}else if(a.shape){o.activeObj=a;h=this.getCurrentIndex();t||(sf.base.isNullOrUndefined(h)||JSON.stringify(o.activeObj.activePoint)!==JSON.stringify(o.objColl[h].activePoint)?sf.base.isNullOrUndefined(o.activeObj.currIndex)&&o.objColl.pop():o.objColl.splice(h,1))}}return r},e.prototype.applyObj=function(e,t){var o=this.parent,r=!1;if(0===o.activeObj.activePoint.width&&0===o.activeObj.activePoint.height)return!1;var i=o.activeObj.activePoint,a=i.startX,s=i.startY,n=i.endX,l=i.endY;if(o.activeObj.shape&&["rectangle","ellipse","line","arrow","path","image","text"].indexOf(o.activeObj.shape)>-1){var h=o.activeObj.topLeftCircle.radius;r=!(e>=a-2*h&&e<=n+2*h&&t>=s-2*h&&t<=l+2*h)&&("default"===o.upperCanvas.style.cursor||"grab"===o.upperCanvas.style.cursor||"crosshair"===o.upperCanvas.style.cursor||"pointer"===o.upperCanvas.style.cursor||"move"===o.upperCanvas.style.cursor)}return r},e.prototype.applyCurrShape=function(e){var t=this.parent,o=!1;if(t.togglePen)return o;var r=sf.base.extend({},t.activeObj,null,!0);if(this.isShapeInserted&&"text"===t.activeObj.shape&&e&&(this.isInitialTextEdited=!0,t.drawModule.draw({prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}})),"block"===t.textArea.style.display||"inline-block"===t.textArea.style.display){var i=sf.base.extend({},t.activeObj,null,!0);t.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r=sf.base.extend({},t.objColl[t.objColl.length-1],null,!0),t.objColl.pop(),t.activeObj=sf.base.extend({},i,null,!0),t.textArea.value=r.keyHistory,t.textArea.style.display="block";var a=r.strokeSettings&&r.strokeSettings.strokeColor?"rgb"===r.strokeSettings.strokeColor.split("(")[0]?this.rgbToHex(parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[0]),parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[1]),parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[2]),parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[3])):r.strokeSettings.strokeColor:null;a&&"#ffffff"===a&&(a="#fff"),this.tempActiveObj.strokeSettings&&this.tempActiveObj.strokeSettings.strokeColor&&"#ffffff"===this.tempActiveObj.strokeSettings.strokeColor&&(this.tempActiveObj.strokeSettings.strokeColor="#fff"),(r.keyHistory!==this.tempActiveObj.keyHistory||a&&a!==this.tempActiveObj.strokeSettings.strokeColor||r.textSettings&&r.textSettings.fontFamily!==this.tempActiveObj.textSettings.fontFamily||r.textSettings&&Math.round(r.textSettings.fontSize)!==Math.round(this.tempActiveObj.textSettings.fontSize)||r.textSettings&&Math.round(r.textSettings.fontRatio)!==Math.round(this.tempActiveObj.textSettings.fontRatio)||r.textSettings&&r.textSettings.bold!==this.tempActiveObj.textSettings.bold||r.textSettings&&r.textSettings.italic!==this.tempActiveObj.textSettings.italic||r.textSettings&&r.textSettings.underline!==this.tempActiveObj.textSettings.underline)&&(o=!0),this.isInitialTextEdited&&!o&&(o=!0,this.isInitialTextEdited=!1)}else this.tempActiveObj.activePoint.height=Math.abs(this.tempActiveObj.activePoint.height),o=JSON.stringify(r)!==JSON.stringify(this.tempActiveObj);return o},e.prototype.canvasMouseDownHandler=function(e){var t,o,r=this.parent;e.preventDefault(),"mousedown"===e.type?(t=e.offsetX||e.pageX-r.lowerCanvas.offsetLeft,o=e.offsetY||e.pageY-r.lowerCanvas.offsetTop):(t=e.touches[0].clientX||e.touches[0].pageX-r.lowerCanvas.offsetLeft,o=e.touches[0].clientY||e.touches[0].pageY-r.lowerCanvas.offsetTop);var i=r.lowerCanvas.getBoundingClientRect();t-=i.left,o-=i.top,this.panDown={x:t,y:o};var a={tempPanMove:null};r.transformModule.transform({prop:"getTempPanMove",onPropertyChange:!1,value:{obj:a}}),sf.base.isNullOrUndefined(a.tempPanMove)&&r.transformModule.transform({prop:"setTempPanMove",onPropertyChange:!1,value:{point:{x:t,y:o}}})},e.prototype.canvasMouseMoveHandler=function(e){var t=this.parent;if(t.isResize)t.upperCanvas.style.cursor="default";else{var o,r;this.dragCanvas?t.lowerCanvas.style.cursor="grab":(this.dragCanvas=t.togglePan=!1,t.lowerCanvas.style.cursor=t.upperCanvas.style.cursor=t.cursor="default"),"mousemove"===e.type?(o=e.offsetX,r=e.offsetY):(o=e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft,r=e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop);var i=t.lowerCanvas.getBoundingClientRect(),a={x:o-=i.left,y:r-=i.top};t.transformModule.transform({prop:"setPanMove",onPropertyChange:!1,value:{point:{x:o,y:r}}}),this.panDown&&a&&t.togglePan&&this.dragCanvas&&((t.isCropTab||t.activeObj.shape)&&(t.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),t.freeHandDrawModule.draw({prop:"resetStraightenPoint"})),t.transformModule.transform({prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:null,yDiff:null}}))}},e.prototype.canvasMouseUpHandler=function(e){var t=this.parent;e.preventDefault();var o={panMove:null};t.transformModule.transform({prop:"getPanMove",onPropertyChange:!1,value:{obj:o}}),t.togglePan&&this.panDown&&o.panMove&&t.togglePan&&this.dragCanvas&&(this.panDown=null,t.transformModule.transform({prop:"setPanMove",onPropertyChange:!1,value:{point:null}})),t.transformModule.transform({prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),"path"!==this.currentDrawingShape&&(t.currObjType.isDragging=!1)},e.prototype.touchStartHandler=function(e){e.preventDefault();var t=this.parent;0===this.touchTime?this.touchTime=(new Date).getTime():(new Date).getTime()-this.touchTime<400?(t.shapeModule.shape({prop:"stopPathDrawing",onPropertyChange:!1,value:{e:e,isApply:null}}),this.touchTime=0):this.touchTime=(new Date).getTime(),2===e.touches.length?this.isFirstMove=!0:this.mouseDownEventHandler(e),sf.base.EventHandler.add(t.lowerCanvas,"touchend",this.mouseUpEventHandler,this),sf.base.EventHandler.add(t.lowerCanvas,"touchmove",this.mouseMoveEventHandler,this),sf.base.EventHandler.add(t.upperCanvas,"touchend",this.mouseUpEventHandler,this),sf.base.EventHandler.add(t.upperCanvas,"touchmove",this.mouseMoveEventHandler,this)},e.prototype.unwireEvent=function(){var e=this.parent;sf.base.EventHandler.remove(e.lowerCanvas,"touchend",this.mouseUpEventHandler),sf.base.EventHandler.remove(e.lowerCanvas,"touchmove",this.mouseMoveEventHandler),sf.base.EventHandler.remove(e.upperCanvas,"touchend",this.mouseUpEventHandler),sf.base.EventHandler.remove(e.upperCanvas,"touchmove",this.mouseMoveEventHandler)},e.prototype.keyDownEventHandler=function(e){var t=this,o=this.parent;!e.ctrlKey||"+"!==e.key&&"-"!==e.key||e.preventDefault();var r={fileName:"",fileType:null};o.drawModule.draw({prop:"getFileName",onPropertyChange:!1,value:{obj:r}});var a={fileName:r.fileName,fileType:r.fileType,cancel:!1};o.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hidden");switch(e.key){case e.ctrlKey&&"s":o.events&&!0===o.events.saving.hasDelegate?o.dotNetRef.invokeMethodAsync("BeforeSaveEventAsync","BeforeSave",a).then((function(o){t.beforeSaveEvent(o,e)})):this.beforeSaveEvent(a,e);break;case e.ctrlKey&&"z":o.allowUndoRedo&&(o.noPushUndo=!1,(o.togglePen||o.drawingShape)&&(o.okBtn(),o.drawingShape=null),o.undoRedoModule.undoRedo({prop:"call-undo"}));break;case e.ctrlKey&&"y":o.allowUndoRedo&&(o.noPushUndo=!1,(o.togglePen||o.drawingShape)&&(o.okBtn(),o.drawingShape=null),o.undoRedoModule.undoRedo({prop:"call-redo"}));break;case e.ctrlKey&&"+":(o.zoomSettings.zoomTrigger&i.Commands)===i.Commands&&(this.zoomType="Commands",o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}}),o.drawModule.draw({prop:"redrawDownScale"}),(o.isCropTab||o.activeObj.shape)&&(o.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),o.freeHandDrawModule.draw({prop:"resetStraightenPoint"})),o.isStraightening&&(o.drawModule.draw({prop:"resetStraightenDestPoints"}),o.drawModule.draw({prop:"setDestForStraighten"})));break;case e.ctrlKey&&"-":(o.zoomSettings.zoomTrigger&i.Commands)===i.Commands&&(this.zoomType="Commands",o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}}),o.drawModule.draw({prop:"redrawDownScale"}),(o.isCropTab||o.activeObj.shape)&&(o.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),o.freeHandDrawModule.draw({prop:"resetStraightenPoint"})),o.isStraightening&&(o.drawModule.draw({prop:"resetStraightenDestPoints"}),o.drawModule.draw({prop:"setDestForStraighten"})));break;case"Delete":this.deleteItem();break;case"Escape":o.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null,isFinalCancel:!0}});break;case"Enter":this.performEnterAction(e);break;case"Tab":this.performTabAction();break;default:!sf.base.Browser.isDevice||"block"!==o.textArea.style.display&&"inline-block"!==o.textArea.style.display||setTimeout(this.textKeyDown.bind(this),1,e)}},e.prototype.performEnterAction=function(e){var t=this.parent;if(t.isKeyDown=!0,t.isResize){if(!this.isValueUpdated())return;var o=this.getNumTextValue(),r=t.element.querySelector("#"+t.element.id+"_aspectratio"),i=t.element.querySelector(".e-ie-toolbar-aspect-ratio-btn");o&&o.x&&o.y&&(r||i&&!i.classList.contains("e-hidden")?t.transformModule.transform({prop:"resize",value:{width:o.x,height:null,isAspectRatio:!0}}):t.transformModule.transform({prop:"resize",value:{width:o.x,height:o.y,isAspectRatio:!1}}));var a=this.parent.element.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox"),s=this.parent.element.querySelector(".e-ie-toolbar-e-resize-width-input .e-textbox");i&&i.classList.contains("e-hidden")&&(a&&""===a.value&&(a.value=a.placeholder,a.value=a.placeholder),s&&""===s.value&&(s.value=s.placeholder,s.value=s.placeholder)),t.drawModule.draw({prop:"redrawDownScale"})}else if("contextual-toolbar"===t.currentToolbar&&(e.target.classList.contains("e-ie-filter-canvas")||e.target.classList.contains("filter-wrapper"))){t.element.querySelectorAll(".e-ie-filter-canvas").forEach((function(e){e.setAttribute("tabindex","-1")}));var n=e.target.classList.contains("e-ie-filter-canvas")?e.target:e.target.querySelector(".e-ie-filter-canvas");n&&(t.contextualToolbarClicked(n.id.split("r-")[1]),n.setAttribute("tabindex","0"))}else{var l=void 0;t.activeObj.shape&&(l=t.activeObj.shape.split("-")),e&&this.isKeyBoardCrop(e)&&t.activeObj.horTopLine&&t.activeObj.shape&&"crop"===l[0]&&t.crop()}},e.prototype.isKeyBoardCrop=function(e){e.target;return!1},e.prototype.beforeSaveEvent=function(e,t){t.preventDefault(),t.stopImmediatePropagation()},e.prototype.handleScroll=function(e){var t,o,r=this.parent,a=!1;"mousewheel"===e.type&&(t=e.clientX,o=e.clientY);var s=r.lowerCanvas.getBoundingClientRect();if(t-=s.left,o-=s.top,t>r.img.destLeft&&t<r.img.destLeft+r.img.destWidth&&o>r.img.destTop&&o<r.img.destTop+r.img.destHeight&&(a=!0),e.stopPropagation(),!0===e.ctrlKey&&a){e.preventDefault(),!r.isCropTab&&r.activeObj.shape&&"crop"!==r.activeObj.shape.split("-")[0]&&r.okBtn(null,!0);var n="";"mousewheel"===e.type&&(r.zoomSettings.zoomTrigger&i.MouseWheel)===i.MouseWheel&&(this.zoomType="MouseWheel",n=e.wheelDelta>0?"zoomIn":"zoomOut"),""!==n&&(r.drawModule.draw({prop:"performPointZoom",onPropertyChange:!1,value:{x:t,y:o,type:n,isResize:null}}),r.drawModule.draw({prop:"redrawDownScale"}),(r.isCropTab||r.activeObj.shape)&&(r.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),r.freeHandDrawModule.draw({prop:"resetStraightenPoint"})),r.isStraightening&&(r.drawModule.draw({prop:"resetStraightenDestPoints"}),r.drawModule.draw({prop:"setDestForStraighten"})))}},e.prototype.textKeyDown=function(e){var t=this.parent;if(0===t.activeObj.rotatedAngle){"\r"===String.fromCharCode(e.which)&&(this.textRow+=1),t.textArea.setAttribute("rows",this.textRow.toString()),t.textArea.style.height="auto",t.textArea.style.height=t.textArea.scrollHeight+"px",t.shapeModule.shape({prop:"setTextBoxWidth",onPropertyChange:!1,value:{e:e}}),sf.base.Browser.isDevice&&(t.textArea.style.width=parseFloat(t.textArea.style.width)+t.textArea.style.fontSize+"px");var o=t.textArea.value.split("\n");this.textRow=o.length,t.textArea.setAttribute("rows",this.textRow.toString()),this.isInitialTextEdited=!1}},e.prototype.clearSelection=function(e){var t=this.parent;!t.disabled&&t.isImageLoaded&&(e?t.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null}}):(t.togglePen=!1,t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0,t.currObjType.shape="",this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.currObjType.isActiveObj=!0,t.currObjType.isCustomCrop=!1,t.upperCanvas.style.cursor=t.cursor="default"))},e.prototype.setDragDirection=function(e,t){var o=this.parent,r=o.activeObj.activePoint;o.img.destWidth>o.img.destHeight?(r.startX=this.dragPoint.startX=e/2-t/2+7.5,r.startY=this.dragPoint.startY=t/2-t/2+7.5,r.endX=e/2+t/2-7.5,r.endY=t/2+t/2-7.5):(r.startY=this.dragPoint.startX=t/2-e/2+7.5,r.endY=t/2+e/2-7.5,r.startX=this.dragPoint.startX=7.5,r.endX=e-7.5)},e.prototype.calcShapeRatio=function(e,t,o,r){for(var i=this.parent,a=i.activeObj.activePoint,s=o,n=r,l=s>=n?s:n,h=l*(e/t),p=l,d=this.getScale(h,s),c=[],u=i.img,v=u.destLeft,g=u.destTop,b=u.destWidth,C=u.destHeight,f=0;f<2;f++)0===f?c.push(h*d):c.push(p*d);h=c[0],p=c[1];var m=this.getScale(p,n),y=[];for(f=0;f<2;f++)0===f?y.push(h*m):y.push(p*m);h=y[0],p=y[1],a.width=h,a.height=p,a.startX=7.5+(this.dragPoint.startX=(s-h)/2),a.startY=7.5+(this.dragPoint.startY=(n-p)/2),a.endX=a.startX+a.width,a.endY=a.startY+a.height,a.startX<v&&v+b>i.lowerCanvas.clientWidth&&(a.startX=v,a.endX=a.startX+h-7.5),a.startY<g&&g+C>i.lowerCanvas.clientHeight&&(a.startY=g,a.endY=a.startY+p-7.5),a.width=a.endX-a.startX,a.height=a.endY-a.startY},e.prototype.getScale=function(e,t){return e>t?t/e:1},e.prototype.findTarget=function(e,t,o){var r=this.parent;if("mousedown"===o.toLowerCase()||"touchstart"===o.toLowerCase()){var i=!1;r.activeObj.shape&&"crop"===r.activeObj.shape.split("-")[0]&&(i=!0),this.findTargetObj(e,t,i),this.updateCursorStyles(e,t,o)}else{var a=r.activeObj,s=a.topLeftCircle,n=a.topCenterCircle,l=a.topRightCircle,h=a.centerLeftCircle,p=a.centerRightCircle,d=a.bottomLeftCircle,c=a.bottomCenterCircle,u=a.bottomRightCircle;switch(this.dragElement.toLowerCase()){case"nw-resize":s.startX=e,s.startY=t;break;case"n-resize":n.startX=e,n.startY=t;break;case"ne-resize":l.startX=e,l.startY=t;break;case"w-resize":h.startX=e,h.startY=t;break;case"e-resize":p.startX=e,p.startY=t;break;case"sw-resize":d.startX=e,d.startY=t;break;case"s-resize":c.startX=e,c.startY=t;break;case"se-resize":u.startX=e,u.startY=t;break;default:this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t)}}},e.prototype.findTargetObj=function(e,t,o){var r=this,i=this.parent,a=!1;if(0!==i.objColl.length&&!i.currObjType.isCustomCrop&&!o){for(var s=0,n=void 0,l=0;l<i.objColl.length;l++){var h=i.upperCanvas.style.cursor;this.setCursor(e,t);var p=sf.base.extend({},i.objColl[l],{},!0),d=p.topLeftCircle.radius;if("line"===p.shape||"arrow"===p.shape){for(var c=0;c<p.pointColl.length;c++)if(e>=p.pointColl[c].x-2*d&&e<=p.pointColl[c].x+2*d&&t>=p.pointColl[c].y-2*d&&t<=p.pointColl[c].y+2*d){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=l;break}this.isTouch||"move"===i.cursor||"grab"===i.cursor||this.isShapeInserted?(0===s||s<p.order)&&(s=p.order,n=l):i.objColl[l].currIndex===this.tempActiveObj.currIndex&&(n=l);break}}else if("path"===p.shape){var u=this.setCursorForPath(p,e,t,i.upperCanvas);if("default"!==u&&"grab"!==u){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=l;break}this.isTouch||"move"===i.cursor||"grab"===i.cursor||this.isShapeInserted?(0===s||s<p.order)&&(s=p.order,n=l):i.objColl[l].currIndex===this.tempActiveObj.currIndex&&(n=l)}}else if(0!==p.rotatedAngle){var v=this.setCursorForRotatedObject(p,e,t,i.upperCanvas);if("default"!==v&&"grab"!==v){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=l;break}this.isTouch||"move"===i.cursor||"grab"===i.cursor||this.isShapeInserted?(0===s||s<p.order)&&(s=p.order,n=l):i.objColl[l].currIndex===this.tempActiveObj.currIndex&&(n=l)}}else{var g=this.getTransRotationPoint(p);if(e>=p.activePoint.startX-2*d&&e<=p.activePoint.endX+2*d&&t>=p.activePoint.startY-2*d&&t<=p.activePoint.endY+2*d||g&&e>=g.x-2*d&&e<=g.x+2*d&&t>=g.y-2*d&&t<=g.y+2*d){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=l;break}this.isTouch||"move"===h||"grabbing"===h||this.isShapeInserted||"move"===i.cursor||"grabbing"===i.cursor?(0===s||s<p.order)&&(s=p.order,n=l):i.objColl[l].currIndex===this.tempActiveObj.currIndex&&(n=l)}}}if(sf.base.isNullOrUndefined(n))i.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),a=!1;else{this.tempObjColl=sf.base.extend([],i.objColl,[],!0),i.currObjType.isCustomCrop=!1,i.activeObj=sf.base.extend({},i.objColl[n],{},!0);var b=sf.base.extend({},i.objColl[n],{},!0);if(i.objColl.splice(n,1),0===i.transform.degree){var C=this.lowerContext.filter;this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter="none",i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),i.activeObj=sf.base.extend({},C,{},!0),this.lowerContext.filter=C,this.getCurrentFlipState()}else{var f=sf.base.extend({},i.panPoint.totalPannedInternalPoint,{},!0),m={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight};i.drawModule.draw({prop:"callUpdateCurrTransState",onPropertyChange:!1}),i.panPoint.totalPannedInternalPoint=f,i.img.destLeft=m.startX,i.img.destTop=m.startY,i.img.destWidth=m.width,i.img.destHeight=m.height,i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}})}i.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape||i.isCircleCrop)&&i.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i.activeObj=sf.base.extend({},b,{},!0),this.setActivePoint(),i.activeObj=sf.base.extend({},b,{},!0);var y=sf.base.extend({},i.activeObj.strokeSettings,{},!0);i.drawModule.draw({prop:"setTempStrokeSettings",onPropertyChange:!1,value:{tempStrokeSettings:y}});var w=sf.base.extend({},i.activeObj.textSettings,{},!0);i.drawModule.draw({prop:"setTempTextSettings",onPropertyChange:!1,value:{tempTextSettings:w}});var P=this.updatePrevShapeSettings(),j={cancel:!1,action:"select",previousShapeSettings:P,currentShapeSettings:P};"line"!==i.activeObj.shape&&"arrow"!==i.activeObj.shape||(j.currentShapeSettings.width=i.activeObj.activePoint.endX-i.activeObj.activePoint.startX,j.currentShapeSettings.height=i.activeObj.activePoint.endY-i.activeObj.activePoint.startY),this.isCropSelection=!1;var x=void 0;if(void 0!==i.activeObj.shape&&(x=i.activeObj.shape.split("-")),void 0!==x&&"crop"===x[0]&&(this.isCropSelection=!0),!this.isCropSelection&&sf.base.isNullOrUndefined(i.eventType)&&i.events&&!0===i.events.shapeChanging.hasDelegate)i.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",j,null),this.shapeEvent(j);else if(this.isCropSelection){var O={action:j.action,previousSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:j.previousShapeSettings.startX,startY:j.previousShapeSettings.startY,width:j.previousShapeSettings.width,height:j.previousShapeSettings.height},currentSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:j.currentShapeSettings.startX,startY:j.currentShapeSettings.startY,width:j.currentShapeSettings.width,height:j.currentShapeSettings.height}};i.events&&!0===i.events.onSelectionResizeStart.hasDelegate?i.dotNetRef.invokeMethodAsync("SelectionEventAsync","OnSelectionResizeStart",O).then((function(e){j.currentShapeSettings.startX=e.currentSelectionSettings.startX,j.currentShapeSettings.startY=e.currentSelectionSettings.startY,j.currentShapeSettings.width=e.currentSelectionSettings.width,j.currentShapeSettings.height=e.currentSelectionSettings.height,r.shapeEvent(j)})):(j.currentShapeSettings.startX=O.currentSelectionSettings.startX,j.currentShapeSettings.startY=O.currentSelectionSettings.startY,j.currentShapeSettings.width=O.currentSelectionSettings.width,j.currentShapeSettings.height=O.currentSelectionSettings.height,this.shapeEvent(j))}else this.shapeEvent(j);a=!0;var S=i.upperCanvas.style.cursor;this.setCursor(e,t),"select"===j.action&&"move"===i.upperCanvas.style.cursor&&i.getShapeValue(i.activeObj.shape),i.upperCanvas.style.cursor=S}}return a},e.prototype.shapeEvent=function(e){var t=this.parent;if(t.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}}),t.activeObj.activePoint){var o={prevActObj:null};if(t.drawModule.draw({prop:"getPrevActObj",onPropertyChange:!1,value:{obj:o}}),sf.base.isNullOrUndefined(o.prevActObj)&&t.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:sf.base.extend({},t.activeObj,{},!0)}}),"image"!==t.activeObj.shape||this.isImageClarity||(this.upgradeImageQuality(),this.isImageClarity=!0),t.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}}),!this.isShapeInserted){var r=t.activeObj.activePoint,i=t.img,a=i.destLeft,s=i.destWidth,n=i.destTop,l=i.destHeight;this.isPreventDragging=r.startX<a||r.endX>a+s||r.startY<n||r.endY>n+l}}},e.prototype.upgradeImageQuality=function(){var e=this.parent,t=sf.base.extend({},e.activeObj,null,!0),o=e.activeObj.imageCanvas.getContext("2d"),r={width:0,height:0};e.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:e.activeObj.imageElement.width,height:e.activeObj.imageElement.height,obj:r,isImgShape:null}}),e.shapeModule.shape({prop:"updateObj",onPropertyChange:!1,value:{dimObj:r,x:null,y:null}}),o.clearRect(0,0,e.activeObj.imageCanvas.width,e.activeObj.imageCanvas.height),this.applyTransformToImg(o),e.activeObj=t},e.prototype.applyTransformToImg=function(e){var t=this.parent;t.activeObj.isHorImageFlip&&t.activeObj.isVerImageFlip?(t.activeObj.isHorImageFlip=t.activeObj.isVerImageFlip=!1,t.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!0,isVFlip:!0}})):t.activeObj.isHorImageFlip?(t.activeObj.isHorImageFlip=!1,t.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!0,isVFlip:!1}})):t.activeObj.isVerImageFlip?(t.activeObj.isVerImageFlip=!1,t.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!1,isVFlip:!0}})):t.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!1,isVFlip:!1}})},e.prototype.targetTouches=function(e){var t=this.parent.lowerCanvas.getBoundingClientRect();return[{x:e[0].pageX-t.left,y:e[0].pageY-t.top},{x:e[1].pageX-t.left,y:e[1].pageY-t.top}]},e.prototype.calculateScale=function(e,t){var o=this.getDistance(e[0],e[1]);return this.getDistance(t[0],t[1])/o},e.prototype.getDistance=function(e,t){var o=0,r=0;return e&&t&&(o=e.x-t.x,r=e.y-t.y),Math.sqrt(o*o+r*r)},e.prototype.redrawShape=function(e,t){for(var o=this.parent,r=0,i=o.objColl.length;r<i;r++)if(JSON.stringify(e)===JSON.stringify(o.objColl[r])){o.objColl.splice(r,1);break}"path"===e.shape&&0===e.pointColl.length||"path"!==e.shape&&0===e.activePoint.width&&0===e.activePoint.height||(this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.isPreventDragging?(o.activeObj.activePoint.startX>o.img.destLeft&&(this.isPreventDragging=!1),t&&o.activeObj.rotatedAngle,o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})):(t&&o.activeObj.rotatedAngle,o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})))},e.prototype.setTimer=function(e){var t=this.parent;this.timer>10&&(clearTimeout(this.timer),this.timer=0,t.shapeModule.shape({prop:"findTextTarget",onPropertyChange:!1,value:{e:e}}),sf.base.Browser.isDevice&&this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height))},e.prototype.applyCurrActObj=function(e,t){var o=this.parent,r=!1,i=sf.base.extend({},o.activeObj,{},!0);if(!sf.base.isNullOrUndefined(i.activePoint)){var a=i.activePoint,s=a.startX,n=a.startY,l=a.endX,h=a.endY,p=i.topLeftCircle?i.topLeftCircle.radius:0;if(e>=Math.floor(s)&&e<=Math.ceil(l)&&t>=Math.floor(n)&&t<=Math.ceil(h))r=!0;else if(0!==p&&e>=Math.floor(s)-p&&e<=Math.ceil(l)+p&&t>=Math.floor(n)-p&&t<=Math.ceil(h)+p)r=!0,this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]};else if("text"!==i.shape&&"image"!==i.shape||""===this.dragElement)if("line"===i.shape||"arrow"===i.shape){var d={x:s<l?s:l,y:n<h?n:h},c={x:s>l?s:l,y:n>h?n:h};e>=Math.floor(d.x)-5&&e<=Math.ceil(c.x)+5&&t>=Math.floor(d.y)-5&&t<=Math.ceil(c.y)+5&&(r=!0)}else if("path"===i.shape){"move"===(u=this.setCursorForPath(i,e,t,o.upperCanvas))&&(r=!0)}else if("grabbing"===this.dragElement)r=!0;else if(0!==i.rotatedAngle){var u;("default"!==(u=this.setCursorForRotatedObject(i,e,t,o.upperCanvas))&&"grab"!==u||"n-resize"===this.dragElement||"e-resize"===this.dragElement||"s-resize"===this.dragElement||"w-resize"===this.dragElement)&&(r=!0)}else"block"!==o.textArea.style.display&&"inline-block"!==o.textArea.style.display||(r=!0);else r=!0;if(!r){if(sf.base.isNullOrUndefined(o.activeObj.currIndex)){var v={id:"shape_"+(o.objColl.length+1)};o.shapeModule.shape({prop:"getNewShapeId",onPropertyChange:!1,value:{obj:v}}),o.activeObj.currIndex=v.id}o.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),void 0===o.activeObj.horTopLine||0===o.activeObj.horTopLine.startX||0===o.activeObj.horTopLine.endX||o.currObjType.isCustomCrop||""===o.currObjType.shape||o.objColl.push(sf.base.extend({},o.activeObj,{},!0));if(["rectangle","ellipse","line","arrow","path","text","image"].indexOf(o.activeObj.shape)>-1){var g=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)";for(var b=0;b<o.objColl.length;b++){var C={isInside:!1};o.cropModule.cropping({prop:"isObjInImage",onPropertyChange:!1,value:{obj:o.objColl[b],object:C}}),C.isInside&&(o.shapeModule.shape({prop:"apply",onPropertyChange:!1,value:{shape:o.objColl[b].shape,obj:o.objColl[b],canvas:null}}),o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}))}o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=g,o.activeObj.shape&&o.shapeModule.shape({prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.isCircleCrop&&o.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})}}}},e.prototype.getCurrentFlipState=function(){var e=this.parent;if(0!==e.rotateFlipColl.length){var t=sf.base.extend({},e.panPoint.totalPannedInternalPoint,{},!0);e.drawModule.draw({prop:"callUpdateCurrTransState",onPropertyChange:!1}),e.panPoint.totalPannedInternalPoint=t}else e.drawModule.draw({prop:"callUpdateCurrTransState",onPropertyChange:!1})},e.prototype.setTextBoxStylesToActObj=function(){var e=this.parent;e.activeObj.textSettings.fontFamily=e.textArea.style.fontFamily,e.activeObj.strokeSettings.strokeColor=""!==e.textArea.style.color&&e.textArea.style.color.split("(")[1]&&e.textArea.style.color.split("(")[1].split(",")[0]&&e.textArea.style.color.split("(")[1].split(",")[1]&&e.textArea.style.color.split("(")[1].split(",")[2]&&e.textArea.style.color.split("(")[1].split(",")[3]?this.rgbToHex(parseFloat(e.textArea.style.color.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[2]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[3])):e.textArea.style.color,"bold"===e.textArea.style.fontWeight?e.activeObj.textSettings.bold=!0:e.activeObj.textSettings.bold=!1,"italic"===e.textArea.style.fontStyle?e.activeObj.textSettings.italic=!0:e.activeObj.textSettings.italic=!1,e.activeObj.textSettings.fontSize=parseFloat(e.textArea.style.fontSize)},e.prototype.rgbToHex=function(e,t,o,r){return e=Math.max(0,Math.min(255,Math.round(e))),t=Math.max(0,Math.min(255,Math.round(t))),o=Math.max(0,Math.min(255,Math.round(o))),r=Math.max(0,Math.min(1,r)),"#"+this.padLeft(e.toString(16),2,"0")+this.padLeft(t.toString(16),2,"0")+this.padLeft(o.toString(16),2,"0")+this.padLeft(Math.round(255*r).toString(16),2,"0")},e.prototype.padLeft=function(e,t,o){for(;e.length<t;)e=o+e;return e},e.prototype.deleteItem=function(){var e=this.parent,t={cancel:!1};if(this.isFhdEditing){this.updateFreehandDrawColorChange();var o=sf.base.extend({},e.cropObj,{},!0),r={currObj:{}};e.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),(h=r.currObj).objColl=sf.base.extend([],e.objColl,[],!0),h.pointColl=sf.base.extend([],e.pointColl,[],!0),h.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var i={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:i}}),h.selPointColl=sf.base.extend([],i.selPointColl,[],!0);var a={freehandDrawSelectedId:null};e.freeHandDrawModule.draw({prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:a}}),e.freeHandDrawModule.draw({prop:"deleteFhd",value:{id:a.freehandDrawSelectedId}}),e.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteFreehandDrawing",previousObj:h,previousObjColl:this.tempObjColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),e.freeHandDrawModule.draw({prop:"resetFreehandDrawSelectedId"})}else if("none"===e.textArea.style.display){a={prevActObj:null};if(e.drawModule.draw({prop:"getPrevActObj",onPropertyChange:!1,value:{obj:a}}),a.prevActObj&&(a.prevActObj.activePoint.width=Math.abs(a.prevActObj.activePoint.width),a.prevActObj.activePoint.height=Math.abs(a.prevActObj.activePoint.height)),a.prevActObj&&JSON.stringify(a.prevActObj)!==JSON.stringify(e.activeObj)){var s=e.activeObj.currIndex;e.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null,isFinalCancel:!0}});for(var n=0,l=e.objColl.length;n<l;n++)if(e.objColl[n].currIndex===s){e.objColl.splice(n,1),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}});break}}r={isNewPath:null};if(e.drawModule.draw({prop:"getNewPath",value:{obj:r}}),r.isNewPath)e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),e.updateToolbar(e.element,"imageLoaded");else if(e.activeObj.shape){e.objColl.push(e.activeObj);o=sf.base.extend({},e.cropObj,{},!0);var h,p={currObj:{}};e.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:p}}),(h=p.currObj).objColl=sf.base.extend([],e.objColl,[],!0),h.pointColl=sf.base.extend([],e.pointColl,[],!0),h.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);i={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:i}}),h.selPointColl=sf.base.extend([],i.selPointColl,[],!0),e.objColl.pop(),t={cancel:!1,action:"delete",previousShapeSettings:this.updatePrevShapeSettings(),currentShapeSettings:null},e.shapeModule.shape({prop:"setKeyHistory",onPropertyChange:!1,value:{keyHistory:""}}),e.clearSelection(),e.events&&!0===e.events.shapeChanging.hasDelegate&&e.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",t,null),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),sf.base.isNullOrUndefined(h.objColl[h.objColl.length-1].currIndex)||(e.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteObj",previousObj:h,previousObjColl:this.tempObjColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}))}e.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}),e.drawingShape&&(this.currentDrawingShape=e.drawingShape.toLowerCase(),e.enableShapeDrawing(e.toPascalCase(e.drawingShape),!0),e.upperCanvas.style.cursor="crosshair")}document.getElementById(e.element.id+"_quickAccessToolbarArea")&&(document.getElementById(e.element.id+"_quickAccessToolbarArea").style.display="none")},e.prototype.updateFreehandDrawColorChange=function(){var e=this.parent,t={freehandSelectedIndex:null};if(e.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:t}}),!sf.base.isNullOrUndefined(t.freehandSelectedIndex)&&!sf.base.isNullOrUndefined(e.pointColl[t.freehandSelectedIndex])&&"#42a5f5"===e.pointColl[t.freehandSelectedIndex].strokeColor){var o={tempFreeHandDrawEditingStyles:null};e.freeHandDrawModule.draw({prop:"getTempFreeHandDrawEditingStyles",value:{obj:o}}),e.pointColl[t.freehandSelectedIndex].strokeColor=o.tempFreeHandDrawEditingStyles.strokeColor}},e.prototype.updatePrevShapeSettings=function(e){var t=this.parent,o=[];if(sf.base.isNullOrUndefined(t.activeObj.currIndex)){var r={id:"shape_"+(t.objColl.length+1)};t.shapeModule.shape({prop:"getNewShapeId",onPropertyChange:!1,value:{obj:r}}),t.activeObj.currIndex=r.id}"text"===t.activeObj.shape&&t.activeObj.textSettings&&(t.activeObj.textSettings.bold&&o.push("bold"),t.activeObj.textSettings.italic&&o.push("italic"),t.activeObj.textSettings.underline&&o.push("underline"));var i=t.activeObj.activePoint,a=i.startX,s=i.startY,n=i.endX,l=i.endY,h=i.width,p=i.height,d=t.activeObj,c=d.keyHistory,u=d.currIndex,v=d.shape,g=d.textSettings,b=d.strokeSettings,C=d.rotatedAngle,f=d.imageElement,m=d.opacity,y={id:sf.base.isNullOrUndefined(u)?null:u,type:t.toPascalCase(v),startX:a,startY:s,width:h,height:p,strokeColor:b?b.strokeColor:null,strokeWidth:b?b.strokeWidth:null,fillColor:b?b.fillColor:null,radius:"ellipse"===v?h/2:null,length:"line"===v||"arrow"===v?h:null,text:"text"===v?c||(g.text?g.text:null):null,fontSize:"text"===v&&g?g.fontSize:null,fontFamily:"text"===v&&g?g.fontFamily:null,fontStyle:"text"===v?o:null,color:"text"===v&&b?b.strokeColor:null,degree:"ellipse"===v||"rectangle"===v||"image"===v||"text"===v?C*(180/Math.PI):null,imageData:"image"===v?f.src:null,opacity:"image"===v?m:null,radiusX:"ellipse"===v?h/2:null,radiusY:"ellipse"===v?p/2:null,endX:"line"===v||"arrow"===v?n:null,endY:"line"===v||"arrow"===v?l:null,arrowHead:"arrow"===v?this.getArrowType(t.activeObj.start):null,arrowTail:"arrow"===v?this.getArrowType(t.activeObj.end):null,points:"path"===v?t.activeObj.pointColl:null,index:t.activeObj.order};return e&&(e.shapeSettingsObj=y),y},e.prototype.getArrowType=function(e){return{none:"None",arrow:"Arrow",arrowSolid:"SolidArrow",circle:"Circle",circleSolid:"SolidCircle",square:"Square",squareSolid:"SolidSquare",bar:"Bar"}[""+e]},e.prototype.getRectanglePoints=function(e,t,o,r,i,a,s){var n=e+o/2,l=t+r/2,h=i*(Math.PI/180),p=Math.cos(h),d=Math.sin(h),c=a-n,u=s-l,v=c*p+u*d,g=-c*d+u*p,b=o/2,C=r/2;return v>=-b&&v<=b&&g>=-C&&g<=C},e.prototype.getTransRotationPoint=function(e,t){var o,r,i=!1,a=!1;if((r=0===e.shapeDegree?this.parent.transform.degree:this.parent.transform.degree-e.shapeDegree)<0&&(r=360+r),e.flipObjColl)for(var s=0,n=e.flipObjColl.length;s<n;s++)"horizontal"===e.flipObjColl[s].toLowerCase()?i=!0:"vertical"===e.flipObjColl[s].toLowerCase()&&(a=!0);return 0===r||360===r?o=a?{x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:{x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:90===r||-270===r?o=i?{x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}:{x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:180===r||-180===r?o=a?{x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:{x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:270!==r&&-90!==r||(o=i?{x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:{x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}),t&&(t.rotationCirclePoint=o),o},e.prototype.getNumTextValue=function(e){var t,o,r,i,a=this.parent.element;if(r=a.querySelector(".e-ie-toolbar-e-resize-width-input .e-textbox"),i=a.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox"),r&&i){var s=i.value.replace(/,/g,""),n=r.value.replace(/,/g,"");""===s&&(s=i.placeholder.replace(/,/g,"")),""===n&&(n=r.placeholder.replace(/,/g,"")),t=parseFloat(s),o=parseFloat(n)}return e&&(e.width=o,e.height=t),{x:o,y:t}},e.prototype.isValueUpdated=function(){var e,t,o=!0;return e=this.parent.element.querySelector(".e-ie-toolbar-e-resize-width-input .e-textbox"),t=this.parent.element.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox"),e&&t&&""===t.value.replace(/,/g,"")&&""===e.value.replace(/,/g,"")&&(o=!1),o},e}(),m=function(){function e(e){this.textSettings={text:"Enter Text",fontFamily:"",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.keyHistory="",this.preventFrameAnnotation=!1,this.parent=e}return e.prototype.shape=function(e){var t,o=this.parent;switch(this.initShapePvtProps(),e.prop){case"drawEllipse":this.drawEllipse(e.value.x,e.value.y,e.value.radiusX,e.value.radiusY,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.degree,e.value.isSelected);break;case"drawLine":this.drawLine(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor,e.value.isSelected);break;case"drawArrow":this.drawArrow(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor,e.value.arrowStart,e.value.arrowEnd,e.value.isSelected);break;case"drawPath":this.drawPath(e.value.pointColl,e.value.strokeWidth,e.value.strokeColor,e.value.isSelected);break;case"drawRectangle":this.drawRectangle(e.value.x,e.value.y,e.value.width,e.value.height,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.degree,e.value.isSelected);break;case"drawText":this.drawText(e.value.x,e.value.y,e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.color,e.value.isSelected,e.value.degree);break;case"redrawActObj":this.redrawActObj(e.value.x,e.value.y,e.value.isMouseDown);break;case"apply":this.apply(e.value.shape,e.value.obj,e.value.canvas);break;case"updateShapeChangeEventArgs":this.updateShapeChangeEventArgs(e.value.shapeSettings);break;case"updSelChangeEventArgs":this.updSelChangeEventArgs(e.value.selectionSettings);break;case"iterateObjColl":this.iterateObjColl();break;case"updImgRatioForActObj":this.updImgRatioForActObj();break;case"redrawObj":this.redrawObj(e.value.degree);break;case"draw-shape-text":this.drawShapeText();break;case"redraw-text":this.redrawText();break;case"draw-shape":this.drawShape(e.value.obj,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.start,e.value.width,e.value.height);break;case"renderTextArea":this.renderTextArea(e.value.x,e.value.y,e.value.actObj);break;case"setTextBoxWidth":this.setTextBoxWidth(e.value.e);break;case"findTextTarget":this.findTextTarget(e.value.e);break;case"updateFontStyles":this.updateFontStyles(e.value.isTextBox);break;case"applyFontStyle":this.applyFontStyle(e.value.item);break;case"updateFontRatio":this.updateFontRatio(e.value.obj,e.value.isTextArea);break;case"updateFontSize":this.updateFontSize(e.value.obj);break;case"pushActItemIntoObj":this.pushActItemIntoObj();break;case"clearActObj":this.clearActObj();break;case"refreshActiveObj":this.refreshActiveObj();break;case"applyActObj":this.applyActObj(e.value.isMouseDown);break;case"wireEvent":sf.base.EventHandler.add(o.upperCanvas,"dblclick",this.findTextTarget,this),sf.base.EventHandler.add(o.textArea,"mousedown",this.findTextTarget,this),(t=document.getElementById(o.element.id+"_fileUpload"))&&sf.base.EventHandler.add(t,"change",this.fileChanged,this);break;case"unWireEvent":sf.base.EventHandler.remove(o.upperCanvas,"dblclick",this.findTextTarget),sf.base.EventHandler.remove(o.textArea,"mousedown",this.findTextTarget),(t=document.getElementById(o.element.id+"_fileUpload"))&&sf.base.EventHandler.remove(t,"change",this.fileChanged);break;case"getShapeSetting":this.getShapeSetting(e.value.id,e.value.obj);break;case"getShapeSettings":this.getShapeSettings(e.value.obj);break;case"isPointsInRange":this.isPointsInRange(e.value.x,e.value.y,e.value.obj);break;case"alignRotateFlipColl":this.alignRotateFlipColl(e.value.collection,e.value.isRotateFlipCollection,e.value.obj);break;case"selectShape":this.selectShape(e.value.id,e.value.obj);break;case"deleteShape":this.deleteShape(e.value.id);break;case"getMaxText":this.getMaxText(e.value.isTextBox,e.value.text,e.value.obj);break;case"setPointCollForLineArrow":e.value.obj.pointColl=this.getLinePoints(e.value.obj.activePoint.startX,e.value.obj.activePoint.startY,e.value.obj.activePoint.endX,e.value.obj.activePoint.endY);break;case"setPointCollForShapeRotation":this.setPointCollForShapeRotation(e.value.obj);break;case"setTextSettings":e.value.textSettings?this.textSettings=e.value.textSettings:e.value.fontFamily?this.textSettings.fontFamily=e.value.fontFamily:e.value.fontSize&&(this.textSettings.fontSize=e.value.fontSize);break;case"setStrokeSettings":e.value.strokeSettings?this.strokeSettings=e.value.strokeSettings:e.value.strokeColor?this.strokeSettings.strokeColor=e.value.strokeColor:e.value.fillColor?this.strokeSettings.fillColor=e.value.fillColor:e.value.strokeWidth&&(this.strokeSettings.strokeWidth=e.value.strokeWidth);break;case"getStrokeSettings":e.value.obj.strokeSettings=this.strokeSettings;break;case"setKeyHistory":this.keyHistory=e.value.keyHistory;break;case"getKeyHistory":e.value.obj.keyHistory=this.keyHistory;break;case"setTextBoxPos":this.setTextBoxPos(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"setTextBoxPoints":this.setTextBoxPoints(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"alignTextAreaIntoCanvas":this.alignTextAreaIntoCanvas();break;case"initializeTextShape":this.initializeTextShape(e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.strokeColor);break;case"stopPathDrawing":this.stopPathDrawing(e.value.e,e.value.isApply);break;case"updateArrowRatio":this.updateArrowRatio(e.value.obj);break;case"getSquarePointForRotatedShape":this.getSquarePointForRotatedShape(e.value.obj,e.value.object);break;case"drawImage":this.drawImage(e.value.x,e.value.y,e.value.width,e.value.height,e.value.src,e.value.degree,e.value.isAspectRatio,e.value.opacity,e.value.isSelected);break;case"reset":this.reset();break;case"fileChanged":this.fileChanged(e.value.e);break;case"updateObj":this.updateObj(e.value.dimObj,e.value.x,e.value.y);break;case"straightenShapes":this.straightenShapes();break;case"straightenShapePoints":this.straightenShapePoints(e.value.obj,e.value.isReverse);break;case"straightenPath":this.straightenPath(e.value.obj);break;case"straightenFHD":this.straightenFHD();break;case"getTextBoxPosition":this.getTextBoxPosition(e.value.obj,e.value.object);break;case"updateSelectionChangeEventArgs":this.updateSelectionChangeEventArgs(e.value.selectionSettings);break;case"setFlipState":this.setFlipState(e.value.x,e.value.y,e.value.obj,e.value.object);break;case"getNewShapeId":e.value.obj.id=this.getNewShapeId();break;case"z-order":this.updateZOrder(e.value.obj,e.value.value);break;case"getSmallestIndex":e.value.obj.index=this.getSmallestIndex();break;case"isIndexInObjColl":e.value.obj.bool=this.isIndexInObjColl(e.value.index);break;case"drawAnnotations":this.drawAnnotations(e.value.ctx,e.value.shape,e.value.pen,e.value.isPreventApply,e.value.x,e.value.y,e.value.panRegion);break;case"updateShapeColl":this.updateShapeColl();break;case"getNewOrder":e.value.obj.order=this.getNewOrder();break;case"getHighestOrder":e.value.obj.order=this.getHighestOrder();break;case"getLowestOrder":e.value.obj.order=this.getLowestOrder()}},e.prototype.getModuleName=function(){return"shape"},e.prototype.initShapePvtProps=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),sf.base.isNullOrUndefined(this.shapeImg)&&(this.shapeImg=sf.base.createElement("img",{id:e.element.id+"_shapeImg",attrs:{name:"Image",crossorigin:"anonymous"}})),""===this.textSettings.fontFamily&&e.defaultFontFamily&&(this.textSettings.fontFamily=e.defaultFontFamily)},e.prototype.reset=function(){this.textSettings={text:"Enter Text",fontFamily:this.parent.defaultFontFamily,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null},this.preventFrameAnnotation=!1},e.prototype.drawEllipse=function(e,t,o,r,i,a,s,n,l){this.initializeShape("ellipse");var h=e&&t?{x:e,y:t}:null;this.drawShape("ellipse",i,a,s,h,o,r,null,null,null,n,null,l)},e.prototype.drawLine=function(e,t,o,r,i,a,s){this.initializeShape("line");var n=e&&t?{x:e,y:t}:null,l=o-e,h=r-t;this.drawShape("line",i,a,null,n,l,h,null,null,null,null,null,s)},e.prototype.drawPath=function(e,t,o,r){var i=this.parent;if(this.initializeShape("path"),e)this.drawShape("path",t,o,null,null,null,null,e,null,null,null,null,r);else{this.drawShape("line",t,o,null,null,null,null,null,null,null,null,null,r);var a=sf.base.extend({},i.objColl[i.objColl.length-1],null,!0);a.shape="path",a.lineDraw=null,a.pointColl=[{x:a.activePoint.startX,y:a.activePoint.startY},{x:a.activePoint.endX,y:a.activePoint.endY}],i.objColl[i.objColl.length-1]=a}},e.prototype.drawArrow=function(e,t,o,r,i,a,s,n,l){this.initializeShape("arrow");var h=e&&t?{x:e,y:t}:null,p=o-e,d=r-t;this.drawShape("arrow",i,a,null,h,p,d,null,s,n,null,null,l)},e.prototype.drawRectangle=function(e,t,o,r,i,a,s,n,l){this.initializeShape("rectangle");var h=e&&t?{x:e,y:t}:null;this.drawShape("rectangle",i,a,s,h,o,r,null,null,null,n,null,l)},e.prototype.drawText=function(e,t,o,r,i,a,s,n,l,h){this.drawShapeText(o,r,i,a,s,n,e,t,l,h)},e.prototype.initializeShape=function(e){var t=this.parent;this.redrawActObj(),t.activeObj.shape=e,"freehanddraw"===t.currObjType.shape&&(this.apply(),t.upperCanvas.style.cursor=t.cursor="default",t.currObjType.shape=""),t.currObjType.isCustomCrop=!1},e.prototype.updateWidthHeight=function(e){return e.activePoint.width=e.activePoint.endX-e.activePoint.startX,e.activePoint.height=e.activePoint.endY-e.activePoint.startY,e},e.prototype.setDimension=function(e,t){var o=this.parent;e&&t&&(o.activeObj.activePoint.width=e,o.activeObj.activePoint.height=t,"ellipse"===o.currObjType.shape.toLowerCase()&&(o.activeObj.activePoint.width=2*e,o.activeObj.activePoint.height=2*t))},e.prototype.getArrowType=function(e){var t=e;if(e){t={None:"none",Arrow:"arrow",SolidArrow:"arrowSolid",Circle:"circle",SolidCircle:"circleSolid",Square:"square",SolidSquare:"squareSolid",Bar:"bar"}[""+e]}return t},e.prototype.drawShape=function(e,t,o,r,i,a,s,n,l,h,p,d,c){var u=this,v=this.parent;if(!v.disabled&&v.isImageLoaded){v.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1}),this.redrawActObj();var g=sf.base.extend([],v.objColl,[],!0);if(v.togglePen=!1,this.keyHistory="",v.upperCanvas.style.display="block",this.refreshActiveObj(),v.currObjType.shape=e=e.toLowerCase(),"path"===e&&sf.base.isNullOrUndefined(n))v.activeObj.shape=e,v.activeObj.pointColl=[],v.upperCanvas.style.cursor=v.cursor="crosshair",v.selectionModule.selection({prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:"path"}});else if("freehanddraw"!==e&&""!==e){v.activeObj.shape=e;var b=v.activeObj.strokeSettings;this.upperContext.clearRect(0,0,v.upperCanvas.width,v.upperCanvas.height),sf.base.isNullOrUndefined(b)&&(b=this.strokeSettings),"path"===e&&n&&(v.activeObj.pointColl=n),null!=d&&(v.activeObj.opacity=d),b.strokeWidth=t||b.strokeWidth,b.strokeColor=o||b.strokeColor,b.fillColor=r||b.fillColor;var C=v.img.destWidth>100?100:v.img.destWidth/2,f=v.img.destHeight>100?100:v.img.destHeight/2;v.activeObj.activePoint.width=C,v.activeObj.activePoint.height=f,"line"===e||"arrow"===e?(v.activeObj.lineDraw="horizontal",v.activeObj.activePoint.height=0,"arrow"===e&&(v.activeObj.activePoint.width+=50,v.activeObj.start=this.getArrowType(l),v.activeObj.end=this.getArrowType(h))):"rectangle"===e&&(v.activeObj.activePoint.width+=v.activeObj.activePoint.width/2),this.setDimension(a,s),i?(v.activeObj.activePoint.startX=i.x,v.activeObj.activePoint.startY=i.y,v.activeObj.activePoint.endX=v.activeObj.activePoint.startX+v.activeObj.activePoint.width,v.activeObj.activePoint.endY=v.activeObj.activePoint.startY+v.activeObj.activePoint.height):this.setCenterPoints(),this.setPointCollForLineAndArrow(),"arrow"===e&&(v.activeObj.triangleDirection="right"),v.currObjType.isDragging=v.currObjType.isCustomCrop=!1,this.initShapeProps();var m={shapeSettingsObj:{}};v.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:m}});var y=m.shapeSettingsObj,w={cancel:!1,action:"insert",previousShapeSettings:y,currentShapeSettings:y};v.events&&!0===v.events.shapeChanging.hasDelegate?v.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",w,null).then((function(e){u.updateShapeChangeEventArgs(e.currentShapeSettings),u.setDimension(a,s),v.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),p&&(v.activeObj.rotatedAngle=p*(Math.PI/180),v.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:v.activeObj}})),v.updateToolbar(v.element,"quickAccessToolbar","shape"),v.selectionModule.selection({prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),v.undoRedoModule.undoRedo({prop:"updateUrObj",onPropertyChange:!1,value:{objColl:g}}),v.isPublicMethod&&!c&&v.undoRedoModule.undoRedo({prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),v.isPublicMethod=!1})):(this.updateShapeChangeEventArgs(w.currentShapeSettings),this.setDimension(a,s),v.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),p&&(v.activeObj.rotatedAngle=p*(Math.PI/180),v.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:v.activeObj}})),v.updateToolbar(v.element,"quickAccessToolbar","shape"),v.selectionModule.selection({prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),v.undoRedoModule.undoRedo({prop:"updateUrObj",onPropertyChange:!1,value:{objColl:g}}),v.isPublicMethod&&!c&&v.undoRedoModule.undoRedo({prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),v.isPublicMethod=!1)}}},e.prototype.initShapeProps=function(){var e=this.parent;e.activeObj.shapeDegree=e.transform.degree,e.activeObj.shapeFlip=e.transform.currFlipState,e.activeObj.textFlip=e.transform.currFlipState,e.activeObj.flipObjColl=[]},e.prototype.setPointCollForLineAndArrow=function(){var e=this.parent,t=e.activeObj.shape,o=e.activeObj.activePoint,r=o.startX,i=o.startY,a=o.endX,s=o.endY;if(("line"===t||"arrow"===t)&&(e.activeObj.pointColl=this.getLinePoints(r,i,a,s),e.activeObj.pointColl))for(var n=0,l=e.activeObj.pointColl.length;n<l;n++)e.activeObj.pointColl[n].ratioX=(e.activeObj.pointColl[n].x-e.img.destLeft)/e.img.destWidth,e.activeObj.pointColl[n].ratioY=(e.activeObj.pointColl[n].y-e.img.destTop)/e.img.destHeight},e.prototype.prevObjColl=function(){var e=this.parent,t={currObj:{}};e.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),this.prevObj=t.currObj,this.prevObj.objColl=sf.base.extend([],e.objColl,[],!0),this.prevObj.pointColl=sf.base.extend([],e.pointColl,[],!0),this.prevObj.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var o={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:o}}),this.prevObj.selPointColl=sf.base.extend([],o.selPointColl,[],!0)},e.prototype.drawShapeText=function(e,t,o,r,i,a,s,n,l,h){var p=this,d=this.parent;if(!d.disabled&&d.isImageLoaded){"freehanddraw"===d.currObjType.shape&&(this.apply(),d.upperCanvas.style.cursor=d.cursor="default",d.currObjType.shape=""),d.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1}),d.togglePen=!1,this.redrawActObj(),this.prevObjColl(),this.refreshActiveObj(),d.activeObj.shape=d.currObjType.shape="text",d.currObjType.isCustomCrop=!1,this.initializeTextShape(e,t,o,r,i,a),d.currObjType.isText=d.currObjType.isInitialText=!0,sf.base.isNullOrUndefined(d.activeObj.textSettings.fontSize)&&(d.getFontSizes(),d.activeObj.textSettings.fontSize=parseInt(d.fontSizeColl[parseInt("3",10)-1].text,10)),d.img.destWidth<100?d.activeObj.textSettings.fontSize=Math.floor(d.img.destWidth/20):d.img.destHeight<100&&(d.activeObj.textSettings.fontSize=Math.floor(d.img.destHeight/20)),d.activeObj.shapeDegree=d.transform.degree,d.activeObj.shapeFlip=d.transform.currFlipState,d.activeObj.flipObjColl=[],this.updateFontStyles();var c=this.upperContext.measureText(d.activeObj.textSettings.text).width+.5*d.activeObj.textSettings.fontSize,u=d.activeObj.textSettings.fontSize+.25*d.activeObj.textSettings.fontSize;sf.base.isNullOrUndefined(s)||sf.base.isNullOrUndefined(n)?this.setCenterPoints(!0,c,u):(d.activeObj.activePoint.startX=s,d.activeObj.activePoint.startY=n,d.activeObj.activePoint.endX=d.activeObj.activePoint.startX+c,d.activeObj.activePoint.endY=d.activeObj.activePoint.startY+u);var v={shapeSettingsObj:{}};d.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:v}});var g=v.shapeSettingsObj,b={cancel:!1,action:"insert",previousShapeSettings:g,currentShapeSettings:g};if(d.events&&!0===d.events.shapeChanging.hasDelegate)d.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",b,null).then((function(t){if(p.drawShapeTextEvent(t),h&&(d.activeObj.rotatedAngle=h*(Math.PI/180),d.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:d.activeObj}}),p.upperContext.clearRect(0,0,d.upperCanvas.width,d.upperCanvas.height),d.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:d.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),d.updateToolbar(d.element,"destroyQuickAccessToolbar"),d.updateToolbar(d.element,"quickAccessToolbar","image")),e&&e.indexOf("\n")>-1&&d.isPublicMethod){var o=String(d.fontSizeColl.findIndex((function(e){return e.text===String(d.activeObj.textSettings.fontSize)}))+1);d.noPushUndo=!0,d.updateFontSize("5"),d.updateFontSize(o),d.noPushUndo=!1}d.isPublicMethod&&!l&&d.undoRedoModule.undoRedo({prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),d.isPublicMethod=!1}));else{if(this.drawShapeTextEvent(b),h&&(d.activeObj.rotatedAngle=h*(Math.PI/180),d.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:d.activeObj}}),this.upperContext.clearRect(0,0,d.upperCanvas.width,d.upperCanvas.height),d.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:d.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),d.updateToolbar(d.element,"destroyQuickAccessToolbar"),d.updateToolbar(d.element,"quickAccessToolbar","image")),e&&e.indexOf("\n")>-1&&d.isPublicMethod){var C=String(d.fontSizeColl.findIndex((function(e){return e.text===String(d.activeObj.textSettings.fontSize)}))+1);d.noPushUndo=!0,d.updateFontSize("5"),d.updateFontSize(C),d.noPushUndo=!1}d.isPublicMethod&&!l&&d.undoRedoModule.undoRedo({prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),d.isPublicMethod=!1}}},e.prototype.drawShapeImageEvent=function(e,t){var o=this.parent;this.updateShapeChangeEventArgs(e.currentShapeSettings),o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),o.objColl.push(o.activeObj);var r=sf.base.extend({},o.cropObj,{},!0);o.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.selectionModule.selection({prop:"redrawShape",onPropertyChange:!1,value:{obj:o.objColl[o.objColl.length-1]}}),t?(o.updateToolbar(o.element,o.activeObj.shape),o.updateToolbar(o.element,"quickAccessToolbar",o.activeObj.shape)):o.okBtn(null,!0),o.selectionModule.selection({prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}})},e.prototype.drawShapeTextEvent=function(e){var t=this.parent;this.updateShapeChangeEventArgs(e.currentShapeSettings),this.addLetter(t.activeObj.textSettings.text),t.activeObj.textFlip=t.transform.currFlipState,this.updateFontRatio(t.activeObj),t.objColl.push(t.activeObj);var o=sf.base.extend({},t.cropObj,{},!0);t.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),t.selectionModule.selection({prop:"redrawShape",onPropertyChange:!1,value:{obj:t.objColl[t.objColl.length-1]}}),t.updateToolbar(t.element,"quickAccessToolbar","text"),t.selectionModule.selection({prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),t.updateToolbar(t.element,"text"),t.getFontSizes()},e.prototype.initializeTextShape=function(e,t,o,r,i,a){var s=this.parent;this.keyHistory="",s.upperCanvas.style.display="block",sf.base.isNullOrUndefined(s.activeObj.textSettings)&&(s.activeObj.textSettings=this.textSettings),sf.base.isNullOrUndefined(s.activeObj.strokeSettings)&&(s.activeObj.strokeSettings=this.strokeSettings),s.activeObj.strokeSettings.strokeColor=a||s.activeObj.strokeSettings.strokeColor,s.activeObj.textSettings.text=e||s.activeObj.textSettings.text,s.activeObj.textSettings.fontFamily=t||s.activeObj.textSettings.fontFamily,s.activeObj.textSettings.fontSize=o||s.activeObj.textSettings.fontSize,s.activeObj.textSettings.bold=r||s.activeObj.textSettings.bold,s.activeObj.textSettings.italic=i||s.activeObj.textSettings.italic},e.prototype.drawImage=function(e,t,o,r,i,a,s,n,l){this.initializeShape("image"),this.onLoadImgShape(e,t,o,r,i,null,a,s,n,l)},e.prototype.redrawActObj=function(e,t,o){var r,i=this.parent;i.activeObj.shape&&(r=i.activeObj.shape.split("-")),i.activeObj.horTopLine&&i.activeObj.shape&&"crop"!==r[0]&&("block"===i.textArea.style.display||"inline-block"===i.textArea.style.display?(i.selectionModule.selection({prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),this.updateFontRatio(i.activeObj,!0),e&&t?e!==i.activeObj.activePoint.startX&&t!==i.activeObj.activePoint.startY&&this.updateTextFromTextArea():(this.updateTextFromTextArea(),i.textArea.style.transform=""),this.refreshActiveObj()):this.applyActObj(o))},e.prototype.apply=function(e,t,o){var r=this.parent;if(!r.disabled)if(r.togglePen&&!r.currObjType.isCustomCrop){var i=r.img.destLeft,a=r.img.destTop,s=r.img.destWidth,n=r.img.destHeight;r.drawModule.draw({prop:"callUpdateCurrTransState",onPropertyChange:!1});var l=this.lowerContext.filter;this.lowerContext.filter="none",r.togglePen=!1,(r.isCircleCrop||r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape)&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.img.destLeft=i,r.img.destTop=a,r.img.destWidth=s,r.img.destHeight=n,this.lowerContext.filter=l}else o=o||"original",sf.base.isNullOrUndefined(r.activeObj.shape)&&sf.base.isNullOrUndefined(e)?r.currObjType.shape="":r.currObjType.shape=e||r.currObjType.shape,""!==r.currObjType.shape&&(this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),"text"===r.activeObj.shape?r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:o,obj:t,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}):r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:o,obj:t}}),r.activeObj.shape=r.currObjType.shape.toLowerCase(),e||""===r.currObjType.shape||r.currObjType.isCustomCrop||r.objColl.push(sf.base.extend({},r.activeObj,{},!0)),this.keyHistory="")},e.prototype.setCenterPoints=function(e,t,o){var r,i,a=this.parent;e&&t&&o?(r=t,i=o):(r=a.activeObj.activePoint.width,i=a.activeObj.activePoint.height),a.activeObj.activePoint.startX=a.lowerCanvas.width/2-r/2,a.activeObj.activePoint.startY=a.lowerCanvas.height/2-i/2,a.activeObj.activePoint.endX=a.lowerCanvas.width/2+r/2,a.activeObj.activePoint.endY=a.lowerCanvas.height/2+i/2},e.prototype.updSelChangeEventArgs=function(e){var t=this.parent;t.activeObj.activePoint={startX:e.startX,startY:e.startY,endX:t.activeObj.activePoint.startX+t.activeObj.activePoint.width,endY:t.activeObj.activePoint.startY+t.activeObj.activePoint.height,width:e.width,height:e.height},t.activeObj.activePoint.endX=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.endY=t.activeObj.activePoint.startY+t.activeObj.activePoint.height},e.prototype.updateShapeChangeEventArgs=function(e){var t,o=this.parent;if(e.id&&-1===e.id.indexOf("shape_")&&-1===e.id.indexOf("pen_")&&(o.activeObj.currIndex?o.activeObj.currIndex="shape_"+e.id:o.pointColl[t].id="pen_"+e.id),e.id&&e.id.split("_")[0]&&"pen"===e.id.split("_")[0])t=parseInt(e.id.split("_")[1],10)-1,o.pointColl[t].points=e.points,o.pointColl[t].strokeColor=e.strokeColor,o.pointColl[t].strokeWidth=e.strokeWidth,o.pointColl[t].opacity=e.opacity,o.pointColl[t].order=e.index;else{switch(o.activeObj.activePoint.startX=e.startX,o.activeObj.activePoint.startY=e.startY,e.width&&e.height&&(o.activeObj.activePoint.width=e.width,o.activeObj.activePoint.height=e.height,o.activeObj.activePoint.endX=o.activeObj.activePoint.startX+o.activeObj.activePoint.width,o.activeObj.activePoint.endY=o.activeObj.activePoint.startY+o.activeObj.activePoint.height),o.activeObj.strokeSettings.strokeColor=e.strokeColor,o.activeObj.strokeSettings.fillColor=e.fillColor,o.activeObj.strokeSettings.strokeWidth=e.strokeWidth,o.activeObj.opacity=e.opacity,o.activeObj.order=e.index,sf.base.isNullOrUndefined(e.degree)&&(e.degree=0),o.activeObj.shape){case"ellipse":o.activeObj.activePoint.width=2*e.radiusX,o.activeObj.activePoint.height=2*e.radiusY,o.activeObj.activePoint.endX=o.activeObj.activePoint.startX+o.activeObj.activePoint.width,o.activeObj.activePoint.endY=o.activeObj.activePoint.startY+o.activeObj.activePoint.height,e.degree&&(o.activeObj.rotatedAngle=e.degree*(Math.PI/180));break;case"line":case"arrow":o.activeObj.activePoint.endX=e.endX,o.activeObj.activePoint.endY=e.endY,o.activeObj.activePoint.width=o.activeObj.activePoint.startX+o.activeObj.activePoint.width,o.activeObj.activePoint.height=o.activeObj.activePoint.startY+o.activeObj.activePoint.height,"arrow"===o.activeObj.shape&&(o.activeObj.start=this.getArrowType(e.arrowHead),o.activeObj.end=this.getArrowType(e.arrowTail));break;case"text":o.activeObj.keyHistory=o.activeObj.textSettings.text=e.text,o.activeObj.textSettings.fontSize=e.fontSize,o.activeObj.strokeSettings.strokeColor=e.color,o.activeObj.textSettings.fontFamily=e.fontFamily,e.degree&&(o.activeObj.rotatedAngle=e.degree*(Math.PI/180)),this.updateFontRatio(o.activeObj);break;case"rectangle":case"image":e.degree&&(o.activeObj.rotatedAngle=e.degree*(Math.PI/180));break;case"path":o.activeObj.pointColl=e.points}if("text"===o.activeObj.shape&&o.activeObj.textSettings){o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!1,o.activeObj.textSettings.underline=!1;for(var r=0;r<e.fontStyle.length;r++)switch(e.fontStyle[r]){case"bold":o.activeObj.textSettings.bold=!0;break;case"italic":o.activeObj.textSettings.italic=!0;break;case"underline":o.activeObj.textSettings.underline=!0}}}},e.prototype.updateSelectionChangeEventArgs=function(e){var t=this.parent;t.activeObj.activePoint.startX=e.startX,t.activeObj.activePoint.startY=e.startY,e.width&&e.height&&(t.activeObj.activePoint.width=e.width,t.activeObj.activePoint.height=e.height,t.activeObj.activePoint.endX=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.endY=t.activeObj.activePoint.startY+t.activeObj.activePoint.height)},e.prototype.addLetter=function(e){var t=this.parent;if("none"===t.textArea.style.display&&(t.currObjType.isText||"text"===t.activeObj.shape)){var o=t.activeObj.textSettings.fontSize;"Backspace"===e?this.keyHistory=this.keyHistory.slice(0,-1):this.keyHistory+=e,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.updateFontStyles();var r=this.upperContext.measureText(this.keyHistory).width+.5*o,i=o+.25*o;this.upperContext.fillText(this.keyHistory,t.activeObj.activePoint.startX,t.activeObj.activePoint.startY+o),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.currObjType.isText=!0,t.selectionModule.selection({prop:"setActivePoint",onPropertyChange:!1,value:{startX:r,startY:i}})}},e.prototype.redrawText=function(){var e=this.parent,t=e.activeObj.textSettings,o=t.fontSize,r=t.fontFamily,i="";t.bold&&(i+="bold "),t.italic&&(i+="italic "),this.upperContext.font=i+o+"px "+r;var a=e.activeObj.keyHistory.split("\n"),s="block"===e.textArea.style.display||"inline-block"===e.textArea.style.display?this.getMaxText(!0):this.getMaxText(),n=this.upperContext.measureText(s).width+.5*o,l=a.length*(o+.25*o);e.selectionModule.selection({prop:"setTextSelection",onPropertyChange:!1,value:{width:n,height:l}}),e.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.activeObj.activePoint,obj:e.activeObj,isMouseMove:null,x:null,y:null}}),e.selectionModule.selection({prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}})},e.prototype.updateTextFromTextArea=function(){var e=this.parent,t=!1,o=e.activeObj.textSettings.fontSize,r=sf.base.extend({},e.activeObj,{},!0),i=sf.base.extend({},e.cropObj,{},!0),a={currObj:{}};e.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var s=a.currObj;s.objColl=sf.base.extend([],e.objColl,[],!0),s.pointColl=sf.base.extend([],e.pointColl,[],!0),s.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var n={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),s.selPointColl=sf.base.extend([],n.selPointColl,[],!0),e.activeObj.keyHistory!==e.textArea.value&&(t=!0),e.activeObj.keyHistory=e.textArea.value,e.textArea.style.display="none",e.textArea.value="",this.updateFontStyles();var l=this.upperContext.measureText(e.activeObj.keyHistory).width+.5*o,h=o+.25*o,p=e.activeObj.keyHistory.split("\n");if(p.length>1){h*=p.length;for(var d=[],c=0,u=p.length;c<u;c++)d.push(this.upperContext.measureText(p[c]).width+.5*o);l=Math.max.apply(Math,d)}if(e.selectionModule.selection({prop:"setTextSelection",onPropertyChange:!1,value:{width:l,height:h}}),0!==e.activeObj.rotatedAngle){var v=e.activeObj.activePoint.width-r.activePoint.width,g=e.activeObj.activePoint.height-r.activePoint.height,b="";v>0&&g>0?b="widthHeight":0!==v?b="width":0!==g&&(b="height"),e.activeObj.activePoint=sf.base.extend({},r.activePoint,{},!0),e.selectionModule.selection({prop:"adjustRotationPoints",onPropertyChange:!1,value:{rectangle:e.activeObj.activePoint,x:v,y:g,angle:e.activeObj.rotatedAngle,type:"text",elem:b}}),e.shapeModule.shape({prop:"updateFontSize",onPropertyChange:!1,value:{obj:e.activeObj}})}e.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.activeObj.activePoint,obj:e.activeObj,isMouseMove:null,x:null,y:null}}),this.updImgRatioForActObj(),0!==e.activeObj.rotatedAngle&&e.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:e.activeObj}}),t?(this.apply(e.activeObj.shape,e.activeObj),e.objColl.push(sf.base.extend({},e.activeObj,{},!0)),e.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"text",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:i,previousText:e.activeObj.keyHistory,currentText:e.textArea.value,previousFilter:null,isCircleCrop:null}})):(this.apply(e.activeObj.shape,e.activeObj),e.objColl.push(sf.base.extend({},e.activeObj,{},!0)))},e.prototype.iterateObjColl=function(){var e=this.parent;if(e.objColl.length>0)for(var t=this.getSmallestIndex(),o=sf.base.extend([],e.objColl,[],!0);o.length>0;){for(var r=!1,i=0;i<o.length;i++){var a=o[i];if(sf.base.isNullOrUndefined(a.order))o.splice(i,1),i--;else if(a.order===t){this.apply(a.shape,a),this.refreshActiveObj(),t++,this.isIndexInObjColl(t)||t++,o.splice(i,1),r=!0;break}}if(!r)break}},e.prototype.getSmallestIndex=function(){for(var e,t=this.parent,o=0,r=t.objColl.length;o<r;o++){var i=t.objColl[o];sf.base.isNullOrUndefined(i.order)||(sf.base.isNullOrUndefined(e)||i.order<e)&&(e=i.order)}return e},e.prototype.isIndexInObjColl=function(e){for(var t=this.parent,o=0,r=t.objColl.length;o<r;o++){var i=t.objColl[o];if(!sf.base.isNullOrUndefined(i.order)&&i.order===e)return!0}return!1},e.prototype.updImgRatioForActObj=function(){var e=this.parent,t={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};this.straightenShapes();var o=e.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight,n=e.activeObj.activePoint;e.activeObj.imageRatio={startX:(n.startX-r)/a,startY:(n.startY-i)/s,endX:(n.endX-r)/a,endY:(n.endY-i)/s,width:a/n.width,height:s/n.height},e.activeObj.rotationCirclePointColl&&(e.activeObj.rotationCirclePointColl.ratioX=(e.activeObj.rotationCirclePointColl.x-r)/a,e.activeObj.rotationCirclePointColl.ratioY=(e.activeObj.rotationCirclePointColl.y-i)/s),"path"===e.activeObj.shape?this.updatePathRatio(e.activeObj):"arrow"===e.activeObj.shape&&this.updateArrowRatio(e.activeObj),e.img.destLeft=t.startX,e.img.destTop=t.startY,e.img.destWidth=t.width,e.img.destHeight=t.height},e.prototype.zoomObjColl=function(e){var t=this.parent,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};this.straightenShapes();var r=t.img;r.destLeft,r.destTop,r.destWidth,r.destHeight;if(t.objColl.length>0){for(var i=0,a=t.objColl.length;i<a;i++){var s=t.objColl[i];if(s.imageRatio&&(s.activePoint.startX=s.imageRatio.startX*t.img.destWidth+t.img.destLeft,s.activePoint.startY=s.imageRatio.startY*t.img.destHeight+t.img.destTop,s.activePoint.endX=s.imageRatio.endX*t.img.destWidth+t.img.destLeft,s.activePoint.endY=s.imageRatio.endY*t.img.destHeight+t.img.destTop),"text"===(s=this.updateWidthHeight(s)).shape)this.updateFontSize(s);else if("line"===s.shape||"arrow"===s.shape){s.pointColl=this.getLinePoints(s.activePoint.startX,s.activePoint.startY,s.activePoint.endX,s.activePoint.endY);for(var n=0,l=s.pointColl.length;n<l;n++)s.pointColl[n].ratioX=(s.pointColl[n].x-t.img.destLeft)/t.img.destWidth,s.pointColl[n].ratioY=(s.pointColl[n].y-t.img.destTop)/t.img.destHeight;"arrow"===s.shape&&this.updateArrowSize(s),0===t.transform.straighten||"line"!==s.shape&&"arrow"!==s.shape||this.straightenShapePoints(s)}else if("path"===s.shape){for(var h=0,p=s.pointColl.length;h<p;h++)s.pointColl[h].x=s.pointColl[h].ratioX*t.img.destWidth+t.img.destLeft,s.pointColl[h].y=s.pointColl[h].ratioY*t.img.destHeight+t.img.destTop;this.updatePathRatio(s),0!==t.transform.straighten&&this.straightenPath(s)}t.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:s.activePoint,obj:s}}),"line"!==s.shape&&"arrow"!==s.shape&&"path"!==s.shape&&0!==s.rotatedAngle&&(this.setPointCollForShapeRotation(s),s.rotationCirclePoint.x=s.rotationCirclePoint.ratioX*t.img.destWidth+t.img.destLeft,s.rotationCirclePoint.y=s.rotationCirclePoint.ratioY*t.img.destHeight+t.img.destTop,s.rotationCirclePointColl.x=s.rotationCirclePointColl.ratioX*t.img.destWidth+t.img.destLeft,s.rotationCirclePointColl.y=s.rotationCirclePointColl.ratioY*t.img.destHeight+t.img.destTop)}if(sf.base.isNullOrUndefined(e)){var d=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=d}}t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height},e.prototype.straightenPath=function(e){for(var t,o=0,r=e.pointColl.length;o<r;o++)t=this.straightenPoints(e.pointColl[o].x,e.pointColl[o].y),e.pointColl[o].x=t.x,e.pointColl[o].y=t.y},e.prototype.straightenFHD=function(){for(var e=this.parent,t=0,o=e.freehandCounter;t<o;t++){e.points=sf.base.extend([],e.pointColl[t].points,[]);for(var r=e.points.length,i=void 0,a=0;a<r;a++)i=this.straightenPoints(e.points[a].x,e.points[a].y),e.points[a].x=i.x,e.points[a].y=i.y}var s={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}});for(t=0,o=e.freehandCounter;t<o;t++)for(r=s.selPointColl[t].points.length,i=void 0,a=0;a<r;a++)i=this.straightenPoints(s.selPointColl[t].points[a].x,s.selPointColl[t].points[a].y),s.selPointColl[t].points[a].x=i.x,s.selPointColl[t].points[a].y=i.y;var n={straightenPoint:null};if(e.freeHandDrawModule.draw({prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:n}}),n.straightenPoint.x&&n.straightenPoint.y){var l={angle:0};e.freeHandDrawModule.draw({prop:"getStraightenPointAngle",onPropertyChange:!1,value:{obj:l}});var h=((360===e.transform.straighten?0:e.transform.straighten)-l.angle)*(Math.PI/180);i=this.straightenPoints(n.straightenPoint.x,n.straightenPoint.y,h);0===h&&(i.x=n.straightenPoint.x,i.y=n.straightenPoint.y),e.freeHandDrawModule.draw({prop:"setStraightenPoint",onPropertyChange:!1,value:{x:i.x,y:i.y}})}},e.prototype.straightenPoints=function(e,t,o){var r=this.parent,i=r.img.destLeft+r.img.destWidth/2,a=r.img.destTop+r.img.destHeight/2;return o=o||r.transform.straighten*(Math.PI/180),{x:Math.cos(o)*(e-i)-Math.sin(o)*(t-a)+i,y:Math.sin(o)*(e-i)+Math.cos(o)*(t-a)+a}},e.prototype.straightenShapes=function(){var e=this.parent,t=e.img,o=t.destLeft,r=t.destTop,i=t.destWidth,a=t.destHeight;if(e.isStraightening&&0!==e.transform.straighten){e.drawModule.draw({prop:"updateImgCanvasPoints"});var s={points:null};e.drawModule.draw({prop:"getImageCanvasPoints",value:{obj:s}});var n=o+i/2,l=r+a/2,h=-e.transform.straighten*(Math.PI/180),p={x:Math.cos(h)*(s.points[0].x-n)-Math.sin(h)*(s.points[0].y-l)+n,y:Math.sin(h)*(s.points[0].x-n)+Math.cos(h)*(s.points[0].y-l)+l},d=Math.cos(h)*(s.points[1].x-n)-Math.sin(h)*(s.points[1].y-l)+n,c=Math.sin(h)*(s.points[1].x-n)+Math.cos(h)*(s.points[1].y-l)+l,u=(Math.cos(h),s.points[2].x,Math.sin(h),s.points[2].y,Math.sin(h)*(s.points[2].x-n)+Math.cos(h)*(s.points[2].y-l)+l);e.img.destWidth=d-p.x,e.img.destHeight=u-c,e.img.destLeft=p.x,e.img.destTop=p.y}},e.prototype.straightenShapePoints=function(e,t){var o=this.parent,r=o.img,i=r.destLeft,a=r.destTop,s=r.destWidth,n=r.destHeight;if(o.isStraightening&&("line"===e.shape||"arrow"===e.shape)){e.activePoint.width=e.activePoint.endX>e.activePoint.startX?e.activePoint.endX-e.activePoint.startX:e.activePoint.startX-e.activePoint.endX,e.activePoint.height=e.activePoint.endY>e.activePoint.startY?e.activePoint.endY-e.activePoint.startY:e.activePoint.startY-e.activePoint.endY;var l={x:i+s/2,y:a+n/2},h=(t?-o.transform.straighten:o.transform.straighten)*(Math.PI/180),p={x:Math.cos(h)*(e.activePoint.startX-l.x)-Math.sin(h)*(e.activePoint.startY-l.y)+l.x,y:Math.sin(h)*(e.activePoint.startX-l.x)+Math.cos(h)*(e.activePoint.startY-l.y)+l.y},d={x:Math.cos(h)*(e.activePoint.endX-l.x)-Math.sin(h)*(e.activePoint.endY-l.y)+l.x,y:Math.sin(h)*(e.activePoint.endX-l.x)+Math.cos(h)*(e.activePoint.endY-l.y)+l.y};e.activePoint.startX=p.x,e.activePoint.startY=p.y,e.activePoint.endX=d.x,e.activePoint.endY=d.y,e.activePoint.width=e.activePoint.endX>e.activePoint.startX?e.activePoint.endX-e.activePoint.startX:e.activePoint.startX-e.activePoint.endX,e.activePoint.height=e.activePoint.endY>e.activePoint.startY?e.activePoint.endY-e.activePoint.startY:e.activePoint.startY-e.activePoint.endY,o.selectionModule.selection({prop:"adjustActObjForLineArrow",onPropertyChange:!1,value:{obj:e}})}},e.prototype.redrawObj=function(e){var t=this.parent,o=!1;if(t.objColl.length>0)if("horizontal"===e||"vertical"===e||"Horizontal"===e||"Vertical"===e||"horizontalVertical"===e||"verticalHorizontal"===e)this.updateCurrentActiveObjPoint(e.toLowerCase());else if("number"==typeof e){this.updateCurrentActiveObjPoint(e);var r=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)";for(var i=0,a=t.objColl.length;i<a;i++){"crop"!==t.objColl[i].shape.split("-")[0]&&(this.apply(t.objColl[i].shape,t.objColl[i]),o=!0)}o&&t.drawModule.draw({prop:"applyFrame",value:{ctx:this.lowerContext,frame:t.frameObj.type,preventImg:!0}}),this.lowerContext.filter=r}},e.prototype.updateCurrentActiveObjPoint=function(e){for(var t,o=this.parent,r=o.img,i=r.destLeft,a=r.destTop,s=r.destWidth,n=r.destHeight,l=0,h=o.objColl.length;l<h;l++){var p=o.objColl[l];if(o.activeObj.shape===p.shape&&o.activeObj.activePoint.startX===p.activePoint.startX&&o.activeObj.activePoint.startY===p.activePoint.startY&&o.activeObj.activePoint.endX===p.activePoint.endX&&o.activeObj.activePoint.endY===p.activePoint.endY&&o.activeObj.currIndex===p.currIndex){t=l;break}}if("horizontal"===e||"vertical"===e||"Horizontal"===e||"Vertical"===e||"horizontalvertical"===e||"verticalhorizontal"===e){if("horizontal"===e||"Horizontal"===e){var d=0;for(h=o.objColl.length;d<h;d++){(p=o.objColl[d]).shapeFlip!==o.transform.currFlipState&&(p.activePoint.startX<=i+s/2?(p.activePoint.endX=i+s-(p.activePoint.startX-i),p.activePoint.startX=p.activePoint.endX-p.activePoint.width,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})):p.activePoint.startX>=i+s/2&&(p.activePoint.startX=i+(i+s-p.activePoint.endX),p.activePoint.endX=p.activePoint.startX+p.activePoint.width,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})),"line"===p.shape||"arrow"===p.shape||"path"===p.shape?this.flipLineArrowObj(p,"horizontal"):0!==p.rotatedAngle&&(p.rotatedAngle=p.rotatedAngle+2*(Math.PI-p.rotatedAngle),p.rotationCirclePointColl.x<=i+s/2?p.rotationCirclePointColl.x=i+s-(p.rotationCirclePointColl.x-i):p.rotationCirclePointColl.x>=i+s/2&&(p.rotationCirclePointColl.x=i+(i+s-p.rotationCirclePointColl.x)),p.rotationCirclePointColl.ratioX=(p.rotationCirclePointColl.x-i)/s),p.shapeFlip=o.transform.currFlipState,p.imageRatio={startX:(p.activePoint.startX-i)/s,startY:(p.activePoint.startY-a)/n,endX:(p.activePoint.endX-i)/s,endY:(p.activePoint.endY-a)/n,width:s/p.activePoint.width,height:n/p.activePoint.height})}}else if("vertical"===e||"Vertical"===e)for(d=0;d<o.objColl.length;d++){(p=o.objColl[d]).shapeFlip!==o.transform.currFlipState&&(p.activePoint.startY<=a+n/2?(p.activePoint.endY=a+n-(p.activePoint.startY-a),p.activePoint.startY=p.activePoint.endY-p.activePoint.height,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})):p.activePoint.startY>=o.lowerCanvas.height/2&&(p.activePoint.startY=a+(a+n-p.activePoint.endY),p.activePoint.endY=p.activePoint.startY+p.activePoint.height,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})),"line"===p.shape||"arrow"===p.shape||"path"===p.shape?this.flipLineArrowObj(p,"vertical"):0!==p.rotatedAngle&&(p.rotatedAngle=-p.rotatedAngle,p.rotationCirclePointColl.y<=a+n/2?p.rotationCirclePointColl.y=a+n-(p.rotationCirclePointColl.y-a):p.rotationCirclePointColl.y>=a+n/2&&(p.rotationCirclePointColl.y=a+(a+n-p.rotationCirclePointColl.y)),p.rotationCirclePointColl.ratioY=(p.rotationCirclePointColl.y-a)/n),p.shapeFlip=o.transform.currFlipState,p.imageRatio={startX:(p.activePoint.startX-i)/s,startY:(p.activePoint.startY-a)/n,endX:(p.activePoint.endX-i)/s,endY:(p.activePoint.endY-a)/n,width:s/p.activePoint.width,height:n/p.activePoint.height})}else if("verticalhorizontal"===e||"horizontalvertical"===e)for(d=0,h=o.objColl.length;d<h;d++){(p=o.objColl[d]).shapeFlip!==o.transform.currFlipState&&(p.activePoint.startX<=i+s/2?(p.activePoint.endX=i+s-(p.activePoint.startX-i),p.activePoint.startX=p.activePoint.endX-p.activePoint.width,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})):p.activePoint.startX>=i+s/2&&(p.activePoint.startX=i+(i+s-p.activePoint.endX),p.activePoint.endX=p.activePoint.startX+p.activePoint.width,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})),p.activePoint.startY<=a+n/2?(p.activePoint.endY=a+n-(p.activePoint.startY-a),p.activePoint.startY=p.activePoint.endY-p.activePoint.height,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})):p.activePoint.startY>=o.lowerCanvas.height/2&&(p.activePoint.startY=a+(a+n-p.activePoint.endY),p.activePoint.endY=p.activePoint.startY+p.activePoint.height,o.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:p.activePoint,obj:p}})),"line"!==p.shape&&"arrow"!==p.shape&&"path"!==p.shape||this.flipLineArrowObj(p,e),p.shapeFlip=o.transform.currFlipState,p.imageRatio={startX:(p.activePoint.startX-i)/s,startY:(p.activePoint.startY-a)/n,endX:(p.activePoint.endX-i)/s,endY:(p.activePoint.endY-a)/n,width:s/p.activePoint.width,height:n/p.activePoint.height})}void 0!==t&&(o.activeObj=sf.base.extend({},o.objColl[t],{},!0))}else if(90===e)this.rotateObjColl();else if(-90===e)for(d=0;d<3;d++)this.rotateObjColl();else if("number"==typeof e)if(e>0)this.rotateObjColl();else for(d=0;d<3;d++)this.rotateObjColl()},e.prototype.rotateObjColl=function(){for(var e=this.parent,t=e.img,o=t.destWidth,r=t.destHeight,i=t.destLeft,a=t.destTop,s=0,n=e.objColl.length;s<n;s++){var l=(h=e.objColl[s]).shape;h.activePoint.startY=a+r*h.imageRatio.startX,h.activePoint.endY=a+r*h.imageRatio.endX,h.activePoint.startX=i+o-o*h.imageRatio.endY,h.activePoint.endX=i+o-o*h.imageRatio.startY,h=this.updateWidthHeight(e.objColl[s]),this.updateFontSize(h),"line"===l||"arrow"===l||"path"===l?(this.rotateLineArrowObj(h),"arrow"===l&&this.updateArrowSize(h)):0!==h.rotatedAngle&&(h.rotationCirclePointColl.y=a+r*h.rotationCirclePointColl.ratioX,h.rotationCirclePointColl.x=i+o-o*h.rotationCirclePointColl.ratioY,h.rotationCirclePointColl.ratioX=(h.rotationCirclePointColl.x-i)/o,h.rotationCirclePointColl.ratioY=(h.rotationCirclePointColl.y-a)/r)}for(s=0,n=e.objColl.length;s<n;s++)e.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.objColl[s].activePoint,obj:e.objColl[s]}});for(s=0,n=e.objColl.length;s<n;s++){var h;(h=e.objColl[s]).imageRatio={startX:(h.activePoint.startX-i)/o,startY:(h.activePoint.startY-a)/r,endX:(h.activePoint.endX-i)/o,endY:(h.activePoint.endY-a)/r,width:o/h.activePoint.width,height:r/h.activePoint.height}}},e.prototype.rotateLineArrowObj=function(e){if(!sf.base.isNullOrUndefined(e.pointColl)){var t=this.parent.img,o=t.destWidth,r=t.destHeight,i=t.destLeft,a=t.destTop;if(e.pointColl.length>0){for(var s=0;s<e.pointColl.length;s++)e.pointColl[s].y=a+r*e.pointColl[s].ratioX,e.pointColl[s].x=i+o-o*e.pointColl[s].ratioY;for(s=0;s<e.pointColl.length;s++)e.pointColl[s].ratioX=(e.pointColl[s].x-i)/o,e.pointColl[s].ratioY=(e.pointColl[s].y-a)/r;var n=void 0;n=sf.base.isNullOrUndefined(e.pointColl[e.pointColl.length-2])?{x:0,y:0}:{x:e.pointColl[e.pointColl.length-2].x,y:e.pointColl[e.pointColl.length-2].y};var l=e.pointColl[e.pointColl.length-1].x-n.x,h=e.pointColl[e.pointColl.length-1].y-n.y;e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x+l/2,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y+h/2,e=this.updateWidthHeight(e)}}},e.prototype.flipLineArrowObj=function(e,t){if(t=t.toLowerCase(),!sf.base.isNullOrUndefined(e.pointColl)&&("horizontal"===t?this.lineArrowHorizontalFlip(e):("vertical"===t||(this.lineArrowHorizontalFlip(e),e.shapeFlip=""),this.lineArrowVerticalFlip(e)),e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y,e.activePoint.startX>e.activePoint.endX)){var o=e.activePoint.startX;e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=o,o=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=o}},e.prototype.lineArrowHorizontalFlip=function(e){var t=this.parent,o=t.img,r=o.destWidth,i=o.destHeight,a=o.destLeft,s=o.destTop;if(e.shapeFlip!==t.transform.currFlipState){for(var n=0,l=e.pointColl.length;n<l;n++){var h=e.pointColl[n];h.x<=a+r/2?h.x=a+r-(h.x-a):h.x>=a+r/2&&(h.x=a+(a+r-h.x)),h.ratioX=(h.x-a)/r,h.ratioY=(h.y-s)/i}if("arrow"===e.shape){var p=e.start;e.start=e.end,e.end=p}e.shapeFlip=t.transform.currFlipState}},e.prototype.lineArrowVerticalFlip=function(e){var t=this.parent,o=t.img,r=o.destWidth,i=o.destHeight,a=o.destLeft,s=o.destTop;if(e.shapeFlip!==t.transform.currFlipState){for(var n=0,l=e.pointColl.length;n<l;n++){var h=e.pointColl[n];h.y<=s+i/2?h.y=s+i-(h.y-s):h.y>=s+i/2&&(h.y=s+(s+i-h.y)),h.ratioX=(h.x-a)/r,h.ratioY=(h.y-s)/i}e.shapeFlip=t.transform.currFlipState}},e.prototype.getRotDegOfShape=function(e){var t;return(t=0===e.shapeDegree?this.parent.transform.degree:this.parent.transform.degree-e.shapeDegree)<0&&(t=360+t),t},e.prototype.renderTextArea=function(e,t,o){var r=this.parent,i=this.getRotDegOfShape(r.activeObj);this.transformTextArea(),r.updateToolbar(r.element,"destroyQuickAccessToolbar");var a=r.element.querySelector("#"+r.element.id+"_zOrderBtn"),s=r.element.querySelector("#"+r.element.id+"_duplicate"),n=r.element.querySelector("#"+r.element.id+"_remove"),l=r.element.querySelector("#"+r.element.id+"_editText");a&&a.classList.add("e-disabled"),s&&s.classList.add("e-disabled"),n&&n.classList.add("e-disabled"),l&&l.classList.add("e-disabled"),r.textArea.style.display="block",r.textArea.style.left=e+"px",r.textArea.style.top=t+"px",r.textArea.style.fontFamily=o.textSettings.fontFamily,r.textArea.style.fontSize=o.textSettings.fontSize+"px",r.textArea.style.color=o.strokeSettings.strokeColor,r.textArea.style.fontWeight=o.textSettings.bold?"bold":"normal",r.textArea.style.fontStyle=o.textSettings.italic?"italic":"normal",r.textArea.style.border="2px solid "+r.themeColl[r.theme].primaryColor,r.textArea.value=o.keyHistory,r.textArea.style.overflow="hidden",r.textArea.style.width="auto",r.textArea.style.height="auto",r.textArea.focus();r.transform.zoomFactor;var h=o.activePoint,p=h.width,d=h.height;i%90==0&&i%180!=0&&0!==i?(r.textArea.style.width=d+"px",r.textArea.style.height=p+"px"):(r.textArea.style.width=p+"px",r.textArea.style.height=d+"px"),this.setTextBoxWidth();var c={flipColl:null};if(r.transformModule.transform({prop:"getFlipColl",onPropertyChange:!1,value:{obj:c}}),c.flipColl.length<=1&&this.setTextBoxHeight(),parseFloat(r.textArea.style.maxHeight)<r.activeObj.textSettings.fontSize&&(r.textArea.style.maxHeight=r.activeObj.textSettings.fontSize+"px"),i%90==0&&i%180!=0?parseFloat(r.textArea.style.left)+parseFloat(r.textArea.style.width)>r.img.destTop+r.img.destHeight&&this.alignTextAreaIntoCanvas():parseFloat(r.textArea.style.left)+parseFloat(r.textArea.style.width)>r.img.destLeft+r.img.destWidth&&this.alignTextAreaIntoCanvas(),0!==o.rotatedAngle){var u=parseFloat(r.textArea.style.left),v=parseFloat(r.textArea.style.top);if(o.flipObjColl.length>0){var g={panRegion:""},b=r.lowerCanvas,C=b.clientWidth,f=b.clientHeight,m={x:0,y:0};r.cropModule.cropping({prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:g}}),""!==g.panRegion&&("horizontal"===g.panRegion?(m.x=C-C/2,u=m.x-u+m.x):"vertical"===g.panRegion?(m.y=f-f/2,v=m.y-v+m.y):(u=(m={x:C-C/2,y:f-f/2}).x-u+m.x,v=m.y-v+m.y))}var y=u+parseFloat(r.textArea.style.width),w=v+parseFloat(r.textArea.style.height),P=parseFloat(r.textArea.style.width),j=parseFloat(r.textArea.style.height),x={x:y-P/2,y:w-j/2},O=Math.cos(o.rotatedAngle),S=Math.sin(o.rotatedAngle),M={x:O*(y-x.x)-S*(w-x.y)+x.x,y:S*(y-x.x)+O*(w-x.y)+x.y};if(M.x>r.img.destLeft&&M.x<r.img.destLeft+r.img.destWidth&&M.y>r.img.destTop&&M.y+parseFloat(r.textArea.style.fontSize)<r.img.destTop+r.img.destHeight)r.textArea.style.width=r.textArea.style.width;else for(var T=0,A=parseFloat(r.textArea.style.width);;)if(T++,(M={x:O*((y=u+(P-=1))-(x={x:y-P/2,y:w-j/2}).x)-S*(w-x.y)+x.x,y:S*(y-x.x)+O*(w-x.y)+x.y}).x>r.img.destLeft&&M.x<r.img.destLeft+r.img.destWidth&&M.y>r.img.destTop&&M.y+parseFloat(r.textArea.style.fontSize)<r.img.destTop+r.img.destHeight||T===A){r.textArea.style.width=P+"px";break}}r.selectionModule.selection({prop:"clearUpperCanvas",onPropertyChange:!1})},e.prototype.setTextBoxWidth=function(e){var t=this.parent;if(0!==t.activeObj.rotatedAngle)return t.textArea.style.whiteSpace="nowrap",t.textArea.style.textOverflow="ellipsis",void(t.textArea.style.display="inline-block");t.textArea.style.whiteSpace="",t.textArea.style.textOverflow="","inline-block"===t.textArea.style.display&&(t.textArea.style.display="block");var o=this.getMaxText(!0);"block"===t.textArea.style.display||"inline-block"===t.textArea.style.display?this.updateFontStyles(!0):this.updateFontStyles();var r=this.upperContext.measureText(o).width+parseFloat(t.textArea.style.fontSize)/2,i=e?this.upperContext.measureText(String.fromCharCode(e.which)).width:0,a=sf.base.extend({},t.activeObj,{},!0),s="",n=this.getRotDegOfShape(a);if(s=a.shapeFlip!==t.transform.currFlipState?"":t.transform.currFlipState,e&&parseFloat(t.textArea.style.width)<r+i||sf.base.isNullOrUndefined(e))if(0===n)"horizontal"===s.toLowerCase()?parseFloat(t.textArea.style.left)-t.img.destLeft-r-i>0&&(t.textArea.style.width=r+i+"px"):t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)>r+i&&(t.textArea.style.width=r+i+"px");else if(90===n)"vertical"===s.toLowerCase()?parseFloat(t.textArea.style.top)-t.img.destTop-r-i>0&&(t.textArea.style.width=r+i+"px"):t.img.destHeight-(parseFloat(t.textArea.style.top)-t.img.destTop)>r+i&&(t.textArea.style.width=r+i+"px");else if(180===n){var l=parseFloat(t.textArea.style.left),h=t.img.destLeft;if("horizontal"===s.toLowerCase())t.img.destWidth-(l-h)>r+i&&(t.textArea.style.width=r+i+"px");else l-h-r-i>0&&(t.textArea.style.width=r+i+"px")}else if(270===n){var p=parseFloat(t.textArea.style.top),d=t.img.destTop;if("vertical"===s.toLowerCase())t.img.destHeight-(p-d)>r+i&&(t.textArea.style.width=r+i+"px");else p-d-r-i>0&&(t.textArea.style.width=r+i+"px")}},e.prototype.setTextBoxHeight=function(){var e,t=this.parent,o=sf.base.extend({},t.activeObj,{},!0),r="",i=this.getRotDegOfShape(o);switch(r=o.textFlip===t.transform.currFlipState?"":""===o.textFlip?t.transform.currFlipState:o.textFlip,i){case 0:"vertical"===r.toLowerCase()?t.textArea.style.maxHeight=t.img.destHeight-(t.img.destHeight-parseFloat(t.textArea.style.top))+"px":(e=parseFloat(t.textArea.style.top)-t.img.destTop,t.textArea.style.maxHeight=t.img.destHeight-e+"px");break;case 90:"horizontal"===r.toLowerCase()?t.textArea.style.maxHeight=t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)+"px":t.textArea.style.maxHeight=parseFloat(t.textArea.style.left)-t.img.destLeft+"px";break;case 180:"vertical"===r.toLowerCase()?(e=parseFloat(t.textArea.style.top)-t.img.destTop,t.textArea.style.maxHeight=t.img.destHeight-e+"px"):t.textArea.style.maxHeight=parseFloat(t.textArea.style.top)-t.img.destTop+"px";break;case 270:"horizontal"===r.toLowerCase()?t.textArea.style.maxHeight=parseFloat(t.textArea.style.left)-t.img.destLeft+"px":t.textArea.style.maxHeight=t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)+"px"}},e.prototype.updatePathRatio=function(e){for(var t=this.parent,o=0,r=e.pointColl.length;o<r;o++){var i=e.pointColl[o];i.ratioX=(i.x-t.img.destLeft)/t.img.destWidth,i.ratioY=(i.y-t.img.destTop)/t.img.destHeight}},e.prototype.stopPathDrawing=function(e,t){var o=this.parent;if("path"===o.activeObj.shape){var r={shape:null};if(o.selectionModule.selection({prop:"getCurrentDrawingShape",value:{obj:r}}),"path"===r.shape){var i=sf.base.extend({},o.cropObj,{},!0),a={currObj:{}};o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var s=a.currObj;s.objColl=sf.base.extend([],o.objColl,[],!0),s.pointColl=sf.base.extend([],o.pointColl,[],!0),s.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var n={selPointColl:null};if(o.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),s.selPointColl=sf.base.extend([],n.selPointColl,[],!0),o.selectionModule.selection({prop:"setCurrentDrawingShape",value:{value:""}}),o.currObjType.isDragging=!1,e&&"touchstart"!==e.type&&sf.base.isNullOrUndefined(t)&&o.activeObj.pointColl.pop(),this.updatePathRatio(o.activeObj),sf.base.isNullOrUndefined(o.activeObj.imageRatio)&&o.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),o.objColl.push(o.activeObj),o.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.objColl.pop(),e&&(o.selectionModule.selection({prop:"mouseUpEventHandler",value:{e:e}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1})),o.drawModule.draw({prop:"setNewPath",value:{bool:!0}}),o.objColl[o.objColl.length-1]){var l=o.drawingShape;o.selectionModule.selection({prop:"setCurrentDrawingShape",value:{value:""}}),o.selectShape(o.objColl[o.objColl.length-1].currIndex),o.selectionModule.selection({prop:"setCurrentDrawingShape",value:{value:"path"}}),o.drawingShape=l}o.updateToolbar(o.element,"quickAccessToolbar",o.activeObj.shape);var h={shapeSettingsObj:{}};o.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:h}});var p=h.shapeSettingsObj,d={cancel:!1,action:"draw-end",previousShapeSettings:p},c={cancel:!1,action:"move",previousShapeSettings:p};o.selectionModule.selection({prop:"triggerShapeChange",onPropertyChange:!1,value:{shapeResizingArgs:d,shapeMovingArgs:c,type:"mouse-up"}}),o.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})}}},e.prototype.findTextTarget=function(e){var t,o,r=this.parent;if("text"!==r.activeObj.shape){if("path"===r.activeObj.shape)return void this.stopPathDrawing(e,null);if("dblclick"!==e.type)return;var i=sf.base.extend({},r.activeObj,{},!0),a=sf.base.extend([],r.objColl,[],!0),s={bool:null};if(r.selectionModule.selection({prop:"findTargetObj",onPropertyChange:!1,value:{x:e.clientX,y:e.clientY,isCrop:!1,obj:s}}),r.objColl=a,!s.bool||"text"!==r.activeObj.shape)return void(r.activeObj=sf.base.extend({},i,{},!0))}if("dblclick"===e.type?(t=e.clientX,o=e.clientY):"touchstart"===e.type&&(t=e.touches[0].clientX,o=e.touches[0].clientY,r.selectionModule.selection({prop:"setTouchEndPoint",onPropertyChange:!1,value:{x:e.touches[0].clientX,y:e.touches[0].clientY}})),r.updateToolbar(r.element,"enableDisableToolbarBtn","textAreaClicked"),sf.base.isNullOrUndefined(t)||sf.base.isNullOrUndefined(o))if("block"!==r.textArea.style.display&&"inline-block"!==r.textArea.style.display||""===this.selectedText()||"mousedown"!==e.type)"none"===r.textArea.style.display&&(r.textArea.style.display="block");else{p=r.textArea.value;r.textArea.value+="a",r.textArea.value=p}else{var n=r.lowerCanvas.getBoundingClientRect();t-=n.left,o-=n.top;var l="",h=this.getRotDegOfShape(r.activeObj);l=""===r.activeObj.textFlip?r.activeObj.textFlip===r.transform.currFlipState?"":r.transform.currFlipState:r.activeObj.textFlip===r.transform.currFlipState?"":""===r.transform.currFlipState?r.activeObj.textFlip:r.transform.currFlipState;var p=void 0;if("none"===r.textArea.style.display){p=sf.base.extend({},r.activeObj,{},!0);for(var d=0;d<r.objColl.length;d++)JSON.stringify(r.activeObj)===JSON.stringify(r.objColl[d])&&r.objColl.splice(d,1);this.refreshActiveObj(),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),this.lowerContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),r.drawModule.draw({prop:"redrawDownScale"}),r.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),r.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),(r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape||r.isCircleCrop)&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.activeObj=p,this.updateFontStyles();var c=sf.base.extend({},r.activeObj,{},!0),u=c.topLeftCircle.radius,v=c.activePoint,g=v.startX,b=v.startY,C=v.endX,f=v.endY,m={x:g+v.width/2,y:b+v.height/2},y=Math.cos(c.rotatedAngle),w=Math.sin(c.rotatedAngle),P={x:y*(g-m.x)-w*(b-m.y)+m.x,y:w*(g-m.x)+y*(b-m.y)+m.y},j={x:y*(C-m.x)-w*(b-m.y)+m.x,y:w*(C-m.x)+y*(b-m.y)+m.y},x={x:y*(g-m.x)-w*(f-m.y)+m.x,y:w*(g-m.x)+y*(f-m.y)+m.y},O={x:y*(C-m.x)-w*(f-m.y)+m.x,y:w*(C-m.x)+y*(f-m.y)+m.y};s={position:null,x:t,y:o,x1:P.x,y1:P.y,x2:j.x,y2:j.y,x3:x.x,y3:x.y,x4:O.x,y4:O.y};if(r.drawModule.draw({prop:"checkPointPosition",onPropertyChange:!1,value:{obj:s}}),0!==c.rotatedAngle&&("inside"===s.position||"on"===s.position)||0===c.rotatedAngle&&t>=c.activePoint.startX-2*u&&t<=c.activePoint.endX+2*u&&o>=c.activePoint.startY-2*u&&o<=c.activePoint.endY+2*u){var S;if(this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),4===c.flipObjColl.length&&(c.flipObjColl=[],l="",c.shapeFlip=""),""===l&&c.flipObjColl.length>1&&(l=c.flipObjColl[c.flipObjColl.length-1]),c.flipObjColl.length<=1)t=(S=this.setTextBoxPos(c,h,l,t,o)).x,o=S.y;else t=(S=this.setTextBoxPoints(c,h,l,t,o)).x,o=S.y;if(0!==r.activeObj.rotatedAngle){var M=this.getTextBoxPosition(r.activeObj);t=M.x,o=M.y,t=(M=this.setFlipState(t,o,r.activeObj)).x,o=M.y}this.renderTextArea(t,o,c)}else this.applyActObj()}}},e.prototype.getTextBoxPosition=function(e,t){var o={x:0,y:0},r=e.activePoint,i=r.startX,a=r.startY,s=r.endX,n=r.endY,l=i+r.width/2,h=a+r.height/2,p=Math.cos(e.rotatedAngle),d=Math.sin(e.rotatedAngle),c={x:p*(i-l)-d*(a-h)+l,y:d*(i-l)+p*(a-h)+h},u={x:p*(s-l)-d*(a-h)+l,y:d*(s-l)+p*(a-h)+h},v={x:p*(i-l)-d*(n-h)+l,y:d*(i-l)+p*(n-h)+h},g={x:p*(s-l)-d*(n-h)+l,y:d*(s-l)+p*(n-h)+h},b=this.getRotDegOfShape(e);return 0===b||360===b?o={x:c.x,y:c.y}:90===b||-270===b?o={x:u.x,y:u.y}:180===b||-180===b?o={x:g.x,y:g.y}:270!==b&&-90!==b||(o={x:v.x,y:v.y}),t&&(t.x=o.x,t.y=o.y),o},e.prototype.setFlipState=function(e,t,o,r){var i=this.parent,a={panRegion:""},s=i.lowerCanvas,n=s.clientWidth,l=s.clientHeight,h={x:0,y:0};return i.cropModule.cropping({prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:a}}),""!==a.panRegion&&("horizontal"===a.panRegion?(h.x=n-n/2,e=h.x-e+h.x):"vertical"===a.panRegion?(h.y=l-l/2,t=h.y-t+h.y):(e=(h={x:n-n/2,y:l-l/2}).x-e+h.x,t=h.y-t+h.y)),r&&(r.x=e,r.y=t),{x:e,y:t}},e.prototype.fileChanged=function(e){var t=e.target.files[0],o=t.name&&t.name.split(".")[1].toLowerCase();if(o&&-1===["jpg","jpeg","png","svg"].indexOf(o))this.refreshActiveObj();else{var r=window.URL.createObjectURL(e.target.files[0]);this.onLoadImgShape(null,null,null,null,r.toString(),!0)}},e.prototype.onLoadImgShape=function(e,t,o,r,i,a,s,n,l,h){var p=this,d=this.parent;"string"==typeof i?this.shapeImg.src=i:(d.inMemoryCanvas.width=i.width,d.inMemoryCanvas.height=i.height,d.inMemoryCanvas.getContext("2d").putImageData(i,0,0),this.shapeImg.src=d.inMemoryCanvas.toDataURL()),this.prevObjColl(),d.activeObj.shape="image",this.initShapeProps(),this.shapeImg.onload=function(){p.upperContext.drawImage(p.shapeImg,0,0,p.shapeImg.width,p.shapeImg.height),p.updateImgCanvas(a,e,t,o,r,s,n,l,h)}},e.prototype.updateImgCanvas=function(e,t,o,r,i,a,s,n,l){var h=this,p=this.parent;p.activeObj.imageElement=this.shapeImg,p.activeObj.imageCanvas=sf.base.createElement("canvas");var d={width:0,height:0};if(p.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:d,isImgShape:null}}),r&&i)if(s){var c={ratio:null};p.selectionModule.selection({prop:"findImageRatio",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:c}}),d=this.resizeImage(r,c.ratio)}else d={width:r,height:i};if(this.updateObj(d,t,o),p.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:p.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:null}}),p.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:d,isImgShape:!0}}),r&&i)if(s){var u={ratio:null};p.selectionModule.selection({prop:"findImageRatio",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:u}}),d=this.resizeImage(r,u.ratio)}else d={width:r,height:i};null!=n&&(p.activeObj.opacity=n),this.updateObj(d,t,o),p.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.shapeImg=null,a&&(p.activeObj.rotatedAngle=a*(Math.PI/180),p.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:p.activeObj}}));var v={shapeSettingsObj:{}};p.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:v}});var g=v.shapeSettingsObj,b={cancel:!1,action:"insert",previousShapeSettings:g,currentShapeSettings:g};e=e||l,p.events&&!0===p.events.shapeChanging.hasDelegate?p.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",b,null).then((function(t){h.drawShapeImageEvent(t,e),p.isPublicMethod&&!l?p.undoRedoModule.undoRedo({prop:"updateUndoRedo",onPropertyChange:!1}):p.isPublicMethod||p.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1}),p.isPublicMethod=!1})):(this.drawShapeImageEvent(b,e),p.isPublicMethod&&!l?p.undoRedoModule.undoRedo({prop:"updateUndoRedo",onPropertyChange:!1}):p.isPublicMethod||p.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1}),p.isPublicMethod=!1)},e.prototype.updateObj=function(e,t,o){var r=this.parent;r.activeObj.activePoint.width=e.width,r.activeObj.activePoint.height=e.height,r.activeObj.activePoint.startX=t||r.lowerCanvas.width/2-e.width/2,r.activeObj.activePoint.startY=o||r.lowerCanvas.height/2-e.height/2,r.activeObj.activePoint.endX=r.activeObj.activePoint.startX+e.width,r.activeObj.activePoint.endY=r.activeObj.activePoint.startY+e.height},e.prototype.resizeImage=function(e,t){var o=t.split(":"),r=parseInt(o[0],10),i=parseInt(o[1],10);return{width:e,height:Math.round(e*i/r)}},e.prototype.setTextBoxPos=function(e,t,o,r,i){var a={x:r,y:i},s=e.activePoint,n=s.startX,l=s.startY,h=s.endX,p=s.endY;switch(o=o.toLowerCase(),t){case 0:"horizontal"===o?(a.x=h,a.y=l):"vertical"===o?(a.x=n,a.y=p):(a.x=n,a.y=l);break;case 90:"horizontal"===o?(a.x=n,a.y=l):"vertical"===o?(a.x=h,a.y=p):(a.x=h,a.y=l);break;case 180:"horizontal"===o?(a.x=n,a.y=p):"vertical"===o?(a.x=h,a.y=l):(a.x=h,a.y=p);break;case 270:"horizontal"===o?(a.x=h,a.y=p):"vertical"===o?(a.x=n,a.y=l):(a.x=n,a.y=p)}return a},e.prototype.setTextBoxPoints=function(e,t,o,r,i){var a={x:r,y:i},s=e.activePoint,n=s.startX,l=s.startY,h=s.endX,p=s.endY;switch(o=o.toLowerCase(),t){case 0:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o?(a.x=n,a.y=l):"vertical"===o&&(a.x=h,a.y=p):"horizontal"===o?(a.x=h,a.y=p):"vertical"===o&&(a.x=h,a.y=l);break;case 90:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o?(a.x=h,a.y=p):"vertical"===o&&(a.x=n,a.y=p):"horizontal"===o?(a.x=n,a.y=p):"vertical"===o&&(a.x=n,a.y=l);break;case 180:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?("horizontal"===o||"vertical"===o)&&(a.x=n,a.y=l):"horizontal"===o?(a.x=n,a.y=l):"vertical"===o&&(a.x=n,a.y=p);break;case 270:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o?(a.x=n,a.y=l):"vertical"===o&&(a.x=h,a.y=l):"horizontal"===o?(a.x=h,a.y=l):"vertical"===o&&(a.x=h,a.y=p)}return a},e.prototype.selectedText=function(){var e=this.parent,t=e.textArea.selectionStart,o=e.textArea.selectionEnd;return e.textArea.value.substring(t,o)},e.prototype.panObjColl=function(e,t,o){var r=this.parent;if(r.objColl.length>0){for(var i=0,a=r.objColl.length;i<a;i++){var s=r.objColl[i];if(""===o&&(s.activePoint.startX+=e,s.activePoint.endX+=e,s.rotationCirclePointColl&&(s.rotationCirclePointColl.x+=e),"path"===s.shape))for(var n=0,l=s.pointColl.length;n<l;n++)s.pointColl[n].x+=e;if(""===o&&(s.activePoint.startY+=t,s.activePoint.endY+=t,s.rotationCirclePointColl&&(s.rotationCirclePointColl.y+=t),"path"===s.shape))for(n=0;n<s.pointColl.length;n++)s.pointColl[n].y+=t;if(s=this.updateWidthHeight(s),r.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:s.activePoint,obj:s}}),"line"===s.shape||"arrow"===s.shape){s.pointColl=this.getLinePoints(s.activePoint.startX,s.activePoint.startY,s.activePoint.endX,s.activePoint.endY);for(var h=0,p=s.pointColl.length;h<p;h++)s.pointColl[h].ratioX=(s.pointColl[h].x-r.img.destLeft)/r.img.destWidth,s.pointColl[h].ratioY=(s.pointColl[h].y-r.img.destTop)/r.img.destHeight}this.refreshActiveObj()}var d=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=d,this.refreshActiveObj(),r.drawModule.draw({prop:"applyFrame",value:{ctx:this.lowerContext,frame:r.frameObj.type,preventImg:!0}})}},e.prototype.updateFontStyles=function(e){var t=this.parent;this.upperContext.strokeStyle=t.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=t.activeObj.strokeSettings.strokeColor;var o="";t.activeObj.textSettings.bold&&(o="bold "),t.activeObj.textSettings.italic&&(o="italic "),t.activeObj.textSettings.bold&&t.activeObj.textSettings.italic&&(o="italic bold ");var r=e?parseFloat(t.textArea.style.fontSize):t.activeObj.textSettings.fontSize,i="block"===t.textArea.style.display||"inline-block"===t.textArea.style.display?t.textArea.style.fontFamily:t.activeObj.textSettings.fontFamily;this.upperContext.font=o+r+"px "+i},e.prototype.applyFontStyle=function(e){var t=this.parent,o={shapeSettingsObj:{}};t.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:o}});var r=o.shapeSettingsObj;this.pushActItemIntoObj();var i=sf.base.extend([],t.objColl,[],!0);switch(t.objColl.pop(),"none"===t.textArea.style.display?this.updateFontRatio(t.activeObj):this.updateFontRatio(t.activeObj,!0),e){case"default":this.updateFontStyle(e,i,"normal","normal");break;case"bold":this.updateFontStyle(e,i,"bold","normal");break;case"italic":this.updateFontStyle(e,i,"normal","italic");break;case"bolditalic":this.updateFontStyle(e,i,"bold","italic")}var a={action:"font-style",currentShapeSettings:sf.base.extend({},r,{},!0)};a.currentShapeSettings.fontStyle=[e],t.triggerShapeChanged(a)},e.prototype.updateFontStyle=function(e,t,o,r){var i=this.parent,a=i.textArea.style;if("block"===a.display||"inline-block"===a.display){"normal"===a.fontWeight&&"bold"===o?a.fontWeight="bold":"bold"===a.fontWeight&&"bold"===o&&(a.fontWeight="normal"),"normal"===a.fontStyle&&"italic"===r?a.fontStyle="italic":"italic"===a.fontStyle&&"italic"===r&&(a.fontStyle="normal");var s="normal"===a.fontWeight&&"normal"===a.fontStyle?"default":"bold"===a.fontWeight&&"normal"===a.fontStyle?"bold":"normal"===a.fontWeight&&"italic"===a.fontStyle?"italic":"bolditalic",n=this.getTextAreaWidth(s);a.width=n+"px",this.updateObjColl(e,t)}else this.textSettings.bold=i.activeObj.textSettings.bold="normal"!==o,this.textSettings.italic=i.activeObj.textSettings.italic="normal"!==r,0===i.activeObj.activePoint.width&&0===i.activeObj.activePoint.height||this.redrawText(),i.undoRedoModule.undoRedo({prop:"updateUrObj",onPropertyChange:!1,value:{objColl:t}})},e.prototype.updateArrowRatio=function(e){var t,o,r={arrowDimension:null};this.parent.drawModule.draw({prop:"getArrowDimension",onPropertyChange:!1,value:{obj:r}}),t=Math.abs(e.activePoint.width)>Math.abs(e.activePoint.height)?Math.abs(e.activePoint.width):Math.abs(e.activePoint.height);for(var i=0,a=["bar","arrow","arrowSolid","circle","square"];i<a.length;i++){o=a[i];var s=t/r.arrowDimension[o].width,n=t/r.arrowDimension[o].height;r.arrowDimension[o].ratioX=s,r.arrowDimension[o].ratioY=n}},e.prototype.updateArrowSize=function(e){var t,o,r={arrowDimension:null};this.parent.drawModule.draw({prop:"getArrowDimension",onPropertyChange:!1,value:{obj:r}}),t=Math.abs(e.activePoint.width)>Math.abs(e.activePoint.height)?Math.abs(e.activePoint.width):Math.abs(e.activePoint.height);for(var i=0,a=["bar","arrow","arrowSolid","circle","square"];i<a.length;i++){o=a[i];var s=r.arrowDimension[o].ratioX,n=r.arrowDimension[o].ratioY;r.arrowDimension[o].width=t/s,r.arrowDimension[o].height=t/n}},e.prototype.updateFontRatio=function(e,t){var o=this.parent,r=this.getMaxText(t),i=this.upperContext.measureText(r).width+.5*o.activeObj.textSettings.fontSize,a=o.activeObj.textSettings.fontSize+.25*o.activeObj.textSettings.fontSize,s=this.getRotDegOfShape(e);sf.base.isNullOrUndefined(t)?0===s||180===Math.abs(s)?e.textSettings.fontRatio=i/e.textSettings.fontSize:e.textSettings.fontRatio=a/e.textSettings.fontSize:t&&(e.textSettings.fontRatio=i/parseFloat(o.textArea.style.fontSize))},e.prototype.updateFontSize=function(e){var t=this.getRotDegOfShape(e);0===t||180===Math.abs(t)?e.textSettings.fontSize=e.activePoint.width/e.textSettings.fontRatio:e.textSettings.fontSize=e.activePoint.height/e.textSettings.fontRatio},e.prototype.updateObjColl=function(e,t){var o=this.parent,r=sf.base.extend({},o.cropObj,{},!0),i={currObj:{}};o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=t,a.pointColl=sf.base.extend([],o.pointColl,[],!0),a.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var s={selPointColl:null};o.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),a.selPointColl=sf.base.extend([],s.selPointColl,[],!0);var n=o.activeObj.textSettings.bold,l=o.activeObj.textSettings.italic;switch(e){case"default":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!1;break;case"bold":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!1;break;case"italic":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!0;break;case"bolditalic":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!0}o.objColl.push(o.activeObj),o.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.objColl.pop(),o.activeObj.textSettings.bold=n,o.activeObj.textSettings.italic=l},e.prototype.pushActItemIntoObj=function(){var e=this.parent;if("none"===e.textArea.style.display)0===e.activeObj.activePoint.width&&0===e.activeObj.activePoint.height||e.objColl.push(e.activeObj);else{var t=sf.base.extend({},e.activeObj,{},!0);e.selectionModule.selection({prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj),e.activeObj=t}},e.prototype.clearActObj=function(){var e=this.parent;"none"===e.textArea.style.display&&(this.refreshActiveObj(),this.applyActObj(),this.refreshActiveObj(),e.currObjType.isCustomCrop=!1)},e.prototype.refreshActiveObj=function(){var e=this.parent;e.activeObj={},e.activeObj.activePoint={startX:0,startY:0,endX:0,endY:0,width:0,height:0},e.activeObj.triangle=[],e.activeObj.triangleRatio=[],e.activeObj.order=null,e.activeObj.flipObjColl=[],e.activeObj.strokeSettings=this.strokeSettings,e.activeObj.textSettings=this.textSettings,e.activeObj.rotatedAngle=0,e.activeObj.opacity=1},e.prototype.applyActObj=function(e){var t=this.parent,o=!1;if(void 0!==t.activeObj.shape&&"text"===t.activeObj.shape&&""===t.activeObj.keyHistory)this.refreshActiveObj(),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height);else{var r=void 0,i=!1;if(void 0!==t.activeObj.shape&&(r=t.activeObj.shape.split("-")),(void 0===r&&t.currObjType.isCustomCrop||void 0!==r&&"crop"===r[0])&&(i=!0),t.activeObj.shape&&!i&&"shape"!==t.activeObj.shape){for(var a=0;a<t.objColl.length;a++)if(JSON.stringify(t.activeObj)===JSON.stringify(t.objColl[a])){o=!0;break}if(!o){sf.base.isNullOrUndefined(t.activeObj.currIndex)&&(t.activeObj.currIndex=this.getNewShapeId()),sf.base.isNullOrUndefined(t.activeObj.order)&&(t.activeObj.order=this.getNewOrder()),this.updImgRatioForActObj();var s=t.activeObj.currIndex.split("_"),n=t.objColl.splice(0,parseInt(s[1],10)-1);n.push(sf.base.extend({},t.activeObj,{},!0));for(a=0;a<t.objColl.length;a++)n.push(t.objColl[a]);t.objColl=n,n=[],this.refreshActiveObj(),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),t.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),t.currObjType.shape="",this.refreshActiveObj(),t.isCircleCrop&&t.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.updateToolbar(t.element,"destroyQuickAccessToolbar"),!sf.base.isNullOrUndefined(e)&&e||(t.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),t.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}))}}}},e.prototype.getNewShapeId=function(){for(var e=this.parent,t=e.objColl.length+1,o=0;o<e.objColl.length;o++)e.objColl[o].currIndex==="shape_"+t&&(t++,o=-1);return"shape_"+t},e.prototype.getNewOrder=function(){var e=this.parent;this.updateShapeColl();for(var t=e.shapeColl.length+1,o=0;o<e.shapeColl.length;o++)e.shapeColl[o].order===t&&(t++,o=-1);return t},e.prototype.getHighestOrder=function(){var e=this.parent;this.updateShapeColl();for(var t=0,o=0;o<e.shapeColl.length;o++)e.shapeColl[o].order>t&&(t=e.shapeColl[o].order);return t},e.prototype.getLowestOrder=function(){var e=this.parent;this.updateShapeColl();for(var t=1,o=0;o<e.shapeColl.length;o++)e.shapeColl[o].order<t&&(t=e.shapeColl[o].order);return t},e.prototype.alignTextAreaIntoCanvas=function(){var e=this.parent,t=e.textArea.value;e.textArea.value="";for(var o=0,r=t.length;o<r;o++)e.textArea.value+=t[o],e.textArea.style.height="auto",e.textArea.style.height=e.textArea.scrollHeight+"px",this.setTextBoxWidth()},e.prototype.transformTextArea=function(){var e=this.parent;if("text"===e.activeObj.shape){e.textArea.style.transformOrigin="0 0";var t=e.activeObj.rotatedAngle*(180/Math.PI),o="",r=this.getRotDegOfShape(e.activeObj);if(e.activeObj.flipObjColl.length>0)for(var i=0;i<e.activeObj.flipObjColl.length;i++)o+=0!==r&&r%90==0&&180!==r?"horizontal"===e.activeObj.flipObjColl[i].toLowerCase()?"scale(1, -1)":"scale(-1, 1)":"horizontal"===e.activeObj.flipObjColl[i].toLowerCase()?"scale(-1, 1)":"scale(1, -1)",r+=t,("horizontal"===e.activeObj.flipObjColl[i].toLowerCase()||"vertical"===e.activeObj.flipObjColl[i].toLowerCase())&&(e.textArea.style.transform="rotate("+r+"deg)"+o);else r+=t,e.textArea.style.transform="rotate("+r+"deg)"}},e.prototype.getTextAreaWidth=function(e){var t=this.parent,o=t.activeObj.textSettings.bold,r=t.activeObj.textSettings.italic;switch(e){case"default":t.activeObj.textSettings.bold=!1,t.activeObj.textSettings.italic=!1;break;case"bold":t.activeObj.textSettings.bold=!0,t.activeObj.textSettings.italic=!1;break;case"italic":t.activeObj.textSettings.bold=!1,t.activeObj.textSettings.italic=!0;break;case"bolditalic":t.activeObj.textSettings.bold=!0,t.activeObj.textSettings.italic=!0}var i,a="none"!==t.textArea.style.display;return this.updateFontStyles(a),i=a?this.upperContext.measureText(t.textArea.value).width+.5*t.activeObj.textSettings.fontSize:this.upperContext.measureText(t.activeObj.keyHistory).width+.5*t.activeObj.textSettings.fontSize,t.activeObj.textSettings.bold=o,t.activeObj.textSettings.italic=r,i},e.prototype.getObjDetails=function(e){var t=this.parent,o={};switch(o.id=e.currIndex,o.type=t.toPascalCase(e.shape),o.startX=e.activePoint.startX,o.startY=e.activePoint.startY,o.index=e.order,e.shape){case"rectangle":o.width=e.activePoint.width,o.height=e.activePoint.height,o.strokeColor=e.strokeSettings.strokeColor,o.fillColor=e.strokeSettings.fillColor,o.strokeWidth=e.strokeSettings.strokeWidth,o.degree=e.rotatedAngle*(180/Math.PI);break;case"ellipse":o.radius=e.activePoint.width/2,o.strokeColor=e.strokeSettings.strokeColor,o.fillColor=e.strokeSettings.fillColor,o.strokeWidth=e.strokeSettings.strokeWidth,o.radiusX=e.activePoint.width/2,o.radiusY=e.activePoint.height/2,o.degree=e.rotatedAngle*(180/Math.PI);break;case"line":case"arrow":if(o.length=e.activePoint.width,o.strokeColor=e.strokeSettings.strokeColor,o.strokeWidth=e.strokeSettings.strokeWidth,o.endX=e.activePoint.endX,o.endY=e.activePoint.endY,"arrow"===e.shape){var r={type:null};t.selectionModule.selection({prop:"getArrowType",onPropertyChange:!1,value:{type:e.start,obj:r}}),o.arrowHead=r.type,t.selectionModule.selection({prop:"getArrowType",onPropertyChange:!1,value:{type:e.end,obj:r}}),o.arrowTail=r.type}break;case"text":o.text=e.keyHistory,o.fontSize=e.textSettings.fontSize,o.fontFamily=e.textSettings.fontFamily,o.color=e.strokeSettings.strokeColor,o.fontStyle=[],e.textSettings.bold&&o.fontStyle.push("bold"),e.textSettings.italic&&o.fontStyle.push("italic"),o.degree=e.rotatedAngle*(180/Math.PI);break;case"path":o.strokeColor=e.strokeSettings.strokeColor,o.strokeWidth=e.strokeSettings.strokeWidth,o.points=e.pointColl;break;case"image":o.imageData=e.imageCanvas.toDataURL(),o.degree=e.rotatedAngle*(180/Math.PI),o.width=e.activePoint.width,o.height=e.activePoint.height,o.opacity=e.opacity}return o},e.prototype.getFreehandDrawDetails=function(e){var t=this.parent,o={};return o.id=t.pointColl[e].id,o.type=r.FreehandDraw,o.points=sf.base.extend([],t.pointColl[e].points),o.strokeColor=t.pointColl[e].strokeColor,o.strokeWidth=t.pointColl[e].strokeWidth,o.index=t.pointColl[e].order,o},e.prototype.getShapeSetting=function(e,t){var o,r=this.parent;if(!r.disabled&&r.isImageLoaded)if("none"!==r.textArea.style.display?r.okBtn(null,!0):this.applyActObj(!0),"shape"===e.split("_")[0]){for(var i,a=0,s=r.objColl.length;a<s;a++)if(r.objColl[a].currIndex===e){i=sf.base.extend({},r.objColl[a],{},!0);break}o=this.getObjDetails(i)}else"pen"===e.split("_")[0]&&(o=this.getFreehandDrawDetails(parseInt(e.split("_")[1],10)-1));t.shapeDetails=o},e.prototype.getShapeSettings=function(e){var t=this.parent,o=[];if(!t.disabled&&t.isImageLoaded){"none"!==t.textArea.style.display?t.okBtn(null,!0):this.applyActObj(!0);for(var r=0,i=t.objColl.length;r<i;r++){var a=this.getObjDetails(t.objColl[r]);o.push(a)}for(r=0;r<t.freehandCounter;r++){a=this.getFreehandDrawDetails(r);o.push(a)}}e.shapeDetailsColl=o},e.prototype.isPointsInRange=function(e,t,o){var r=!1,i=this.parent;!sf.base.isNullOrUndefined(e)&&!sf.base.isNullOrUndefined(t)&&e>=i.img.destLeft&&t>=i.img.destTop&&e<=i.img.destLeft+i.img.destWidth&&t<=i.img.destTop+i.img.destHeight&&(r=!0),o.inRange=r},e.prototype.alignRotateFlipColl=function(e,t,o){return e=this.popForDefaultTransformedState(e),e=this.popForDefaultFlipState(e),0===(e=this.popForDefaultRotateState(e)).length&&t&&(this.parent.transform.degree=0,this.parent.transform.currFlipState=""),o.collection=e,e},e.prototype.popForDefaultTransformedState=function(e){for(var t=0,o=0,r=0,i=0,a=0;a<e.length;a++)90===e[a]||"rotateRight"===e[a]?(o=0,r=0,i=0,4===++t&&(e.pop(),e.pop(),e.pop(),e.pop())):-90===e[a]||"rotateLeft"===e[a]?(t=0,r=0,i=0,4===++o&&(e.pop(),e.pop(),e.pop(),e.pop())):"horizontal"===e[a]||"Horizontal"===e[a]||"horizontalflip"===e[a]?(o=0,t=0,i=0,2===++r&&(e.pop(),e.pop())):"vertical"!==e[a]&&"Vertical"!==e[a]&&"verticalflip"!==e[a]||(r=0,o=0,t=0,2===++i&&(e.pop(),e.pop()));return e},e.prototype.popForDefaultFlipState=function(e){for(var t=0,o=e.length-3;t<o;t++){var r="horizontal"===e[t]||"Horizontal"===e[t]||"horizontalFlip"===e[t],i="vertical"===e[t]||"Vertical"===e[t]||"verticalFlip"===e[t],a="horizontal"===e[t+1]||"Horizontal"===e[t+1]||"horizontalFlip"===e[t+1],s="vertical"===e[t+1]||"Vertical"===e[t+1]||"verticalFlip"===e[t+1],n="horizontal"===e[t+2]||"Horizontal"===e[t+2]||"horizontalFlip"===e[t+2],l="vertical"===e[t+2]||"Vertical"===e[t+2]||"verticalFlip"===e[t+2],h="horizontal"===e[t+3]||"Horizontal"===e[t+3]||"horizontalFlip"===e[t+3];(r&&s&&n&&l||i&&a&&l&&h)&&(e.splice(t,4),t-=4)}return e},e.prototype.popForDefaultRotateState=function(e){for(var t=0;t<e.length-1;t++){var o=e[t],r=e[t+1];(90!==o&&"rotateRight"!==o||-90!==r&&"rotateLeft"!==r)&&(-90!==o&&"rotateLeft"!==o||90!==r&&"rotateRight"!==r)||(e.splice(t,2),t-=2)}return e},e.prototype.selectShape=function(e,t){var o=this.parent,r=!1;if(!o.disabled&&o.isImageLoaded)if(this.applyActObj(),"shape"===e.split("_")[0]){for(var i,a=0,s=o.objColl.length;a<s;a++)if(o.objColl[a].currIndex===e){i=sf.base.extend({},o.objColl[a],{},!0);break}if(sf.base.isNullOrUndefined(i))r=!1;else{r=!0,o.activeObj=i;var n={canvasFilter:null};this.lowerContext.filter=n.canvasFilter,o.selectionModule.selection({prop:"redrawShape",onPropertyChange:!1,value:{obj:o.activeObj}}),o.updateToolbar(o.element,o.activeObj.shape),"path"===o.activeObj.shape?o.updateToolbar(o.element,"path","pathQuickAccessToolbar"):o.updateToolbar(o.element,"quickAccessToolbar",o.activeObj.shape)}}else if("pen"===e.split("_")[0]){n={bool:!1};o.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),n.bool&&o.okBtn(null,!0);var l={isIndex:!1};o.freeHandDrawModule.draw({prop:"isFHDIdx",value:{index:parseInt(e.split("_")[1],10)-1,obj:l}}),l.isIndex?(r=!0,o.freeHandDrawModule.draw({prop:"selectFhd",value:{id:e}}),o.updateToolbar(o.element,"pen"),o.updateToolbar(o.element,"quickAccessToolbar","pen")):r=!1}t.isSelected=r},e.prototype.deleteShape=function(e){var t=this.parent;if(!t.disabled&&t.isImageLoaded){if(t.activeObj.currIndex&&t.activeObj.currIndex===e)t.selectionModule.selection({prop:"deleteItem",onPropertyChange:!1});else if(this.applyActObj(),"shape"===e.split("_")[0]){for(var o=0,r=t.objColl.length;o<r;o++)if(t.objColl[o].currIndex===e){t.objColl.splice(o,1);break}}else"pen"===e.split("_")[0]&&t.freeHandDrawModule.draw({prop:"handle-freehand-draw",value:{id:e}});this.lowerContext.filter=null,this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),t.updateToolbar(t.element,"imageLoaded")}},e.prototype.getMaxText=function(e,t,o){var r;sf.base.isNullOrUndefined(t)&&(t=e?this.parent.textArea.value:this.parent.activeObj.keyHistory);for(var i=t.split("\n"),a=i[0].length,s=i[0],n=1;n<i.length;n++)(r=i[n].length)>a&&(s=i[n],a=r);return o&&(o.maxText=s),s},e.prototype.getLinePoints=function(e,t,o,r){var i,a,s=[];if(e===o){t<r?(i=[e,t],a=[o,r]):(a=[e,t],i=[o,r]);for(var n=this.getSlope(i,a,!0),l=this.getIntercept(i,n),h=i[1];h<=a[1];h++){var p=n*h+l;s.push({x:p,y:h})}}else{e<o?(i=[e,t],a=[o,r]):(a=[e,t],i=[o,r]);for(n=this.getSlope(i,a,!1),l=this.getIntercept(i,n),p=i[0];p<=a[0];p++){h=n*p+l;s.push({x:p,y:h})}}if(Math.floor(e)===Math.floor(o)||s.length<10&&(r-t>10||t-r>10)){s=[];for(var d=Math.min(t,r),c=0;c<Math.abs(Math.floor(r)-Math.floor(t));c++)s.push({x:e,y:d+c});if(s.length>1){var u=void 0;u=sf.base.isNullOrUndefined(s[s.length-2])?{x:0,y:0}:s[s.length-2];var v=s[s.length-1].x-u.x,g=s[s.length-1].y-u.y;s.push({x:s[s.length-1].x+v/2,y:s[s.length-1].y+g/2})}}else if(Math.floor(t)===Math.floor(r)||s.length<10&&(o-e>10||e-o>10)){s=[];for(var b=Math.min(e,o),C=0;C<Math.abs(Math.floor(o)-Math.floor(e));C++)s.push({x:b+C,y:t});if(s.length>1){u=void 0;u=sf.base.isNullOrUndefined(s[s.length-2])?{x:0,y:0}:s[s.length-2];v=s[s.length-1].x-u.x,g=s[s.length-1].y-u.y;s.push({x:s[s.length-1].x+v/2,y:s[s.length-1].y+g/2})}}return s},e.prototype.getSlope=function(e,t,o){var r;if(o){if(e[1]===t[1])return null;r=(t[0]-e[0])/(t[1]-e[1])}else{if(e[0]===t[0])return null;r=(t[1]-e[1])/(t[0]-e[0])}return r},e.prototype.getIntercept=function(e,t){return null===t?e[0]:e[1]-t*e[0]},e.prototype.setPointCollForShapeRotation=function(e){var t=this.parent,o=e.activePoint,r=o.startX,i=o.startY,a=o.endX,s=o.endY,n=r+o.width/2,l=i+o.height/2,h=Math.cos(e.rotatedAngle),p=Math.sin(e.rotatedAngle),d={x:h*(r-n)-p*(i-l)+n,y:p*(r-n)+h*(i-l)+l},c={x:h*(a-n)-p*(i-l)+n,y:p*(a-n)+h*(i-l)+l},u={x:h*(r-n)-p*(s-l)+n,y:p*(r-n)+h*(s-l)+l},v={x:h*(a-n)-p*(s-l)+n,y:p*(a-n)+h*(s-l)+l};e.horTopLinePointColl=this.getLinePoints(d.x,d.y,c.x,c.y),e.horTopLinePointColl=this.getLinePoints(d.x,d.y,c.x,c.y),e.horBottomLinePointColl=this.getLinePoints(u.x,u.y,v.x,v.y),e.verLeftLinePointColl=this.getLinePoints(d.x,d.y,u.x,u.y),e.verRightLinePointColl=this.getLinePoints(c.x,c.y,v.x,v.y),e.verLeftLinePointColl.reverse(),e.verRightLinePointColl.reverse();for(var g=0;g<e.horTopLinePointColl.length;g++)e.horTopLinePointColl[g].ratioX=(e.horTopLinePointColl[g].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horTopLinePointColl[g].ratioY=(e.horTopLinePointColl[g].y-this.parent.img.destTop)/this.parent.img.destHeight;for(g=0;g<e.horBottomLinePointColl.length;g++)e.horBottomLinePointColl[g].ratioX=(e.horBottomLinePointColl[g].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horBottomLinePointColl[g].ratioY=(e.horBottomLinePointColl[g].y-this.parent.img.destTop)/this.parent.img.destHeight;for(g=0;g<e.verLeftLinePointColl.length;g++)e.verLeftLinePointColl[g].ratioX=(e.verLeftLinePointColl[g].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verLeftLinePointColl[g].ratioY=(e.verLeftLinePointColl[g].y-this.parent.img.destTop)/this.parent.img.destHeight;for(g=0;g<e.verRightLinePointColl.length;g++)e.verRightLinePointColl[g].ratioX=(e.verRightLinePointColl[g].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verRightLinePointColl[g].ratioY=(e.verRightLinePointColl[g].y-this.parent.img.destTop)/this.parent.img.destHeight;if("move"!==t.upperCanvas.style.cursor){var b={rotationCirclePoint:null};t.selectionModule.selection({prop:"getTransRotationPoint",value:{obj:e,object:b}});var C=b.rotationCirclePoint;C&&(e.rotationCirclePointColl={x:h*(C.x-n)-p*(C.y-l)+n,y:p*(C.x-n)+h*(C.y-l)+l},e.rotationCirclePointColl.ratioX=(e.rotationCirclePointColl.x-t.img.destLeft)/t.img.destWidth,e.rotationCirclePointColl.ratioY=(e.rotationCirclePointColl.y-t.img.destTop)/t.img.destHeight)}},e.prototype.getSquarePointForRotatedShape=function(e,t){var o={startX:0,startY:0,endX:0,endY:0,width:0,height:0},r=e.activePoint,i=r.startX,a=r.startY,s=r.endX,n=r.endY,l=i+r.width/2,h=a+r.height/2,p=Math.cos(e.rotatedAngle),d=Math.sin(e.rotatedAngle),c={x:p*(i-l)-d*(a-h)+l,y:d*(i-l)+p*(a-h)+h},u={x:p*(s-l)-d*(a-h)+l,y:d*(s-l)+p*(a-h)+h},v={x:p*(i-l)-d*(n-h)+l,y:d*(i-l)+p*(n-h)+h},g={x:p*(s-l)-d*(n-h)+l,y:d*(s-l)+p*(n-h)+h};return o.startX=c.x,o.startY=c.y,o.endX=c.x,o.endY=c.y,o.startX>u.x&&(o.startX=u.x),o.startX>v.x&&(o.startX=v.x),o.startX>g.x&&(o.startX=g.x),o.startY>u.y&&(o.startY=u.y),o.startY>v.y&&(o.startY=v.y),o.startY>g.y&&(o.startY=g.y),o.endX<u.x&&(o.endX=u.x),o.endX<v.x&&(o.endX=v.x),o.endX<g.x&&(o.endX=g.x),o.endY<u.y&&(o.endY=u.y),o.endY<v.y&&(o.endY=v.y),o.endY<g.y&&(o.endY=g.y),o.width=o.endX-o.startX,o.height=o.endY-o.startY,t&&(t.activePoint=o),o},e.prototype.updateZOrder=function(e,t){var o=this.parent;t=t.toLowerCase();var r=e;if(!sf.base.isNullOrUndefined(r.order)){var i,a,s=this.getHighestOrder();if(this.updateShapeColl(),0!==o.shapeColl.length){for(var n,l=0;l<o.shapeColl.length;l++)n=o.shapeColl[l],r.id&&r.id.indexOf("pen")>-1?n.id&&n.id===r.id&&o.shapeColl.splice(l,1):n.shape&&n.shape.indexOf("crop-")>-1&&o.shapeColl.splice(l,1);switch(t){case"sendtoback":a=r.order,i=r.order,r.order=1;break;case"sendbackward":r.order-=1,i=r.order;break;case"bringtofront":a=r.order,i=s,r.order=i;break;case"bringforward":r.order+=1,i=r.order}this.reArrangeObjColl(i,t,a),r.id&&r.id.indexOf("pen")>-1&&this.reUpdateShapeColl(r)}}},e.prototype.reArrangeObjColl=function(e,t,o){var r,i=this.parent;switch(t){case"sendtoback":for(var a=0,s=i.shapeColl.length;a<s;a++)(r=i.shapeColl[a]).order<o&&r.order<=e&&(r.order+=1,this.reUpdateShapeColl(r));break;case"sendbackward":for(a=0,s=i.shapeColl.length;a<s;a++)if((r=i.shapeColl[a]).order===e){r.order+=1,this.reUpdateShapeColl(r);break}break;case"bringtofront":for(a=0,s=i.shapeColl.length;a<s;a++)(r=i.shapeColl[a]).order>o&&r.order<=e&&(r.order-=1,this.reUpdateShapeColl(r));break;case"bringforward":for(a=0,s=i.shapeColl.length;a<s;a++)if((r=i.shapeColl[a]).order===e){r.order-=1,this.reUpdateShapeColl(r);break}}},e.prototype.updateShapeColl=function(){var e=this.parent,t=!1,o=1,r=sf.base.extend([],e.objColl,[],!0),i=sf.base.extend([],e.pointColl,[],!0);if(e.shapeColl.length>0&&e.shapeColl.length===e.objColl.length+e.pointColl.length){for(var a=0;a<e.shapeColl.length;a++){if(e.shapeColl[a].order!==o){t=!1;break}t=!0,o++}if(t){for(a=0;a<e.shapeColl.length;a++)if(e.shapeColl[a].currIndex&&e.shapeColl[a].currIndex.indexOf("shape")>-1){for(var s=0;s<r.length;s++)if(e.shapeColl[a].currIndex===r[s].currIndex){e.shapeColl[a]=sf.base.extend({},r[s],{},!0),r.splice(s,1);break}}else if(e.shapeColl[a].id&&e.shapeColl[a].id.indexOf("pen")>-1)for(s=0;s<i.length;s++)if(e.shapeColl[a].id===i[s].id){e.shapeColl[a]=sf.base.extend([],i[s],[],!0),i.splice(s,1);break}return}}r=sf.base.extend([],e.objColl,[],!0),i=sf.base.extend([],e.pointColl,[],!0),e.shapeColl=[];for(var n,l=1,h=!1;0!==r.length||0!==i.length;){n=h=!1;for(a=0;a<r.length;a++)if(r[a].order===l||!r[a].order&&r[a].shape&&r[a].shape.indexOf("crop-")>-1){e.shapeColl.push(sf.base.extend({},r[a],{},!0)),r[a].shape&&r[a].shape.indexOf("crop-")>-1&&(h=!0),r.splice(a,1),n=!0;break}if(!n)for(a=0;a<i.length;a++)if(i[a].order===l){e.shapeColl.push(sf.base.extend([],i[a],[],!0)),i.splice(a,1),n=!0;break}h||l++}},e.prototype.reUpdateShapeColl=function(e){var t=this.parent;if(e.id&&e.id.indexOf("pen")>-1){if(t.freehandCounter>0)for(var o=0;o<t.freehandCounter;o++)t.pointColl[o].id===e.id&&(t.pointColl[o].order=e.order)}else if(e.currIndex&&e.currIndex.indexOf("shape")>-1)for(o=0;o<t.objColl.length;o++)t.objColl[o].currIndex===e.currIndex&&(t.objColl[o].order=e.order)},e.prototype.drawAnnotations=function(e,t,o,r,i,a,s){var n=this.parent,l=sf.base.extend({},n.activeObj,{},!0),h=sf.base.extend([],n.objColl,[],!0),p=sf.base.extend([],n.pointColl,[],!0);this.updateShapeColl();var d=sf.base.extend([],n.shapeColl,[],!0),c=!1;this.preventFrameAnnotation||(this.preventFrameAnnotation=c=!0);for(var u=0;u<d.length;u++){var v=d[u].id;if(d[u].order||!d[u].order&&d[u].shape&&d[u].shape.indexOf("crop-")>-1||!d[u].order&&"path"===d[u].shape&&"path"===n.drawingShape){if(d[u].currIndex&&d[u].currIndex.indexOf("shape")>-1){if(n.objColl=[],n.objColl.push(sf.base.extend({},d[u],{},!0)),"iterate"===t){var g=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=g}else if("zoom"===t||"pan"===t){for(var b=-1,C=0;C<h.length;C++)if(JSON.stringify(h[C])===JSON.stringify(n.objColl[0])){b=C;break}"zoom"===t?this.zoomObjColl(r):this.panObjColl(i,a,s),b>-1&&(h[b]=sf.base.extend({},n.objColl[0],{},!0))}}else if(d[u].id&&d[u].id.indexOf("pen")>-1)if(n.pointColl=[],n.freehandCounter=0,n.pointColl.push(sf.base.extend({},d[u],{},!0)),n.freehandCounter=n.pointColl.length,"iterate"===o)n.freeHandDrawModule.draw({prop:"freehandRedraw",onPropertyChange:!1,value:{context:e,points:null}});else if("zoom"===o||"pan"===o){"zoom"===o?n.freeHandDrawModule.draw({prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:r}}):n.freeHandDrawModule.draw({prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:i,yDiff:a,panRegion:s}});for(var f=0;f<p.length;f++)if(p[f].id===n.pointColl[0].id){p[f]=sf.base.extend({},n.pointColl[0],{},!0);break}}}else(d[u].shape||v)&&(d[u].currIndex||v)||d.splice(u,1)}o&&"zoom"===o&&(n.pointColl=[],n.freehandCounter=0,n.freeHandDrawModule.draw({prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:r}})),n.objColl=h,n.pointColl=p,n.freehandCounter=n.pointColl.length,c&&this.preventFrameAnnotation&&(n.drawModule.draw({prop:"applyFrame",value:{ctx:this.lowerContext,frame:n.frameObj.type,preventImg:!0}}),this.preventFrameAnnotation=!1),n.activeObj=l},e}(),y=function(){function e(e){this.isReverseFlip=!1,this.disablePan=!1,this.isReverseRotate=!1,this.flipColl=[],this.prevZoomValue=1,this.cropDimension={width:0,height:0},this.isPreventSelect=!1,this.preventDownScale=!1,this.resizedImgAngle=null,this.parent=e}return e.prototype.transform=function(e){switch(this.initTransformPvtVar(),e.prop){case"flipImage":this.flipImage(e.value.direction);break;case"setDestPointsForFlipState":this.setDestPointsForFlipState();break;case"zoomAction":this.zoomAction(e.value.zoomFactor,e.value.zoomPoint,e.value.isResize);break;case"disableZoomOutBtn":this.disableZoomOutBtn(e.value.isZoomOut);break;case"rotatedFlip":this.rotatedFlip();break;case"drawPannedImage":this.drawPannedImage(e.value.xDiff,e.value.yDiff);break;case"drawPannImage":this.drawPannImage(e.value.point);break;case"performTransformation":this.performTransformation(e.value.text);break;case"updateTransform":this.updateTransform(e.value.text);break;case"rotatePan":this.rotatePan(e.value.isCropSelection,e.value.isDefaultZoom);break;case"resetZoom":this.resetZoom();break;case"pan":this.pan(e.value.value);break;case"zoom":this.zoom(e.value.zoomFactor,e.value.zoomPoint);break;case"setCurrPanRegion":this.setCurrPanRegion(e.value.region,e.value.type,e.value.obj);break;case"rotate":this.rotate(e.value.degree,e.value.obj);break;case"flip":this.flip(e.value.direction);break;case"update":this.update();break;case"calcMaxDimension":this.calcMaxDimension(e.value.width,e.value.height,e.value.obj,e.value.isImgShape);break;case"getPanMove":e.value.obj.panMove=this.panMove;break;case"setPanMove":this.panMove=e.value.point;break;case"getTempPanMove":e.value.obj.tempPanMove=this.tempPanMove;break;case"setTempPanMove":this.tempPanMove=e.value.point;break;case"setReverseFlip":this.isReverseFlip=e.value.isReverseFlip;break;case"setDisablePan":this.disablePan=e.value.bool;break;case"setCurrDestinationPoint":this.currDestPoint=e.value.point,this.currDestPoint.startX-=this.parent.cropObj.totalPannedPoint.x,this.currDestPoint.startY-=this.parent.cropObj.totalPannedPoint.y;break;case"setReverseRotate":this.isReverseRotate=e.value.bool;break;case"getFlipColl":e.value.obj.flipColl=this.flipColl;break;case"setFlipColl":this.flipColl=e.value.flipColl;break;case"getPreviousZoomValue":e.value.obj.previousZoomValue=this.prevZoomValue;break;case"setPreviousZoomValue":this.prevZoomValue=e.value.previousZoomValue;break;case"getCropDimension":e.value.obj.cropDimension=this.cropDimension;break;case"setCropDimension":this.cropDimension.width=e.value.width,this.cropDimension.height=e.value.height;break;case"getPreventSelect":e.value.obj.bool=this.isPreventSelect;break;case"setPreventSelect":this.isPreventSelect=e.value.bool;break;case"resizeImage":this.resizeImage(e.value.width,e.value.height);break;case"resizeCrop":this.resizeCrop(e.value.width,e.value.height);break;case"updateResize":this.updateResize();break;case"resize":this.resize(e.value.width,e.value.height,e.value.isAspectRatio);break;case"straightenImage":this.straightenImage(e.value.degree);break;case"reset":this.reset();break;case"cropZoom":e.value.obj.maxDimension=this.cropZoom(e.value.value,e.value.selectionObj);break;case"setResizedImgAngle":this.resizedImgAngle=e.value.angle}},e.prototype.getModuleName=function(){return"transform"},e.prototype.initTransformPvtVar=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.zoomBtnHold=null,this.tempPanMove=null,this.panMove=null,this.disablePan=!1,this.currDestPoint=null,this.isReverseRotate=!1,this.flipColl=[],this.resizedImgAngle=null,this.transCurrObj=null,this.prevZoomValue=1,this.isPreventSelect=this.preventDownScale=!1},e.prototype.rotateImage=function(e){var t=this,o=this.parent,r={cancel:!1,previousDegree:o.transform.degree,currentDegree:360===Math.abs(o.transform.degree+e)?0:o.transform.degree+e};!this.isPreventSelect&&o.events&&!0===o.events.rotating.hasDelegate?o.dotNetRef.invokeMethodAsync("RotateEventAsync","OnRotate",r,null).then((function(o){t.rotateEvent(o,e)})):this.rotateEvent(r,e)},e.prototype.rotateEvent=function(e,t){var o=this.parent;if(e.cancel)o.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:o.prevEventObjPoint}}),o.activeObj=o.prevEventSelectionPoint,o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}});else{var r=void 0;if(sf.base.isNullOrUndefined(this.transCurrObj)){var i={currObj:{}};o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),(r=i.currObj).objColl=sf.base.extend([],o.objColl,null,!0),r.pointColl=sf.base.extend({},o.pointColl,null,!0),r.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var a={selPointColl:null};o.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),r.selPointColl=sf.base.extend([],a.selPointColl,[],!0)}o.afterCropActions.push(90===t?"rotateRight":"rotateLeft");var s=[],n=void 0;o.activeObj.activePoint&&o.activeObj.shape&&(void 0!==o.activeObj.shape&&(s=o.activeObj.shape.split("-")),(o.currObjType.isCustomCrop||"crop"===s[0])&&(n=o.currObjType.isCustomCrop?"custom":s[1],o.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),o.objColl.push(o.activeObj),o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}))),o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.drawRotatedImage(t),o.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1}),o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.isCircleCrop&&o.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),n&&(this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.activeObj=sf.base.extend({},o.objColl[o.objColl.length-1],{},!0),o.objColl.pop(),o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}})),o.isUndoRedo=!1;var l={collection:o.rotateFlipColl};if(o.shapeModule.shape({prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:o.rotateFlipColl,isRotateFlipCollection:!0,obj:l}}),o.rotateFlipColl=l.collection,o.cropObj.activeObj.shape&&!this.isPreventSelect&&(o.drawModule.draw({prop:"setIsCropSelect",value:{bool:!0}}),this.isPreventSelect=!0,o.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),this.isPreventSelect=!1,o.zoomSettings.zoomFactor=1,this.prevZoomValue=o.zoomSettings.zoomFactor),e={previousDegree:e.previousDegree,currentDegree:e.currentDegree},!this.isPreventSelect&&o.events&&!0===o.events.rotated.hasDelegate){var h={degree:e.currentDegree};o.dotNetRef.invokeMethodAsync("RotateEventAsync","Rotated",null,h)}o.events&&!0===o.events.rotating.hasDelegate&&(o.drawModule.draw({prop:"resetStraightenDestPoints"}),o.drawModule.draw({prop:"setDestForStraighten"}))}},e.prototype.drawRotatedImage=function(e){var t=this.parent;0===e?t.transform.degree=0:t.transform.degree+=e,360===Math.abs(t.transform.degree)&&(t.transform.degree=0),t.drawModule.draw({prop:"setDestPoints",onPropertyChange:!1});var o=sf.base.extend([],t.objColl,[],!0),r=sf.base.extend({},t.activeObj,{},!0);if(t.objColl=[],t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseRotate||t.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),this.rotateDegree(e),this.isReverseRotate||(t.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.rotateFlipColl.push(e)),t.objColl=sf.base.extend([],o,[],!0),t.activeObj=sf.base.extend({},r,{},!0),t.isCircleCrop&&t.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.shapeModule.shape({prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),e>0)t.freeHandDrawModule.draw({prop:"rotateFhdColl",onPropertyChange:!1});else for(var i=0;i<3;i++)t.freeHandDrawModule.draw({prop:"rotateFhdColl",onPropertyChange:!1});t.freeHandDrawModule.draw({prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.updateCurrSelectionPoint(e)},e.prototype.rotateDegree=function(e){var t=this.parent;this.lowerContext.save(),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.translate(t.lowerCanvas.width/2,t.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*e),this.lowerContext.translate(-t.lowerCanvas.width/2,-t.lowerCanvas.height/2);var o=this.lowerContext.filter;t.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=o,this.lowerContext.translate(t.lowerCanvas.width/2,t.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*-e),this.lowerContext.translate(-t.lowerCanvas.width/2,-t.lowerCanvas.height/2),this.lowerContext.restore()},e.prototype.updateCurrSelectionPoint=function(e){var t=this.parent;if(t.currSelectionPoint&&this.currDestPoint){var o=sf.base.extend({},t.activeObj,{},!0),r=sf.base.extend([],t.objColl,[],!0),i={startX:t.img.srcLeft,startY:t.img.srcTop,width:t.img.srcWidth,height:t.img.srcHeight},a={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.objColl=[],t.objColl.push(sf.base.extend({},t.currSelectionPoint,{},!0)),sf.base.isNullOrUndefined(t.objColl[0].imageRatio)&&(t.activeObj=t.objColl[0],t.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl[0]=t.activeObj),t.img={srcLeft:0,srcTop:0,srcWidth:t.baseImgCanvas.width,srcHeight:t.baseImgCanvas.height,destLeft:this.currDestPoint.startX,destTop:this.currDestPoint.startY,destWidth:this.currDestPoint.width,destHeight:this.currDestPoint.height},"number"==typeof e&&(t.drawModule.draw({prop:"setDestPoints",onPropertyChange:!1}),t.drawModule.draw({prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}})),t.shapeModule.shape({prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),t.currSelectionPoint=sf.base.extend({},t.objColl[0],{},!0),this.currDestPoint={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight},t.objColl=r,t.activeObj=o,t.img={srcLeft:i.startX,srcTop:i.startY,srcWidth:i.width,srcHeight:i.height,destLeft:a.startX,destTop:a.startY,destWidth:a.width,destHeight:a.height}}},e.prototype.flipImage=function(e){var t=this,o=this.parent,r={direction:e,cancel:!1,previousDirection:o.toPascalCase(o.transform.currFlipState||e)};!this.isPreventSelect&&o.events&&!0===o.events.flipping.hasDelegate?o.dotNetRef.invokeMethodAsync("FlipEventAsync","OnFlip",r,null).then((function(o){t.flipEvent(o,e)})):this.flipEvent(r,e)},e.prototype.flipEvent=function(e,t){var o,r=this.parent;if(e.cancel)return r.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:r.prevEventObjPoint}}),r.activeObj=r.prevEventSelectionPoint,void r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}});if(sf.base.isNullOrUndefined(this.transCurrObj)){var i={currObj:{}};r.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),(o=i.currObj).objColl=sf.base.extend([],r.objColl,null,!0),o.pointColl=sf.base.extend({},r.pointColl,null,!0),o.afterCropActions=sf.base.extend([],r.afterCropActions,[],!0);var a={selPointColl:null};r.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),o.selPointColl=sf.base.extend([],a.selPointColl,[],!0)}r.afterCropActions.push("horizontal"===t.toLowerCase()?"horizontalflip":"verticalflip");var s,n=[];r.activeObj.activePoint&&(void 0!==r.activeObj.shape&&(n=r.activeObj.shape.split("-")),(r.currObjType.isCustomCrop||"crop"===n[0])&&(s=r.currObjType.isCustomCrop?"custom":n[1],r.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),r.objColl.push(r.activeObj),r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}))),r.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),r.clearContext(this.lowerContext),r.clearContext(this.upperContext);var l=sf.base.extend([],r.objColl,[],!0),h=sf.base.extend({},r.activeObj,{},!0);r.objColl=[],r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseFlip||r.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var p=t.toLowerCase();this.updateFlipState(p);var d=r.transform.currFlipState.toLowerCase();r.transform.currFlipState="horizontal"===p&&"horizontal"===d||"vertical"===p&&"vertical"===d?"":p;var c={isSelected:null};r.drawModule.draw({prop:"getRotatedFlipCropSelection",onPropertyChange:!1,value:{bool:c}}),c.isSelected&&(r.img.destLeft+=r.panPoint.totalPannedInternalPoint.x,r.img.destTop+=r.panPoint.totalPannedInternalPoint.y);var u=this.lowerContext.filter;if(r.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=u,r.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1}),this.updateFlipState(t.toLowerCase()),this.isReverseFlip||(r.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),this.updateFlipColl(t.toLocaleLowerCase()),r.rotateFlipColl.push(t.toLowerCase())),1===r.rotateFlipColl.length){var v={panRegion:""};r.cropModule.cropping({prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:v}}),""===v.panRegion?r.drawModule.draw({prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}}):this.setDestPointsForFlipState()}r.isCircleCrop&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.objColl=sf.base.extend([],l,[],!0),r.activeObj=sf.base.extend({},h,{},!0);for(var g=0,b=r.objColl.length;g<b;g++){var C=r.objColl[g].flipObjColl;0===C.length?C.push(t):C[C.length-1]===t?C.pop():C.push(t)}r.shapeModule.shape({prop:"redrawObj",onPropertyChange:!1,value:{degree:t.toLowerCase()}});var f=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",r.shapeModule.shape({prop:"iterateObjColl",onPropertyChange:!1});var m=t.toLowerCase();"horizontal"===m||"vertical"===m?(r.freeHandDrawModule.draw({prop:"flipFHDColl",onPropertyChange:!1,value:{value:m}}),r.freeHandDrawModule.draw({prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}})):r.freeHandDrawModule.draw({prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=f,r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.updateCurrSelectionPoint(m),r.isUndoRedo=!1,r.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),r.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),r.isCircleCrop&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),s&&(this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj=sf.base.extend({},r.objColl[r.objColl.length-1],{},!0),r.objColl.pop(),r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}}));var y={collection:r.rotateFlipColl};if(r.shapeModule.shape({prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:r.rotateFlipColl,isRotateFlipCollection:!0,obj:y}}),r.rotateFlipColl=y.collection,r.cropObj.activeObj.shape&&!this.isPreventSelect&&(r.drawModule.draw({prop:"setIsCropSelect",value:{bool:!0}}),this.isPreventSelect=!0,r.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),this.isPreventSelect=!1,r.zoomSettings.zoomFactor=1,this.prevZoomValue=r.zoomSettings.zoomFactor),e={previousDirection:e.previousDirection,direction:e.direction},!this.isPreventSelect&&r.events&&!0===r.events.flipped.hasDelegate){var w={direction:e.direction};r.dotNetRef.invokeMethodAsync("FlipEventAsync","Flipped",null,w)}},e.prototype.updateFlipState=function(e){var t=this.parent.transform.degree;"horizontal"===e?t%90==0&&t%180!=0?this.verticalFlip():this.horizontalFlip():"vertical"===e&&(t%90==0&&t%180!=0?this.horizontalFlip():this.verticalFlip())},e.prototype.horizontalFlip=function(){this.lowerContext.translate(this.lowerContext.canvas.width,0),this.lowerContext.scale(-1,1),this.upperContext.translate(this.upperContext.canvas.width,0),this.upperContext.scale(-1,1)},e.prototype.verticalFlip=function(){this.lowerContext.translate(0,this.lowerContext.canvas.height),this.lowerContext.scale(1,-1),this.upperContext.translate(0,this.upperContext.canvas.height),this.upperContext.scale(1,-1)},e.prototype.updateFlipColl=function(e){if(!this.isPreventSelect&&(0===this.flipColl.length||this.flipColl[this.flipColl.length-1]!==e?this.flipColl.push(e):this.flipColl.pop(),this.flipColl.length>=4)){var t=this.flipColl.slice(-4);("horizontal"===t[0]&&"vertical"===t[1]&&"horizontal"===t[2]&&"vertical"===t[3]||"vertical"===t[0]&&"horizontal"===t[1]&&"vertical"===t[2]&&"horizontal"===t[3])&&this.flipColl.splice(-4)}},e.prototype.setDestPointsForFlipState=function(){var e=this.parent,t={panRegion:""},o=e.img,r=o.destLeft,i=o.destTop,a=o.destWidth,s=o.destHeight,n=e.lowerCanvas,l=n.clientWidth,h=n.clientHeight;e.cropModule.cropping({prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:t}}),""!==t.panRegion&&("horizontal"===t.panRegion?e.img.destLeft=l-(a+r):("vertical"===t.panRegion||(e.img.destLeft=l-(a+r)),e.img.destTop=h-(s+i)))},e.prototype.zoomAction=function(e,t,o,r){var i=this,a=this.parent;if(!a.disabled&&a.isImageLoaded){if(sf.base.isNullOrUndefined(o)&&(a.zoomSettings.zoomFactor>=a.zoomSettings.maxZoomFactor&&e>0||a.zoomSettings.zoomFactor>a.zoomSettings.minZoomFactor&&e<0&&this.disableZoomOutBtn(!0)||a.zoomSettings.zoomFactor<=a.zoomSettings.minZoomFactor&&e<0))return;a.drawModule.draw({prop:"setImageEdited",onPropertyChange:!1});var s=e;e=s>0?.1:-.1;for(var n=0;n<Math.round(Math.abs(s/.1));n++)if(1===this.prevZoomValue)this.prevZoomValue+=e>0?10*e:10*e/10;else if(this.prevZoomValue>1)this.prevZoomValue+=10*e;else if(this.prevZoomValue<1){this.prevZoomValue+=10*e/10;var l=Math.pow(10,1);this.prevZoomValue=Math.round(this.prevZoomValue*l)/l}e=s,a.zoomSettings.zoomFactor=this.prevZoomValue;var h=void 0;this.tempActiveObj=null,this.isShape=!1,void 0!==a.activeObj.shape&&("shape"===a.activeObj.shape?a.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}):h=a.activeObj.shape.split("-")),void 0!==h&&"crop"===h[0]?(this.tempActiveObj=sf.base.extend({},a.activeObj,{},!0),a.isCropTab=!0):a.activeObj.shape&&"crop"!==h[0]&&(this.isShape=!0);var p={zoomType:null};a.selectionModule.selection({prop:"getZoomType",onPropertyChange:!1,value:{obj:p}}),sf.base.isNullOrUndefined(t)&&(t=a.isCropTab&&this.tempActiveObj?{x:a.activeObj.activePoint.startX+a.activeObj.activePoint.width/2,y:a.activeObj.activePoint.startY+a.activeObj.activePoint.height/2}:{x:a.lowerCanvas.clientWidth/2,y:a.lowerCanvas.clientHeight/2},"MouseWheel"!==p.zoomType&&"Pinch"!==p.zoomType||(t={x:a.zoomSettings.zoomPoint.x,y:a.zoomSettings.zoomPoint.y}));var d={zoomPoint:t,cancel:!1,previousZoomFactor:a.zoomSettings.zoomFactor-10*e,currentZoomFactor:a.zoomSettings.zoomFactor,zoomTrigger:p.zoomType};!a.isCropToolbar&&a.isZoomBtnClick&&a.events&&!0===a.events.zooming.hasDelegate?(d.zoomTrigger=parseInt(this.getZoomTriggerType(d.zoomTrigger)),a.dotNetRef.invokeMethodAsync("ZoomEventAsync","OnZoom",d,null).then((function(t){i.zoomEvent(t,e,r)}))):this.zoomEvent(d,e,r)}},e.prototype.getZoomTriggerType=function(e){switch(e){case"MouseWheel":return"1";case"Pinch":return"2";case"Commands":return"4";default:return"8"}},e.prototype.zoomEvent=function(e,t,o){var r=this.parent,i=r.zoomSettings,a=i.zoomFactor,s=i.minZoomFactor;if(e.cancel)r.isZoomBtnClick=!1;else{"resize-toolbar"!==r.currentToolbar&&"crop-toolbar"!==r.currentToolbar&&r.element.querySelector(".e-contextual-toolbar-wrapper")&&!r.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hidden")&&r.updateToolbar(r.element,"closeContextualToolbar"),r.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height);var n={canvasFilter:r.canvasFilter};this.lowerContext.filter=n.canvasFilter,r.upperCanvas.style.cursor=r.cursor="default";var l=sf.base.extend([],r.objColl,[],!0);if(!r.isCropTab){if(0!==r.transform.degree){r.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r.panPoint.currentPannedPoint={x:0,y:0};var h=r.allowDownScale;r.allowDownScale=!1,this.rotatePan(!0,!0),r.allowDownScale=h}else""!==r.transform.currFlipState&&(r.panPoint.totalPannedPoint={x:0,y:0});0!==r.transform.straighten||this.isPreventSelect||r.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:o}})}if(0===r.transform.degree){this.drawZoomImgToCanvas(t,this.tempActiveObj);var p={panRegion:""};if(r.cropModule.cropping({prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:p}}),""!==p.panRegion){r.cropModule.cropping({prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:r.panPoint.totalPannedPoint,isAdd:!0}}),l=sf.base.extend([],r.objColl,[],!0),r.objColl=[];var d=r.img.destLeft,c=r.img.destTop;this.setDestPointsForFlipState(),this.rotatedFlip(),r.img.destLeft=d,r.img.destTop=c,r.objColl=l,r.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:o}}),0!==r.transform.straighten||this.isPreventSelect||r.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:o}})}a<=s&&!r.isCropTab&&(r.panPoint.totalPannedPoint={x:0,y:0})}else{0!==r.transform.straighten||this.isPreventSelect||r.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:o}}),r.panPoint.totalPannedClientPoint={x:0,y:0},r.panPoint.totalPannedInternalPoint={x:0,y:0},this.rotateZoom(t);var u={panRegion:""};if(r.cropModule.cropping({prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:u}}),""!==u.panRegion){h=this.lowerContext.filter;this.lowerContext.filter="none",r.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:o}}),this.lowerContext.filter=h}}var v=Math.pow(10,1);(a<=s||Math.round(r.transform.zoomFactor*v)/v==2)&&(clearInterval(this.zoomBtnHold),this.zoomBtnHold=0);var g,b={panRegion:""};if(r.cropModule.cropping({prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:b}}),""===b.panRegion){h=this.lowerContext.filter;this.lowerContext.filter="none",r.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:o}}),this.lowerContext.filter=h}(r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape||r.isCircleCrop)&&r.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.tempActiveObj&&(r.activeObj=sf.base.extend({},this.tempActiveObj,{},!0),r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}}),a<=s&&(r.currSelectionPoint=null)),r.isUndoRedo=!1,(g=r.element.querySelector("#zoomout"))&&a<=s?g.classList.add("e-overlay"):g&&g.classList.remove("e-overlay");var C=r.drawingShape;this.autoEnablePan(),r.drawingShape=C,this.tempActiveObj&&(r.activeObj=sf.base.extend({},this.tempActiveObj,{},!0)),"crop-custom"===r.activeObj.shape&&(r.currObjType.isCustomCrop=!0);var f=r.element.querySelector(".e-img-pan .e-btn");if(f&&r.togglePan?f.classList.add("e-selected-btn"):f&&f.classList.remove("e-selected-btn"),this.isShape&&(r.activeObj=sf.base.extend({},r.objColl[r.objColl.length-1],{},!0),r.objColl.pop(),r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})),r.updateToolbar(r.element,"enableDisableToolbarBtn"),r.selectionModule.selection({prop:"setZoomType",onPropertyChange:!1,value:{zoomType:"Toolbar"}}),e={zoomPoint:e.zoomPoint,previousZoomFactor:e.previousZoomFactor,currentZoomFactor:e.currentZoomFactor,zoomTrigger:e.zoomTrigger},!r.isCropToolbar&&r.isZoomBtnClick&&r.events&&!0===r.events.zoomed.hasDelegate){e.zoomTrigger="number"!=typeof e.zoomTrigger?parseInt(this.getZoomTriggerType(e.zoomTrigger)):e.zoomTrigger;var m={zoomPoint:e.zoomPoint,zoomFactor:e.currentZoomFactor,zoomTrigger:e.zoomTrigger};r.dotNetRef.invokeMethodAsync("ZoomEventAsync","Zoomed",null,m),r.isZoomBtnClick=!1}else!r.isCropToolbar&&r.isZoomBtnClick&&(r.isZoomBtnClick=!1);if(r.drawingShape){var y=sf.base.extend({},r.activeObj,{},!0);if(r.enableShapeDrawing(r.toPascalCase(r.drawingShape),!0),r.activeObj=y,y.activePoint.width>0||y.activePoint.height>0||y.pointColl&&y.pointColl.length>0){var w=r.element.querySelector("#"+r.element.id+"_zOrderBtn"),P=r.element.querySelector("#"+r.element.id+"_duplicate"),j=r.element.querySelector("#"+r.element.id+"_remove"),x=r.element.querySelector("#"+r.element.id+"_editText");w&&w.classList.remove("e-disabled"),P&&P.classList.remove("e-disabled"),j&&j.classList.remove("e-disabled"),x&&x.classList.remove("e-disabled")}}}},e.prototype.disableZoomOutBtn=function(e){var t,o=this.parent,r=o.zoomSettings,i=r.zoomFactor,a=r.minZoomFactor,s=!1;sf.base.isNullOrUndefined(e)||(o.transform.zoomFactor-=.1),t=o.element.querySelector("#zoomout");var n={destLeft:o.img.destLeft,destTop:o.img.destTop,destWidth:o.img.destWidth,destHeight:o.img.destHeight};if(o.activeObj.shape){var l=this.setZoomDimension(-.1,o.activeObj);if(!sf.base.isNullOrUndefined(t)){var h=o.activeObj.activePoint;if(0===o.transform.straighten)o.img.destLeft>h.startX||o.img.destTop>h.startY||o.img.destLeft+o.img.destWidth<h.endX||o.img.destTop+o.img.destHeight<h.endY||i===a?(t.classList.add("e-overlay"),s=!0):(t.classList.remove("e-overlay"),s=!1);else{o.img.destWidth=l.width,o.img.destHeight=l.height;var p={isIntersect:null};o.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),o.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}}),p.isIntersect||i===a?(t.classList.add("e-overlay"),s=!0):(t.classList.remove("e-overlay"),s=!1)}}}else this.setZoomDimension(-.1,null);return sf.base.isNullOrUndefined(e)||(o.transform.zoomFactor+=.1),o.img.destLeft=n.destLeft,o.img.destTop=n.destTop,o.img.destWidth=n.destWidth,o.img.destHeight=n.destHeight,s},e.prototype.drawZoomImgToCanvas=function(e,t){var o=this.parent,r=Math.pow(10,1),i=Math.round(o.transform.zoomFactor*r)/r;.1===i&&-.1===e||0===i&&-.025===e?o.transform.zoomFactor=0:o.transform.zoomFactor+=e,o.transform[o.isCropTab?"cropZoomFactor":"defaultZoomFactor"]=o.transform.zoomFactor;var a={width:0,height:0};o.isCropTab?a=this.cropZoom(e,t):((a=this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=a.width*o.transform.zoomFactor,a.height+=a.height*o.transform.zoomFactor,o.img.destLeft=(o.lowerCanvas.clientWidth-a.width)/2,o.img.destTop=(o.lowerCanvas.clientHeight-a.height+1)/2),o.drawModule.draw({prop:"draw-image-to-canvas",value:{dimension:a}}),a.width=this.cropDimension.width,a.height=this.cropDimension.height,a.width+=a.width*o.transform.zoomFactor,a.height+=a.height*o.transform.zoomFactor,o.drawModule.draw({prop:"setZoomCropWidth",value:{width:a.width,height:a.height}})},e.prototype.rotatedFlip=function(){var e=this.parent;this.isReverseFlip=!0;var t=e.transform.currFlipState,o=this.flipColl,r=sf.base.extend([],e.objColl,[],!0),i=sf.base.extend({},e.activeObj,{},!0);this.flipColl=[],e.objColl=[],e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),e.drawModule.draw({prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}});var a=this.lowerContext.filter;e.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=a,e.drawModule.draw({prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,context:null,isPreventCircleCrop:null}}),""===t&&""!==e.transform.currFlipState&&(t=e.transform.currFlipState),e.transform.currFlipState=t,this.flipColl=o,e.objColl=sf.base.extend([],r,[],!0),this.lowerContext.filter="none",e.shapeModule.shape({prop:"iterateObjColl",onPropertyChange:!1}),this.lowerContext.filter=a,0!==i.activePoint.width&&(e.activeObj=sf.base.extend({},i,{},!0)),this.isReverseFlip=!1},e.prototype.rotateZoom=function(e){var t=this.parent,o=Math.pow(10,1),r=Math.round(t.transform.zoomFactor*o)/o;.1===r&&-.1===e||0===r&&-.025===e?t.transform.zoomFactor=0:t.transform.zoomFactor+=e,t.isCropTab?t.transform.cropZoomFactor=t.transform.zoomFactor:t.transform.defaultZoomFactor=t.transform.zoomFactor;var i=sf.base.extend([],t.objColl,[],!0),a=sf.base.extend({},t.activeObj,{},!0);t.objColl=[],t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),t.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),t.drawModule.draw({prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),t.drawModule.draw({prop:"setDestPoints",onPropertyChange:!1});var s=this.lowerContext.filter;t.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=s,t.drawModule.draw({prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),t.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.objColl=i,t.activeObj=a;var n={width:this.cropDimension.width,height:this.cropDimension.height};n.width+=n.width*t.transform.zoomFactor,n.height+=n.height*t.transform.zoomFactor,t.drawModule.draw({prop:"setZoomCropWidth",value:{width:n.width,height:n.height}})},e.prototype.autoEnablePan=function(){var e=this.parent;e.transform.zoomFactor<=0?(e.togglePan=!1,e.selectionModule.selection({prop:"setDragCanvas",value:{bool:!1}}),e.pan(!1),this.disablePan=!1):e.pan(!this.disablePan)},e.prototype.cropZoom=function(e,t){var o=this.parent,r=o.img.destLeft,i=o.img.destTop,a={width:0,height:0};return 0===o.img.srcLeft||0===o.img.srcTop?a=sf.base.isNullOrUndefined(t)?this.setZoomDimension(e,null):this.setZoomDimension(e,t):((a=o.transform.degree%90==0&&o.transform.degree%180!=0?this.calcMaxDimension(o.img.srcHeight,o.img.srcWidth):this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=a.width*o.transform.zoomFactor,a.height+=a.height*o.transform.zoomFactor),o.img.destLeft=r-(a.width-o.img.destWidth)/2,o.img.destTop=i-(a.height-o.img.destHeight)/2,r=o.img.destLeft,i=o.img.destTop,t&&0===o.transform.straighten&&(o.img.destLeft>t.activePoint.startX&&(o.img.destLeft=t.activePoint.startX,0===o.transform.degree&&(o.panPoint.totalPannedPoint.x-=r-o.img.destLeft)),o.img.destTop>t.activePoint.startY&&(o.img.destTop=t.activePoint.startY,0===o.transform.degree&&(o.panPoint.totalPannedPoint.y-=i-o.img.destTop)),o.img.destLeft+a.width<t.activePoint.endX&&(o.img.destLeft=t.activePoint.endX-a.width,0===o.transform.degree&&(o.panPoint.totalPannedPoint.x-=r-o.img.destLeft)),o.img.destTop+a.height<t.activePoint.endY&&(o.img.destTop=t.activePoint.endY-a.height,0===o.transform.degree&&(o.panPoint.totalPannedPoint.y-=i-o.img.destTop))),a},e.prototype.setZoomDimension=function(e,t){var o=this.parent,r=o.transform.degree,i={width:0,height:0};if((i=r%90==0&&r%180!=0?this.calcMaxDimension(o.img.srcHeight,o.img.srcWidth):this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=i.width*o.transform.zoomFactor,i.height+=i.height*o.transform.zoomFactor,o.img.destLeft+=(o.img.destWidth-i.width)/2,o.img.destTop+=(o.img.destHeight-i.height)/2,e<0&&t){var a=t.activePoint.startX,s=t.activePoint.startY,n=t.activePoint.width,l=t.activePoint.height,h=o.img.destLeft+i.width,p=o.img.destTop+i.height;o.img.destLeft>a&&(o.img.destLeft=a),o.img.destTop>s&&(o.img.destTop=s),h<a+n&&(o.img.destLeft=a+n-i.width),p<s+l&&(o.img.destTop=s+l-i.height)}else e<0&&sf.base.isNullOrUndefined(t)&&(o.img.destLeft>0&&(o.img.destLeft=0),o.img.destTop>0&&(o.img.destTop=0),o.img.destLeft+i.width<o.lowerCanvas.clientWidth&&(o.img.destLeft=o.lowerCanvas.clientWidth-o.img.destWidth),o.img.destTop+i.height<o.lowerCanvas.clientHeight&&(o.img.destTop=o.lowerCanvas.clientHeight-o.img.destHeight));return i},e.prototype.drawPannedImage=function(e,t){var o=this,r=this.parent,i={panDown:null};r.selectionModule.selection({prop:"getPanDown",onPropertyChange:!1,value:{obj:i}});var a={startPoint:i.panDown,endPoint:this.panMove,cancel:!1};sf.base.isNullOrUndefined(r.eventType)&&r.events&&!0===r.events.onPanStart.hasDelegate?(r.eventType="pan",r.panEventArgs=a,r.dotNetRef.invokeMethodAsync("PanEventAsync","OnPanStart",a).then((function(r){o.panEvent(r,e,t)}))):this.panEvent(a,e,t)},e.prototype.panEvent=function(e,t,o){if(!e.cancel){var r=this.parent,i=!1;if(r.activeObj.shape&&"shape"===r.activeObj.shape&&r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),sf.base.isNullOrUndefined(r.activeObj.shape)){i=!0;var a=r.activeObj.activePoint={startX:r.img.destLeft,startY:r.img.destTop,endX:r.img.destLeft+r.img.destWidth,endY:r.img.destTop+r.img.destHeight},s=a.startX,n=a.startY,l=a.endX,h=a.endY;s<0&&(a.startX=0),n<0&&(a.startY=0),l>r.lowerCanvas.width&&(a.endX=r.lowerCanvas.width),h>r.lowerCanvas.height&&(a.endY=r.lowerCanvas.height),a.width=a.endX-a.startX,a.height=a.endY-a.startY,r.activeObj.shape="crop-custom";var p={strokeSettings:{}};r.shapeModule.shape({prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:p}}),r.activeObj.strokeSettings=p.strokeSettings,r.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:a,obj:r.activeObj,isMouseMove:null,x:null,y:null}}),r.isCropTab=!0}if(0===r.transform.degree){var d=void 0;d=sf.base.isNullOrUndefined(t)&&sf.base.isNullOrUndefined(o)?this.updatePanPoints():{x:t,y:o},r.panPoint.totalPannedPoint.x+=d.x,r.panPoint.totalPannedPoint.y+=d.y;var c=sf.base.extend({},r.activeObj,{},!0),u=this.lowerContext.filter;this.drawPannImage(d,i),this.lowerContext.filter=u,this.tempPanMove=sf.base.extend({},this.panMove,{},!0),r.activeObj=sf.base.extend({},c,{},!0),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj.shape&&r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}})}else{var v=r.transform.currFlipState;r.isCropTab=!0,sf.base.isNullOrUndefined(t)&&sf.base.isNullOrUndefined(o)?r.panPoint.currentPannedPoint=this.updatePanPoints():r.panPoint.currentPannedPoint={x:t,y:o},r.transform.currFlipState=v,this.rotatePan(null,null,i),r.isCropTab=!1,this.tempPanMove=sf.base.extend({},this.panMove,{},!0)}i&&(r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),r.isCropTab=!1,this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height))}},e.prototype.drawPannImage=function(e,t){var o=this.parent,r=this.lowerContext.filter,i={startX:o.img.destLeft,startY:o.img.destTop,width:o.img.destWidth,height:o.img.destHeight};this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),o.img.destLeft=i.startX,o.img.destTop=i.startY,o.img.destWidth=i.width,o.img.destHeight=i.height,this.setDestPointsForFlipState(),t&&(o.isCropTab=!1),o.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),t&&(o.isCropTab=!0),(o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape||o.isCircleCrop)&&o.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}}),this.lowerContext.filter=r,o.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),o.img.destLeft=i.startX,o.img.destTop=i.startY,o.img.destWidth=i.width,o.img.destHeight=i.height;var a=this.lowerContext.filter;this.lowerContext.filter="none",t&&(o.isCropTab=!1),o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:e.x,y:e.y,panRegion:""}}),t&&(o.isCropTab=!0),this.lowerContext.filter=a,o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.isCircleCrop&&o.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}})},e.prototype.resetZoom=function(){var e=this.parent;if(0!==e.transform.defaultZoomFactor){var t=e.isUndoRedo,o={currObj:{}};e.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),this.transCurrObj=o.currObj,this.transCurrObj.objColl=sf.base.extend([],e.objColl,null,!0),this.transCurrObj.pointColl=sf.base.extend({},e.pointColl,null,!0),this.transCurrObj.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var r={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),this.transCurrObj.selPointColl=sf.base.extend([],r.selPointColl,[],!0),e.isUndoRedo=e.isCropToolbar=!0;var i=e.transform.defaultZoomFactor;i>0?this.zoomAction(-i):this.zoomAction(Math.abs(i)),e.isCropToolbar=!1,e.isUndoRedo=t}},e.prototype.performTransformation=function(e){var t=this.parent,o=t.transform.defaultZoomFactor,r=t.isUndoRedo,i=sf.base.extend({},t.cropObj,{},!0);this.resetZoom(),this.updateTransform(e);for(var a=0,s=t.objColl.length;a<s;a++)if(t.objColl[a].flipObjColl.length>0){var n={collection:t.objColl[a].flipObjColl};t.shapeModule.shape({prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:n.collection,isRotateFlipCollection:null,obj:n}}),t.objColl[a].flipObjColl=n.collection,0===t.objColl[a].flipObjColl.length&&(t.objColl[a].shapeFlip="")}if(0!==o){t.isUndoRedo=!0,this.zoomAction(o),t.isUndoRedo=r;var l="";"rotateleft"===e||"rotateright"===e?l="rotate":"horizontalflip"!==e&&"verticalflip"!==e||(l="flip"),t.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:l,previousObj:this.transCurrObj,previousObjColl:this.transCurrObj.objColl,previousPointColl:this.transCurrObj.pointColl,previousSelPointColl:this.transCurrObj.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.transCurrObj=null}},e.prototype.updateTransform=function(e){switch(e.toLowerCase()){case"rotateleft":this.rotateImage(-90);break;case"rotateright":this.rotateImage(90);break;case"horizontalflip":this.flipImage(t.Horizontal);break;case"verticalflip":this.flipImage(t.Vertical)}},e.prototype.rotatePan=function(e,t,o){var r=this.parent;this.isReverseRotate=!0;var i,a=r.transform.degree,s={selPointColl:null};r.activeObj.activePoint&&r.activeObj.shape&&(i=sf.base.extend({},r.activeObj,{},!0));var n=sf.base.extend([],r.objColl,[],!0),l=sf.base.extend([],r.pointColl,[],!0);r.objColl=[],r.pointColl=[],r.freehandCounter=0,r.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}});var h=s.selPointColl;r.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),r.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),r.drawModule.draw({prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),r.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var p=r.img.destLeft,d=r.img.destTop,c=r.panPoint.totalPannedInternalPoint;r.isCropTab&&(r.img.destLeft+=c.x,r.img.destTop+=c.y),r.cropModule.cropping({prop:"updateRotatePan",onPropertyChange:!1}),r.isCropTab&&(r.panPoint.totalPannedInternalPoint.x=r.img.destLeft-p,r.panPoint.totalPannedInternalPoint.y=r.img.destTop-d);var u=this.lowerContext.filter;o&&(r.isCropTab=!1),r.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),o&&(r.isCropTab=!0),r.drawModule.draw({prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),r.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,isRotatePan:!0}});var v=r.img.destLeft,g=r.img.destTop;r.img.destLeft+=r.panPoint.totalPannedClientPoint.x,r.img.destTop+=r.panPoint.totalPannedClientPoint.y,r.img.destLeft+=r.panPoint.currentPannedPoint.x,r.img.destTop+=r.panPoint.currentPannedPoint.y,r.panPoint.totalPannedClientPoint.x=r.img.destLeft-v,r.panPoint.totalPannedClientPoint.y=r.img.destTop-g,r.objColl=n,r.pointColl=l,r.freehandCounter=r.pointColl.length,r.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:h}}}),r.transform.degree=a,this.lowerContext.filter="none",e&&(t?(r.panPoint.totalPannedClientPoint.x=-r.panPoint.totalPannedClientPoint.x,r.panPoint.totalPannedClientPoint.y=-r.panPoint.totalPannedClientPoint.y,r.panPoint.currentPannedPoint=sf.base.extend({},r.panPoint.totalPannedClientPoint,{},!0),r.panPoint.totalPannedClientPoint={x:0,y:0},r.img.destLeft+=r.panPoint.currentPannedPoint.x,r.img.destTop+=r.panPoint.currentPannedPoint.y):r.panPoint.currentPannedPoint=sf.base.extend({},r.panPoint.totalPannedClientPoint,{},!0)),o&&(r.isCropTab=!1),r.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:r.panPoint.currentPannedPoint.x,y:r.panPoint.currentPannedPoint.y,panRegion:""}}),o&&(r.isCropTab=!0),this.lowerContext.filter=u,r.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj=sf.base.extend({},i,{},!0),r.activeObj.activePoint&&r.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),this.isReverseRotate=!1},e.prototype.limitPan=function(){var e=this.parent,t=e.activeObj.activePoint,o=t.startX,r=t.startY,i=t.endX,a=t.endY,s=e.img;e.activeObj.activePoint&&(s.destLeft>o&&(e.img.destLeft=o),s.destTop>r&&(e.img.destTop=r),s.destLeft+s.destWidth<i&&(e.img.destLeft=i-s.destWidth),s.destTop+s.destHeight<a&&(e.img.destTop=a-s.destHeight))},e.prototype.pan=function(e){var t=this.parent;!t.disabled&&t.isImageLoaded&&(e?(t.togglePan=!0,t.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),t.selectionModule.selection({prop:"setDragCanvas",value:{bool:!0}}),t.lowerCanvas.style.cursor=t.upperCanvas.style.cursor=t.cursor="grab",t.selectionModule.selection({prop:"setPanDown",onPropertyChange:!1,value:{panDown:null}})):(t.togglePan=t.currObjType.isCustomCrop=!1,t.selectionModule.selection({prop:"setDragCanvas",value:{bool:!1}}),t.lowerCanvas.style.cursor=t.upperCanvas.style.cursor=t.cursor="default"))},e.prototype.zoom=function(e,t){var o=this.parent;if(!o.disabled&&o.isImageLoaded){var r=this.getCurrentZoomFactor(e);if(sf.base.isNullOrUndefined(t))this.zoomAction(r,t);else for(var i=r>0?"zoomIn":"zoomOut",a=10*Math.abs(r),s=0;s<a;s++)o.drawModule.draw({prop:"performPointZoom",onPropertyChange:!1,value:{x:t.x,y:t.y,type:i,isResize:null}})}},e.prototype.getCurrentZoomFactor=function(e){return e>=1?this.prevZoomValue<1?e-this.prevZoomValue:.1*(e-this.prevZoomValue):e-this.prevZoomValue},e.prototype.setCurrPanRegion=function(e,t,o){var r=e;r=""===e?"horizontal"===t?"horizontal":"vertical"===t?"vertical":e:"horizontal"===e?"horizontal"===t?"horizontalVertical":"vertical"===t?"verticalHorizontal":90===t?"vertical":-90===t?"horizontal":e:"vertical"===e?"horizontal"===t?"horizontalVertical":"vertical"===t?"verticalHorizontal":90===t?"horizontal":-90===t?"vertical":e:"horizontal"===t?"vertical":"vertical"===t?"horizontal":e,o.panRegion=r},e.prototype.rotate=function(e,t){var o=this.parent;!o.disabled&&o.isImageLoaded&&e%90==0&&this.rotateImage(e),t.isRotate=!1},e.prototype.flip=function(e){var t=this.parent;!t.disabled&&t.isImageLoaded&&this.flipImage(e)},e.prototype.update=function(){var e=this.parent,t=0,o=!1,r=!1,i={bool:!1},a=e.isStraightening,s=0,n=e.element.querySelector("#"+e.element.id+"_contextualToolbar"),l=e.element.querySelector(".e-contextual-toolbar-wrapper"),h=e.element.querySelector("#"+e.element.id+"_headWrapper");if(e.isImageLoaded){var p=!1,d=void 0;sf.base.Browser.isDevice&&(e.activeObj.shape&&(d=e.activeObj.shape.split("-")),(e.currObjType.isCustomCrop||d&&"crop"===d[0])&&(p=!0));"frame-toolbar"===e.currentToolbar&&(o=!0),!a&&(n&&!n.parentElement.classList.contains("e-hide")||h&&!h.parentElement.classList.contains("e-hide"))&&(l.classList.add("e-hide"),p||e.okBtn(null,!0),e.updateToolbar(e.element,"imageLoaded")),e.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:i}}),i.bool&&e.updateToolbar(e.element,"destroyQuickAccessToolbar");var c=sf.base.extend({},e.activeObj.activePoint,{},!0);!e.activeObj.shape||0===c.width&&0===c.height||(r=!0,"block"===e.textArea.style.display||"inline-block"===e.textArea.style.display?(e.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),e.updateToolbar(e.element,"destroyQuickAccessToolbar")):(e.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj)),e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}))}var u=this.lowerContext.filter,v=e.element.querySelector("#"+e.element.id+"_canvasWrapper");if(v&&(v.style.width=e.element.offsetWidth-2+"px"),e.lowerCanvas.width=e.upperCanvas.width=e.element.offsetWidth-2,e.toolbarTemplate?t=e.element.querySelector("#"+e.element.id+"_toolbarArea").clientHeight:e.element.querySelector("#"+e.element.id+"_toolbar")&&(t=e.element.querySelector("#"+e.element.id+"_toolbar").clientHeight),sf.base.Browser.isDevice&&a&&(s=e.element.querySelector("#"+e.element.id+"_contextualToolbarArea").clientHeight),sf.base.Browser.isDevice?v&&(v.style.height=e.element.offsetHeight-(2*t+s)-4+"px"):v&&(v.style.height=e.element.offsetHeight-t-2+"px"),e.lowerCanvas.height=e.upperCanvas.height=parseFloat(v.style.height),e.updateToolbar(e.element,""),this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",e.filterModule.filter({prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.clearContext(this.lowerContext),e.clearContext(this.upperContext),e.isImageLoaded){if(e.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.lowerContext.filter=u,e.initialAdjustmentValue=u,e.canvasFilter=this.lowerContext.filter,e.isImageLoaded&&(sf.popups.showSpinner(e.element),e.element.style.opacity="0.5"),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),v){v.style.width=e.element.offsetWidth-2+"px",v.style.height=e.element.offsetHeight+"px";var g={toolbarHeight:e.toolbarHeight};sf.base.Browser.isDevice?v.style.height=parseFloat(v.style.height)-2*g.toolbarHeight-s-4+"px":v.style.height=parseFloat(v.style.height)-g.toolbarHeight-2+"px"}e.lowerCanvas.width=e.upperCanvas.width=parseFloat(v.style.width),e.lowerCanvas.height=e.upperCanvas.height=parseFloat(v.style.height),this.lowerContext.filter=u;var b={width:0,height:0};this.calcMaxDimension(e.img.srcWidth,e.img.srcHeight,b);var C=b;if(a&&0!==e.transform.cropZoomFactor?(C.width+=C.width*e.transform.cropZoomFactor,C.height+=C.height*e.transform.cropZoomFactor):e.transform.defaultZoomFactor>0&&(C.width+=C.width*e.transform.defaultZoomFactor,C.height+=C.height*e.transform.defaultZoomFactor),e.img.destLeft=(e.lowerCanvas.clientWidth-C.width)/2,e.img.destTop=(e.lowerCanvas.clientHeight-C.height+1)/2,0===e.transform.degree&&""===e.transform.currFlipState)e.transform.defaultZoomFactor>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),e.drawModule.draw({prop:"draw-image-to-canvas",value:{dimension:C}});else{e.drawModule.draw({prop:"draw-image-to-canvas",value:{dimension:C}}),e.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var f=this.lowerContext.filter;e.drawModule.draw({prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=f,e.drawModule.draw({prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}})}if(e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),e.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),e.isCircleCrop&&e.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),sf.popups.hideSpinner(e.element),e.element.style.opacity="1",e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),r){var m=sf.base.extend({},e.objColl[e.objColl.length-1],null,!0);e.objColl.pop(),0!==m.activePoint.width&&0!==m.activePoint.height&&(this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),e.objColl.push(m),e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),m=sf.base.extend({},e.objColl[e.objColl.length-1],null,!0),e.objColl.pop(),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),e.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:m}}),a&&e.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:m}}),"rectangle"!==e.activeObj.shape&&"ellipse"!==e.activeObj.shape&&"text"!==e.activeObj.shape&&"line"!==e.activeObj.shape&&"arrow"!==e.activeObj.shape&&"path"!==e.activeObj.shape&&"image"!==e.activeObj.shape||e.updateToolbar(e.element,"quickAccessToolbar",e.activeObj.shape))}if(i.bool&&e.updateToolbar(e.element,"quickAccessToolbar","pen"),o?e.updateToolbar(e.element,"frame"):e.isResize&&(e.aspectWidth=Math.ceil(e.img.destWidth),e.aspectHeight=Math.ceil(e.img.destHeight),e.updateToolbar(e.element,"resize")),(0!==e.transform.degree||""!==e.transform.currFlipState)&&e.transform.defaultZoomFactor>0){var y=sf.base.extend({},e.panPoint.totalPannedPoint,null,!0),w=sf.base.extend({},e.panPoint.totalPannedInternalPoint,null,!0),P=sf.base.extend({},e.panPoint.totalPannedClientPoint,null,!0);this.zoomAction(.1),this.zoomAction(-.1),0===e.transform.degree?(e.img.destLeft+=y.x,e.img.destTop+=y.y,e.panPoint.totalPannedPoint=y,e.drawModule.draw({prop:"updateFlipPan",value:{tempSelectionObj:null}})):(e.panPoint.totalPannedInternalPoint=w,e.panPoint.totalPannedClientPoint=P,e.panPoint.currentPannedPoint={x:0,y:0},e.isCropTab=!0,this.rotatePan(),e.isCropTab=!1)}else 0!==e.transform.degree&&e.transform.cropZoomFactor>0&&(e.transform.zoomFactor=0,e.transform.cropZoomFactor=null,e.updateToolbar(e.element,"enableDisableToolbarBtn"))}},e.prototype.calcMaxDimension=function(e,t,o,r){var i={toolbarHeight:0},a=this.parent;i.toolbarHeight=a.toolbarHeight;var s=r?a.element.clientWidth/3:a.element.clientWidth,n=r?(a.element.clientHeight-i.toolbarHeight)/3:a.element.clientHeight-i.toolbarHeight;if(n=sf.base.Browser.isDevice?n-i.toolbarHeight:n,sf.base.Browser.isDevice&&a.isStraightening){var l=a.element.querySelector("#"+a.element.id+"_contextualToolbarArea");n-=l?l.clientHeight:0}sf.base.isNullOrUndefined(r)&&(s>30&&(s-=30),n>30&&(n-=30));var h=s/e,p=n/t,d=Math.min(e,s),c=Math.min(t,n);if(h<1&&h<p?(d=e*h,c=t*h):p<1&&p<h&&(d=e*p,c=t*p),sf.base.isNullOrUndefined(r)){var u={bool:null};a.cropModule.cropping({prop:"getPreventScaling",onPropertyChange:!1,value:{obj:u}}),u.bool&&a.cropObj.activeObj.activePoint&&0!==a.cropObj.activeObj.activePoint.width&&0!==a.cropObj.activeObj.activePoint.height&&(d=a.cropObj.activeObj.activePoint.width,c=a.cropObj.activeObj.activePoint.height)}return o&&(o.width=d,o.height=c),{width:d,height:c}},e.prototype.updatePanPoints=function(){var e=this.parent,t=sf.base.extend({},e.activeObj,{},!0),o=e.img.destLeft,r=e.img.destTop;sf.base.isNullOrUndefined(this.tempPanMove)&&(this.tempPanMove={x:this.panMove.x,y:this.panMove.y});var i=this.panMove.x-this.tempPanMove.x,a=this.panMove.y-this.tempPanMove.y;e.img.destLeft+=i,e.img.destTop+=a,this.limitPan();var s={bool:null},n={isIntersect:null};e.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:n}}),e.drawModule.draw({prop:"isSelOutsideImg",onPropertyChange:!1,value:{obj:s}});for(var l=0;0!==e.transform.straighten&&(n.isIntersect||s.bool)&&(l++,e.img.destLeft=o,e.img.destTop=r,0!==i&&i>0?i-=1:0!==i&&i<0&&(i+=1),0!==a&&a>0?a-=1:0!==a&&a<0&&(a+=1),(0!==i||0!==a)&&200!==l);)e.img.destLeft+=i,e.img.destTop+=a,this.limitPan(),e.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:n}}),e.drawModule.draw({prop:"isSelOutsideImg",onPropertyChange:!1,value:{obj:s}});return e.activeObj=t,{x:e.img.destLeft-o,y:e.img.destTop-r}},e.prototype.resizeImage=function(e,t){var o=this.parent,r=!0,i=!0;o.allowDownScale=!1,o.img.srcLeft=0,o.img.srcTop=0,o.isAspectRatio=!0;var a=[];for(o.img.srcWidth=o.baseImgCanvas.width,o.img.srcHeight=o.baseImgCanvas.height,o.resizeSrc&&0!==o.resizeSrc.width&&0!==o.resizeSrc.height&&(o.img.srcLeft=o.resizeSrc.startX,o.img.srcTop=o.resizeSrc.startY,o.img.srcWidth=o.resizeSrc.width,o.img.srcHeight=o.resizeSrc.height);(e<o.img.destWidth||t<o.img.destHeight)&&i;)if(this.zoomAction(-.1,null,!0,!0),e>o.img.destWidth||t>o.img.destHeight)for(;e>o.img.destWidth||t>o.img.destHeight;)this.zoomAction(.0125,null,!0,!0),i=!1,a.push(o.img.destWidth);for(;(e>o.img.destWidth||t>o.img.destHeight)&&i&&r;)if(this.zoomAction(.1,null,!0,!0),e<o.img.destWidth||t<o.img.destHeight)for(;e<o.img.destWidth;)this.zoomAction(-.0125,null,!0,!0),r=!1,a.push(o.img.destWidth);for(var s=a[0],n=Math.abs(o.img.destWidth-s),l=0,h=a;l<h.length;l++){var p=h[l],d=Math.abs(e-p);d<n&&(s=p,n=d)}s<e&&r&&(this.zoomAction(-.0125,null,!0,!0),r=!1),s>e&&!r&&(this.zoomAction(.0125,null,!0,!0),r=!1),this.zoomAction(.0125,null,!0),o.allowDownScale=!0,this.zoomAction(-.0125,null,!0);var c=sf.base.extend({},o.cropObj,{},!0),u=sf.base.extend({},this.prevResizeCurrObj,{},!0);o.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:u,previousObjColl:u.objColl,previousPointColl:u.pointColl,previousSelPointColl:u.selPointColl,previousCropObj:c,previousText:null,currentText:null,previousFilter:null,isCircleCrop:o.isCircleCrop}}),o.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})},e.prototype.resizeCrop=function(e,t){var o=this.parent,r=!0,i={prevObj:o.prevObj};o.cropObj=sf.base.extend({},o.prevCropObj,{},!0),o.allowDownScale=!1;var a=sf.base.extend({},i.prevObj.activeObj,{},!0);i.prevObj.activeObj=sf.base.extend({},o.activeObj,{},!0),o.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:i.prevObj}}),o.objColl=sf.base.extend([],i.prevObj.objColl,[],!0),o.pointColl=sf.base.extend([],i.prevObj.pointColl,[],!0),o.transform.straighten=0,o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),0!==o.transform.straighten||this.isPreventSelect||o.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1});var s=e,n=t,l=!1;if(t>=e&&t<=Math.ceil(o.img.destHeight)){for(;t<=Math.ceil(o.img.destHeight)&&r;)if(this.zoomAction(-.1,null,!0,!0),e>o.img.destWidth||t>o.img.destHeight)for(;e>o.img.destWidth||t>o.img.destHeight;)this.zoomAction(.0125,null,!0,!0),r=!1}else if(t<=e&&e<o.img.destWidth){for(;e<o.img.destWidth&&r;)if(this.zoomAction(-.1,null,!0,!0),e>o.img.destWidth||t>o.img.destHeight)for(;e>o.img.destWidth||t>o.img.destHeight;)this.zoomAction(.0125,null,!0,!0),r=!1}else if(t>=e&&t>=o.img.destHeight)for(;t>=o.img.destHeight&&r;)this.zoomAction(.1,null,!0,!0);else if(e>=t&&e>=o.img.destWidth){for(;e>=o.img.destWidth&&r;)this.zoomAction(.1,null,!0,!0);if(e<o.img.destWidth&&t<o.img.destHeight){for(;e<o.img.destWidth&&t<o.img.destHeight;)this.zoomAction(-.0125,null,!0,!0),r=!1;this.zoomAction(.0125,null,!0,!0)}}else if(t>o.img.destHeight&&e>o.img.destWidth){for(;t>o.img.destHeight&&e>o.img.destWidth&&r;)this.zoomAction(.1,null,!0,!0);if(e<o.img.destWidth&&t<o.img.destHeight){for(;e<o.img.destWidth&&t<o.img.destHeight;)this.zoomAction(-.0125,null,!0,!0),r=!1;this.zoomAction(.0125,null,!0,!0)}}if(this.resizeImg(a,e,t),e=s,(t=n)!==o.img.destHeight||e!==o.img.destWidth){for(;t>o.img.destHeight||e>o.img.destWidth;)this.zoomAction(.0125,null,!0,!0),l=!0;l&&(this.zoomAction(-.0125,null,!0,!0),l=!1)}if(t!==o.img.destHeight||e!==o.img.destWidth){for(;t<o.img.destHeight||e<o.img.destWidth;)this.zoomAction(-.0125,null,!0,!0),l=!0;l&&(this.zoomAction(-.0125,null,!0,!0),l=!1)}i.prevObj.activeObj=sf.base.extend({},a,{},!0),this.zoomAction(.0125,null,!0),o.allowDownScale=!this.preventDownScale,o.isCropTab=!1,this.zoomAction(-.0125,null,!0),o.aspectWidth=e,o.aspectHeight=t},e.prototype.resizeImg=function(e,t,o){var r=this.parent,i=t/r.img.destWidth,a=o/r.img.destHeight;e.shape?(r.currSelectionPoint=e,r.cropModule.cropping({prop:"setInitCrop",onPropertyChange:!1,value:{bool:!0}})):r.img.srcWidth===r.baseImgCanvas.width&&r.img.srcHeight===r.baseImgCanvas.height&&(r.currSelectionPoint=null,r.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}})),sf.base.isNullOrUndefined(r.currSelectionPoint)?r.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:r.img.destLeft,startY:r.img.destTop,width:r.img.destWidth,height:r.img.destHeight}}):r.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),t=r.activeObj.activePoint.width*i,o=r.activeObj.activePoint.height*a;for(var s=r.activeObj.activePoint.startX+r.activeObj.activePoint.width/2-t/2,n=r.activeObj.activePoint.startY+r.activeObj.activePoint.height/2-o/2,l=0;sf.base.Browser.isDevice&&l<500&&(s<0||n<0||s+t>r.img.destWidth||n+o>r.img.destHeight);)l++,t-=1,o-=1,s=r.activeObj.activePoint.startX+r.activeObj.activePoint.width/2-t/2,n=r.activeObj.activePoint.startY+r.activeObj.activePoint.height/2-o/2;if(r.transform.defaultZoomFactor=0,r.drawModule.draw({prop:"setResizeSelect",value:{bool:!0}}),r.drawModule.draw({prop:"setIsCropSelect",value:{bool:!0}}),r.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:s,startY:n,width:t,height:o}}),r.drawModule.draw({prop:"setResizeSelect",value:{bool:!1}}),0!==r.transform.straighten){var h={isIntersect:null,arr:null};for(r.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),r.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:h}});h.arr[0]||h.arr[1]||h.arr[2]||h.arr[3];)this.zoomAction(.0125,null,!0),r.drawModule.draw({prop:"updateImgCanvasPoints",onPropertyChange:!1}),r.drawModule.draw({prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:h}})}r.isCropToolbar=!0,r.crop(),r.isCropToolbar=!1},e.prototype.updateResize=function(){var e=this.parent;e.prevCropObj=sf.base.extend({},e.cropObj,{},!0);var t={currObj:{}};e.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),e.prevObj=t.currObj,e.currSelectionPoint&&e.prevCropObj.activeObj.shape&&(e.prevObj.activeObj=sf.base.extend({},e.prevCropObj.activeObj,{},!0)),e.prevObj.objColl=sf.base.extend([],e.objColl,[],!0),e.prevObj.pointColl=sf.base.extend([],e.pointColl,[],!0),e.prevObj.afterCropActions=sf.base.extend([],e.afterCropActions,[],!0);var o={selPointColl:null};e.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:o}}),e.prevObj.selPointColl=sf.base.extend([],o.selPointColl,[],!0),e.resizeSrc={startX:e.img.srcLeft,startY:e.img.srcTop,width:e.img.srcWidth,height:e.img.srcHeight}},e.prototype.resize=function(e,t,o){var r=this,i=this.parent;i.isResize=!0,sf.base.isNullOrUndefined(i.prevCropObj)&&sf.base.isNullOrUndefined(i.prevObj)&&i.transformModule.transform({prop:"updateResize",value:{bool:!1}});var a,s=i.element.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox");a=s?""===s.value?s.placeholder:s.value:this.parent.aspectHeight?this.parent.aspectHeight.toString():"";var n={cancel:!1,previousWidth:Math.ceil(i.img.destWidth),previousHeight:Math.ceil(i.img.destHeight),width:Math.ceil(e),height:t&&0!==t?Math.ceil(t):o?Math.ceil(parseFloat(a)):Math.ceil(i.img.destHeight),isAspectRatio:o||!1};i.events&&!0===i.events.imageResizing.hasDelegate&&!i.isResizeOkBtn?i.dotNetRef.invokeMethodAsync("OnImageResizingAsync","ImageResizing",n,null).then((function(e){r.resizeEventCancel=e.cancel,e.cancel?i.aspectHeight&&i.aspectWidth&&(i.aspectHeight=n.previousHeight,i.aspectWidth=n.previousWidth):r.resizeEventHandler(e)})):this.resizeEventCancel||this.resizeEventHandler(n)},e.prototype.resizeEventHandler=function(e){var t,o=this.parent,r=o.element.querySelector("#"+o.element.id+"_resizeWidth"),i=o.element.querySelector("#"+o.element.id+"_resizeHeight"),a=o.element.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox"),s=o.element.querySelector(".e-ie-toolbar-e-resize-width-input .e-textbox");if(e.isAspectRatio)if(null!=this.resizedImgAngle&&this.resizedImgAngle===o.transform.degree||(this.resizedImgAngle=o.transform.degree,t=!0),t){o.transformModule.transform({prop:"resizeImage",value:{width:e.width,height:0}});var n,l=o.img.destWidth,h=o.img.destHeight;if(n=parseFloat(""===s.value?s.placeholder:s.value),i){var p=(c=n/(l/h))%1>=.5||c%1<=-.5?Math.round(c):c<0?Math.ceil(c):Math.floor(c);if(sf.base.getComponent(i,"numerictextbox").value=p,i.value=p.toString()+" px",o.aspectHeight=p,r&&""===r.value){var d=(c=parseFloat(""===i.value?i.placeholder:i.value)/(h/l))%1>=.5||c%1<=-.5?Math.round(c):c<0?Math.ceil(c):Math.floor(c);sf.base.getComponent(r,"numerictextbox").value=d,r.value=d.toString()+" px",o.aspectWidth=d}}else if(a){var c;p=(c=n/(l/h))%1>=.5||c%1<=-.5?Math.round(c):c<0?Math.ceil(c):Math.floor(c);if(a.value=p.toString(),o.aspectHeight=p,s&&""===s.value){d=(c=parseFloat(""===a.value?a.placeholder:a.value)/(h/l))%1>=.5||c%1<=-.5?Math.round(c):c<0?Math.ceil(c):Math.floor(c);s.value=d.toString(),o.aspectWidth=d}}}else o.transformModule.transform({prop:"resizeImage",value:{width:e.width,height:null}});else null!==this.resizedImgAngle&&this.resizedImgAngle!==o.transform.degree&&(this.resizedImgAngle=o.transform.degree,t=!0),t?(this.preventDownScale=!0,o.transformModule.transform({prop:"resizeCrop",value:{width:e.width,height:e.height}}),o.undoRedoModule.undoRedo({prop:"setPreventUR",value:{bool:!0}}),o.okBtn(null,!0),o.undoRedoModule.undoRedo({prop:"setPreventUR",value:{bool:!1}}),o.resizeSrc={startX:o.img.srcLeft,startY:o.img.srcTop,width:o.img.srcWidth,height:o.img.srcHeight},o.updateToolbar(o.element,"resize")):o.transformModule.transform({prop:"resizeCrop",value:{width:e.width,height:e.height}});if(this.resizedImgAngle=o.transform.degree,e={previousHeight:e.previousHeight,previousWidth:e.previousWidth,width:e.width,height:e.height,isAspectRatio:e.isAspectRatio},o.isResizeOkBtn&&o.events&&!0===o.events.imageResized.hasDelegate){var u={width:e.width,height:e.height,isAspectRatio:e.isAspectRatio};o.dotNetRef.invokeMethodAsync("OnImageResizingAsync","ImageResized",null,u)}},e.prototype.straightenImage=function(e){var t=this.parent;t.toolbar&&0===t.toolbar.length&&t.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),t.performCropClick(),t.setStraighten(e,!0),t.okBtn()},e}(),w=function(){function e(e){this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,this.isPreventing=!1,this.parent=e}return e.prototype.initializeUrPvtProp=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},e.prototype.undoRedo=function(e){switch(this.initializeUrPvtProp(),e.prop){case"updateUndoRedoColl":this.updateUrc(e.value.operation,e.value.previousObj,e.value.previousObjColl,e.value.previousPointColl,e.value.previousSelPointColl,e.value.previousCropObj,e.value.previousText,e.value.currentText,e.value.previousFilter,e.value.isCircleCrop);break;case"refreshUrc":this.refreshUrc(e.value.bool);break;case"updateCurrUrc":this.updateCurrUrc(e.value.type,e.value.isCancel);break;case"call-undo":this.callUndo();break;case"call-redo":this.callRedo();break;case"undo":this.undo();break;case"redo":this.redo();break;case"updateUrObj":this.updateUrObj(e.value.objColl,e.value.operation);break;case"updateUndoRedo":this.updateUndoRedo(e.value?e.value.operation:null);break;case"getAppliedUndoRedoColl":e.value.obj.appliedUndoRedoColl=this.appliedUndoRedoColl;break;case"getUndoRedoStep":e.value.obj.undoRedoStep=this.undoRedoStep;break;case"setUndoRedoStep":this.undoRedoStep=e.value.step;break;case"undoDefault":this.undoDefault(e.value.obj);break;case"setPreventUR":this.isPreventing=e.value.bool;break;case"updateUndoRedoStack":e.value&&e.value.isPenDraw?this.updateUndoRedoStack(e.value.isPenDraw):this.updateUndoRedoStack();break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"undo-redo"},e.prototype.reset=function(){this.tempCurrSelPoint=null,this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempActObj=null,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,this.isPreventing=!1},e.prototype.refreshUrc=function(e){var t=this.parent;(e=e||!1)&&(this.tempUndoRedoColl=sf.base.extend([],this.appliedUndoRedoColl,[],!0),this.tempUndoRedoStep=this.undoRedoStep),this.undoRedoColl=this.undoRedoColl.slice(0,this.undoRedoStep),this.appliedUndoRedoColl=this.appliedUndoRedoColl.slice(0,this.undoRedoStep),t.isUndoRedo=t.currObjType.isUndoAction=!1,t.updateToolbar(t.element,"enableDisableToolbarBtn")},e.prototype.updateCurrUrc=function(e,t){var o=this.parent;if(!(o.isResize||this.isPreventing||o.noPushUndo)){if("ok"===e){o.drawModule.draw({prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!1}});var r=this.tempUndoRedoColl.length>0?sf.base.extend([],this.tempUndoRedoColl,[],!0):sf.base.extend([],this.undoRedoColl,[],!0),i=this.undoRedoColl[this.undoRedoColl.length-1],a=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],s=i?sf.base.extend({},i.previousObj,{},!0):null;if(sf.base.isNullOrUndefined(a)?this.undoRedoColl[0]&&(i.previousCropObj=r[0].previousCropObj,i.previousObj=r[0].previousObj,i.previousObjColl=r[0].previousObjColl,i.previousPointColl=r[0].previousPointColl,i.previousText=r[0].previousText):"imageHFlip"!==i.operation&&"imageVFlip"!==i.operation&&(i.previousCropObj=a.currentCropObj,i.previousObj=a.currentObj,i.previousObjColl=a.currentObjColl,i.previousPointColl=a.currentPointColl,i.previousText=a.currentText,"frame"===i.operation&&i.previousObj&&s&&(i.previousObj.defaultZoom=s.defaultZoom,i.previousObj.zoomFactor=s.zoomFactor,i.previousObj.cropZoom=s.cropZoom)),i){if("imageHFlip"!==i.operation&&"imageVFlip"!==i.operation){var n=this.getZeroZoomObjPointValue(i.currentObjColl,i.currentPointColl);i.currentObjColl=n.obj,i.currentPointColl=n.point;var l={adjustmentLevel:null};o.filterModule.filter({prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:l}}),i.currentObj.adjustmentLevel=sf.base.extend({},l.adjustmentLevel,{},!0),o.filterModule.filter({prop:"setTempAdjVal"}),i.currentObj.currentFilter=o.currentFilter}this.appliedUndoRedoColl.push(i)}this.tempUndoRedoColl=[],this.tempUndoRedoStep=0}else this.tempUndoRedoColl.length>0&&(this.appliedUndoRedoColl=sf.base.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0);var h=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],p=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-2];this.appliedUndoRedoColl.length>16?this.appliedUndoRedoColl.splice(0,1):!t&&h&&p&&(("shapeTransform"===h.operation&&"shapeTransform"===p.operation||"shapeInsert"===h.operation&&"shapeInsert"===p.operation)&&JSON.stringify(h.currentObjColl)===JSON.stringify(p.currentObjColl)||"freehand-draw"===h.operation&&"freehand-draw"===p.operation&&JSON.stringify(h.currentPointColl)===JSON.stringify(p.currentPointColl)||"freehanddrawCustomized"===h.operation&&"freehanddrawCustomized"===p.operation&&JSON.stringify(h.currentPointColl)===JSON.stringify(p.currentPointColl))&&this.appliedUndoRedoColl.splice(this.appliedUndoRedoColl.length-1,1),this.undoRedoColl=[],this.undoRedoColl=sf.base.extend([],this.appliedUndoRedoColl,[],!0),"ok"===e&&(this.undoRedoStep=this.undoRedoColl.length,o.updateToolbar(o.element,"enableDisableToolbarBtn")),o.transform.zoomFactor>0&&(o.togglePan=!0,o.selectionModule.selection({prop:"setDragCanvas",value:{bool:!0}}))}},e.prototype.cancelCropSelection=function(){var e,t=this.parent,o=!1;t.activeObj.shape&&(e=t.activeObj.shape.split("-")),(t.currObjType.isCustomCrop||e&&"crop"===e[0])&&(o=!0),o&&t.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null}}),0===this.tempUndoRedoColl.length&&0===this.tempUndoRedoStep||(this.appliedUndoRedoColl=sf.base.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoColl=sf.base.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0)},e.prototype.refreshToolbarActions=function(){var e=this.parent;sf.base.isNullOrUndefined(e.activeObj.shape)&&e.updateToolbar(e.element,"imageLoaded")},e.prototype.applyCurrentChanges=function(){var e=this.parent;e.currObjType.isFiltered=!1,0===e.transform.zoomFactor&&(e.togglePan=!1,e.selectionModule.selection({prop:"setDragCanvas",value:{bool:!1}})),e.togglePen&&(e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default",this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height)),this.appliedUndoRedoColl.length>0&&(this.undoRedoColl=sf.base.extend([],this.appliedUndoRedoColl,[],!0))},e.prototype.callUndo=function(){this.applyCurrentChanges(),this.undo()},e.prototype.callRedo=function(){this.applyCurrentChanges(),this.redo()},e.prototype.undo=function(){var e=this.parent;if(this.cancelCropSelection(),e.drawModule.draw({prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!1}}),!e.disabled&&e.isImageLoaded&&this.undoRedoStep>0){this.refreshToolbarActions(),e.activeObj.activePoint&&0!==e.activeObj.activePoint.width&&(this.tempActObj=e.activeObj),e.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.undoRedoStep--,e.updateToolbar(e.element,"enableDisableToolbarBtn"),e.isUndoRedo=!0;var t=this.undoRedoColl[this.undoRedoStep];this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,"textAreaCustomization"===t.operation||"block"!==e.textArea.style.display&&"inline-block"!==e.textArea.style.display||(e.textArea.style.display="none"),e.drawModule.draw({prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}});switch(e.cropObj=sf.base.extend({},t.previousCropObj,{},!0),e.afterCropActions=t.previousObj.afterCropActions,this.lowerContext.filter=t.previousObj.filter,e.filterModule.filter({prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:t.previousObj.adjustmentLevel}}),e.filterModule.filter({prop:"setTempAdjVal"}),e.currentFilter=t.previousObj.currentFilter,e.filterModule.filter({prop:"setTempFilVal"}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.filterModule.filter({prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}}),t.operation){case"shapeTransform":case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":case"imageRotate":case"shapeInsert":this.shapeTransform(t.previousObjColl,t.previousPointColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(t.previousPointColl,t.previousSelPointColl),e.freeHandDrawModule.draw({prop:"setCurrentFreehandDrawIndex",value:{value:e.pointColl.length}});break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(t.previousObjColl,t.previousPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(t.operation,t.previousObjColl,t.previousPointColl,t.previousSelPointColl);break;case"textAreaCustomization":this.shapeTransform(t.previousObjColl,t.previousPointColl),this.updateTextAreaCustomization(void 0,t.previousObjColl);break;case"text":this.updateText(t.previousObjColl,!0);break;case"frame":e.transform.zoomFactor=e.transform.defaultZoomFactor=t.previousObj.defaultZoom,e.zoomSettings.zoomFactor=t.previousObj.zoomFactor,e.transformModule.transform({prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.zoomSettings.zoomFactor}}),sf.base.extend(e.frameObj,t.previousObj.frameObj),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:!0}});break;case"imageHFlip":this.imageFlip("horizontal",t.previousObjColl);break;case"imageVFlip":this.imageFlip("vertical",t.previousObjColl);break;default:this.undoDefault(t,!0),e.filterModule.filter({prop:"set-adjustment",value:{operation:t.operation}}),e.filterModule.filter({prop:"update-filter",value:{operation:t.operation,filter:t.filter}})}"crop"===t.operation?(t.previousObj.currSelectionPoint&&(e.currSelectionPoint=sf.base.extend({},t.previousObj.currSelectionPoint,{},!0),e.currSelectionPoint&&sf.base.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null)),e.updateCropTransformItems(),e.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),e.isCircleCrop&&(e.isCircleCrop=!1,this.tempCurrSelPoint=sf.base.extend({},e.currSelectionPoint,{},!0),e.currSelectionPoint=null),e.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null,isUndoRedo:!0}}),e.currObjType.isActiveObj=!1,0!==e.transform.straighten&&e.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}})):"resize"===t.operation&&e.cropObj&&e.cropObj.activeObj&&(e.currSelectionPoint=sf.base.extend({},e.cropObj.activeObj,{},!0)),this.undoRedoColl[this.undoRedoStep-1]&&this.undoRedoColl[this.undoRedoStep-1].isCircleCrop&&(e.isCircleCrop=!0,e.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})),this.endUndoRedo(t.operation,!0)}},e.prototype.redo=function(){var e=this.parent;if(this.cancelCropSelection(),e.drawModule.draw({prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!1}}),!e.disabled&&e.isImageLoaded&&this.undoRedoStep<this.appliedUndoRedoColl.length){this.refreshToolbarActions(),this.undoRedoStep++,e.updateToolbar(e.element,"enableDisableToolbarBtn"),e.isUndoRedo=!0;var t=this.undoRedoColl[this.undoRedoStep-1];this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,"textAreaCustomization"===t.operation||"block"!==e.textArea.style.display&&"inline-block"!==e.textArea.style.display||(e.textArea.style.display="none"),e.drawModule.draw({prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}}),e.cropObj=sf.base.extend({},t.currentCropObj,{},!0),e.afterCropActions=t.currentObj.afterCropActions,this.lowerContext.filter=t.currentObj.filter,e.filterModule.filter({prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:t.currentObj.adjustmentLevel}}),e.filterModule.filter({prop:"setTempAdjVal"}),e.currentFilter=t.currentObj.currentFilter,e.filterModule.filter({prop:"setTempFilVal"}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.filterModule.filter({prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}});var o=void 0;switch(t.operation){case"shapeTransform":case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":case"imageRotate":case"shapeInsert":this.shapeTransform(t.currentObjColl,t.currentPointColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(t.currentPointColl,t.currentSelPointColl),e.freeHandDrawModule.draw({prop:"setCurrentFreehandDrawIndex",value:{value:e.pointColl.length}});break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(t.currentObjColl,t.currentPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(t.operation,t.currentObjColl,t.currentPointColl,t.currentSelPointColl);break;case"textAreaCustomization":this.shapeTransform(t.currentObjColl,t.currentPointColl),this.updateTextAreaCustomization(o,t.currentObjColl);break;case"text":this.updateText(t.currentObjColl,!1);break;case"frame":sf.base.extend(e.frameObj,t.currentObj.frameObj),e.drawModule.draw({prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:!0}});break;case"imageHFlip":this.imageFlip("horizontal",t.currentObjColl);break;case"imageVFlip":this.imageFlip("vertical",t.currentObjColl);break;default:e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),e.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:t.currentObj,isUndoRedo:!0}}),e.img.destLeft=t.currentObj.destPoints.startX,e.img.destTop=t.currentObj.destPoints.startY,o=sf.base.extend({},e.activeObj,{},!0),e.objColl=sf.base.extend([],t.currentObjColl,[],!0),e.pointColl=sf.base.extend([],t.currentPointColl,[],!0),e.freehandCounter=e.pointColl.length,e.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:sf.base.extend([],t.currentSelPointColl,[],!0)}}}),e.transform.straighten=0,this.lowerContext.filter="none",e.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=t.currentObj.filter,e.prevStraightenedDegree=e.transform.straighten,e.activeObj=o,this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),0!==e.activeObj.activePoint.width&&0!==e.activeObj.activePoint.height&&e.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),e.filterModule.filter({prop:"set-adjustment",value:{operation:t.operation}}),e.filterModule.filter({prop:"update-filter",value:{operation:t.operation}})}"crop"===t.operation&&t.isCircleCrop&&(e.isCircleCrop=!0,e.currSelectionPoint=sf.base.extend({},this.tempCurrSelPoint,{},!0),this.tempCurrSelPoint=null),"crop"!==t.operation||t.isCircleCrop||(e.isCircleCrop=!1),"crop"===t.operation&&t.currentObj.currSelectionPoint&&(e.currSelectionPoint=sf.base.extend({},t.currentObj.currSelectionPoint,{},!0),e.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:e.currSelectionPoint}})),e.currSelectionPoint&&sf.base.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),"resize"===t.operation&&e.cropObj&&e.cropObj.activeObj&&(e.currSelectionPoint=sf.base.extend({},e.cropObj.activeObj,{},!0)),this.endUndoRedo(t.operation,!1)}},e.prototype.imageFlip=function(e,t){var o=this.parent;this.shapeTransform(t,null),o.activeObj=sf.base.extend({},o.objColl[o.objColl.length-1],{},!0);var r=o.activeObj,i=r.shape,a=r.isHorImageFlip,s=r.isVerImageFlip;o.objColl.pop(),i&&"image"===i?("horizontal"===e?sf.base.isNullOrUndefined(a)&&s?(o.activeObj.isHorImageFlip=!0,o.activeObj.isVerImageFlip=null,o.horizontalFlip(this.upperContext,!0)):(sf.base.isNullOrUndefined(a)||!a?o.activeObj.isHorImageFlip=!0:o.activeObj.isHorImageFlip=null,o.horizontalFlip(this.upperContext,!0)):"vertical"===e&&(sf.base.isNullOrUndefined(s)&&a?(o.activeObj.isVerImageFlip=!0,o.activeObj.isHorImageFlip=null,o.verticalFlip(this.upperContext,!0)):(sf.base.isNullOrUndefined(s)||!s?o.activeObj.isVerImageFlip=!0:o.activeObj.isVerImageFlip=null,o.verticalFlip(this.upperContext,!0))),o.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):o.drawModule.draw({prop:"render-image",value:{isMouseWheel:!0}})},e.prototype.shapeTransform=function(e,t){var o=this.parent;o.objColl=sf.base.extend([],e,[],!0),t&&(o.pointColl=sf.base.extend([],t,[],!0),o.freehandCounter=o.pointColl.length),o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.isUndoRedo=!0,o.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1})},e.prototype.updateFreehandDraw=function(e,t){var o=this.parent;o.pointColl=e,o.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:t}}}),o.freehandCounter=o.pointColl.length,o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.isUndoRedo=!0,o.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1})},e.prototype.updateFreehandDrawCustomized=function(e,t){var o=this.parent;o.objColl=sf.base.extend([],e,[],!0),o.pointColl=t,o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.isUndoRedo=!0,o.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1})},e.prototype.updateDelete=function(e,t,o,r){var i=this.parent;"deleteFreehandDrawing"===e?(i.pointColl=o,i.freehandCounter=i.pointColl.length,i.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:r}}}),i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})):"deleteObj"===e&&(i.objColl=t,i.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.isUndoRedo=!0,i.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1})},e.prototype.updateTextAreaCustomization=function(e,t){var o=this.parent;o.objColl=sf.base.extend([],t,[],!0),o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.isUndoRedo=!0,o.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1});for(var r=0,i=t.length;r<i;r++){if(!this.tempActObj){e=sf.base.extend({},t[t.length-1],{},!0),o.objColl.splice(r,1);break}if(this.tempActObj.currIndex===t[r].currIndex){e=sf.base.extend({},t[r],{},!0),o.objColl.splice(r,1);break}}e&&this.updateTextBox(e),"block"!==o.textArea.style.display&&"inline-block"!==o.textArea.style.display||o.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}})},e.prototype.updateText=function(e,t){var o=this.parent;if(this.tempActObj&&(o.activeObj=sf.base.extend({},this.tempActObj,{},!0)),0===e.length&&1===o.objColl.length)this.tempActObj=sf.base.extend({},o.objColl[0],{},!0);else for(var r=0,i=o.objColl.length;r<i;r++){if(o.objColl[r]&&sf.base.isNullOrUndefined(e[r])){this.tempActObj=sf.base.extend({},o.objColl[r],{},!0);break}if(e[r].currIndex!==o.objColl[r].currIndex){this.tempActObj=sf.base.extend({},o.objColl[r],{},!0);break}}t&&(o.activeObj=sf.base.extend({},this.tempActObj,{},!0)),o.objColl=sf.base.extend([],e,[],!0),o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:!0}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.isUndoRedo=!0,o.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1})},e.prototype.updateTextBox=function(e){var t=this.parent;this.upperContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),t.updateToolbar(t.element,"destroyQuickAccessToolbar");var o=t.textArea;o.style.display="block",o.style.fontFamily=e.textSettings.fontFamily,o.style.fontSize=e.textSettings.fontSize+"px",o.style.color=e.strokeSettings.strokeColor,o.style.fontWeight=e.textSettings.bold?"bold":"normal",o.style.fontStyle=e.textSettings.italic?"italic":"normal",o.style.border="2px solid "+t.themeColl[t.theme].primaryColor,o.value=e.keyHistory,t.activeObj=sf.base.extend({},e,{},!0),t.shapeModule.shape({prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}}),t.textArea.style.width=t.activeObj.activePoint.width+"px"},e.prototype.undoDefault=function(e,t){this.lowerContext.filter=e.previousObj.filter;var o=this.parent;o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),o.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:e.previousObj,isUndoRedo:t}}),o.prevStraightenedDegree=o.transform.straighten,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),o.img.destLeft=e.previousObj.destPoints.startX,o.img.destTop=e.previousObj.destPoints.startY;var r=sf.base.extend({},o.activeObj,{},!0);o.objColl=sf.base.extend([],e.previousObjColl,[],!0),o.pointColl=sf.base.extend([],e.previousPointColl,[],!0),o.freehandCounter=o.pointColl.length,o.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:sf.base.extend([],e.previousSelPointColl,[],!0)}}}),o.transform.straighten=0,this.lowerContext.filter="none",o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=e.previousObj.filter,o.activeObj=r,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),0!==o.activeObj.activePoint.width&&0!==o.activeObj.activePoint.height&&o.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})},e.prototype.endUndoRedo=function(e,t){var o=this.parent;if((o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape||o.isCircleCrop)&&JSON.stringify(o.frameObj)!==JSON.stringify({type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""})&&o.drawModule.draw({prop:"render-image",value:{isMouseWheel:!0}}),o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.isCircleCrop&&(t&&"crop"!==e||!t)&&o.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o.transform.zoomFactor>0&&o.selectionModule.selection({prop:"setDragCanvas",value:{bool:!0}}),o.drawModule.draw({prop:"setCancelAction",onPropertyChange:!1,value:{bool:!1}}),(sf.base.isNullOrUndefined(o.activeObj.shape)||"crop"!==o.activeObj.shape.split("-")[0])&&(o.updateToolbar(o.element,"imageLoaded"),o.updateToolbar(o.element,"enableDisableToolbarBtn")),document.getElementById(o.element.id+"_quickAccessToolbarArea")&&(document.getElementById(o.element.id+"_quickAccessToolbarArea").style.display="none"),o.updateToolbar(o.element,"enableDisableToolbarBtn"),0!==o.transform.degree&&o.transformModule.transform({prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}}),o.filterModule.filter({prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),o.currObjType.isCustomCrop=!1,o.events&&!0===o.events.historyChanged.hasDelegate){var r=this.getImageAction(e),i={length:this.undoRedoColl.length,index:this.undoRedoStep,actionTrigger:t?"Undo":"Redo",imageAction:r};o.dotNetRef.invokeMethodAsync("OnHistoryChangedAsync",i)}},e.prototype.getImageAction=function(e){return-1!==["brightness","contrast","saturation","opacity","blur","hue"].indexOf(e)?"FinetuneApplied":-1!==["chrome","cold","warm","grayscale","blackandwhite","sepia","invert"].indexOf(e)?"FilterApplied":"frame"===e?"FrameApplied":"resize"===e?"ImageResized":-1!==["deleteFreehandDrawing","deleteObj"].indexOf(e)?"ShapeDeleted":"crop"===e?"Cropped":-1!==["shapeInsert","freehanddraw","freehand-draw"].indexOf(e)?"ShapeInserted":"ShapeCustomized"},e.prototype.updateUrc=function(e,t,o,r,i,a,s,n,l,h){var p=this.parent;if(!p.isResize&&!this.isPreventing){var d={isInitialLoaded:!1};if(p.currObjType.isUndoAction&&this.refreshUrc(!0),p.drawModule.draw({prop:"isInitialLoaded",onPropertyChange:!1,value:{object:d}}),!d.isInitialLoaded&&p.allowUndoRedo){var c={currObj:{}};p.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:c}});var u=c.currObj;u.objColl=sf.base.extend([],p.objColl,[],!0),u.pointColl=sf.base.extend([],p.pointColl,[],!0),u.afterCropActions=sf.base.extend([],p.afterCropActions,[],!0);var v={selPointColl:null};if(p.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:v}}),u.selPointColl=sf.base.extend([],v.selPointColl,[],!0),"crop"===e)u.currSelectionPoint=sf.base.extend({},p.currSelectionPoint,{},!0);else if("frame"===e)t.destPoints={startX:p.frameDestPoints.destLeft,startY:p.frameDestPoints.destTop,width:p.frameDestPoints.destWidth,height:p.frameDestPoints.destHeight},u.destPoints={startX:p.frameDestPoints.destLeft,startY:p.frameDestPoints.destTop,width:p.frameDestPoints.destWidth,height:p.frameDestPoints.destHeight},sf.base.isNullOrUndefined(p.tempFrameZoomLevel)||(t.defaultZoom=u.defaultZoom=p.tempFrameZoomLevel);else if(("imageHFlip"===e||"imageVFlip"===e)&&this.appliedUndoRedoColl.length>0){var g=o[o.length-1].currIndex;if(o=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentObjColl,g)for(var b=0,C=o.length;b<C;b++)if(o[b].currIndex===g){var f=sf.base.extend({},o[b],{},!0);o.splice(b,1),o.push(f);break}}if(this.undoRedoColl.push({operation:e,previousObj:t,currentObj:u,previousObjColl:o,currentObjColl:u.objColl,previousPointColl:r,currentPointColl:u.pointColl,previousSelPointColl:i,currentSelPointColl:u.selPointColl,previousCropObj:a,currentCropObj:sf.base.extend({},p.cropObj,{},!0),previousText:s,currentText:n,filter:l,isCircleCrop:h}),"pen-toolbar"!==p.currentToolbar){var m=null;"text-toolbar"===p.currentToolbar&&"textAreaCustomization"===e&&(m="textAreaClicked"),p.updateToolbar(p.element,"enableDisableToolbarBtn",m)}}}},e.prototype.updateUrObj=function(e,t){var o=this.parent;if(o.allowUndoRedo){o.currObjType.isUndoAction&&!o.isShapeDrawing&&this.refreshUrc(!0),sf.base.isNullOrUndefined(o.activeObj.imageRatio)&&o.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),o.objColl.push(o.activeObj);var r=sf.base.extend({},o.cropObj,{},!0),i={currObj:{}};o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var a=i.currObj;a.objColl=sf.base.extend([],o.objColl,[],!0),a.pointColl=sf.base.extend([],o.pointColl,[],!0),a.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var s={selPointColl:null};o.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),a.selPointColl=sf.base.extend([],s.selPointColl,[],!0);var n=t||"shapeTransform";this.undoRedoColl.push({operation:n,previousObj:a,currentObj:a,previousObjColl:e,currentObjColl:a.objColl,previousPointColl:a.pointColl,currentPointColl:a.pointColl,previousSelPointColl:a.selPointColl,currentSelPointColl:a.selPointColl,previousCropObj:r,currentCropObj:r}),o.selectionModule.selection({prop:"redrawShape",onPropertyChange:!1,value:{obj:o.objColl[o.objColl.length-1]}})}},e.prototype.updateUndoRedo=function(e){var t=this.parent,o=sf.base.extend({},t.cropObj,{},!0),r={currObj:{}};t.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}});var i=r.currObj;i.objColl=sf.base.extend([],t.objColl,[],!0),i.pointColl=sf.base.extend([],t.pointColl,[],!0),i.afterCropActions=sf.base.extend([],t.afterCropActions,[],!0);var a={selPointColl:null};t.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0),sf.base.isNullOrUndefined(t.activeObj.imageRatio)&&t.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj);var s=e||"shapeTransform";this.updateUrc(s,i,i.objColl,i.pointColl,i.selPointColl,o),t.objColl.pop(),t.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),t.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),t.updateToolbar(t.element,"imageLoaded")},e.prototype.getZeroZoomObjPointValue=function(e,t){var o=this.parent;this.updateObjColl();var r={currObj:{}};o.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}});var i=r.currObj;i.objColl=sf.base.extend([],o.objColl,[],!0),i.pointColl=sf.base.extend([],o.pointColl,[],!0),i.afterCropActions=sf.base.extend([],o.afterCropActions,[],!0);var a={selPointColl:null};o.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),i.selPointColl=sf.base.extend([],a.selPointColl,[],!0);var s={cropDimension:null};o.transformModule.transform({prop:"getCropDimension",onPropertyChange:!1,value:{obj:s}});var n=sf.base.extend([],o.objColl,[],!0),l=sf.base.extend([],o.pointColl,[],!0),h={arrowDimension:null};this.parent.drawModule.draw({prop:"getArrowDimension",onPropertyChange:!1,value:{obj:h}});var p=sf.base.extend({},h.arrowDimension,{},!0);if(o.transform.zoomFactor>0&&(e.length>0||t.length>0)){if(e.length>0)for(var d=0;d<e.length;d++)e[d].currIndex||(e[d].currIndex="shape_"+(d+1));o.objColl=e,o.pointColl=t;var c=o.isUndoRedo,u=o.isCropTab;if(0!==o.transform.zoomFactor){o.isUndoRedo=!0,o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:!0}}),o.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1}),o.isCropTab=!0;var v=sf.base.extend({},o.zoomSettings,null,!0);o.transform.zoomFactor>0?o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-o.transform.zoomFactor,zoomPoint:null,isResize:null}}):o.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(o.transform.zoomFactor),zoomPoint:null,isResize:null}}),o.zoomSettings=v,o.isCropTab=u,o.isUndoRedo=c,n=sf.base.extend([],o.objColl,[],!0),l=sf.base.extend([],o.pointColl,[],!0),o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),o.transformModule.transform({prop:"setCropDimension",onPropertyChange:!1,value:{width:s.cropDimension.width,height:s.cropDimension.height}});var g={width:s.cropDimension.width,height:s.cropDimension.height};g.width+=g.width*i.defaultZoom,g.height+=g.height*i.defaultZoom,o.drawModule.draw({prop:"setZoomCropWidth",value:{width:g.width,height:g.height}}),o.drawModule.draw({prop:"setCurrentObj",onPropertyChange:!1,value:{obj:i}}),o.img.destLeft=i.destPoints.startX,o.img.destTop=i.destPoints.startY,o.panPoint.totalPannedPoint=i.totalPannedPoint,o.panPoint.totalPannedClientPoint=i.totalPannedClientPoint,o.panPoint.totalPannedInternalPoint=i.totalPannedInternalPoint,o.objColl=sf.base.extend([],i.objColl,[],!0),o.pointColl=sf.base.extend([],i.pointColl,[],!0),o.freehandCounter=o.pointColl.length,o.drawModule.draw({prop:"setArrowDimension",onPropertyChange:!1,value:{arrowDimension:p}}),o.freeHandDrawModule.draw({prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:sf.base.extend([],i.selPointColl,[],!0)}}}),this.lowerContext.filter="none",o.transform.straighten=0,this.applyImgTranform(),o.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),o.freeHandDrawModule.draw({prop:"updateFHDCurPts",onPropertyChange:!1}),this.lowerContext.filter=i.filter,0!==o.transform.degree&&o.transformModule.transform({prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}}),o.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(o.isCircleCrop||o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape)&&o.cropModule.cropping({prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})}}return{obj:n,point:l}},e.prototype.updateObjColl=function(){for(var e=this.parent,t=0;t<e.objColl.length;t++){var o=e.objColl[t];"line"!==o.shape&&"arrow"!==o.shape||(o.activePoint.width<0&&(o.activePoint.width=Math.abs(o.activePoint.width)),o.activePoint.height<0&&(o.activePoint.height=Math.abs(o.activePoint.height)))}},e.prototype.applyImgTranform=function(){for(var e=this.parent,t=sf.base.extend({},e.activeObj,{},!0),o=0,r=e.objColl.length;o<r;o++)if("image"===e.objColl[o].shape){e.activeObj=sf.base.extend({},e.objColl[o],{},!0);var i=e.objColl[o].imageCanvas.getContext("2d");e.selectionModule.selection({prop:"applyTransformToImg",onPropertyChange:!1,value:{ctx:i}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.selectionModule.selection({prop:"setImageClarity",onPropertyChange:!1,value:{bool:!0}})}e.activeObj=t},e.prototype.updateUndoRedoStack=function(e){var t=this.parent;if(t.activeObj.currIndex&&0!==t.activeObj.activePoint.width||0!==t.activeObj.activePoint.height||t.activeObj.pointColl&&t.activeObj.pointColl.length>0||e){var o="none"!==t.textArea.style.display,r=t.noPushUndo;if(t.noPushUndo=!1,t.isUndoRedoStack=!0,e){var i=t.togglePen,a={freehandDrawSelectedId:null};t.freeHandDrawModule.draw({prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:a}}),t.okBtn(),t.noPushUndo=r,a.freehandDrawSelectedId?t.selectShape(a.freehandDrawSelectedId):t.freeHandDraw(!0),t.togglePen=i}else if(t.activeObj.currIndex){var s=t.activeObj.currIndex;t.okBtn(),t.noPushUndo=r,t.selectShape(s),t.drawingShape&&t.selectionModule.selection({prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:t.drawingShape.toLowerCase()}}),o&&t.enableTextEditing()}t.isUndoRedoStack=!1}},e}(),P=(c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),j=function(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"===("undefined"==typeof Reflect?"undefined":o(Reflect))&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var l=e.length-1;l>=0;l--)(a=e[l])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n},x=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}P(t,e)}(sf.base.ChildProperty),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.minZoomFactor=1,t.maxZoomFactor=10,t.zoomFactor=1,t}P(t,e)}(sf.base.ChildProperty),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.showCircle=!0,t}P(t,e)}(sf.base.ChildProperty),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.default="Arial",t}P(t,e)}(sf.base.ChildProperty),function(){function e(e,t,o,r,i){this.isImageLoaded=!1,this.activeObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],rotatedAngle:0,opacity:1,order:null},this.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1},this.objColl=[],this.pointColl={},this.freehandCounter=0,this.points=[],this.togglePen=!1,this.togglePan=!1,this.img={destLeft:0,destTop:0,destWidth:0,destHeight:0,srcLeft:0,srcTop:0,srcWidth:0,srcHeight:0},this.rotateFlipColl=[],this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,zoomFactor:0,previousZoomValue:0,aspectWidth:null,aspectHeight:null,frame:"none",straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""},this.afterCropActions=[],this.transform={degree:0,currFlipState:"",zoomFactor:0,cropZoomFactor:null,defaultZoomFactor:0,straighten:0},this.panPoint={currentPannedPoint:{x:0,y:0},totalPannedPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0}},this.isUndoRedo=!1,this.isCropTab=!1,this.isCircleCrop=!1,this.fontSizeColl=[],this.initialAdjustmentValue="",this.currentFilter="",this.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",this.toolbarHeight=0,this.isPublicMethod=!1,this.isCropToolbar=!1,this.cursor="default",this.resizeSrc={startX:this.img.srcLeft,startY:this.img.srcTop,width:this.img.srcWidth,height:this.img.srcHeight},this.isResize=!1,this.isAspectRatio=!1,this.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.tempFrameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.allowDownScale=!0,this.gradientColor="",this.size=20,this.inset=0,this.offset=0,this.borderRadius=0,this.lineCount=0,this.prevStraightenedDegree=0,this.tempStraighten=0,this.isStraightening=!1,this.isFinetuning=!1,this.isZoomBtnClick=!1,this.isFinetuneBtnClick=!1,this.isFilterCanvasClick=!1,this.isFrameBtnClick=!1,this.isChangesSaved=!1,this.isShapeDrawing=!1,this.noPushUndo=!1,this.isUndoRedoStack=!1,this.shapeColl=[],this.isInteracted=!1,this.currentToolbar="main-toolbar",this.CTTOOLBAR=".e-ie-contextual-toolbar",this.CTWRAPPER=".e-contextual-toolbar-wrapper",this.CHECKBTN=".e-ie-toolbar-check-btn",this.CLOSEBTN=".e-ie-toolbar-close-btn",this.ANNOTATEBTN=".e-ie-toolbar-annotation",this.MAINSEP=".e-ie-toolbar-main-separator",this.MCLONEBTN=".e-ie-toolbar-main-clone-btn",this.MDELBTN=".e-ie-toolbar-main-delete-btn",this.MEDITBTN=".e-ie-toolbar-main-editText-btn",this.CLONEBTN=".e-ie-toolbar-clone-btn",this.DELBTN=".e-ie-toolbar-delete-btn",this.EDITBTN=".e-ie-toolbar-editText-btn",this.HORIZONTALFLIPBTN=".e-ie-toolbar-horizontalFlip-btn",this.VERTICALFLIPBTN=".e-ie-toolbar-verticalFlip-btn",this.FONTFAM=".e-ie-toolbar-e-font-family",this.FONTSIZE=".e-ie-toolbar-e-font-size",this.FONTCLR=".e-ie-toolbar-e-font-color",this.SHAPECLR=".e-ie-toolbar-e-shape-color",this.LINECLR=".e-ie-toolbar-e-line-color",this.PENCLR=".e-ie-toolbar-e-pen-color",this.SHAPEFILLCLR=".e-ie-toolbar-e-shape-fill-color",this.DDBPREVIEW=" .e-dropdownbtn-preview",this.BOLDBTN=".e-ie-toolbar-bold-btn",this.ITALICBTN=".e-ie-toolbar-italic-btn",this.currentResizeRatio="aspect",this.isStraigthenChanged=!1,this.height="100%",this.theme="Bootstrap5",this.width="100%",this.allowUndoRedo=!0,this.showQuickAccessToolbar=!0,this.cropModule=new u(this),this.drawModule=new v(this),this.filterModule=new b(this),this.freeHandDrawModule=new C(this),this.selectionModule=new f(this),this.shapeModule=new m(this),this.transformModule=new y(this),this.undoRedoModule=new w(this),this.exportModule=new g(this),this.element=t,this.dataId=e,this.element=t,this.element.id=o.id,window.sfBlazor.setCompInstance(this),this.dotNetRef=i,this.cssClass=o.cssClass,this.disabled=!o.disabled,this.height=o.height,this.theme=o.theme,this.width=o.width,this.allowUndoRedo=o.allowUndoRedo,this.isReadOnly=o.isReadOnly,this.enableRtl=o.enableRtl,this.zoomSettings=o.zoomSettings||{zoomTrigger:null,zoomPoint:null,minZoomFactor:1,maxZoomFactor:10,zoomFactor:1},this.selectionSettings=o.selectionSettings||{showCircle:!0,strokeColor:null,fillColor:null},this.finetuneSettings=o.finetuneSettings,this.events=r,this.showQuickAccessToolbar=o.showQuickAccessToolbar,this.quickAccessToolbarTemplate=o.quickAccessToolbarTemplate,this.theme=o.theme,this.defaultFontFamily=o.defaultFontFamily}return e.prototype.requiredModules=function(){var e=[];return e.push({member:"crop",args:[this]}),e.push({member:"draw",args:[this]}),e.push({member:"selection",args:[this]}),e.push({member:"transform",args:[this]}),e.push({member:"export",args:[this]}),e.push({member:"toolbar-module",args:[this]}),e.push({member:"undo-redo",args:[this]}),e.push({member:"filter",args:[this]}),e.push({member:"shape",args:[this]}),e.push({member:"freehand-draw",args:[this]}),e},e.prototype.preRender=function(){this.element.id=this.element.id||sf.base.getUniqueID("ej2-image-editor"),sf.base.Browser.isDevice&&this.element.classList.add("e-device"),this.initializeThemeColl()},e.prototype.getModuleName=function(){return"image-editor"},e.prototype.onPropertyChanged=function(e,t){switch(e){case"cssClass":this.cssClass&&sf.base.removeClass([this.element],this.cssClass.replace(/\s+/g," ").trim().split(" ")),t&&sf.base.addClass([this.element],t.replace(/\s+/g," ").trim().split(" "));break;case"disabled":this.disabled=!t,t?this.wireEvent():this.unwireEvent();break;case"height":this.element.style.height=t;break;case"width":this.element.style.width=t;break;case"theme":t&&(this.theme&&""!==this.theme?this.theme=this.toPascalCase(t):this.theme="Bootstrap5",this.upperContext.strokeStyle=this.themeColl[this.theme].primaryColor,this.upperContext.fillStyle=this.themeColl[this.theme].secondaryColor);break;case"allowUndoRedo":this.allowUndoRedo=t;break;case"showQuickAccessToolbar":this.showQuickAccessToolbar=t;break;case"isReadOnly":this.isReadOnly=t;break;case"toolbar":this.updateMainToolbar(this.element,!0),this.updateToolbar(this.element,"")}},e.prototype.destroy=function(){var e=[];this.element.removeAttribute("tabindex"),this.cssClass&&(e=e.concat(this.cssClass.replace(/\s+/g," ").trim().split(" "))),sf.base.removeClass([this.element],e),this.element.getAttribute("class")||this.element.removeAttribute("class"),this.element.classList.remove("e-image-editor"),this.unwireEvent(),this.element.innerHTML=""},e.prototype.createUploader=function(){var e=this.element.querySelector(".e-ie-drop-area");if(e){var t=e.getElementsByTagName("input")[0],o=e.getElementsByTagName("a")[0];t.onchange=this.fileSelect.bind(this,t),o.onclick=function(){return t.click(),!1}}this.element.querySelector(".e-ie-toolbar-zoom-in")&&this.wireZoomBtnEvents()},e.prototype.wireZoomBtnEvents=function(){var e=this.element.querySelector("#zoomin"),t=this.element.querySelector("#zoomout");e&&e.addEventListener("click",this.zoomInBtnClickHandler.bind(this)),t&&t.addEventListener("click",this.zoomOutBtnClickHandler.bind(this))},e.prototype.zoomInBtnClickHandler=function(e){if((this.zoomSettings.zoomTrigger&i.Toolbar)===i.Toolbar){this.noPushUndo=!1,this.currObjType.isFiltered&&this.okBtn();var t=this.drawingShape;if(this.drawingShape){var o=this.activeObj.currIndex;this.noPushUndo=!0,this.okBtn(),this.noPushUndo=!1,this.drawingShape=null,o&&this.selectShape(o)}if(this.refreshShapeDrawing(),sf.base.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var r={bool:!1};this.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:r}}),r.bool&&this.freeHandDrawModule.draw({prop:"applyFhd",onPropertyChange:!1}),this.isZoomBtnClick=!0,this.applyPreviewFilter(),this.currObjType.isFiltered=!1,this.togglePen&&(this.currObjType.isZoomed=!0,this.freeHandDraw(!1),this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})),this.drawModule.draw({onPropertyChange:!1,prop:"resetCurrentSelectionPoint"}),this.drawingShape=t,this.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}}),this.drawModule.draw({onPropertyChange:!1,prop:"redrawDownScale"}),(this.isCropTab||this.activeObj.shape)&&(this.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),this.freeHandDrawModule.draw({prop:"resetStraightenPoint"})),this.isStraightening&&(this.drawModule.draw({prop:"resetStraightenDestPoints"}),this.drawModule.draw({prop:"setDestForStraighten"}))}},e.prototype.zoomOutBtnClickHandler=function(e){if((this.zoomSettings.zoomTrigger&i.Toolbar)===i.Toolbar){this.noPushUndo=!1,this.currObjType.isFiltered&&this.okBtn();var t=this.drawingShape;if(this.drawingShape){var o=this.activeObj.currIndex;this.noPushUndo=!0,this.okBtn(),this.noPushUndo=!1,this.drawingShape=null,o&&this.selectShape(o)}if(this.refreshShapeDrawing(),sf.base.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var r={bool:!1};this.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:r}}),r.bool&&this.freeHandDrawModule.draw({prop:"applyFhd",onPropertyChange:!1}),this.isZoomBtnClick=!0,this.applyPreviewFilter(),this.currObjType.isFiltered=!1,this.togglePen&&(this.currObjType.isZoomed=!0,this.freeHandDraw(!1),this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})),this.drawModule.draw({prop:"resetCurrentSelectionPoint"}),this.drawingShape=t,this.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}}),this.drawModule.draw({prop:"redrawDownScale"}),(this.isCropTab||this.activeObj.shape)&&(this.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),this.freeHandDrawModule.draw({prop:"resetStraightenPoint"})),this.isStraightening&&(this.drawModule.draw({prop:"resetStraightenDestPoints"}),this.drawModule.draw({prop:"setDestForStraighten"}))}},e.prototype.applyPreviewFilter=function(){(document.querySelector("#"+this.element.id+"_sliderWrapper")||this.currObjType.isFiltered)&&(this.initialAdjustmentValue=this.canvasFilter=this.lowerCanvas.getContext("2d").filter,this.currObjType.isFiltered=!1)},e.prototype.refreshShapeDrawing=function(){var e={shape:""};this.selectionModule.selection({prop:"getCurrentDrawingShape",onPropertyChange:!1,value:{obj:e}}),""!==e.shape&&(this.selectionModule.selection({prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.updateToolbar(this.element,"imageLoaded"))},e.prototype.fileSelect=function(e,t){if(t.detail&&t.detail.DropEvent){var o=t.detail.DropEvent.dataTransfer.files[0].type.split("/")[1];if("png"!=o&&"jpg"!=o&&"jpeg"!=o&&"svg"!=o)return void this.dotNetRef.invokeMethodAsync("UpdateDialog",!1)}!sf.base.isNullOrUndefined(t.detail)&&t.detail.isPaste||(this.isInteracted?(this.shapeModule.shape({prop:"fileChanged",value:{e:t}}),this.updateToolbar(this.element,"image")):this.drawModule.draw({prop:"fileSelect",value:{inputElement:e,args:t}}))},e.prototype.wireEvent=function(){sf.base.EventHandler.add(document,"keydown",this.keyDownEventHandler,this),sf.base.EventHandler.add(document,"keypress",this.keyUpEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mousedown",this.mouseDownEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mousemove",this.mouseMoveEventHandler,this),sf.base.EventHandler.add(this.upperCanvas,"mouseup",this.mouseUpEventHandler,this),sf.base.EventHandler.add(document,"mouseup",this.mouseUpEventHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler,this),sf.base.EventHandler.add(this.upperCanvas,"touchstart",this.touchStartHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"touchstart",this.touchStartHandler,this),sf.base.EventHandler.add(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),sf.base.EventHandler.add(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),window.addEventListener("resize",this.windowResizeHandler.bind(this)),sf.base.Browser.isIos||"safari"===sf.base.Browser.info.name||screen.orientation.addEventListener("change",this.screenOrientation.bind(this)),this.shapeModule.shape({prop:"wireEvent",onPropertyChange:!1})},e.prototype.unwireEvent=function(){sf.base.EventHandler.remove(document,"keydown",this.keyDownEventHandler),sf.base.EventHandler.remove(document,"keypress",this.keyUpEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mousedown",this.mouseDownEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mousemove",this.mouseMoveEventHandler),sf.base.EventHandler.remove(this.upperCanvas,"mouseup",this.mouseUpEventHandler),sf.base.EventHandler.remove(document,"mouseup",this.mouseUpEventHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler),sf.base.EventHandler.remove(this.upperCanvas,"touchstart",this.touchStartHandler),sf.base.EventHandler.remove(this.lowerCanvas,"touchstart",this.touchStartHandler),sf.base.EventHandler.remove(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll),sf.base.EventHandler.remove(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll),window.removeEventListener("resize",this.windowResizeHandler.bind(this)),sf.base.Browser.isIos||"safari"===sf.base.Browser.info.name||screen.orientation.removeEventListener("change",this.screenOrientation.bind(this)),this.shapeModule.shape({prop:"unWireEvent",onPropertyChange:!1}),this.selectionModule.selection({prop:"unWireEvent",onPropertyChange:!1})},e.prototype.touchStartHandler=function(e){this.selectionModule.selection({prop:"touchStartHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.mouseDownEventHandler=function(e){this.isKeyDown=!1,"e-ie-drop-browse"!==e.target.className&&this.selectionModule.selection({prop:"mouseDownEventHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.mouseMoveEventHandler=function(e){this.selectionModule.selection({prop:"mouseMoveEventHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.mouseUpEventHandler=function(e){"e-ie-drop-browse"!==e.target.className&&this.selectionModule.selection({prop:"mouseUpEventHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.keyDownEventHandler=function(e){this.isKeyDown=!0,this.selectionModule.selection({prop:"keyDownEventHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.keyUpEventHandler=function(e){"block"!==this.textArea.style.display&&"inline-block"!==this.textArea.style.display||e.target.id!==this.element.id+"_textArea"||this.selectionModule.selection({prop:"textKeyDown",value:{e:e}})},e.prototype.canvasMouseDownHandler=function(e){"e-ie-drop-browse"!==e.target.className&&this.selectionModule.selection({prop:"canvasMouseDownHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.canvasMouseMoveHandler=function(e){this.selectionModule.selection({prop:"canvasMouseMoveHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.canvasMouseUpHandler=function(e){"e-ie-drop-browse"!==e.target.className&&this.selectionModule.selection({prop:"canvasMouseUpHandler",onPropertyChange:!1,value:{e:e}})},e.prototype.handleScroll=function(e){this.selectionModule.selection({prop:"handleScroll",onPropertyChange:!1,value:{e:e}})},e.prototype.adjustToScreen=function(){this.update()},e.prototype.screenOrientation=function(){sf.base.Browser.isDevice&&setTimeout(this.adjustToScreen.bind(this),100)},e.prototype.windowResizeHandler=function(){!sf.base.Browser.isDevice&&this.element.classList.contains("e-image-editor")&&this.adjustToScreen()},e.prototype.notifyResetForAllModules=function(){this.requiredModules();this.cropModule.cropping({prop:"reset",onPropertyChange:!1}),this.drawModule.draw({prop:"reset",onPropertyChange:!1}),this.exportModule.export({prop:"reset",onPropertyChange:!1}),this.filterModule.filter({prop:"reset",onPropertyChange:!1}),this.freeHandDrawModule.draw({prop:"reset",onPropertyChange:!1}),this.selectionModule.selection({prop:"reset",onPropertyChange:!1}),this.shapeModule.shape({prop:"reset",onPropertyChange:!1}),this.transformModule.transform({prop:"reset",onPropertyChange:!1}),this.undoRedoModule.undoRedo({prop:"reset",onPropertyChange:!1})},e.prototype.allowShape=function(e,t){this.isPublicMethod=!0,this.applyShapes();var o={inRange:!1};return this.shapeModule.shape({prop:"isPointsInRange",onPropertyChange:!1,value:{x:e,y:t,obj:o}}),o.inRange},e.prototype.clearSelection=function(e){this.selectionModule.selection({prop:"clearSelection",onPropertyChange:!1,value:{resetCrop:e}})},e.prototype.crop=function(){var e={isCrop:!1};return this.cropModule.cropping({prop:"crop",onPropertyChange:!1,value:{obj:e}}),e.isCrop},e.prototype.flip=function(e){this.transformModule.transform({prop:"flip",value:{direction:e}}),this.drawModule.draw({prop:"redrawDownScale"}),this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}})},e.prototype.getImageData=function(){var e={canvas:null};return this.applyShapes(),this.exportModule.export({prop:"exportToCanvas",value:{object:e}}),e.canvas.getContext("2d").getImageData(0,0,e.canvas.width,e.canvas.height)},e.prototype.open=function(e){sf.base.isNullOrUndefined(e)||(document.getElementById(this.element.id+"_dropArea")&&(document.getElementById(this.element.id+"_dropArea").style.display="none"),this.drawModule.draw({prop:"open",value:{data:e}}))},e.prototype.reset=function(){var e={isErrorImage:!1};if(this.drawModule.draw({prop:"getErrorImage",value:{obj:e}}),!this.disabled&&!e.isErrorImage){this.clearContext(this.inMemoryContext),this.clearContext(this.lowerContext),this.clearContext(this.upperContext),this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1});var t=this.isImageLoaded;this.currObjType.isUndoAction=this.isUndoRedo=this.togglePan=this.togglePen=this.isImageLoaded=this.isFinetuning=!1,this.isCircleCrop=this.isCropTab=!1,this.objColl=[],this.transform.degree=0,this.upperCanvas.style.display="block",this.transform.currFlipState="",this.allowDownScale=!0,this.upperCanvas.style.cursor=this.cursor=this.lowerCanvas.style.cursor="default",this.lowerContext.lineWidth=this.upperContext.lineWidth=void 0,this.frameDestPoints=null,this.textArea.value=this.textArea.textContent="",this.textArea.style.display="none",this.lowerContext.filter=this.canvasFilter=this.getDefaultFilter(),this.img.destLeft=this.img.destTop=this.img.srcLeft=this.img.srcTop=0,this.img.destWidth=this.img.destHeight=this.img.srcWidth=this.img.srcHeight=null,this.currSelectionPoint=null,this.panPoint.currentPannedPoint={x:0,y:0},this.rotateFlipColl=[],this.points=[],this.pointColl={},this.freehandCounter=0,this.drawModule.draw({prop:"resetPanPoints"}),this.lowerCanvas.style.left=this.upperCanvas.style.left="",this.fontSizeColl=[],this.lowerCanvas.style.top=this.upperCanvas.style.top="",this.lowerCanvas.style.maxWidth=this.upperCanvas.style.maxWidth="",this.lowerCanvas.style.maxHeight=this.upperCanvas.style.maxHeight="",this.transform.defaultZoomFactor=this.transform.zoomFactor=0,this.transform.cropZoomFactor=null,this.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.tempFrameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1},this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""},this.afterCropActions=[],this.currentFilter="",this.tempFrameZoomLevel=null,this.cxtTbarHeight=null,this.straightenPoint=null,this.transform.straighten=0,this.cancelCropSelection=null,this.aspectWidth=this.aspectHeight=null,this.isResize=!1,this.drawingShape=null,this.isShapeDrawing=this.noPushUndo=this.isUndoRedoStack=!1,this.shapeColl=[];var o={initialZoomValue:!1};this.drawModule.draw({prop:"getInitialZoomValue",onPropertyChange:!1,value:{obj:o}}),o.initialZoomValue&&(this.zoomSettings.zoomFactor=o.initialZoomValue);var r=document.getElementById(this.element.id+"_quickAccessToolbarArea");r&&(r.style.display="none"),this.notifyResetForAllModules(),this.filterModule.filter({prop:"update-finetunes"}),this.isImageLoaded=t,this.straightenBaseImageCanvas(),this.isImageLoaded=!1,this.drawModule.draw({prop:"update-canvas",onPropertyChange:!1}),this.isImageLoaded=t,this.prevStraightenedDegree=0,this.activeObj.textSettings.fontFamily=this.defaultFontFamily}},e.prototype.rotate=function(e){var t={isRotate:!1};return 90!==e&&-90!==e||this.updateImageTransformColl(90===e?"rotateright":"rotateleft"),this.transformModule.transform({prop:"rotate",value:{degree:e,obj:t}}),this.drawModule.draw({prop:"redrawDownScale"}),t.isRotate},e.prototype.export=function(e,t,o){this.applyShapes(),this.exportModule.export({prop:"export",onPropertyChange:!1,value:{type:e,fileName:t,imgQuality:o}})},e.prototype.select=function(e,t,o,r,i){this.applyShapes(),this.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:e,startX:t,startY:o,width:r,height:i}}),t&&o||r&&i?this.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:e,startX:t,startY:o,width:r,height:i}}):this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""}},e.prototype.freeHandDraw=function(e){this.freeHandDrawModule.draw({prop:"freeHandDraw",onPropertyChange:!1,value:{value:e}})},e.prototype.freehandDraw=function(e){!this.disabled&&this.isImageLoaded&&(this.applyShapes(),this.freeHandDraw(e))},e.prototype.pan=function(e){this.applyShapes(),this.transformModule.transform({prop:"pan",onPropertyChange:!1,value:{value:e}})},e.prototype.zoom=function(e,t){this.isZoomBtnClick=!0,this.transformModule.transform({prop:"zoom",onPropertyChange:!1,value:{zoomFactor:e,zoomPoint:t}}),this.drawModule.draw({prop:"redrawDownScale"})},e.prototype.drawEllipse=function(e,t,o,r,i,a,s,n,l){var h=!1,p=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(p||sf.base.isNullOrUndefined(e)&&sf.base.isNullOrUndefined(t))&&(h=!0,this.shapeModule.shape({prop:"drawEllipse",onPropertyChange:!1,value:{x:e,y:t,radiusX:o,radiusY:r,strokeWidth:i,strokeColor:a,fillColor:s,degree:n,isSelected:l}}),this.drawModule.draw({prop:"redrawDownScale"})),h},e.prototype.drawLine=function(e,t,o,r,i,a,s){var n=!1,l=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(l||sf.base.isNullOrUndefined(e)&&sf.base.isNullOrUndefined(t))&&(n=!0,this.shapeModule.shape({prop:"drawLine",onPropertyChange:!1,value:{startX:e,startY:t,endX:o,endY:r,strokeWidth:i,strokeColor:a,isSelected:s}}),this.drawModule.draw({prop:"redrawDownScale"})),n},e.prototype.drawArrow=function(e,t,o,r,i,a,s,n,l){var h=!1,p=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(p||sf.base.isNullOrUndefined(e)&&sf.base.isNullOrUndefined(t))&&(h=!0,this.shapeModule.shape({prop:"drawArrow",onPropertyChange:!1,value:{startX:e,startY:t,endX:o,endY:r,strokeWidth:i,strokeColor:a,arrowStart:s,arrowEnd:n,isSelected:l}}),this.drawModule.draw({prop:"redrawDownScale"})),h},e.prototype.drawPath=function(e,t,o,r){this.isPublicMethod=!0;var i={inRange:!1},a=!1;if(e&&e.length>0)for(var s=0;s<e.length&&!i.inRange;s++)this.shapeModule.shape({prop:"isPointsInRange",onPropertyChange:!1,value:{x:e[s].x,y:e[s].y,obj:i}});return!this.disabled&&this.isImageLoaded&&(i.inRange||sf.base.isNullOrUndefined(e))&&(a=!0,this.applyShapes(),this.shapeModule.shape({prop:"drawPath",onPropertyChange:!1,value:{pointColl:e,strokeWidth:t,strokeColor:o,isSelected:r}}),this.drawModule.draw({prop:"redrawDownScale"})),a},e.prototype.drawRectangle=function(e,t,o,r,i,a,s,n,l){var h=!1,p=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(p||sf.base.isNullOrUndefined(e)&&sf.base.isNullOrUndefined(t))&&(h=!0,this.shapeModule.shape({prop:"drawRectangle",onPropertyChange:!1,value:{x:e,y:t,width:o,height:r,strokeWidth:i,strokeColor:a,fillColor:s,degree:n,isSelected:l}}),this.drawModule.draw({prop:"redrawDownScale"})),h},e.prototype.drawText=function(e,t,o,r,i,a,s,n,l,h){var p=!1,d=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(d||sf.base.isNullOrUndefined(e)&&sf.base.isNullOrUndefined(t))&&(p=!0,this.shapeModule.shape({prop:"drawText",onPropertyChange:!1,value:{x:e,y:t,text:o,fontFamily:r,fontSize:i,bold:a,italic:s,color:n,isSelected:l,degree:h}}),this.drawModule.draw({prop:"redrawDownScale"})),p},e.prototype.drawImage=function(e,t,o,r,i,a,s,n,l){var h=!1,p=this.allowShape(t,o);if(!this.disabled&&this.isImageLoaded&&(p||sf.base.isNullOrUndefined(t)&&sf.base.isNullOrUndefined(o))){var d=this.objColl.length;this.shapeModule.shape({prop:"drawImage",onPropertyChange:!1,value:{x:t,y:o,width:r,height:i,src:e,degree:s,isAspectRatio:a,opacity:n,isSelected:l}}),this.drawModule.draw({prop:"redrawDownScale"}),this.objColl.length>d&&(h=!0)}return h},e.prototype.selectShape=function(e){this.applyShapes();var t={isSelected:!1};return this.shapeModule.shape({prop:"selectShape",onPropertyChange:!1,value:{id:e,obj:t}}),this.drawModule.draw({prop:"redrawDownScale"}),t.isSelected},e.prototype.deleteShape=function(e){this.applyShapes(),this.shapeModule.shape({prop:"deleteShape",onPropertyChange:!1,value:{id:e}}),this.drawModule.draw({prop:"redrawDownScale"})},e.prototype.getShapeSetting=function(e){this.applyShapes();var t={shapeDetails:null};return this.shapeModule.shape({prop:"getShapeSetting",onPropertyChange:!1,value:{id:e,obj:t}}),this.drawModule.draw({prop:"redrawDownScale"}),t.shapeDetails?t.shapeDetails:{}},e.prototype.getShapeSettings=function(){this.applyShapes();var e={shapeDetailsColl:[]};return this.shapeModule.shape({prop:"getShapeSettings",onPropertyChange:!1,value:{obj:e}}),this.drawModule.draw({prop:"redrawDownScale"}),e.shapeDetailsColl},e.prototype.update=function(){this.transformModule.transform({prop:"update"})},e.prototype.finetuneImage=function(e,t){!this.disabled&&this.isImageLoaded&&(this.applyShapes(),this.filterModule.filter({prop:"finetuneImage",value:{value:t,option:e}}),this.drawModule.draw({prop:"redrawDownScale"}))},e.prototype.applyImageFilter=function(e){!this.disabled&&this.isImageLoaded&&(this.applyShapes(),this.filterModule.filter({prop:"applyImageFilter",value:{option:e.toString()}}),this.drawModule.draw({prop:"redrawDownScale"}),this.canvasFilter=this.lowerContext.filter,this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}))},e.prototype.undo=function(){this.applyShapes(),this.undoRedoModule.undoRedo({prop:"undo",onPropertyChange:!1}),this.drawModule.draw({prop:"redrawDownScale"})},e.prototype.redo=function(){this.applyShapes(),this.undoRedoModule.undoRedo({prop:"redo",onPropertyChange:!1}),this.drawModule.draw({prop:"redrawDownScale"})},e.prototype.getImageDimension=function(){return{x:this.img.destLeft,y:this.img.destTop,width:this.img.destWidth,height:this.img.destHeight}},e.prototype.resize=function(e,t,o){var r=!1;if(e.toString().length<=4&&t.toString().length<=4){this.applyShapes();var i={startX:this.img.destLeft,startY:this.img.destTop,width:this.img.destWidth,height:this.img.destHeight};this.updateToolbar(this.element,"resize"),this.transformModule.transform({prop:"resize",value:{width:e,height:t,isAspectRatio:o}}),i.startX!==this.img.destLeft||i.startY!==this.img.destTop||i.width!==this.img.destWidth||i.height!==this.img.destHeight?(r=!0,this.okBtn()):this.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null}}),this.drawModule.draw({prop:"redrawDownScale"})}return r},e.prototype.drawFrame=function(e,t,o,r,i,a,s,n,l){var h=!1;this.applyShapes();var p={frameChangeEventArgs:null};t=t||"#fff",o=o||"",r=r||20,i=i||0,a=a||0,s=s||0,n=n||d.Solid,l=l||0;var c={type:this.toPascalCase(this.frameObj.type),color:this.frameObj.color,gradientColor:this.frameObj.gradientColor,size:this.frameObj.size,inset:this.frameObj.inset,offset:this.frameObj.offset,borderRadius:this.frameObj.radius,frameLineStyle:this.toPascalCase(this.frameObj.border),lineCount:this.frameObj.amount};return sf.base.extend(this.tempFrameObj,this.frameObj),this.tempFrameZoomLevel=this.transform.zoomFactor,this.frameDestPoints=sf.base.extend({},this.img,{},!0),this.performFrameClick(),this.frameObj.type=e.toLowerCase(),this.frameObj.color=t,this.frameObj.gradientColor=o,this.frameObj.size=r,this.frameObj.inset=i,this.frameObj.offset=a,this.frameObj.radius=s,this.frameObj.border=n.toLowerCase(),this.frameObj.amount=l,this.drawModule.draw({prop:"triggerFrameChange",value:{prevFrameSettings:c,obj:p}}),p.frameChangeEventArgs&&!p.frameChangeEventArgs.cancel?(this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),JSON.stringify(this.frameObj)!==JSON.stringify(this.tempFrameObj)?(h=!0,this.okBtn()):this.tempFrameZoomLevel=null):(this.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null}}),sf.base.extend(this.frameObj,this.tempFrameObj),this.tempFrameZoomLevel=null),this.drawModule.draw({prop:"redrawDownScale"}),h},e.prototype.straightenImage=function(e){var t=!1;return e>=-45&&e<=45&&(this.applyShapes(),t=!0,this.transformModule.transform({prop:"straightenImage",value:{degree:e}}),this.drawModule.draw({prop:"redrawDownScale"})),t},e.prototype.updateShape=function(e,t){var o={isSelected:!1},r=!1,i={bool:!1};if(sf.base.isNullOrUndefined(e.id))e.strokeColor&&(this.activeObj.strokeSettings.strokeColor=e.strokeColor),e.fillColor&&(this.activeObj.strokeSettings.fillColor=e.fillColor),e.strokeWidth&&(this.activeObj.strokeSettings.strokeWidth=e.strokeWidth),e.index&&(this.activeObj.order=e.index),"FreehandDraw"===e.type&&e.strokeWidth&&this.freeHandDrawModule.draw({prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:e.strokeWidth}});else if("text"!==e.type.toLowerCase()||"block"!==this.textArea.style.display&&"inline-block"!==this.textArea.style.display||(this.okBtn(null,!0),r=!0),this.shapeModule.shape({prop:"selectShape",onPropertyChange:!1,value:{id:e.id,obj:o}}),this.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:i}}),o.isSelected){var a=this.activeObj.textSettings.fontSize;if(this.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e}}),"text"===this.activeObj.shape&&a){var s=this.activeObj.textSettings.fontSize-a;0!==s&&(this.activeObj.activePoint.height+=s,this.activeObj.activePoint.startY-=s/2,this.activeObj.activePoint.endY+=s/2,this.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:this.activeObj.activePoint,obj:this.activeObj,isMouseMove:null,x:null,y:null}}))}var n=sf.base.extend({},this.activeObj,{},!0);this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:null}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),n.shape&&this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:n}}),i.bool&&this.undoRedoModule.undoRedo({prop:"setPreventUR",value:{bool:!0}}),this.okBtn(t,!0),i.bool&&this.undoRedoModule.undoRedo({prop:"setPreventUR",value:{bool:!1}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawModule.draw({prop:"redrawDownScale"}),r&&this.enableTextEditing(),t&&this.selectShape(e.id)}return o.isSelected},e.prototype.cloneShape=function(e){var t={isSelected:!1};return"shape"===e.split("_")[0]&&(this.shapeModule.shape({prop:"selectShape",onPropertyChange:!1,value:{id:e,obj:t}}),t.isSelected&&(this.duplicateShape(!1,!0),this.okBtn(null,!0),this.drawModule.draw({prop:"redrawDownScale"}))),t.isSelected},e.prototype.getImageFilter=function(e){var t=sf.base.createElement("canvas").getContext("2d");return this.filterModule.filter({prop:"updateAdj",value:{type:e.toLowerCase(),value:null,isPreview:!0,ctx:t}}),t.filter},e.prototype.enableTextEditing=function(){var e=sf.base.extend({},this.activeObj,{},!0);e.order||(this.noPushUndo=!0,this.okBtn(),this.noPushUndo=!1,this.selectShape(e.currIndex),e.order=this.activeObj.order),this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!1}}),this.activeObj=e,this.editText()},e.prototype.editText=function(){var e={x:this.activeObj.activePoint.startX,y:this.activeObj.activePoint.startY};if(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.selectionModule.selection({prop:"setTempActObj",onPropertyChange:!1,value:{obj:sf.base.extend({},this.activeObj,{},!0)}}),this.selectionModule.selection({prop:"setInitialTextEdit",onPropertyChange:!1,value:{bool:!0}}),this.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:sf.base.extend({},this.activeObj,{},!0)}}),0!==this.activeObj.rotatedAngle){var t={x:e.x,y:e.y};this.shapeModule.shape({prop:"getTextBoxPosition",onPropertyChange:!1,value:{obj:this.activeObj,object:t}}),e.x=t.x,e.y=t.y;var o={x:e.x,y:e.y};this.shapeModule.shape({prop:"setFlipState",onPropertyChange:!1,value:{x:e.x,y:e.y,obj:this.activeObj,object:o}}),e.x=o.x,e.y=o.y}this.shapeModule.shape({prop:"renderTextArea",onPropertyChange:!1,value:{x:e.x,y:e.y,actObj:this.activeObj}}),sf.base.isNullOrUndefined(this.activeObj.currIndex)&&this.drawModule.draw({prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}}),document.getElementById(this.element.id+"_quickAccessToolbarArea")&&(document.getElementById(this.element.id+"_quickAccessToolbarArea").style.display="none")},e.prototype.canUndo=function(){var e=!1;return this.getUndoRedoColl().index>0&&(e=!0),e},e.prototype.canRedo=function(){var e=!1,t=this.getUndoRedoColl(),o=t.undoRedoColl,r=t.index;return o&&o.length>0&&r<o.length-1&&(e=!0),r===o.length?e=!1:(0===r&&o.length>0||r>0)&&(e=!0),e},e.prototype.getUndoRedoColl=function(){var e={undoRedoColl:null,index:null},t={undoRedoStep:null},o={appliedUndoRedoColl:[]};return this.undoRedoModule.undoRedo({prop:"getAppliedUndoRedoColl",value:{obj:o}}),this.undoRedoModule.undoRedo({prop:"getUndoRedoStep",value:{obj:t}}),e.undoRedoColl=o.appliedUndoRedoColl,e.index=t.undoRedoStep,e},e.prototype.getObjColl=function(){return this.objColl},e.prototype.setObjColl=function(e){this.objColl=e,this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!1}})},e.prototype.getPointColl=function(){return this.pointColl},e.prototype.setPointColl=function(e){this.pointColl=e,this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!1}})},e.prototype.apply=function(){this.closeOverlayTbar(),this.okBtn(null,!0),this.updateToolbar(this.element,"imageLoaded")},e.prototype.discard=function(){this.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:this.closeOverlayTbar(),isFinalCancel:!0}})},e.prototype.enableShapeDrawing=function(e,t){if(t&&(this.drawingShape=e.toLowerCase(),this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1})),e&&t){this.currObjType.shape=e.toLowerCase(),this.activeObj.shape=this.currObjType.shape,this.currObjType.isDragging=this.currObjType.isCustomCrop=!1,this.activeObj.shapeDegree=this.transform.degree,this.activeObj.shapeFlip=this.transform.currFlipState,this.activeObj.textFlip=this.transform.currFlipState,this.activeObj.flipObjColl=[];var o={order:null};this.shapeModule.shape({prop:"getNewOrder",onPropertyChange:!1,value:{obj:o}}),this.activeObj.order=o.order,this.selectionModule.selection({prop:"annotate",value:{shape:this.currObjType.shape}}),this.updateToolbar(this.element,this.activeObj.shape)}else t||(this.okBtn(null,!0),this.updateToolbar(this.element,"imageLoaded"))},e.prototype.bringToFront=function(e){this.selectShape(e)&&(this.updateShapeOrder(e,"bringToFront"),this.apply())},e.prototype.bringForward=function(e){this.selectShape(e)&&(this.updateShapeOrder(e,"bringForward"),this.apply())},e.prototype.sendToBack=function(e){this.selectShape(e)&&(this.updateShapeOrder(e,"sendToBack"),this.apply())},e.prototype.sendBackward=function(e){this.selectShape(e)&&(this.updateShapeOrder(e,"sendBackward"),this.apply())},e.prototype.clearImage=function(){this.reset(),this.isImageLoaded=!1,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),document.getElementById(this.element.id+"_dropArea").style.display="block",this.updateToolbar(this.element,"imageLoaded","unloaded")},e.prototype.closeOverlayTbar=function(){var e=!1;if("frame-toolbar"!==this.currentToolbar&&this.element.querySelector(this.CTWRAPPER)){this.element.querySelector(this.CTWRAPPER).classList.contains("e-hide")||(e=!0);var t={bool:this.isStraightening};(!sf.base.Browser.isDevice||sf.base.Browser.isDevice&&!t.bool)&&this.element.querySelector(this.CTWRAPPER).classList.add("e-hide")}return e},e.prototype.getObjFromId=function(e){var t;if(this.activeObj.currIndex&&this.activeObj.currIndex===e)t=sf.base.extend({},this.activeObj,{},!0);else for(var o=0;o<this.shapeColl.length;o++){if((this.shapeColl[o].id?this.shapeColl[o].id:this.shapeColl[o].currIndex)===e){t=sf.base.extend({},this.shapeColl[o],{},!0);break}}return t},e.prototype.applyShapes=function(){if(!this.isUndoRedoStack){var e={bool:!1};this.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:e}}),(e.bool||this.togglePen||this.activeObj.shape&&-1!==["rectangle","ellipse","line","arrow","path","text","image"].indexOf(this.activeObj.shape)||this.drawingShape)&&this.okBtn(null,!0)}},e.prototype.getTextFromId=function(e){return{1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"}[""+e]},e.prototype.getFinetuneOption=function(e){return{brightness:l.Brightness,contrast:l.Contrast,hue:l.Hue,saturation:l.Saturation,opacity:l.Opacity,blur:l.Blur,exposure:l.Exposure}[""+e]},e.prototype.setPenStroke=function(e){this.freeHandDrawModule.draw({prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:parseInt(e,10)}})},e.prototype.updateFreehandDrawColorChange=function(){var e={tempFreeHandDrawEditingStyles:null};this.freeHandDrawModule.draw({prop:"getTempFreeHandDrawEditingStyles",value:{obj:e}}),this.freeHandDrawModule.draw({prop:"color-change",value:{color:e.tempFreeHandDrawEditingStyles.strokeColor}})},e.prototype.updateImageTransformColl=function(e){var t;"rotateleft"===e?t=-90:"rotateright"===e?t=90:"horizontalflip"===e?t="horizontal":"verticalflip"===e&&(t="vertical");for(var o=0;o<this.objColl.length;o++){var r=this.objColl[o].shape;if("image"===r||"text"===r){sf.base.isNullOrUndefined(this.objColl[o].rotateFlipColl)&&(this.objColl[o].rotateFlipColl=[]),this.objColl[o].rotateFlipColl.push(t);var i={collection:this.objColl[o].rotateFlipColl};this.shapeModule.shape({prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:this.objColl[o].rotateFlipColl,isRotateFlipCollection:!1,obj:i}}),this.objColl[o].rotateFlipColl=i.collection}}},e.prototype.setInitialZoomState=function(){this.objColl.push(this.activeObj),this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1});var e=this.isUndoRedo;this.isCropTab=!1,this.isUndoRedo=!0,this.transform.cropZoomFactor&&this.transform.cropZoomFactor>0?this.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.cropZoomFactor,zoomPoint:null,isResize:!0}}):this.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(this.transform.cropZoomFactor),zoomPoint:null,isResize:!0}}),this.isUndoRedo=e,this.panPoint.totalPannedPoint={x:0,y:0},this.transform.cropZoomFactor=0,this.freeHandDrawModule.draw({prop:"updateFHDColl",onPropertyChange:!1}),this.activeObj=sf.base.extend({},this.objColl[this.objColl.length-1],{},!0),this.objColl.pop(),this.isCropTab=!0,this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}})},e.prototype.updateCropTransformItems=function(){this.prevCurrSelectionPoint=sf.base.extend({},this.currSelectionPoint,{},!0),this.drawModule.draw({prop:"updateCropSelection",onPropertyChange:!1})},e.prototype.toPascalCase=function(e,t){var o=[];sf.base.isNullOrUndefined(e)||(o=e.toLowerCase().split("-"));for(var r=0;r<o.length;r++)o[r]=o[r].charAt(0).toUpperCase()+o[r].slice(1);return t&&(t.maxText=o.join("")),o.join("")},e.prototype.getFontSizes=function(){var e,t=[];this.fontSizeColl=[],e=0===this.transform.degree||this.transform.degree%180==0?this.img.destWidth/25:this.img.destHeight/25;for(var o=1;o<=10;o++)this.fontSizeColl.push({text:(o*Math.round(e/2)).toString()}),t.push({text:o.toString()});return t},e.prototype.okBtn=function(e,t){if(t){this.noPushUndo=!1;this.selectionModule.selection({prop:"setTempActObj",onPropertyChange:!1,value:{obj:{activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null}}})}var o=this.element.querySelector(".e-contextual-toolbar-wrapper");o&&o.classList.remove("e-frame-wrapper");var i,a=!1;this.isResizeOkBtn=!0;var s=this.element.querySelector("#"+this.element.id+"_aspectratio"),n=this.element.querySelector("#"+this.element.id+"_nonaspectratio"),l=this.element.querySelector(".e-ie-toolbar-aspect-ratio-btn"),h=this.element.querySelector(".e-ie-toolbar-nonaspect-ratio-btn");if(void 0!==this.activeObj.shape&&(i=this.activeObj.shape.split("-")),(void 0===i&&this.currObjType.isCustomCrop||void 0!==i&&"crop"===i[0])&&(a=!0),this.allowDownScale=!0,(this.activeObj.shape&&"image"!==this.activeObj.shape||this.togglePen)&&!a){var p={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:p}});var d=p.shapeSettingsObj;this.togglePen&&(d.type=r.FreehandDraw);var c={action:"apply",currentShapeSettings:sf.base.extend({},d,{},!0)};this.triggerShapeChanged(c)}if(s||n||"resize-toolbar"===this.currentToolbar){var u={width:null,height:null};this.selectionModule.selection({prop:"getNumTextValue",onPropertyChange:!1,value:{obj:u}});var v={x:u.width,y:u.height},g={prevCropObj:this.prevCropObj},b={prevObj:this.prevObj};if(v&&v.x&&v.y&&g.prevCropObj&&b.prevObj){n||h&&!h.classList.contains("e-hidden")?this.transformModule.transform({prop:"resize",value:{width:v.x,height:v.y,isAspectRatio:!1}}):(s||l&&!l.classList.contains("e-hidden"))&&this.transformModule.transform({prop:"resize",value:{width:v.x,height:null,isAspectRatio:!0}}),this.isResize=!1,this.aspectWidth=v.x,this.aspectHeight=v.y,this.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.zoomFactor,zoomPoint:null,isResize:!0}}),this.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:b.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),b.prevObj.zoomFactor&&(this.zoomSettings.zoomFactor=b.prevObj.zoomFactor),this.transformModule.transform({prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:this.zoomSettings.zoomFactor}}),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:b.prevObj,previousObjColl:b.prevObj.objColl,previousPointColl:b.prevObj.pointColl,previousSelPointColl:b.prevObj.selPointColl,previousCropObj:g.prevCropObj,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}});var C=this.cancelCropSelection;C&&h&&h.classList.contains("e-hidden")&&(C.previousObj.aspectWidth=C.currentObj.aspectWidth=this.aspectWidth,C.previousObj.aspectHeight=C.currentObj.aspectHeight=this.aspectHeight,C.previousCropObj=sf.base.extend({},this.cropObj,{},!0),C.currentCropObj=sf.base.extend({},this.cropObj,{},!0),this.drawModule.draw({prop:"updateCropSelObj"})),this.cancelCropSelection=null}else!v||0!==v.x&&0!==v.y||this.drawModule.draw({prop:"performCancel",value:{isContextualToolbar:null}});this.isAspectRatio=!1}var f=this.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected"),m={bool:!1};this.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:m}});var y=this.element.querySelector(".e-ie-contextual-slider");if(f&&(this.currentFilter=f.children[0].children[0].id.replace("Canvas","")),a){if(0!==this.transform.straighten&&(0!==this.panPoint.totalPannedPoint.x||0!==this.panPoint.totalPannedPoint.y||0!==this.panPoint.totalPannedClientPoint.x||0!==this.panPoint.totalPannedClientPoint.y)){var w=this.prevStraightenedDegree;this.prevStraightenedDegree=this.transform.straighten,this.setStraighten(this.transform.straighten-3),this.setStraighten(this.transform.straighten+3),this.prevStraightenedDegree=w}this.isCroppedEvent=this.crop()}else if(this.togglePen)this.freeHandDraw(!1),this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),this.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}});else if("block"===this.textArea.style.display||"inline-block"===this.textArea.style.display)this.shapeModule.shape({prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),sf.base.isNullOrUndefined(e)&&this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),this.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}});else if(!y.classList.contains("e-hidden")||this.currObjType.isFiltered){this.initialAdjustmentValue=this.canvasFilter=this.lowerContext.filter,this.currObjType.isFiltered=!1;var P=0!==this.activeObj.activePoint.width&&0!==this.activeObj.activePoint.height||"path"===this.activeObj.shape&&this.activeObj.pointColl.length>0,j={value:null};this.drawModule.draw({prop:"getTempAdjustmentValue",value:{obj:j}}),j.value===this.lowerContext.filter||!y.classList.contains("e-hidden")&&y.classList.contains("e-ie-finetune-slider-wrap")||P||this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),P&&this.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}})}else if(m.bool)this.freeHandDrawModule.draw({prop:"applyFhd",onPropertyChange:!1}),this.selectionModule.selection({prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),this.updateToolbar(this.element,"destroyQuickAccessToolbar"),this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),this.freeHandDrawModule.draw({prop:"resetFreehandDrawSelectedId",onPropertyChange:!1});else if(0!==this.activeObj.activePoint.width||0!==this.activeObj.activePoint.height||"path"===this.activeObj.shape&&this.activeObj.pointColl.length>0)"image"===this.activeObj.shape&&this.drawModule.draw({prop:"setImageApply",onPropertyChange:!1,value:{bool:!0}}),this.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}});else{if(JSON.stringify(this.frameObj)!==JSON.stringify(this.tempFrameObj)){var x={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:x}}),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:x.currObj,previousObjColl:x.currObj.objColl,previousPointColl:x.currObj.pointColl,previousSelPointColl:x.currObj.selPointColl,previousCropObj:sf.base.extend({},this.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),this.tempFrameObj=sf.base.extend({},this.frameObj,{},!0)}this.drawModule.draw({prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!0}})}this.isCropToolbar||"resize-toolbar"!=this.currentToolbar&&"frame-toolbar"!=this.currentToolbar||this.updateToolbar(this.element,"imageLoaded"),this.drawModule.draw({prop:"setNewPath",value:{bool:!1}}),this.transform.zoomFactor=this.transform.defaultZoomFactor,this.selectionModule.selection({prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),this.isResizeOkBtn=!1,this.drawModule.draw({prop:"redrawDownScale"}),this.isChangesSaved=!1,this.triggerActionComplete(),t&&(this.drawingShape=null,this.drawModule.draw({prop:"resetTempObjColl"}),this.drawModule.draw({prop:"resetTempPointColl"}))},e.prototype.setTempFilterProperties=function(){this.upperCanvas.style.display="block",this.cropSelectedState();var e={adjustmentLevel:null};this.filterModule.filter({prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:e}}),this.lowerContext.filter=this.initialAdjustmentValue,this.drawModule.draw({prop:"setTempAdjustmentValue",value:{tempAdjustmentValue:this.lowerContext.filter}}),this.filterModule.filter({prop:"setTempAdjustmentLevel",onPropertyChange:!1,value:{tempAdjustmentLevel:sf.base.extend({},e.adjustmentLevel,{},!0)}}),this.drawModule.draw({prop:"setTempFilter",value:{tempFilter:this.currentFilter}});var t={undoRedoStep:null};this.undoRedoModule.undoRedo({prop:"getUndoRedoStep",value:{obj:t}}),this.drawModule.draw({prop:"setTempUndoRedoStep",value:{tempUndoRedoStep:t.undoRedoStep}})},e.prototype.cropSelectedState=function(){this.activeObj.shape&&"crop"===this.activeObj.shape.split("-")[0]&&this.okBtn()},e.prototype.getCurrentCanvasData=function(){var e=sf.base.extend({},this.frameObj,{},!0);this.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""};var t=this.lowerContext.filter;this.lowerContext.filter=this.canvasFilter="none";var o=sf.base.extend([],this.objColl,null,!0),r=sf.base.extend([],this.pointColl,null,!0);this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.drawModule.draw({prop:"render-image",value:{isMouseWheel:!1}});var i=this.element.querySelector(".e-contextual-toolbar-wrapper");i&&i.classList.add("e-hide");var a=this.getImageData();return i&&(i.classList.remove("e-hide"),this.element.querySelector(".e-ie-toolbar-check-btn").classList.remove("e-hidden"),this.element.querySelector(".e-ie-toolbar-close-btn").classList.remove("e-hidden")),this.objColl=o,this.pointColl=r,this.freehandCounter=r.length,this.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=this.canvasFilter=t,this.frameObj=e,a},e.prototype.setCurrAdjustmentValue=function(e,t){var o=this,r={finetune:this.getFinetuneOption(e),value:t,cancel:!1};if(this.events&&!0===this.events.finetuneValueChanging.hasDelegate)r.value=parseInt(r.value.toString()),this.dotNetRef.invokeMethodAsync("OnFinetuneValueChangeAsync","FinetuneValueChanging",r,null).then((function(r){r.cancel||o.filterModule.filter({prop:"setCurrAdjValue",value:{type:e.toLowerCase(),value:t}})}));else{if(r.cancel)return;this.filterModule.filter({prop:"setCurrAdjValue",value:{type:e.toLowerCase(),value:t}})}},e.prototype.getSquarePointForPath=function(e){var t={startX:0,startY:0,endX:0,endY:0,width:0,height:0};if(e.pointColl.length>0){t={startX:e.pointColl[0].x,startY:e.pointColl[0].y,endX:e.pointColl[0].x,endY:e.pointColl[0].y};for(var o=1;o<e.pointColl.length;o++)e.pointColl[o].x<t.startX&&(t.startX=e.pointColl[o].x),e.pointColl[o].y<t.startY&&(t.startY=e.pointColl[o].y),e.pointColl[o].x>t.endX&&(t.endX=e.pointColl[o].x),e.pointColl[o].y>t.endY&&(t.endY=e.pointColl[o].y);t.width=t.endX-t.startX,t.height=t.endY-t.startY}return t},e.prototype.getSelectionType=function(e){return{CropCustom:"Custom",CropSquare:"Square",CropCircle:"Circle","Crop3:2":"3:2","Crop4:3":"4:3","Crop5:4":"5:4","Crop7:5":"7:5","Crop16:9":"16:9","Crop2:3":"2:3","Crop3:4":"3:4","Crop4:5":"4:5","Crop5:7":"5:7","Crop9:16":"9:16"}[""+e]},e.prototype.clearContext=function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.clearRect(0,0,e.canvas.height,e.canvas.width)},e.prototype.updateArrow=function(e,t){var o={1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"},r=!1,i=this.objColl.length;this.shapeModule.shape({prop:"pushActItemIntoObj"}),i!==this.objColl.length&&(r=!0);var a=sf.base.extend({},this.cropObj,{},!0),s={currObj:{}},n={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:n}});var l=n.shapeSettingsObj;this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var h=s.currObj;h.objColl=sf.base.extend([],this.objColl,[],!0),h.pointColl=sf.base.extend([],this.pointColl,[],!0),h.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0),r&&this.objColl.pop(),"startArrow"===e?(this.activeObj.start=this.getTextFromId(t),this.selectionModule.selection({prop:"setArrowShape",value:{type:"initial",shape:o[""+t]}})):"endArrow"===e&&(this.activeObj.end=this.getTextFromId(t),this.selectionModule.selection({prop:"setArrowShape",value:{type:"final",shape:o[""+t]}})),this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}});var p={action:e,currentShapeSettings:sf.base.extend({},l,{},!0)};this.triggerShapeChanged(p),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.updateFontFamily=function(e){this.selectionModule.selection({prop:"setInitialTextEdit",value:{bool:!1}});var t=!1,o=this.objColl.length;this.shapeModule.shape({prop:"pushActItemIntoObj"}),o!==this.objColl.length&&(t=!0);var r=sf.base.extend([],this.objColl,[],!0),i=sf.base.extend({},this.cropObj,{},!0),a={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var s=a.shapeSettingsObj,n={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var l=n.currObj;l.objColl=sf.base.extend([],this.objColl,[],!0),l.pointColl=sf.base.extend([],this.pointColl,[],!0),l.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var h={selPointColl:null};if(this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),l.selPointColl=sf.base.extend([],h.selPointColl,[],!0),t&&this.objColl.pop(),"block"===this.textArea.style.display||"inline-block"===this.textArea.style.display){this.shapeModule.shape({prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}});var p=this.activeObj.textSettings.fontFamily;this.activeObj.textSettings.fontFamily=this.toPascalCase(e),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.shapeModule.shape({prop:"redraw-text"}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:l,previousObjColl:l.objColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var d=this.activeObj.activePoint.width+.25*this.activeObj.textSettings.fontSize;this.textArea.style.width=d+"px",this.textArea.style.fontFamily=this.toPascalCase(e),this.activeObj.textSettings.fontFamily=p,this.shapeModule.shape({prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}})}else{this.shapeModule.shape({prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}});var c=this.activeObj.textSettings.fontFamily=this.toPascalCase(e);this.shapeModule.shape({prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:c,fontSize:null}}),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.shapeModule.shape({prop:"redraw-text"}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:l,previousObjColl:r,previousPointColl:sf.base.extend([],this.pointColl,[],!0),previousSelPointColl:l.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})}var u={action:"font-family",currentShapeSettings:sf.base.extend({},s,{},!0)};u.currentShapeSettings.fontFamily=this.textArea.style.fontFamily,this.triggerShapeChanged(u),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.updateFontSize=function(e){var t=e;this.selectionModule.selection({prop:"setInitialTextEdit",value:{bool:!1}});var o=!1,r=this.objColl.length;this.shapeModule.shape({prop:"pushActItemIntoObj"}),r!==this.objColl.length&&(o=!0);var i=sf.base.extend({},this.cropObj,{},!0),a={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var s=a.shapeSettingsObj,n={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var l=n.currObj;l.objColl=sf.base.extend([],this.objColl,[],!0),l.pointColl=sf.base.extend([],this.pointColl,[],!0),l.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var h={selPointColl:null};if(this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),l.selPointColl=sf.base.extend([],h.selPointColl,[],!0),o&&this.objColl.pop(),"block"===this.textArea.style.display||"inline-block"===this.textArea.style.display){this.shapeModule.shape({prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}});var p=this.activeObj.textSettings.fontSize;this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(t,10)-1].text,10),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:l,previousObjColl:l.objColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop();var d="";"bold"===this.textArea.style.fontWeight&&(d="bold "),"italic"===this.textArea.style.fontStyle&&(d="italic "),"bold"===this.textArea.style.fontWeight&&"italic"===this.textArea.style.fontStyle&&(d="italic bold "),this.upperContext.font=d+this.activeObj.textSettings.fontSize+"px "+this.textArea.style.fontFamily;var c=this.textArea.value.split("\n"),u={maxText:""};this.shapeModule.shape({prop:"getMaxText",onPropertyChange:!1,value:{isTextBox:!0,text:null,obj:u}});var v=u.maxText,g=this.upperContext.measureText(v).width+.5*this.activeObj.textSettings.fontSize;this.textArea.style.width=g+"px",this.textArea.style.height=c.length*(this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize)+"px",this.activeObj.textSettings.fontSize=p,this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily,this.textArea.style.fontSize=parseInt(this.fontSizeColl[parseInt(t,10)-1].text,10)+"px","georgia"===this.textArea.style.fontFamily&&(this.textArea.style.width=parseFloat(this.textArea.style.width)+parseFloat(this.textArea.style.fontSize)+"px")}else{this.shapeModule.shape({prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}});var b=this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(t,10)-1].text,10);this.shapeModule.shape({prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:null,fontSize:b}}),this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily;c=this.activeObj.keyHistory.split("\n"),u={maxText:""};this.shapeModule.shape({prop:"getMaxText",onPropertyChange:!1,value:{isTextBox:null,text:null,obj:u}});var C=u.maxText,f=(g=this.upperContext.measureText(C).width+.5*this.activeObj.textSettings.fontSize,c.length*(this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize));0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.selectionModule.selection({prop:"setTextSelection",onPropertyChange:!1,value:{width:g,height:f}}),this.drawModule.draw({prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:this.activeObj.activePoint,obj:this.activeObj,isMouseMove:null,x:null,y:null}}),this.shapeModule.shape({prop:"redraw-text"})),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:l,previousObjColl:l.objColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})}var m={action:"font-size",currentShapeSettings:sf.base.extend({},s,{},!0)};m.currentShapeSettings.fontSize=this.activeObj.textSettings.fontSize,this.triggerShapeChanged(m),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.updateFontColor=function(e){this.selectionModule.selection({prop:"setInitialTextEdit",value:{bool:!1}});var t=!1,o=this.objColl.length;this.shapeModule.shape({prop:"pushActItemIntoObj"}),o!==this.objColl.length&&(t=!0);var r=sf.base.extend({},this.cropObj,{},!0),i={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:i}});var a=i.shapeSettingsObj,s={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var n=s.currObj;n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var l={selPointColl:null};if(this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),n.selPointColl=sf.base.extend([],l.selPointColl,[],!0),t&&this.objColl.pop(),"none"===this.textArea.style.display)this.activeObj.strokeSettings.strokeColor=e,this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}),this.togglePen||(this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})));else if("block"===this.textArea.style.display||"inline-block"===this.textArea.style.display){this.textArea.style.color=e;var h=this.activeObj.strokeSettings.strokeColor;this.activeObj.strokeSettings.strokeColor=e,this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop(),this.activeObj.strokeSettings.strokeColor=h}else this.togglePen||(this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}));var p={action:"font-color",currentShapeSettings:sf.base.extend({},a,{},!0)};p.currentShapeSettings.fillColor=e,this.triggerShapeChanged(p),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.updatePenStrokeWidth=function(e){var t=sf.base.extend([],this.pointColl,[],!0);this.updateFreehandDrawColorChange();var o=sf.base.extend({},this.cropObj,{},!0),i={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:i}});var a=i.shapeSettingsObj,s={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var n=s.currObj;n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var l={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),n.selPointColl=sf.base.extend([],l.selPointColl,[],!0),this.pointColl=t,this.selectionModule.selection({prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.setPenStroke(e);var h={bool:!1};if(this.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:h}}),h.bool){var p={penStrokeWidth:null};this.freeHandDrawModule.draw({prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:p}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:p.penStrokeWidth}});var d={freehandSelectedIndex:null};this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:d}}),this.pointColl[d.freehandSelectedIndex].strokeWidth=p.penStrokeWidth,this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),this.drawModule.draw({prop:"redrawDownScale"}),this.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:p.penStrokeWidth}}),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}a.type=r.FreehandDraw;var c={action:"stroke-width",currentShapeSettings:sf.base.extend({},a,{},!0)};c.currentShapeSettings.strokeWidth=this.activeObj.strokeSettings.strokeWidth,this.triggerShapeChanged(c),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",value:{isPenDraw:!0}})},e.prototype.updatePenStrokeColor=function(e){var t=sf.base.extend([],this.pointColl,[],!0);this.updateFreehandDrawColorChange();var o=sf.base.extend({},this.cropObj,{},!0),i={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:i}});var a=i.shapeSettingsObj,s={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var n=s.currObj;n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var l={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),n.selPointColl=sf.base.extend([],l.selPointColl,[],!0),this.pointColl=t,this.selectionModule.selection({prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.activeObj.strokeSettings.strokeColor=e;var h={freehandSelectedIndex:null};this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:h}}),null!=h.freehandSelectedIndex&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null}}),this.drawModule.draw({prop:"redrawDownScale"}),this.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}));var p={bool:!1};if(this.selectionModule.selection({prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:p}}),p.bool){var d={freehandSelectedIndex:null};this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:d}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.pointColl[d.freehandSelectedIndex].strokeColor=e,this.freeHandDrawModule.draw({prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:e}}),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}else this.togglePen||this.selectionModule.selection({prop:"redrawShape",value:{obj:this.activeObj}});a.type=r.FreehandDraw;var c={action:"stroke-color",currentShapeSettings:sf.base.extend({},a,{},!0)};c.currentShapeSettings.strokeColor=e,this.triggerShapeChanged(c)},e.prototype.updateStrokeWidth=function(e){if(this.activeObj.shape&&("path"!==this.activeObj.shape||"path"===this.activeObj.shape&&this.activeObj.pointColl.length>0)){var t={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:t}});var o=t.shapeSettingsObj,r=!1,i=this.objColl.length;this.shapeModule.shape({prop:"pushActItemIntoObj"}),i!==this.objColl.length&&(r=!0);var a=sf.base.extend({},this.cropObj,{},!0),s={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var n=s.currObj;n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var l={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),n.selPointColl=sf.base.extend([],l.selPointColl,[],!0),r&&this.objColl.pop(),this.activeObj.strokeSettings.strokeWidth=parseInt(e,10),"rectangle"!==this.activeObj.shape&&"ellipse"!==this.activeObj.shape||(this.activeObj.strokeSettings.strokeWidth=parseInt(e,10)-1),this.activeObj.strokeSettings.strokeWidth*=2,this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}});var h={action:"stroke-width",currentShapeSettings:sf.base.extend({},o,{},!0)};h.currentShapeSettings.strokeWidth=this.activeObj.strokeSettings.strokeWidth,this.triggerShapeChanged(h)}else this.activeObj.shape&&"path"===this.activeObj.shape&&0===this.activeObj.pointColl.length&&(this.activeObj.strokeSettings.strokeWidth=parseInt(e,10),this.activeObj.strokeSettings.strokeWidth*=2,this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}}));this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.updateZOrder=function(e){var t={freehandDrawSelectedId:null};this.freeHandDrawModule.draw({prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:t}});var o=t.freehandDrawSelectedId?t.freehandDrawSelectedId:this.activeObj.currIndex;this.updateShapeOrder(o,e),o.indexOf("shape")>-1?this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1}):o.indexOf("pen")>-1&&this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",value:{isPenDraw:!0}})},e.prototype.updateStrokeColor=function(e){var t={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:t}});var o=t.shapeSettingsObj;if(this.activeObj.shape&&("path"!==this.activeObj.shape||"path"===this.activeObj.shape&&this.activeObj.pointColl.length>0)){var r=!1,i=this.objColl.length;this.shapeModule.shape({prop:"pushActItemIntoObj"}),i!==this.objColl.length&&(r=!0);var a=sf.base.extend({},this.cropObj,{},!0),s={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var n=s.currObj;n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var l={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),n.selPointColl=sf.base.extend([],l.selPointColl,[],!0),r&&this.objColl.pop(),this.activeObj.strokeSettings.strokeColor=e,this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}),this.togglePen||(this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))}else this.activeObj.shape&&"path"===this.activeObj.shape&&0===this.activeObj.pointColl.length&&(this.activeObj.strokeSettings.strokeColor=e,this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}));var h={action:"stroke-color",currentShapeSettings:sf.base.extend({},o,{},!0)};h.currentShapeSettings.strokeColor=e,this.triggerShapeChanged(h)},e.prototype.updateFillColor=function(e){var t={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:t}});var o=t.shapeSettingsObj,r=!1,i=this.objColl.length;this.shapeModule.shape({prop:"pushActItemIntoObj"}),i!==this.objColl.length&&(r=!0);var a=sf.base.extend({},this.cropObj,{},!0),s={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var n=s.currObj;n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var l={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),n.selPointColl=sf.base.extend([],l.selPointColl,[],!0),r&&this.objColl.pop(),this.activeObj.strokeSettings.fillColor=e,this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:this.activeObj.strokeSettings.fillColor,strokeWidth:null}}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}});var h={action:"fill-color",currentShapeSettings:sf.base.extend({},o,{},!0)};this.triggerShapeChanged(h)},e.prototype.horizontalFlip=function(e,t){var o,r;if(sf.base.isNullOrUndefined(t)){sf.base.isNullOrUndefined(this.activeObj.imageRatio)&&this.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),this.shapeModule.shape({prop:"pushActItemIntoObj"}),o=sf.base.extend({},this.cropObj,{},!0);var i={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),(r=i.currObj).objColl=sf.base.extend([],this.objColl,[],!0),r.pointColl=sf.base.extend([],this.pointColl,[],!0),r.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),r.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.objColl.pop()}e.clearRect(0,0,this.activeObj.imageCanvas.width,this.activeObj.imageCanvas.height);var s=this.duplicateImage();this.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:this.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:null}}),this.activeObj.activePoint=s,this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),sf.base.isNullOrUndefined(t)&&(this.objColl.push(this.activeObj),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageHFlip",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})),this.currObjType.isUndoAction||this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.verticalFlip=function(e,t){var o,r;if(sf.base.isNullOrUndefined(t)){sf.base.isNullOrUndefined(this.activeObj.imageRatio)&&this.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),this.shapeModule.shape({prop:"pushActItemIntoObj"}),o=sf.base.extend({},this.cropObj,{},!0);var i={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),(r=i.currObj).objColl=sf.base.extend([],this.objColl,[],!0),r.pointColl=sf.base.extend([],this.pointColl,[],!0),r.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),r.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.objColl.pop()}e.clearRect(0,0,this.activeObj.imageCanvas.width,this.activeObj.imageCanvas.height);var s=this.duplicateImage();this.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:this.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:!0}}),this.activeObj.activePoint=s,this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),sf.base.isNullOrUndefined(t)&&(this.objColl.push(this.activeObj),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageVFlip",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})),this.currObjType.isUndoAction||this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.rotateImage=function(e){var t,o;sf.base.isNullOrUndefined(this.activeObj.imageRatio)&&this.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),this.shapeModule.shape({prop:"pushActItemIntoObj"}),t=sf.base.extend({},this.cropObj,{},!0);var r={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),(o=r.currObj).objColl=sf.base.extend([],this.objColl,[],!0),o.pointColl=sf.base.extend([],this.pointColl,[],!0),o.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var i={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:i}}),o.selPointColl=sf.base.extend([],i.selPointColl,[],!0),this.objColl.pop(),"rotleft"===e?this.activeObj.rotatedAngle-=Math.PI/180*90:this.activeObj.rotatedAngle+=Math.PI/180*90,this.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.activeObj}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height);var a=sf.base.extend({},this.activeObj,{},!0);this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),this.activeObj=a,this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.objColl.push(this.activeObj),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageRotate",previousObj:o,previousObjColl:o.objColl,previousPointColl:o.pointColl,previousSelPointColl:o.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),this.updateToolbar(this.element,"destroyQuickAccessToolbar"),this.updateToolbar(this.element,"quickAccessToolbar","image"),this.currObjType.isUndoAction||this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})},e.prototype.pascalToSplitWords=function(e){var t=(e=e.charAt(0).toUpperCase()+e.slice(1)).match(/[A-Z][a-z]+/g);return sf.base.isNullOrUndefined(t)?e:t.map((function(e){return e.charAt(0).toUpperCase()+e.slice(1)})).join(" ")},e.prototype.getCurrAdjustmentValue=function(e){var t=100,o={freehandSelectedIndex:null};if(this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:o}}),"transparency"===e&&this.togglePen){var r={penOpacity:1};this.freeHandDrawModule.draw({prop:"getPenOpacity",onPropertyChange:!1,value:{obj:r}}),t=100*r.penOpacity}else if("transparency"===e&&null!=o.freehandSelectedIndex)t=100*this.pointColl[o.freehandSelectedIndex].opacity;else{r={adjustmentLevel:null};this.filterModule.filter({prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:r}}),t={brightness:r.adjustmentLevel.brightness,contrast:r.adjustmentLevel.contrast,hue:r.adjustmentLevel.hue,saturation:r.adjustmentLevel.saturation,opacity:r.adjustmentLevel.opacity,blur:r.adjustmentLevel.blur,exposure:r.adjustmentLevel.exposure,transparency:r.adjustmentLevel.transparency,straighten:this.transform.straighten}[""+e]}return t},e.prototype.transformSelect=function(e){0!==this.transform.straighten||"rotateleft"!==e&&"rotateright"!==e||!this.activeObj.shape||-1===["crop-2:3","crop-3:2","crop-3:4","crop-4:3","crop-4:5","crop-5:4","crop-5:7","crop-7:5","crop-9:16","crop-16:9"].indexOf(this.activeObj.shape)&&(-1===this.activeObj.shape.indexOf("crop-")||"crop-custom"===this.activeObj.shape||"crop-square"===this.activeObj.shape||"crop-circle"===this.activeObj.shape)||(this.activeObj.shape="crop-"+this.activeObj.shape.split("-")[1].split(":")[1]+":"+this.activeObj.shape.split("-")[1].split(":")[0]),this.isCropToolbar=!0,this.allowDownScale=!1;var t=this.transform.straighten,o=sf.base.extend({},this.activeObj,{},!0),r=this.transform.zoomFactor;this.prevEventSelectionPoint=sf.base.extend({},this.activeObj,{},!0);var i={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),this.prevEventObjPoint=i.currObj,this.prevEventObjPoint.objColl=sf.base.extend([],this.objColl,[],!0),this.prevEventObjPoint.pointColl=sf.base.extend([],this.pointColl,[],!0),this.prevEventObjPoint.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};if(this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),this.prevEventObjPoint.selPointColl=sf.base.extend([],a.selPointColl,[],!0),0!==this.transform.straighten){this.transform.straighten=0,this.straightenBaseImageCanvas();for(var s=0,n=this.objColl.length;s<n;s++){"line"!==(h=this.objColl[s].shape)&&"arrow"!==h&&"path"!==h&&(this.objColl[s].rotatedAngle-=t*(Math.PI/180),this.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[s]}}))}this.drawModule.draw({prop:"render-image",value:{isMouseWheel:!1}}),this.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})}this.setInitialZoomState();var l=sf.base.extend({},this.activeObj,{},!0);if(this.cropModule.cropping({prop:"setTransformCrop",onPropertyChange:!1,value:{bool:!0}}),this.cropSelectedState(),this.cropModule.cropping({prop:"setTransformCrop",onPropertyChange:!1,value:{bool:!1}}),this.drawModule.draw({prop:"resetCurrentSelectionPoint"}),this.updateImageTransformColl(e),this.transformModule.transform({prop:"performTransformation",value:{text:e}}),this.isCropTab=!0,this.drawModule.draw({prop:"moveToSelectionRange",value:{type:e,activeObj:l}}),!this.isStraightening||"horizontalflip"!==e&&"verticalflip"!==e||(this.drawModule.draw({prop:"resetStraightenDestPoints"}),this.drawModule.draw({prop:"setDestForStraighten"})),0!==t){this.transform.straighten=t,this.straightenBaseImageCanvas();for(s=0,n=this.objColl.length;s<n;s++){var h;"line"!==(h=this.objColl[s].shape)&&"arrow"!==h&&"path"!==h&&(this.objColl[s].rotatedAngle+=t*(Math.PI/180),this.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[s]}}))}this.shapeModule.shape({prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:!1}}),this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o}}),this.drawModule.draw({prop:"setStraightenActObj",value:{activeObj:null}}),this.drawModule.draw({prop:"setStraightenInitZoom",value:{zoomFactor:r}}),(this.isStraightening&&("horizontalflip"===e||"verticalflip"===e)&&sf.base.isNullOrUndefined(this.transform.zoomFactor)||0===this.transform.zoomFactor)&&(0===this.transform.degree?this.transform.zoomFactor+=.025:0===this.transform.zoomFactor&&(this.transform.zoomFactor=null)),this.drawModule.draw({prop:"zoomToSel",value:{activeObj:o,isToolbar:!1}})}this.isCropToolbar=!1;var p=this.element.querySelector(".e-ie-straighten-value-span");p&&(p.innerHTML=this.transform.straighten.toString()+"&#176")},e.prototype.getDefaultFilter=function(){return"brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)"},e.prototype.setStraighten=function(e,t){var o={cancel:!1,previousDegree:this.transform.straighten,currentDegree:e};this.prevStraightenEvent=this.transform.straighten,o.cancel||this.performStraighten(o)},e.prototype.duplicateImage=function(){var e=sf.base.extend({},this.activeObj.activePoint,{},!0),t={width:0,height:0};return this.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.activeObj.imageElement.width,height:this.activeObj.imageElement.height,obj:t,isImgShape:null}}),this.activeObj.activePoint.width=t.width,this.activeObj.activePoint.height=t.height,e},e.prototype.performStraighten=function(e){var t=e.currentDegree,o=this.element.querySelector(".e-ie-straighten-value-span");o&&(o.innerHTML=t.toString()+"&#176");this.transform.straighten;var r=sf.base.extend({},this.activeObj,null,!0);this.freeHandDrawModule.draw({prop:"setCenterSelPoints"}),this.transform.straighten=t,this.straightenPoint={x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2},this.straightenBaseImageCanvas();for(var i=0,a=this.objColl.length;i<a;i++){var s=this.objColl[i].shape;"line"!==s&&"arrow"!==s&&"path"!==s&&(this.objColl[i].rotatedAngle+=(this.transform.straighten-this.prevStraightenedDegree)*(Math.PI/180),this.selectionModule.selection({prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[i]}}))}this.transform.degree%90==0&&this.transform.degree%180!=0?(0===this.transform.straighten&&(this.transform.straighten=360),this.drawModule.draw({prop:"performPointZoom",onPropertyChange:!1,value:{x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2,type:"zoomIn",isResize:!0}}),this.drawModule.draw({prop:"performPointZoom",onPropertyChange:!1,value:{x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2,type:"zoomOut",isResize:!0}}),360===this.transform.straighten&&(this.transform.straighten=0)):this.drawModule.draw({prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:null,isStraighten:!0}}),this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r}}),this.drawModule.draw({prop:"zoomToSel",value:{activeObj:r,isToolbar:!0}}),this.transformModule.transform({prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),this.prevStraightenedDegree=this.transform.straighten},e.prototype.straightenBaseImageCanvas=function(){if(this.isImageLoaded){var e=this.getStraightenFlipState(),t="horizontal"===e||"vertical"===e?-this.transform.straighten:this.transform.straighten,o=this.baseImgCanvas.getContext("2d");if(o.canvas.width!==this.lowerContext.canvas.width&&o.canvas.height!==this.lowerContext.canvas.height){this.cropModule.cropping({prop:"calcRatio",onPropertyChange:!1,value:{obj:{width:0,height:0},dimension:{width:o.canvas.width,height:o.canvas.height}}})}var r;r=this.getRotatedCanvasDim(this.baseImg.width,this.baseImg.height,this.transform.straighten),this.img.srcWidth=o.canvas.width=r.width,this.img.srcHeight=o.canvas.height=r.height;var i=o.canvas.width/2,a=o.canvas.height/2;o.clearRect(0,0,o.canvas.width,o.canvas.height),o.translate(i,a),o.rotate(t*Math.PI/180),o.drawImage(this.baseImg,-this.baseImg.width/2,-this.baseImg.height/2,this.baseImg.width,this.baseImg.height),o.setTransform(1,0,0,1,0,0);this.cropModule.cropping({prop:"calcRatio",onPropertyChange:!1,value:{obj:{width:0,height:0},dimension:{width:o.canvas.width,height:o.canvas.height}}})}},e.prototype.getRotatedCanvasDim=function(e,t,o){var r=o*Math.PI/180,i=Math.cos(r),a=Math.sin(r),s=Math.min(0,e*i,t*Math.cos(Math.PI/2-r),e*i+t*Math.cos(Math.PI/2-r)),n=Math.max(0,e*i,t*Math.cos(Math.PI/2-r),e*i+t*Math.cos(Math.PI/2-r)),l=Math.min(0,e*a,t*Math.sin(Math.PI/2-r),e*a+t*Math.sin(Math.PI/2-r)),h=Math.max(0,e*a,t*Math.sin(Math.PI/2-r),e*a+t*Math.sin(Math.PI/2-r));return{width:Math.ceil(n-s),height:Math.ceil(h-l)}},e.prototype.updateShapeOrder=function(e,t){var o=this.getObjFromId(e);if(o&&o.shape&&("path"!==o.shape||"path"===o.shape&&o.pointColl.length>0)||o&&o.id&&o.id.indexOf("pen")>-1){var r={shapeSettingsObj:{}};this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}});var i=r.shapeSettingsObj;o.shape&&this.shapeModule.shape({prop:"pushActItemIntoObj"});var a=sf.base.extend({},this.cropObj,{},!0),s={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var n=s.currObj;n.objColl=sf.base.extend([],this.objColl,[],!0),n.pointColl=sf.base.extend([],this.pointColl,[],!0),n.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var l={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),n.selPointColl=sf.base.extend([],l.selPointColl,[],!0),o.shape&&this.objColl.pop(),this.shapeModule.shape({prop:"z-order",onPropertyChange:!1,value:{obj:o,value:t}}),o.shape&&(this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:o.strokeSettings.strokeWidth}}),this.objColl.push(o)),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.shape&&(this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),this.activeObj.order=o.order),{action:"stroke-width",previousShapeSettings:sf.base.extend({},i,{},!0),currentShapeSettings:sf.base.extend({},i,{},!0)}.currentShapeSettings.strokeWidth=this.activeObj.strokeSettings.strokeWidth}else this.activeObj.shape&&"path"===this.activeObj.shape&&0===this.activeObj.pointColl.length&&this.shapeModule.shape({prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}})},e.prototype.getStraightenFlipState=function(){var e="";if(this.rotateFlipColl.length>0)for(var t=0,o=this.rotateFlipColl.length;t<o;t++){var r=this.rotateFlipColl[t];"horizontal"===r?e+="horizontal":"vertical"===r&&(e+="vertical"),"horizontalvertical"!==e&&"verticalhorizontal"!==e||(e="")}return e},e.prototype.initializeImageEditor=function(e,t){this.element=e,this.createUploader(),this.isFirstLoad=!0,this.theme||(this.theme="Tailwind"),this.element.querySelector(".place-holder")&&this.element.querySelector(".place-holder").remove(),this.element.offsetWidth>359&&this.element.querySelector(".e-ie-min-drop-content")&&this.element.querySelector(".e-ie-drop-content")&&(this.element.querySelector(".e-ie-min-drop-content").style.display="none",this.element.querySelector(".e-ie-drop-content").style.display="block"),this.element.querySelector(".e-ie-drop-area")&&(this.element.querySelector(".e-ie-drop-area").style.display="block"),this.element.querySelector(".e-toolbar-area")&&(this.element.querySelector(".e-toolbar-area").style.display="block");var o=this.element.querySelector(".e-canvas-wrapper");this.element.querySelector("#"+this.element.id+"_toolbarArea")?this.toolbarHeight=this.element.querySelector("#"+this.element.id+"_toolbarArea").scrollHeight:this.toolbarHeight=0,o.style.height=this.element.offsetHeight-this.toolbarHeight-2+"px",o.style.width=this.element.offsetWidth-2+"px",this.lowerCanvas=this.element.querySelector(".e-lower-canvas"),this.upperCanvas=this.element.querySelector(".e-upper-canvas"),this.lowerCanvas.id=this.element.id+"_lowerCanvas",this.upperCanvas.id=this.element.id+"_upperCanvas",this.textArea=this.element.querySelector(".e-textarea"),this.inMemoryCanvas=sf.base.createElement("canvas",{id:this.element.id+"_inMemoryCanvas",attrs:{name:"canvasImage"}}),this.baseImgCanvas=sf.base.createElement("canvas",{id:this.element.id+"_baseImgCanvas",attrs:{name:"canvasImage"}}),this.upperCanvas.width=this.lowerCanvas.width=this.inMemoryCanvas.width=this.element.offsetWidth,this.upperCanvas.height=this.lowerCanvas.height=this.inMemoryCanvas.height=this.element.offsetHeight-this.toolbarHeight,this.lowerContext=this.lowerCanvas.getContext("2d"),this.baseImg=sf.base.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.upperContext=this.upperCanvas.getContext("2d"),this.inMemoryContext=this.inMemoryCanvas.getContext("2d"),t&&(this.dotNetRef=t),this.prerender(),this.wireEvent(),this.lowerContext.filter=this.getDefaultFilter(),this.filterModule.filter({prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),this.canvasFilter=this.initialAdjustmentValue=this.lowerContext.filter,this.cssClass&&sf.base.addClass([this.element],this.cssClass.replace(/\s+/g," ").trim().split(" ")),this.element&&sf.popups.createSpinner({target:this.element}),this.initializeZoomSettings(),this.imgSrc&&this.open(this.imgSrc)},e.prototype.prerender=function(){this.element.id=this.element.id||sf.base.getUniqueID("ej2-image-editor"),sf.base.Browser.isDevice&&this.element.classList.add("e-device"),this.initializeThemeColl()},e.prototype.initializeZoomSettings=function(){(sf.base.isNullOrUndefined(this.zoomSettings.zoomTrigger)||0===this.zoomSettings.zoomTrigger)&&(this.zoomSettings.zoomTrigger=i.MouseWheel|i.Pinch|i.Toolbar|i.Commands),sf.base.isNullOrUndefined(this.selectionSettings.strokeColor)&&(this.selectionSettings.strokeColor=this.themeColl[this.theme].primaryColor),sf.base.isNullOrUndefined(this.selectionSettings.fillColor)&&(this.selectionSettings.fillColor=this.themeColl[this.theme].secondaryColor)},e.prototype.initializeThemeColl=function(){this.themeColl={Bootstrap5:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Bootstrap5Dark:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Tailwind:{primaryColor:"#4f46e5",secondaryColor:"#fff"},TailwindDark:{primaryColor:"#22d3ee",secondaryColor:"#fff"},Fluent:{primaryColor:"#0078d4",secondaryColor:"#fff"},FluentDark:{primaryColor:"#0078d4",secondaryColor:"#fff"},Bootstrap4:{primaryColor:"#007bff",secondaryColor:"#fff"},Bootstrap:{primaryColor:"#317ab9",secondaryColor:"#fff"},BootstrapDark:{primaryColor:"#317ab9",secondaryColor:"#fff"},Material:{primaryColor:"#e3165b",secondaryColor:"#fff"},MaterialDark:{primaryColor:"#00b0ff",secondaryColor:"#fff"},Fabric:{primaryColor:"#0078d6",secondaryColor:"#fff"},FabricDark:{primaryColor:"#0074cc",secondaryColor:"#fff"},Highcontrast:{primaryColor:"#000000",secondaryColor:"#fff"},Material3:{primaryColor:"#6750a4",secondaryColor:"#fff"},Material3Dark:{primaryColor:"#d0bcff",secondaryColor:"#fff"},Fluent2:{primaryColor:"#0f6cbd",secondaryColor:"#fff"},Fluent2Dark:{primaryColor:"#115ea3",secondaryColor:"#fff"},Fluent2Highcontrast:{primaryColor:"#1aebff",secondaryColor:"#fff"}}},e.prototype.toolbarCreated=function(){var e=this;if(this.element.querySelector(".e-ie-toolbar-upload-btn")&&this.element.querySelector(".e-ie-toolbar-upload-btn").remove(),this.element.querySelector(".e-ie-toolbar-upload-div")&&this.element.querySelector(".e-ie-toolbar-upload-div").classList.remove("e-hide"),this.createToolbar(),this.updateColorToolbar(this.element),!sf.base.Browser.isDevice){var t=this.element.querySelector(".e-ie-toolbar-straighten .e-slider-input");t&&(t.addEventListener("custom-change",(function(t){e.transform.straighten!==parseInt(t.target.value)&&(e.updateSliderValue(parseInt(t.target.value),"straighten"),e.isStraigthenChanged=!0)})),t.addEventListener("custom-changed",(function(t){if(e.isStraigthenChanged){var o={cancel:!1,previousDegree:e.prevStraightenEvent,currentDegree:parseInt(t.target.value)};if(e.events&&!0===e.events.rotating.hasDelegate&&e.dotNetRef.invokeMethodAsync("RotateEventAsync","OnRotate",o,null),e.events&&!0===e.events.rotated.hasDelegate){var r={degree:o.currentDegree};e.dotNetRef.invokeMethodAsync("RotateEventAsync","Rotated",null,r)}e.isStraigthenChanged=!1}})));var o=this.element.querySelector(".e-ie-toolbar-straighten .e-handle");o&&(o.addEventListener("mousedown",(function(e){e.preventDefault(),e.stopPropagation()})),o.addEventListener("touchstart",(function(e){e.preventDefault(),e.stopPropagation()})));var r=this.element.querySelector(".e-ie-contextual-slider .e-slider-input");r&&(r.addEventListener("custom-change",(function(t){var o=e.element.querySelector(".e-ie-contextual-slider .e-ie-slider-label").getAttribute("data-id");"finetune"===o&&(o="brightness"),e.getCurrAdjustmentValue(o)!==parseInt(t.target.value)&&e.updateSliderValue(parseInt(t.target.value),o)})),r.addEventListener("custom-changed",(function(t){var o=e.element.querySelector(".e-ie-contextual-slider .e-ie-slider-label").getAttribute("data-id");"finetune"===o&&(o="brightness"),"transparency"!==o?(e.selectionModule.selection({prop:"setSliding",value:{bool:!1}}),e.drawModule.draw({prop:"redrawDownScale"})):e.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})}))),this.updateResizeTextbox()}for(var i=0;i<Object.keys(window.sfBlazor.instances).length;i++)if(Object.keys(window.sfBlazor.instances)[i].includes("sfToolbar")){var a=Object.keys(window.sfBlazor.instances)[i],s=window.sfBlazor.getCompInstance(a);if(s.element.attributes.dataId&&s.element.attributes.dataId.value===this.dataId+"_main-toolbar"){this.toolbarId=a;break}}},e.prototype.bottomToolbarCreated=function(){var e=this,t=this.element.querySelector(".e-ie-contextual-slider .e-slider-input");t&&(t.addEventListener("custom-change",(function(t){var o=e.element.querySelector(".e-ie-contextual-slider .e-ie-slider-label").getAttribute("data-id");"finetune"===o&&(o="brightness"),"crop"===o&&(o="straighten"),("straighten"===o?e.transform.straighten:e.getCurrAdjustmentValue(o))!==parseInt(t.target.value)&&(e.updateSliderValue(parseInt(t.target.value),o),"straighten"===o&&(e.isStraigthenChanged=!0))})),t.addEventListener("custom-changed",(function(t){var o=e.element.querySelector(".e-ie-contextual-slider .e-ie-slider-label").getAttribute("data-id");if("finetune"===o&&(o="brightness"),"crop"===o&&(o="straighten"),"transparency"!==o&&"straighten"!==o)e.selectionModule.selection({prop:"setSliding",value:{bool:!1}}),e.drawModule.draw({prop:"redrawDownScale"});else if("straighten"===o&&this.isStraigthenChanged){var r={cancel:!1,previousDegree:e.prevStraightenEvent,currentDegree:parseInt(t.target.value)};if(e.events&&!0===e.events.rotating.hasDelegate&&e.dotNetRef.invokeMethodAsync("RotateEventAsync","OnRotate",r,null),e.events&&!0===e.events.rotated.hasDelegate){var i={degree:r.currentDegree};e.dotNetRef.invokeMethodAsync("RotateEventAsync","Rotated",null,i)}e.isStraigthenChanged=!1}}))),this.updateResizeTextbox();for(var o=0;o<Object.keys(window.sfBlazor.instances).length;o++)if(Object.keys(window.sfBlazor.instances)[o].includes("sfToolbar")){var r=Object.keys(window.sfBlazor.instances)[o],i=window.sfBlazor.getCompInstance(r);if(i.element.attributes.dataId&&i.element.attributes.dataId.value===this.dataId+"_bottom-toolbar"){this.bottomToolbarId=r;break}}},e.prototype.canvasToolbarCreated=function(){for(var e=0;e<Object.keys(window.sfBlazor.instances).length;e++)if(Object.keys(window.sfBlazor.instances)[e].includes("sfToolbar")){var t=Object.keys(window.sfBlazor.instances)[e],o=window.sfBlazor.getCompInstance(t);if(o.element.attributes.dataId&&o.element.attributes.dataId.value===this.dataId+"_canvas-toolbar"){this.canvasToolbarId=t;break}}},e.prototype.updateToolbar=function(e,t,o){switch(t){case"imageLoaded":switch(this.currentToolbar){case"text-toolbar":this.updateTextToolbar(e,!1);break;case"line-toolbar":case"path-toolbar":this.updateLineToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1);break;case"rectangle-toolbar":case"ellipse-toolbar":this.updateRectangleToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"crop-toolbar":if(this.updateCropToolbar(e,!1),sf.base.Browser.isDevice)this.element.querySelector(".e-ie-contextual-slider .e-slider-container")&&this.element.querySelector(".e-ie-contextual-slider .e-slider-container").classList.remove("e-straighten-slider"),this.updateContextualToolbar(e,!1),this.element.querySelector(".e-bottom-toolbar-area").style.marginTop="";break;case"contextual-toolbar":this.updateContextualToolbar(e,!1),"okBtnClick"===o&&this.okBtn();break;case"pen-toolbar":this.updatePenToolbar(e,!1);break;case"addImage-toolbar":sf.base.Browser.isDevice&&this.element.querySelector(".e-ie-contextual-slider .e-slider-container")&&this.element.querySelector(".e-ie-contextual-slider .e-slider-container").classList.remove("e-ie-device-transparency-slider"),this.updateContextualToolbar(e,!1),this.updateImageToolbar(e,!1);break;case"resize-toolbar":this.updateResizeToolbar(e,!1),this.queryToAddRemoveClass(e,".e-ie-toolbar-undo","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-redo","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-in","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-out","e-hidden",!0);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1),"okBtnClick"===o&&this.okBtn()}"main-toolbar"!==this.currentToolbar&&(this.updateMainToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!1),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!1)),"initial"!==o&&"unloaded"!==o||(this.queryToAddRemoveClass(e,".e-ie-toolbar-undo","e-hidden","initial"===o),this.queryToAddRemoveClass(e,".e-ie-toolbar-redo","e-hidden","initial"===o),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-in","e-hidden","initial"===o),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-out","e-hidden","initial"===o),this.updateMainToolbar(e,"initial"===o),this.updateRightToolbar(e,"initial"===o)),this.isInteracted=!1,this.enableDisableToolbarBtn(),"quick-access-toolbar"===this.quickAccessToolbar&&this.destroyQuickAccessToolbar(),this.currentToolbar="main-toolbar";break;case"line":case"path":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":case"ellipse-toolbar":this.updateRectangleToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1);break;case"addImage-toolbar":this.updateContextualToolbar(e,!1),this.updateImageToolbar(e,!1);break;case"resize-toolbar":this.updateResizeToolbar(e,!1);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1)}"line"===t||"pathQuickAccessToolbar"===o||"path"===t&&sf.base.Browser.isDevice?(this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)):"path"!==t||sf.base.Browser.isDevice||(this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!1),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!1)),!this.events||!0!==this.events.toolbarUpdating.hasDelegate||"line-toolbar"!==this.currentToolbar&&"path-toolbar"!==this.currentToolbar||this.updateLineToolbar(e,!1,this.currentToolbar.split("-")[0]),this.updateLineToolbar(e,!0,t,o),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.currentToolbar=t+"-toolbar";break;case"arrow":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":case"ellipse-toolbar":this.updateRectangleToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1);break;case"line-toolbar":case"path-toolbar":this.updateLineToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"addImage-toolbar":this.updateContextualToolbar(e,!1),this.updateImageToolbar(e,!1);break;case"resize-toolbar":this.updateResizeToolbar(e,!1);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1)}"arrow-toolbar"!==this.currentToolbar&&(this.updateArrowToolbar(e,!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.currentToolbar="arrow-toolbar";break;case"text":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":case"ellipse-toolbar":this.updateRectangleToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"line-toolbar":case"path-toolbar":this.updateLineToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1);break;case"addImage-toolbar":this.updateContextualToolbar(e,!1),this.updateImageToolbar(e,!1);break;case"resize-toolbar":this.updateResizeToolbar(e,!1);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1)}"text-toolbar"!==this.currentToolbar&&(this.updateTextToolbar(e,!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.currentToolbar="text-toolbar";break;case"rectangle":case"ellipse":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"line-toolbar":case"path-toolbar":this.updateLineToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1);break;case"pen-toolbar":this.updatePenToolbar(e,!1);break;case"addImage-toolbar":this.updateContextualToolbar(e,!1),this.updateImageToolbar(e,!1);break;case"resize-toolbar":this.updateResizeToolbar(e,!1);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1)}!this.events||!0!==this.events.toolbarUpdating.hasDelegate||"rectangle-toolbar"!==this.currentToolbar&&"ellipse-toolbar"!==this.currentToolbar||this.updateRectangleToolbar(e,!1,this.currentToolbar.split("-")[0]),this.updateRectangleToolbar(e,!0,t),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0),this.currentToolbar=t+"-toolbar";break;case"cropToolbar":"contextual-toolbar"===this.currentToolbar&&this.updateContextualToolbar(e,!1),this.updateMainToolbar(e,!1),this.updateCropToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0),this.currentToolbar="crop-toolbar";break;case"pen":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":case"ellipse-toolbar":this.updateRectangleToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"line-toolbar":case"path-toolbar":this.updateLineToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1);break;case"addImage-toolbar":this.updateContextualToolbar(e,!1),this.updateImageToolbar(e,!1);break;case"resize-toolbar":this.updateResizeToolbar(e,!1);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1)}"pen-toolbar"!==this.currentToolbar&&(this.updatePenToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0),this.updateColorToolbar(this.element,this.activeObj.strokeSettings,t)),this.currentToolbar="pen-toolbar";break;case"colorToolbar":this.updateColorToolbar(this.element,this.activeObj.strokeSettings,this.currentToolbar.split("-")[0]);break;case"enableDisableToolbarBtn":this.enableDisableToolbarBtn(o);break;case"quickAccessToolbar":this.updateQuickAccessToolbar(o);break;case"destroyQuickAccessToolbar":this.destroyQuickAccessToolbar();break;case"closeContextualToolbar":this.updateContextualToolbar(e,!1),"main-toolbar"!==this.currentToolbar&&("frame-toolbar"===this.currentToolbar&&this.updateFrameToolbar(e,!1),this.updateMainToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!1),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!1)),this.currentToolbar="main-toolbar";break;case"image":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"rectangle-toolbar":case"ellipse-toolbar":this.updateRectangleToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"line-toolbar":case"path-toolbar":this.updateLineToolbar(e,!1,this.currentToolbar.split("-")[0]);break;case"text-toolbar":this.updateTextToolbar(e,!1);break;case"arrow-toolbar":this.updateArrowToolbar(e,!1);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1)}"addImage-toolbar"!==this.currentToolbar&&(this.updateImageToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.updateColorToolbar(this.element,"no-color",t),this.currentToolbar="addImage-toolbar";break;case"resize":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"contextual-toolbar":this.updateMainToolbar(e,!1),this.updateContextualToolbar(e,!1);break;case"frame-toolbar":this.updateContextualToolbar(e,!1),this.updateFrameToolbar(e,!1)}"resize-toolbar"!==this.currentToolbar&&(this.updateResizeToolbar(e,!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-undo","e-hidden",!1),this.queryToAddRemoveClass(e,".e-ie-toolbar-redo","e-hidden",!1),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-in","e-hidden",!1),this.queryToAddRemoveClass(e,".e-ie-toolbar-zoom-out","e-hidden",!1),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.currentToolbar="resize-toolbar";break;case"nonAspectRatio":case"aspectRatio":"nonAspectRatio"===t?(this.queryToAddRemoveClass(this.element,".e-ie-toolbar-nonaspect-ratio-btn","e-hidden",!1),this.queryToAddRemoveClass(this.element,".e-ie-toolbar-aspect-ratio-btn","e-hidden",!0),this.currentResizeRatio="aspect"):(this.queryToAddRemoveClass(this.element,".e-ie-toolbar-aspect-ratio-btn","e-hidden",!1),this.queryToAddRemoveClass(this.element,".e-ie-toolbar-nonaspect-ratio-btn","e-hidden",!0),this.currentResizeRatio="non-aspect");break;case"frame":switch(this.currentToolbar){case"main-toolbar":this.updateMainToolbar(e,!1);break;case"contextual-toolbar":this.updateMainToolbar(e,!1),this.updateContextualToolbar(e,!1)}"frame-toolbar"!==this.currentToolbar&&(this.updateFrameToolbar(e,!0),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0)),this.currentToolbar="frame-toolbar"}var r=window.sfBlazor.getCompInstance(this.toolbarId);if(r){if((a=r.scrollModule)&&r.element.querySelector(".e-scroll-right-nav").classList.contains("e-overlay")){var i=r.element.querySelector(".e-hscroll-bar");i.scrollLeft+i.offsetWidth<i.scrollWidth&&r.destroyScroll()}r.refreshOverflow(),a&&!r.scrollModule&&r.itemPositioning()}if(sf.base.Browser.isDevice){var a,s=window.sfBlazor.getCompInstance(this.bottomToolbarId);if(s)(a=s.scrollModule)&&s.element.querySelector(".e-scroll-right-nav")&&s.destroyScroll(),s.refreshOverflow(),a&&!s.scrollModule&&s.itemPositioning()}},e.prototype.queryToAddRemoveClass=function(e,t,o,r){var i=e.querySelector(t);i&&(r?i.classList.remove(o):i.classList.add(o))},e.prototype.updateTextToolbar=function(e,t){var o=this;(this.events&&!0===this.events.toolbarUpdating.hasDelegate?this.textToolbar:[this.ANNOTATEBTN,this.FONTFAM,this.BOLDBTN,this.ITALICBTN,this.FONTCLR,this.FONTSIZE,".e-ie-toolbar-main-zOrder-btn",this.MAINSEP,this.MCLONEBTN,this.MDELBTN,this.MEDITBTN]).forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)})),[this.MCLONEBTN,this.MDELBTN,this.MEDITBTN,".e-ie-toolbar-main-zOrder-btn"].forEach((function(t){o.queryToAddRemoveClass(e,t,"e-overlay",!1)}))},e.prototype.updateLineToolbar=function(e,t,o,r){var i,a=this;this.events&&!0===this.events.toolbarUpdating.hasDelegate?"line"===o?i=this.lineToolbar:"path"===o&&(i=this.pathToolbar):i=[this.ANNOTATEBTN,this.LINECLR,".e-ie-toolbar-e-line-size",".e-ie-toolbar-main-zOrder-btn",this.MAINSEP,this.MCLONEBTN,this.MDELBTN],i.forEach((function(o){a.queryToAddRemoveClass(e,o,"e-hidden",t)})),[this.MCLONEBTN,this.MDELBTN,".e-ie-toolbar-main-zOrder-btn"].forEach((function(o){var i="pathQuickAccessToolbar"===r;a.queryToAddRemoveClass(e,o,"e-overlay",t&&i)}))},e.prototype.updateArrowToolbar=function(e,t){var o,r=this;this.events&&!0===this.events.toolbarUpdating.hasDelegate?o=this.arrowToolbar:(this.updateLineToolbar(e,t),o=[this.ANNOTATEBTN,".e-ie-toolbar-e-arrow-start",".e-ie-toolbar-e-arrow-end",".e-ie-toolbar-main-zOrder-btn",this.MAINSEP,this.MCLONEBTN,this.MDELBTN]),o.forEach((function(o){r.queryToAddRemoveClass(e,o,"e-hidden",t)})),[this.MCLONEBTN,this.MDELBTN,".e-ie-toolbar-main-zOrder-btn"].forEach((function(t){r.queryToAddRemoveClass(e,t,"e-overlay",!1)}))},e.prototype.updateRectangleToolbar=function(e,t,o){var r,i=this;this.events&&!0===this.events.toolbarUpdating.hasDelegate?"rectangle"===o?r=this.rectangleToolbar:"ellipse"===o&&(r=this.ellipseToolbar):r=[this.ANNOTATEBTN,this.SHAPEFILLCLR,this.SHAPECLR,".e-ie-toolbar-e-noshape-size",".e-ie-toolbar-main-zOrder-btn",this.MAINSEP,this.MCLONEBTN,this.MDELBTN],r.forEach((function(o){i.queryToAddRemoveClass(e,o,"e-hidden",t)})),[this.MCLONEBTN,this.MDELBTN,".e-ie-toolbar-main-zOrder-btn"].forEach((function(o){i.queryToAddRemoveClass(e,o,"e-overlay",!t)}))},e.prototype.updateCropToolbar=function(e,t){var o=this;[".e-ie-toolbar-crop",".e-ie-toolbar-crop-separator",".e-ie-toolbar-rotateleft-btn",".e-ie-toolbar-rotateright-btn",".e-ie-toolbar-horizontalflip-btn",".e-ie-toolbar-verticalflip-btn",".e-ie-toolbar-straighten-separator",".e-ie-toolbar-straighten"].forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)}))},e.prototype.updatePenToolbar=function(e,t){var o=this;(this.events&&!0===this.events.toolbarUpdating.hasDelegate?this.penToolbar:[this.ANNOTATEBTN,this.PENCLR,".e-ie-toolbar-e-pen-size",".e-ie-toolbar-main-zOrder-btn",this.MAINSEP,this.MDELBTN]).forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)})),[this.MDELBTN,".e-ie-toolbar-main-zOrder-btn"].forEach((function(r){o.queryToAddRemoveClass(e,r,"e-overlay",!t)}))},e.prototype.updateImageToolbar=function(e,t){var o=this;(this.events&&!0===this.events.toolbarUpdating.hasDelegate?this.imageToolbar:[this.ANNOTATEBTN,".e-ie-toolbar-rotateLeft-btn",".e-ie-toolbar-rotateRight-btn",".e-ie-toolbar-main-horizontalFlip-btn",".e-ie-toolbar-main-verticalFlip-btn",".e-ie-toolbar-main-image-separator",".e-ie-toolbar-main-transparency-btn",".e-ie-toolbar-main-zOrder-btn",this.MAINSEP,this.MCLONEBTN,this.MDELBTN]).forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)}))},e.prototype.updateResizeToolbar=function(e,t){var o=this;[".e-ie-toolbar-resize-width-btn",".e-ie-resize-width",".e-ie-toolbar-e-resize-width-input",".e-ie-toolbar-resize-height-btn",".e-ie-resize-height",".e-ie-toolbar-e-resize-height-input"].forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)})),"non-aspect"===this.currentResizeRatio?this.queryToAddRemoveClass(e,".e-ie-toolbar-nonaspect-ratio-btn","e-hidden",t):this.queryToAddRemoveClass(e,".e-ie-toolbar-aspect-ratio-btn","e-hidden",t)},e.prototype.updateFrameToolbar=function(e,t){var o=this;[".e-ie-toolbar-frame-none-btn",".e-ie-toolbar-frame-mat-btn",".e-ie-toolbar-frame-bevel-btn",".e-ie-toolbar-frame-line-btn",".e-ie-toolbar-frame-inset-btn",".e-ie-toolbar-frame-hook-btn"].forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)}))},e.prototype.updateMainToolbar=function(e,t){var o=this,r=[".e-ie-toolbar-crop-btn",".e-ie-toolbar-main-annotation",".e-ie-toolbar-finetune-btn",".e-ie-toolbar-filter-btn",".e-ie-toolbar-main-frame-btn",".e-ie-toolbar-main-resize-btn"];sf.base.Browser.isDevice&&(r.push(".e-ie-toolbar-upload"),r.push(".e-ie-toolbar-reset-btn"),r.push(".e-ie-toolbar-save-btn")),r.forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)})),e.querySelectorAll(".e-ie-toolbar-custom").forEach((function(e){e.classList.toggle("e-hidden",!t)}))},e.prototype.updateRightToolbar=function(e,t){var o=this;[".e-ie-toolbar-reset-btn",".e-ie-toolbar-save-btn"].forEach((function(r){o.queryToAddRemoveClass(e,r,"e-hidden",t)}))},e.prototype.enableDisableToolbarBtn=function(e){var t=this,o={appliedUndoRedoColl:[]};this.undoRedoModule.undoRedo({prop:"getAppliedUndoRedoColl",value:{obj:o}});var r={undoRedoStep:null};if(this.undoRedoModule.undoRedo({prop:"getUndoRedoStep",value:{obj:r}}),this.element.querySelector(".e-ie-toolbar-undo")){var i=this.element.querySelector("#undo");i&&(0===r.undoRedoStep?(i.classList.add("e-overlay"),i.setAttribute("aria-disabled","true")):(i.classList.remove("e-overlay"),i.setAttribute("aria-disabled","false")));var a=this.element.querySelector("#redo");a&&(r.undoRedoStep===o.appliedUndoRedoColl.length?(a.classList.add("e-overlay"),a.setAttribute("aria-disabled","true")):(0===r.undoRedoStep&&o.appliedUndoRedoColl.length>0||r.undoRedoStep>0)&&(a.classList.remove("e-overlay"),a.setAttribute("aria-disabled","false")))}var s=this.element.querySelector("#zoomin");s&&(this.zoomSettings.zoomFactor>=this.zoomSettings.maxZoomFactor?(s.classList.add("e-overlay"),s.setAttribute("aria-disabled","true")):(s.classList.remove("e-overlay"),s.setAttribute("aria-disabled","false")));var n=this.element.querySelector("#zoomout");n&&(this.zoomSettings.zoomFactor<=this.zoomSettings.minZoomFactor?(n.classList.add("e-overlay"),n.setAttribute("aria-disabled","true")):(n.classList.remove("e-overlay"),n.setAttribute("aria-disabled","false")));var l=document.querySelector(".e-ie-toolbar-main-frame-btn");l&&(this.currSelectionPoint&&"crop-circle"===this.currSelectionPoint.shape||this.isCircleCrop)?l.classList.add("e-overlay"):l&&l.classList.remove("e-overlay");var h=[this.MCLONEBTN,this.MDELBTN,this.MEDITBTN,".e-ie-toolbar-main-zOrder-btn"];"textAreaClicked"===e?h.forEach((function(e){t.queryToAddRemoveClass(t.element,e,"e-overlay",!1)})):h.forEach((function(e){t.queryToAddRemoveClass(t.element,e,"e-overlay",!0)}))},e.prototype.updateContextualToolbar=function(e,t){var o=this;if(t&&e.querySelector(this.CTWRAPPER)){if("main-toolbar"===this.currentToolbar){this.updateMainToolbar(e,!1),this.queryToAddRemoveClass(e,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CLOSEBTN,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CTWRAPPER,"e-hidden",!0),this.queryToAddRemoveClass(e,this.CTTOOLBAR,"e-hidden",!1),this.queryToAddRemoveClass(e,".e-ie-contextual-slider","e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-toolbar-brightness-btn","e-hidden",!0);var r=e.querySelector(".e-ie-toolbar-brightness-btn");r&&r.children.length>0&&r.children[0].focus();[".e-ie-toolbar-contrast-btn",".e-ie-toolbar-hue-btn",".e-ie-toolbar-saturation-btn",".e-ie-toolbar-grain-btn",".e-ie-toolbar-opacity-btn",".e-ie-toolbar-blur-btn"].forEach((function(t){o.queryToAddRemoveClass(e,t,"e-hidden",!0)})),this.currentToolbar="contextual-toolbar"}else this.queryToAddRemoveClass(e,this.CTWRAPPER,"e-hidden",!0),this.queryToAddRemoveClass(e,".e-ie-contextual-slider","e-hidden",!0);var i=e.querySelector("#"+e.id+"_toolbarArea"),a=e.querySelector("#"+e.id+"_contextualToolbarArea");if(a.style.left=i.offsetLeft+"px",sf.base.Browser.isDevice){var s=a.offsetHeight+1,n=e.querySelector("#"+e.id+"_canvasWrapper").offsetHeight;a.style.top=this.toolbarHeight+n-s+"px"}else a.style.top=this.toolbarHeight+"px";var l=window.sfBlazor.getCompInstance(this.toolbarId);if(l&&l.refreshOverflow(),sf.base.Browser.isDevice){var h=window.sfBlazor.getCompInstance(this.bottomToolbarId);h&&h.refreshOverflow()}}else{[this.CHECKBTN,this.CLOSEBTN,this.CTWRAPPER,this.CTTOOLBAR,".e-ie-contextual-slider",".e-ie-toolbar-brightness-btn",".e-ie-toolbar-contrast-btn",".e-ie-toolbar-hue-btn",".e-ie-toolbar-saturation-btn",".e-ie-toolbar-grain-btn",".e-ie-toolbar-opacity-btn",".e-ie-toolbar-blur-btn",".e-ie-toolbar-filter-default",".e-ie-toolbar-filter-chrome",".e-ie-toolbar-filter-cold",".e-ie-toolbar-filter-warm",".e-ie-toolbar-filter-greyscale",".e-ie-toolbar-filter-sepia",".e-ie-toolbar-filter-invert",".e-ie-toolbar-e-frame-color",".e-ie-toolbar-e-frame-size",".e-ie-toolbar-e-frame-inset",".e-ie-toolbar-e-frame-offset",".e-ie-toolbar-e-frame-radius",".e-ie-toolbar-e-frame-amnt",".e-ie-toolbar-e-frame-border",".e-ie-toolbar-e-frame-gradient"].forEach((function(t){o.queryToAddRemoveClass(e,t,"e-hidden",!1)}))}},e.prototype.updateColorToolbar=function(e,t,o){if(t){[this.FONTCLR+this.DDBPREVIEW,this.SHAPECLR+this.DDBPREVIEW,this.LINECLR+this.DDBPREVIEW].forEach((function(o){var r=e.querySelector(o);r&&(r.style.background=t.strokeColor)})),(s=e.querySelector(this.SHAPEFILLCLR+this.DDBPREVIEW))&&(""===t.fillColor?s.classList.add("e-nocolor-item"):(s.classList.contains("e-nocolor-item")&&s.classList.remove("e-nocolor-item"),s.style.background=t.fillColor));var r=e.querySelector(this.PENCLR+this.DDBPREVIEW);if(r&&(r.style.background=t.strokeColor),"text"===o){var i=this.element.querySelector(this.BOLDBTN+" .e-btn"),a=this.element.querySelector(this.ITALICBTN+" .e-btn");i&&(this.activeObj.textSettings.bold?i.classList.add("e-selected-btn"):i.classList.remove("e-selected-btn")),a&&(this.activeObj.textSettings.italic?a.classList.add("e-selected-btn"):a.classList.remove("e-selected-btn"))}}else{var s;[this.FONTCLR+this.DDBPREVIEW,this.SHAPECLR+this.DDBPREVIEW,this.LINECLR+this.DDBPREVIEW,this.PENCLR+this.DDBPREVIEW,".e-ie-toolbar-e-frame-color"+this.DDBPREVIEW].forEach((function(t){var o=e.querySelector(t);o&&(o.style.background="#fff")})),(s=e.querySelector(this.SHAPEFILLCLR+this.DDBPREVIEW))&&s.classList.add("e-nocolor-item");var n=e.querySelector(".e-ie-toolbar-e-frame-gradient"+this.DDBPREVIEW);n&&n.classList.add("e-nocolor-item")}},e.prototype.contextualToolbarClicked=function(e){var t=this;if("frame-toolbar"!==this.currentToolbar){var o=this.element.querySelector(this.CTWRAPPER+" .e-toolbar-item.e-selected");o&&o.classList.remove("e-selected"),this.element.querySelector("#"+e).classList.add("e-selected"),this.currObjType.isFiltered=!0;var r={filter:this.toPascalCase(e),cancel:!1};if(this.events&&!0===this.events.imageFiltering.hasDelegate)this.dotNetRef.invokeMethodAsync("OnImageFilterEventAsync","ImageFiltering",r,null).then((function(o){o.cancel||(t.filterModule.filter({prop:"applyImageFilter",value:{option:e.toLowerCase()}}),t.currentFilter=e,t.enableDisableToolbarBtn(),t.drawModule.draw({prop:"redrawDownScale"}),t.isFilterCanvasClick=!0,t.curFilterObjEvent=o)}));else{if(r.cancel)return;this.filterModule.filter({prop:"applyImageFilter",value:{option:e.toLowerCase()}}),this.currentFilter=e,this.enableDisableToolbarBtn(),this.drawModule.draw({prop:"redrawDownScale"}),this.isFilterCanvasClick=!0,this.curFilterObjEvent=r}}},e.prototype.quickAccessToolbarClicked=function(e){if(!sf.base.isNullOrUndefined(e)){var t=null,o={prevActObj:null},r={tempObj:null},i=void 0,a=void 0,s=void 0,n=void 0,l=void 0;this.drawModule.draw({prop:"getPrevActObj",onPropertyChange:!1,value:{obj:o}}),this.selectionModule.selection({prop:"getTempActObj",onPropertyChange:!1,value:{obj:r}}),r.tempObj.activePoint.height=Math.abs(r.tempObj.activePoint.height);var h=void 0,p={freehandSelectedIndex:null},d={order:null};switch(e){case"clone":JSON.stringify(r.tempObj)===JSON.stringify(this.activeObj)&&(t=!0),this.duplicateShape(t);break;case"delete":this.noPushUndo=!1,this.selectionModule.selection({prop:"deleteItem",onPropertyChange:!1}),this.drawingShape||this.updateToolbar(this.element,"imageLoaded");break;case"editText":if(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.selectionModule.selection({prop:"setTempActObj",onPropertyChange:!1,value:{obj:sf.base.extend({},this.activeObj,{},!0)}}),this.selectionModule.selection({prop:"setInitialTextEdit",onPropertyChange:!1,value:{bool:!0}}),this.drawModule.draw({prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:sf.base.extend({},this.activeObj,{},!0)}}),i={x:this.activeObj.activePoint.startX,y:this.activeObj.activePoint.startY},0!==this.activeObj.rotatedAngle){var c={x:i.x,y:i.y};this.shapeModule.shape({prop:"getTextBoxPosition",onPropertyChange:!1,value:{obj:this.activeObj,object:c}}),i.x=c.x,i.y=c.y}h=sf.base.extend({},this.activeObj,{},!0),this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.lowerContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawModule.draw({prop:"redrawImgWithObj",onPropertyChange:!1}),this.drawModule.draw({prop:"redrawDownScale"}),this.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.drawModule.draw({prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),this.activeObj=h,this.shapeModule.shape({prop:"renderTextArea",onPropertyChange:!1,value:{x:i.x,y:i.y,actObj:this.activeObj}}),(sf.base.isNullOrUndefined(this.activeObj.currIndex)||o.prevActObj)&&this.drawModule.draw({prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}}),(a=document.getElementById(this.element.id+"_quickAccessToolbarArea"))&&(a.style.display="none"),(s=this.element.querySelector(this.MCLONEBTN))&&s.classList.add("e-overlay"),(n=this.element.querySelector(this.MDELBTN))&&n.classList.add("e-overlay"),(l=this.element.querySelector(this.MEDITBTN))&&l.classList.add("e-overlay");break;case"horizontalFlip":this.element.querySelector(".e-ie-toolbar-main-horizontalFlip-btn").classList.contains("e-overlay")||this.horizontalFlip(this.activeObj.imageCanvas.getContext("2d"));break;case"verticalFlip":this.element.querySelector(".e-ie-toolbar-main-verticalFlip-btn").classList.contains("e-overlay")||this.verticalFlip(this.activeObj.imageCanvas.getContext("2d"));break;case"rotateLeft":this.element.querySelector(".e-ie-toolbar-rotateLeft-btn").classList.contains("e-overlay")||this.rotateImage("rotleft");break;case"rotateRight":this.element.querySelector(".e-ie-toolbar-rotateRight-btn").classList.contains("e-overlay")||this.rotateImage("rotright");break;case"bring-to-front":this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:p}});var u=null!==p.freehandSelectedIndex?this.pointColl[p.freehandSelectedIndex].id:this.activeObj.currIndex;this.updateShapeOrder(u,"bringtofront");var v=!1;if(this.shapeModule.shape({prop:"getHighestOrder",onPropertyChange:!1,value:{obj:d}}),u.indexOf("pen")>-1)this.shapeModule.shape({prop:"updateShapeColl",onPropertyChange:!1}),v=this.getObjFromId(u).order>=d.order;else v=this.getObjFromId(u).order>d.order;v?document.querySelector(".e-ie-toolbar-bring-to-front").classList.add("e-disabled"):document.querySelector(".e-ie-toolbar-bring-to-front").classList.remove("e-disabled")}"clone"!==e&&"delete"!==e||this.drawModule.draw({prop:"redrawDownScale"})}},e.prototype.updateQuickAccessToolbar=function(e){var t,o=this;switch(e){case"pen":this.queryToAddRemoveClass(this.element,".e-ie-toolbar-main-zOrder-btn","e-overlay",!0),this.queryToAddRemoveClass(this.element,this.MDELBTN,"e-overlay",!0),t=[{Name:"BringToFront"},{Name:"Delete"}];break;case"shape":case"ellipse":case"rectangle":case"arrow":case"line":case"path":this.queryToAddRemoveClass(this.element,".e-ie-toolbar-main-zOrder-btn","e-overlay",!0),this.queryToAddRemoveClass(this.element,this.MCLONEBTN,"e-overlay",!0),this.queryToAddRemoveClass(this.element,this.MDELBTN,"e-overlay",!0),t=[{Name:"BringToFront"},{Name:"Clone"},{Name:"Delete"}];break;case"text":t=[{Name:"BringToFront"},{Name:"Clone"},{Name:"Delete"},{Name:"EditText"}];break;case"image":t=[{Name:"BringToFront"},{Name:"HorizontalFlip"},{Name:"VerticalFlip"},{Name:"Clone"},{Name:"Delete"}]}var r={cancel:!1,shape:e,toolbarItems:t};"pen"===e&&(r.shape="freehanddraw"),this.events&&this.events.quickAccessToolbarOpening.hasDelegate?this.dotNetRef.invokeMethodAsync("QuickAccessToolbarEventAsync",r).then((function(t){t.cancel||o.renderQuickAccessToolbar(t.toolbarItems,e)})):this.renderQuickAccessToolbar(t,e)},e.prototype.destroyQuickAccessToolbar=function(){document.getElementById(this.element.id+"_quickAccessToolbarArea")&&(document.getElementById(this.element.id+"_quickAccessToolbarArea").style.display="none");var e=this.element.querySelector(this.CLONEBTN),t=this.element.querySelector(this.DELBTN),o=this.element.querySelector(this.EDITBTN),r=this.element.querySelector(this.HORIZONTALFLIPBTN),i=this.element.querySelector(this.VERTICALFLIPBTN);e&&e.removeAttribute("style"),t&&t.removeAttribute("style"),o&&o.removeAttribute("style"),r&&r.removeAttribute("style"),i&&i.removeAttribute("style"),this.queryToAddRemoveClass(this.element,this.CLONEBTN,"e-hidden",!1),this.queryToAddRemoveClass(this.element,this.DELBTN,"e-hidden",!1),this.queryToAddRemoveClass(this.element,this.EDITBTN,"e-hidden",!1),this.queryToAddRemoveClass(this.element,this.HORIZONTALFLIPBTN,"e-hidden",!1),this.queryToAddRemoveClass(this.element,this.VERTICALFLIPBTN,"e-hidden",!1),this.element.querySelectorAll(".e-ie-qat").forEach((function(e){e.classList.add("e-hidden"),e.removeAttribute("style")})),this.quickAccessToolbar=""},e.prototype.renderQuickAccessToolbar=function(e,t){if(this.activeObj&&this.showQuickAccessToolbar){var o=document.getElementById(this.element.id+"_quickAccessToolbarArea");document.getElementById(this.element.id+"_quickAccessToolbarArea")&&(document.getElementById(this.element.id+"_quickAccessToolbarArea").style.display="block");var r=this.toolbarHeight&&0!==this.toolbarHeight?this.toolbarHeight:o.clientHeight,i=0;if(e&&(i=e.length),sf.base.isNullOrUndefined(this.quickAccessToolbarTemplate))for(var a=this.element.querySelector(this.CLONEBTN),s=this.element.querySelector(this.DELBTN),n=this.element.querySelector(this.EDITBTN),l=this.element.querySelector(this.HORIZONTALFLIPBTN),h=this.element.querySelector(this.VERTICALFLIPBTN),p=this.element.querySelector(".e-ie-toolbar-bring-to-front"),d={freehandSelectedIndex:-1},c=0;c<i;c++){switch(e[c].name||e[c].Name){case"BringToFront":this.queryToAddRemoveClass(this.element,".e-ie-toolbar-bring-to-front","e-hidden",!0),0===c&&p&&(p.style.marginLeft=window.getComputedStyle(p).marginLeft);var u={order:null};this.shapeModule.shape({prop:"getHighestOrder",onPropertyChange:!1,value:{obj:u}}),sf.base.isNullOrUndefined(this.activeObj.shape)?(this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:d}}),this.getObjFromId(this.pointColl[d.freehandSelectedIndex].id).order>=u.order?p.classList.add("e-disabled"):p.classList.remove("e-disabled")):this.activeObj.order>u.order?p.classList.add("e-disabled"):p.classList.remove("e-disabled");break;case"Clone":this.queryToAddRemoveClass(this.element,this.CLONEBTN,"e-hidden",!0),c===i-1&&a&&(a.style.marginRight=window.getComputedStyle(l).marginLeft),0===c&&a&&l&&(a.style.marginLeft=window.getComputedStyle(l).marginLeft);break;case"Delete":this.queryToAddRemoveClass(this.element,this.DELBTN,"e-hidden",!0),0===c&&s&&l&&(s.style.marginLeft=window.getComputedStyle(l).marginLeft),c===i-1&&l&&s&&n&&(s.style.marginRight=window.getComputedStyle(l).marginLeft);break;case"EditText":this.queryToAddRemoveClass(this.element,this.EDITBTN,"e-hidden",!0),0===c&&n&&l&&(n.style.marginLeft=window.getComputedStyle(l).marginLeft);break;case"HorizontalFlip":this.queryToAddRemoveClass(this.element,this.HORIZONTALFLIPBTN,"e-hidden",!0),c===i-1&&l&&(l.style.marginLeft=window.getComputedStyle(l).marginLeft);break;case"VerticalFlip":this.queryToAddRemoveClass(this.element,this.VERTICALFLIPBTN,"e-hidden",!0),0===c&&h&&l&&(h.style.marginLeft=window.getComputedStyle(l).marginLeft),c===i-1&&l&&h&&n&&(h.style.marginRight=window.getComputedStyle(l).marginLeft)}if(sf.base.isNullOrUndefined(e[c].name)&&sf.base.isNullOrUndefined(e[c].Name)){this.queryToAddRemoveClass(this.element,"."+e[c].cssClass.split(" ")[1],"e-hidden",!0);var v=this.element.querySelector("."+e[c].cssClass.split(" ")[1]);0===c&&v&&l&&(v.style.marginLeft=window.getComputedStyle(l).marginLeft)}}if("pen"!==t&&(0!==this.activeObj.activePoint.width||0!==this.activeObj.activePoint.height||this.activeObj.shape&&"path"===this.activeObj.shape&&this.activeObj.pointColl.length>0)){o.style.width="auto",this.activeObj.activePoint.width=Math.abs(this.activeObj.activePoint.width),this.activeObj.activePoint.height=Math.abs(this.activeObj.activePoint.height);var g=this.activeObj.activePoint.startX<this.activeObj.activePoint.endX?this.activeObj.activePoint.startX:this.activeObj.activePoint.endX,b=this.activeObj.activePoint.startY<this.activeObj.activePoint.endY?this.activeObj.activePoint.startY:this.activeObj.activePoint.endY,C=this.activeObj.activePoint.width;if(0!==this.activeObj.rotatedAngle&&"arrow"!==this.activeObj.shape){var f={activePoint:null};this.shapeModule.shape({prop:"getSquarePointForRotatedShape",onPropertyChange:!1,value:{obj:this.activeObj,object:f}}),g=(P=f.activePoint).startX,b=P.startY,C=P.width}else if("path"===this.activeObj.shape){var m=this.getSquarePointForPath(this.activeObj);g=m.startX,b=m.startY,C=m.width}if(o.style.left=g+C/2-25*i+"px",parseFloat(o.style.left)+o.clientWidth/2!==g+C/2){var y=g+C/2-(parseFloat(o.style.left)+o.clientWidth/2);o.style.left=parseFloat(o.style.left)+y+"px"}b-(r+r/1.5)<this.img.destTop?o.style.top=this.img.destTop+"px":o.style.top=b-(r+r/1.5)+"px"}else if("pen"===t){var w={activePoint:null};d={freehandSelectedIndex:null};this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:d}}),this.freeHandDrawModule.draw({prop:"getSqPtFD",value:{idx:d.freehandSelectedIndex,obj:w}});var P=w.activePoint;o.style.width="auto",o.style.left=P.startX+P.width/2-24*i+"px",P.startY-(r+r/1.5)<this.img.destTop?o.style.top=this.img.destTop+"px":o.style.top=P.startY-(r+r/1.5)+"px"}else o.style.display="none";this.quickAccessToolbar="quick-access-toolbar"}},e.prototype.toolbarClicked=function(e,t){var o,r,i,a,s,n,l=this.element.querySelector(".e-ie-toolbar-e-resize-width-input .e-textbox"),h=this.element.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox");this.element.querySelector(this.CTWRAPPER).classList.contains("e-hidden");switch(e){case"reset":this.reset(),this.updateColorToolbar(this.element),this.updateToolbar(this.element,"imageLoaded"),this.aspectWidth=null,this.aspectHeight=null,this.currentResizeRatio="aspect",this.tempStraighten=this.prevStraightenEvent=0,this.isStraightening=!1,this.isFilterCanvasClick=this.isFinetuneBtnClick=this.isFrameBtnClick=!1,r=this.element.querySelector(this.BOLDBTN+" .e-btn"),i=this.element.querySelector(this.ITALICBTN+" .e-btn"),n=this.element.querySelector(".e-image-editor-toolbar .e-tbar-btn"),r.classList.contains("e-selected-btn")&&r.classList.remove("e-selected-btn"),i.classList.contains("e-selected-btn")&&i.classList.remove("e-selected-btn"),n&&!sf.base.Browser.isDevice&&this.isKeyDown&&n.focus();break;case"undo":this.noPushUndo=!1,(this.togglePen||this.drawingShape)&&(this.okBtn(),this.drawingShape=null),this.undoRedoModule.undoRedo({prop:"call-undo"});break;case"redo":this.noPushUndo=!1,(this.togglePen||this.drawingShape)&&(this.okBtn(),this.drawingShape=null),this.undoRedoModule.undoRedo({prop:"call-redo"});break;case"annotation":this.currObjType.isFiltered&&this.okBtn(),"contextual-toolbar"===this.currentToolbar&&(this.updateContextualToolbar(this.element,!1),this.currentToolbar="main-toolbar");break;case"crop":if(this.allowDownScale=!1,this.isCropTab=!0,this.performCropClick(),sf.base.Browser.isDevice){this.element.querySelector(".e-ie-contextual-slider .e-slider-container")&&this.element.querySelector(".e-ie-contextual-slider .e-slider-container").classList.add("e-straighten-slider"),this.updateContextualToolbar(this.element,!0),this.currentToolbar="crop-toolbar";var p=this.element.querySelector(this.CTWRAPPER);this.element.querySelector(".e-bottom-toolbar-area").style.marginTop=p.offsetHeight+"px",this.update();var d=this.element.querySelector("#"+this.element.id+"_canvasWrapper");d&&(d.style.height=parseInt(d.style.height)+1+"px"),this.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}})}(n=this.element.querySelector(".e-dropdown-btn.e-ie-crop-ddb-popup"))&&!sf.base.Browser.isDevice&&this.isKeyDown&&n.focus();break;case"rotateleft":case"rotateright":case"horizontalflip":case"verticalflip":this.isCropToolbar=!0,this.transformSelect(e),"rotateleft"!==e&&"rotateright"!==e||(this.drawModule.draw({prop:"resetStraightenDestPoints"}),this.drawModule.draw({prop:"setDestForStraighten"})),this.isCropToolbar=!1,this.transformModule.transform({prop:"disableZoomOutBtn",value:{isZoomOut:!0}});break;case"ok":this.element.querySelector(this.CTWRAPPER).classList.remove("e-frame-wrapper"),this.okBtn(null,!0),this.isStraightening=!1,this.isResize=!1,("crop-toolbar"!==this.currentToolbar||this.isCroppedEvent&&"crop-toolbar"===this.currentToolbar)&&this.updateToolbar(this.element,"imageLoaded"),(n=this.element.querySelector(".e-image-editor-toolbar .e-tbar-btn"))&&!sf.base.Browser.isDevice&&this.isKeyDown&&n.focus();break;case"cancel":this.isFilterCanvasClick=this.isFinetuneBtnClick=this.isFrameBtnClick=!1,this.element.querySelector(this.CTWRAPPER).classList.remove("e-frame-wrapper"),"frame-toolbar"==this.currentToolbar&&(this.element.querySelector(".e-ie-toolbar-e-frame-color"+this.DDBPREVIEW).style.background=this.tempFrameObj.color,this.element.querySelector(".e-ie-toolbar-e-frame-gradient"+this.DDBPREVIEW).style.background=this.tempFrameObj.gradientColor,this.frameObj.border=this.tempFrameObj.border),"crop-toolbar"===this.currentToolbar&&(this.isStraightening=!1,this.updateContextualToolbar(this.element,!1)),this.drawModule.draw({prop:"performCancel",onPropertyChange:!1,value:{isContextualToolbar:!this.element.querySelector(this.CTWRAPPER).classList.contains("e-hidden")}}),(n=this.element.querySelector(".e-image-editor-toolbar .e-tbar-btn"))&&!sf.base.Browser.isDevice&&this.isKeyDown&&n.focus();break;case"filter":this.updateFilterToolBar(),(s=this.element.querySelector(".e-ie-toolbar-filter-btn .e-btn"))&&s.classList.add("e-selected-btn");break;case"resize":this.currObjType.isFiltered&&this.okBtn(),this.performResizeClick(),l&&this.isKeyDown&&l.focus();break;case"nonAspectRatio":""===l.value&&""===h.value||(this.aspectWidth=l.value?l.value:l.placeholder,this.aspectHeight=h.value?h.value:h.placeholder,this.transformModule.transform({prop:"resize",value:{width:parseInt(this.aspectWidth.replace(",",""),10),height:parseInt(this.aspectHeight.replace(",",""),10),isAspectRatio:!1}}),l.value=this.aspectWidth,h.value=this.aspectHeight),this.cancelCropSelection=null,this.resizeSrc={startX:this.img.srcLeft,startY:this.img.srcTop,width:this.img.srcWidth,height:this.img.srcHeight},this.updateToolbar(this.element,e),(n=this.element.querySelector(".e-ie-toolbar-aspect-ratio-btn .e-btn"))&&!sf.base.Browser.isDevice&&this.isKeyDown&&n.focus();break;case"aspectRatio":(this.currSelectionPoint&&"crop-circle"!==this.currSelectionPoint.shape||!this.isCircleCrop)&&(""!==l.value?(this.aspectWidth=l.value,this.aspectHeight=h.value,this.transformModule.transform({prop:"resize",value:{width:parseInt(this.aspectWidth.replace(",",""),10),height:null,isAspectRatio:!0}})):""!==h.value&&(this.aspectWidth=l.placeholder,this.aspectHeight=h.value,this.transformModule.transform({prop:"resize",value:{width:parseInt(this.aspectWidth.replace(",",""),10),height:parseInt(this.aspectHeight.replace(",",""),10),isAspectRatio:!0}})),this.resizeSrc={startX:this.img.srcLeft,startY:this.img.srcTop,width:this.img.srcWidth,height:this.img.srcHeight},this.updateToolbar(this.element,e),(n=this.element.querySelector(".e-ie-toolbar-nonaspect-ratio-btn .e-btn"))&&!sf.base.Browser.isDevice&&this.isKeyDown&&n.focus());break;case"frame":this.performFrameClick(),this.element.querySelector(".e-ie-toolbar-e-frame-color"+this.DDBPREVIEW).style.background=this.frameObj.color;var c=this.element.querySelector(".e-ie-toolbar-e-frame-gradient"+this.DDBPREVIEW);""!==this.frameObj.gradientColor?(c.classList.remove("e-nocolor-item"),c.style.background=this.frameObj.gradientColor):c.classList.contains("e-nocolor-item")||c.classList.add("e-nocolor-item"),this.element.querySelector(".e-ie-toolbar-frame-"+this.frameObj.type+"-btn .e-btn").focus(),this.element.querySelector(".e-ie-toolbar-frame-"+this.tempFrameObj.type+"-btn .e-btn").classList.remove("e-selected-btn");break;case"frameNone":case"frameMat":case"frameBevel":case"frameLine":case"frameInset":case"frameHook":(s=this.element.querySelector(".e-ie-frame-btn .e-selected-btn"))&&this.element.querySelector(".e-ie-frame-btn .e-selected-btn").classList.remove("e-selected-btn"),this.element.querySelector("#"+e+" .e-btn").classList.add("e-selected-btn"),"frameNone"==e?(this.updateContextualToolbar(this.element,!1),this.queryToAddRemoveClass(this.element,this.CHECKBTN,"e-hidden",!0),this.queryToAddRemoveClass(this.element,this.CLOSEBTN,"e-hidden",!0)):this.updateContextualFrameToolBar(e);var u={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}}),this.frameObj={type:e.substring(5).toLowerCase(),color:this.frameObj.color,size:20,inset:20,offset:"frameInset"==e?60:20,radius:0,amount:1,border:this.frameObj.border,gradientColor:this.frameObj.gradientColor},this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:u.currObj,previousObjColl:u.currObj.objColl,previousPointColl:u.currObj.pointColl,previousSelPointColl:u.currObj.selPointColl,previousCropObj:sf.base.extend({},this.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),this.isFrameBtnClick=!0,this.curFrameObjEvent={previousFrameSetting:this.tempFrameObj,currentFrameSetting:this.frameObj};break;case"aspectResize":if("height"===t&&""!==h.value){var v=this.img.destWidth,g=this.img.destHeight,b=parseFloat(h.value)/(g/v),C=b%1>=.5||b%1<=-.5?Math.round(b):b<0?Math.ceil(b):Math.floor(b);"aspect"===this.currentResizeRatio&&(null==C||isNaN(C)?""===l.value?(l.placeholder="0",""===h.value&&""!==h.placeholder&&(l.placeholder=this.img.srcWidth)):l.value=0:""===l.value?l.placeholder=C.toString():l.value=C)}else if(""!==l.value){v=this.img.destWidth,g=this.img.destHeight;var f=parseFloat(l.value)/(v/g),m=f%1>=.5||f%1<=-.5?Math.round(f):f<0?Math.ceil(f):Math.floor(f);"aspect"===this.currentResizeRatio&&(isNaN(m)?""===h.value?(h.placeholder="0",""===l.value&&""!==l.placeholder&&(h.placeholder=this.img.srcHeight)):h.value=0:""===h.value?h.placeholder=m.toString():h.value=m)}break;case"save":this.noPushUndo=!1,this.okBtn(),this.drawingShape=null,this.updateToolbar(this.element,"imageLoaded");break;case"bold":this.selectionModule.selection({prop:"setInitialTextEdit",value:{bool:!1}}),a=(o=this.activeObj.textSettings).bold?o.italic?"italic":"default":o.italic?"bolditalic":"bold",this.shapeModule.shape({prop:"applyFontStyle",onPropertyChange:!1,value:{item:a}}),(r=this.element.querySelector(this.BOLDBTN+" .e-btn")).classList.contains("e-selected-btn")?r.classList.remove("e-selected-btn"):r.classList.add("e-selected-btn"),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"italic":this.selectionModule.selection({prop:"setInitialTextEdit",value:{bool:!1}}),a=(o=this.activeObj.textSettings).bold&&o.italic?"bold":o.bold&&!o.italic?"bolditalic":!o.bold&&o.italic?"default":"italic",this.shapeModule.shape({prop:"applyFontStyle",onPropertyChange:!1,value:{item:a}}),(i=this.element.querySelector(this.ITALICBTN+" .e-btn")).classList.contains("e-selected-btn")?i.classList.remove("e-selected-btn"):i.classList.add("e-selected-btn"),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})}if("finetune"!==e&&"filter"!==e&&"crop"!==e){var y=this.element.querySelector(".e-ie-toolbar-brightness-btn .e-btn");y.classList.contains("e-selected-btn")&&y.classList.remove("e-selected-btn"),(s=this.element.querySelector(".e-ie-frame-btn .e-selected-btn"))&&this.element.querySelector(".e-ie-frame-btn .e-selected-btn").classList.remove("e-selected-btn"),this.enableDisableToolbarBtn()}"filter"!==e&&(s=this.element.querySelector(".e-ie-toolbar-filter-btn .e-btn"))&&s.classList.remove("e-selected-btn"),this.isStraightening&&this.transformModule.transform({prop:"disableZoomOutBtn",value:{isZoomOut:!0}});-1!==["undo","redo","cancel","aspectRatio","nonAspectRatio","resize","save","filter","frame","frameNone","frameMat","frameBevel","frameLine","frameInset","frameHook"].indexOf(e)&&this.drawModule.draw({prop:"redrawDownScale"}),this.isKeyDown=!1},e.prototype.updateFilterToolBar=function(){var e=this;sf.popups.showSpinner(this.element);[".e-ie-toolbar-filter-default",".e-ie-toolbar-filter-chrome",".e-ie-toolbar-filter-cold",".e-ie-toolbar-filter-warm",".e-ie-toolbar-filter-greyscale",".e-ie-toolbar-filter-sepia",".e-ie-toolbar-filter-invert"].forEach((function(t){e.queryToAddRemoveClass(e.element,t,"e-hidden",!0)})),this.queryToAddRemoveClass(this.element,this.CTWRAPPER,"e-hidden",!0),this.queryToAddRemoveClass(this.element,this.CTTOOLBAR,"e-hidden",!0),sf.base.Browser.isDevice?(this.queryToAddRemoveClass(this.element,".e-ie-toolbar-upload","e-hidden",!1),this.queryToAddRemoveClass(this.element,".e-ie-toolbar-reset-btn","e-hidden",!1),this.queryToAddRemoveClass(this.element,".e-ie-toolbar-save-btn","e-hidden",!1)):(this.queryToAddRemoveClass(this.element,this.CLOSEBTN,"e-hidden",!0),this.queryToAddRemoveClass(this.element,this.CHECKBTN,"e-hidden",!0)),this.setTempFilterProperties();var t=this.getCurrentCanvasData(),o=this.element.querySelector(this.CTWRAPPER+" .e-toolbar-item.e-selected");if(o){o.classList.remove("e-selected");var r=o.querySelector(".e-ie-filter-canvas");r&&r.setAttribute("tabindex","-1")}this.inMemoryCanvas.width=t.width,this.inMemoryCanvas.height=t.height,this.inMemoryCanvas.getContext("2d").putImageData(t,0,0),this.updateFilterCanvas("e-ie-toolbar-default","default"),this.updateFilterCanvas("e-ie-toolbar-chrome","chrome"),this.updateFilterCanvas("e-ie-toolbar-cold","cold"),this.updateFilterCanvas("e-ie-toolbar-warm","warm"),this.updateFilterCanvas("e-ie-toolbar-grayscale","grayscale"),this.updateFilterCanvas("e-ie-toolbar-sepia","sepia"),this.updateFilterCanvas("e-ie-toolbar-invert","invert"),this.initialAdjustmentValue=this.lowerCanvas.getContext("2d").filter;var i=this.element.querySelector("#"+this.element.id+"_toolbarArea"),a=this.element.querySelector("#"+this.element.id+"_contextualToolbarArea");if(a.style.left=i.offsetLeft+"px",sf.base.Browser.isDevice){var s=a.offsetHeight,n=this.element.querySelector("#"+this.element.id+"_canvasWrapper").offsetHeight;a.style.top=this.toolbarHeight+n-s+"px";var l=window.sfBlazor.getCompInstance(this.canvasToolbarId);l&&l.refreshOverflow()}else a.style.top=this.toolbarHeight+"px";this.currentToolbar="contextual-toolbar",sf.popups.hideSpinner(this.element);var h=window.sfBlazor.getCompInstance(this.toolbarId);h&&h.refreshOverflow()},e.prototype.updateFilterCanvas=function(e,t){var o=this.element.querySelector("#"+e),r=o.getContext("2d");this.filterModule.filter({prop:"updateAdj",value:{type:t,value:null,isPreview:!0,ctx:r}}),r.clearRect(0,0,this.inMemoryCanvas.width,this.inMemoryCanvas.height),r.drawImage(this.inMemoryCanvas,0,0,300,150),(this.currentFilter===e||""==this.currentFilter&&"default"===t)&&(o.parentElement.parentElement.classList.add("e-selected"),o.setAttribute("tabindex","0"))},e.prototype.performCropClick=function(e){void 0===e&&(e=!1),this.drawModule.draw({prop:"setTempStraightenZoomDeg"}),this.tempStraighten=this.transform.straighten,this.currObjType.isFiltered&&this.okBtn(),this.isStraightening=!0,this.updateToolbar(this.element,"cropToolbar"),this.updateCropTransformItems(),sf.base.Browser.isDevice||this.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null,isPreventEvent:e}}),this.drawModule.draw({prop:"setDestForStraighten"}),this.drawModule.draw({prop:"setTempDestForStraighten"})},e.prototype.performResizeClick=function(){var e=this.element.querySelector(".e-ie-toolbar-e-resize-width-input .e-textbox"),t=this.element.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox"),o=!(!this.aspectWidth||!this.aspectHeight);(this.isCircleCrop||this.currSelectionPoint&&"crop-circle"===this.currSelectionPoint.shape)&&(this.aspectHeight=this.aspectWidth);var r=this.transform.degree%90==0&&this.transform.degree%180!=0?Math.ceil(this.img.srcHeight).toString():Math.ceil(this.img.srcWidth).toString(),i=this.transform.degree%90==0&&this.transform.degree%180!=0?Math.ceil(this.img.srcWidth).toString():Math.ceil(this.img.srcHeight).toString();o&&e&&t?(e.value=this.aspectWidth,t.value=this.aspectHeight,e.placeholder=t.placeholder=""):e&&t&&(e.placeholder=r,t.placeholder=i,e.value=t.value=""),(this.currSelectionPoint&&"crop-circle"==this.currSelectionPoint.shape||this.isCircleCrop)&&(this.currentResizeRatio="aspect"),this.drawModule.draw({prop:"updateCropSelection",onPropertyChange:!1}),this.upperCanvas.style.cursor="default",this.transformModule.transform({prop:"updateResize",value:{bool:!1}}),this.isResize=!0,this.updateToolbar(this.element,"resize"),this.prevCropObj=sf.base.extend({},this.cropObj,{},!0);var a={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}}),this.prevObj=a.currObj,this.currSelectionPoint&&this.prevCropObj.activeObj.shape&&(this.prevObj.activeObj=sf.base.extend({},this.prevCropObj.activeObj,{},!0)),this.prevObj.objColl=sf.base.extend([],this.objColl,[],!0),this.prevObj.pointColl=sf.base.extend([],this.pointColl,[],!0),this.prevObj.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var s={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),this.prevObj.selPointColl=sf.base.extend([],s.selPointColl,[],!0),this.resizeSrc={startX:this.img.srcLeft,startY:this.img.srcTop,width:this.img.srcWidth,height:this.img.srcHeight},this.aspectWidth&&this.aspectHeight&&("aspect"!==this.currentResizeRatio?(this.transformModule.transform({prop:"resize",value:{width:this.aspectWidth,height:this.aspectHeight,isAspectRatio:!1}}),this.transformModule.transform({prop:"resize",value:{width:this.aspectWidth,height:this.aspectHeight,isAspectRatio:!1}})):this.transformModule.transform({prop:"resize",value:{width:this.aspectWidth,height:null,isAspectRatio:!0}}))},e.prototype.performFrameClick=function(){this.currObjType.isFiltered&&this.okBtn();var e,t,o=this.transform.zoomFactor;for(this.drawModule.draw({prop:"updateCropSelection",onPropertyChange:!1}),this.frameDestPoints=sf.base.extend({},this.img,{},!0),sf.base.isNullOrUndefined(this.cxtTbarHeight)&&(e=sf.base.extend({},this.frameObj,{},!0),t=sf.base.extend({},this.tempFrameObj,{},!0),this.callFrameToolbar(),this.updateContextualFrameToolBar("framemat"),this.cxtTbarHeight=this.element.querySelector(this.CTWRAPPER).scrollHeight,this.callFrameToolbar(),this.frameObj=e,this.tempFrameObj=t,this.element.querySelector(".e-contextual-toolbar-wrapper")&&!this.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hidden")&&this.updateToolbar(this.element,"closeContextualToolbar")),this.transformModule.transform({prop:"resetZoom",onPropertyChange:!1});!(this.toolbarHeight+this.img.destTop>=this.toolbarHeight+this.cxtTbarHeight);)this.transformModule.transform({prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:!0}});this.tempFrameZoomLevel=o,sf.base.Browser.isDevice?this.img.destTop-=this.cxtTbarHeight/2:this.img.destTop+=this.cxtTbarHeight/2,this.callFrameToolbar(),"none"!==this.frameObj.type&&this.updateContextualFrameToolBar("frame"+this.frameObj.type),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}})},e.prototype.callFrameToolbar=function(){this.drawModule.draw({prop:"setTempFrame",value:{frame:this.frameObj.type}}),sf.base.extend(this.tempFrameObj,this.frameObj);var e={appliedUndoRedoColl:[]};if(this.undoRedoModule.undoRedo({prop:"getAppliedUndoRedoColl",value:{obj:e}}),0===e.appliedUndoRedoColl.length){var t={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:t.currObj,previousObjColl:t.currObj.objColl,previousPointColl:t.currObj.pointColl,previousSelPointColl:t.currObj.selPointColl,previousCropObj:sf.base.extend({},this.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}this.updateToolbar(this.element,"frame")},e.prototype.updateContextualFrameToolBar=function(e){var t=this,o=[".e-ie-toolbar-e-frame-color",".e-ie-toolbar-e-frame-size",".e-ie-toolbar-e-frame-inset",".e-ie-toolbar-e-frame-offset",".e-ie-toolbar-e-frame-radius",".e-ie-toolbar-e-frame-amnt",".e-ie-toolbar-e-frame-border",".e-ie-toolbar-e-frame-gradient"];switch(o.forEach((function(e){t.queryToAddRemoveClass(t.element,e,"e-hidden",!1)})),e.toLowerCase()){case"framemat":case"framebevel":o=[".e-ie-toolbar-e-frame-color",".e-ie-toolbar-e-frame-size",".e-ie-toolbar-e-frame-gradient"];break;case"frameline":o=[".e-ie-toolbar-e-frame-color",".e-ie-toolbar-e-frame-size",".e-ie-toolbar-e-frame-inset",".e-ie-toolbar-e-frame-offset",".e-ie-toolbar-e-frame-radius",".e-ie-toolbar-e-frame-amnt",".e-ie-toolbar-e-frame-border",".e-ie-toolbar-e-frame-gradient"];break;case"frameinset":o=[".e-ie-toolbar-e-frame-color",".e-ie-toolbar-e-frame-size",".e-ie-toolbar-e-frame-inset",".e-ie-toolbar-e-frame-offset",".e-ie-toolbar-e-frame-gradient"];break;case"framehook":o=[".e-ie-toolbar-e-frame-color",".e-ie-toolbar-e-frame-size",".e-ie-toolbar-e-frame-inset",".e-ie-toolbar-e-frame-gradient"]}o.forEach((function(e){t.queryToAddRemoveClass(t.element,e,"e-hidden",!0)})),this.queryToAddRemoveClass(this.element,this.CTWRAPPER,"e-hidden",!0),this.element.querySelector(this.CTWRAPPER).classList.add("e-frame-wrapper"),this.queryToAddRemoveClass(this.element,this.CTTOOLBAR,"e-hidden",!0),sf.base.Browser.isDevice||(this.queryToAddRemoveClass(this.element,this.CLOSEBTN,"e-hidden",!0),this.queryToAddRemoveClass(this.element,this.CHECKBTN,"e-hidden",!0));var r=this.element.querySelector("#"+this.element.id+"_toolbarArea"),i=this.element.querySelector("#"+this.element.id+"_contextualToolbarArea");if(i.style.left=r.offsetLeft+"px",sf.base.Browser.isDevice){var a=i.offsetHeight,s=this.element.querySelector("#"+this.element.id+"_canvasWrapper").offsetHeight;i.style.top=this.toolbarHeight+s-a+"px";var n=window.sfBlazor.getCompInstance(this.canvasToolbarId);if(n){var l=n.scrollModule;l&&n.element.querySelector(".e-scroll-right-nav")&&n.destroyScroll(),n.refreshOverflow(),l&&!n.scrollModule&&n.itemPositioning()}}else i.style.top=this.toolbarHeight+"px";this.currentToolbar="frame-toolbar";var h=window.sfBlazor.getCompInstance(this.toolbarId);h&&h.refreshOverflow()},e.prototype.getStrokeWidth=function(e,t){var o,r;if("pen"===t){var i={freehandSelectedIndex:null};this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:i}}),r=!sf.base.isNullOrUndefined(i.freehandSelectedIndex)&&i.freehandSelectedIndex>-1?parseInt(this.pointColl[i.freehandSelectedIndex].strokeWidth,10):2}else r=parseInt(e,10)/2;switch(r){case 1:o="X-Small";break;case 2:o="Small";break;case 3:o="Medium";break;case 4:o="Large";break;case 5:o="X-Large"}return o},e.prototype.createToolbar=function(){var e=this.element.querySelector(".e-ie-toolbar-upload-div");if(e){var t=e.getElementsByTagName("input")[0],o=e.getElementsByTagName("button")[0];o.className="e-tbar-btn e-tbtn-txt e-btn top-icon",o.innerHTML="",o.appendChild(sf.base.createElement("span",{className:"e-btn-icon e-icons e-upload-icon e-icon-left"})),t.onchange=this.fileSelect.bind(this,t),o.onclick=this.fileBtnClick.bind(this)}},e.prototype.fileBtnClick=function(e){0==e.x?this.isInteracted=!0:this.isInteracted=!1},e.prototype.duplicateShape=function(e,t){this.selectionModule.selection({prop:"setTempActObj",onPropertyChange:!1,value:{obj:{activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]}}});var o,r={prevActObj:null};this.drawModule.draw({prop:"getPrevActObj",onPropertyChange:!1,value:{obj:r}});var i=sf.base.extend({},this.activeObj,{},!0),a={order:null};this.shapeModule.shape({prop:"getHighestOrder",onPropertyChange:!1,value:{obj:a}}),i.order?(this.shapeModule.shape({prop:"updateShapeColl",onPropertyChange:!1}),i.order=a.order>i.order?a.order+1:i.order+1):(this.noPushUndo=!0,this.okBtn(),this.noPushUndo=!1,this.selectShape(i.currIndex),i.order=a.order>i.order?a.order+1:i.order+1),"image"===i.shape&&(o=sf.base.extend([],this.objColl,[],!0),this.undoRedoModule.undoRedo({prop:"updateUrObj",onPropertyChange:!1,value:{objColl:o}})),sf.base.isNullOrUndefined(this.activeObj.currIndex)?this.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:e}}):r.prevActObj||t?(this.activeObj.currIndex=null,i.currIndex=null,this.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:e}})):this.shapeModule.shape({prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}});var s=this.noPushUndo;if(this.noPushUndo=!1,this.undoRedoModule.undoRedo({prop:"updateCurrUrc",value:{type:"ok"}}),this.noPushUndo=s,o=sf.base.extend([],this.objColl,[],!0),i.activePoint.startX+=10,i.activePoint.startY-=10,i.activePoint.endX+=10,i.activePoint.endY-=10,"path"===i.shape)for(var n=0;n<i.pointColl.length;n++)i.pointColl[n].x+=10,i.pointColl[n].y-=10;else"image"===i.shape&&(i.imageCanvas=sf.base.createElement("canvas"));var l={id:"shape_"+(this.objColl.length+1)};if(this.shapeModule.shape({prop:"getNewShapeId",onPropertyChange:!1,value:{obj:l}}),i.currIndex=l.id,this.activeObj=sf.base.extend({},i,{},!0),"image"===this.activeObj.shape){var h=sf.base.extend({},i.activePoint,{},!0),p={width:0,height:0};this.transformModule.transform({prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.activeObj.imageElement.width,height:this.activeObj.imageElement.height,obj:p,isImgShape:null}}),this.activeObj.activePoint.width=p.width,this.activeObj.activePoint.height=p.height,this.activeObj.isHorImageFlip&&this.activeObj.isVerImageFlip?(this.activeObj.isHorImageFlip=this.activeObj.isVerImageFlip=!1,this.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:i.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:!0}}),this.activeObj.isHorImageFlip=this.activeObj.isVerImageFlip=!0):this.activeObj.isHorImageFlip?(this.activeObj.isHorImageFlip=!1,this.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:i.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:null}}),this.activeObj.isHorImageFlip=!0):this.activeObj.isVerImageFlip?(this.activeObj.isVerImageFlip=!1,this.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:i.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:!0}}),this.activeObj.isVerImageFlip=!0):this.drawModule.draw({prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:i.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:null}}),this.activeObj.activePoint=h}"line"!==this.activeObj.shape&&"arrow"!==this.activeObj.shape||this.shapeModule.shape({prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:this.activeObj}}),this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}}),this.undoRedoModule.undoRedo({prop:"updateUrObj",onPropertyChange:!1,value:{objColl:o}}),this.updateToolbar(this.element,"quickAccessToolbar",this.activeObj.shape)},e.prototype.getShapeValue=function(e,t){var o,r;if("arrow"===e)o=this.activeObj.start?this.pascalToSplitWords(this.activeObj.start):void 0,r=this.activeObj.end?this.pascalToSplitWords(this.activeObj.end):void 0;else if("text"===e){var i=this.element.querySelector(this.FONTFAM),a=this.element.querySelector(this.FONTSIZE);if(i&&(o=this.activeObj.textSettings.fontFamily),a)for(var s=0;s<this.fontSizeColl.length;s++)if(parseInt(this.fontSizeColl[s].text,10)>=Math.round(this.activeObj.textSettings.fontSize)){r=(s+1).toString();break}}var n=[this.activeObj.strokeSettings.strokeColor,this.activeObj.strokeSettings.fillColor,this.getStrokeWidth(this.activeObj.strokeSettings.strokeWidth,e),e,o,r];return"get"===t?n:(this.dotNetRef.invokeMethodAsync("UpdateColorValue",n[0],n[1],n[2],e,o,r),[])},e.prototype.updateSliderValue=function(e,t){if("transparency"===t.toLowerCase()){if(this.activeObj.shape){var o,r=void 0;sf.base.isNullOrUndefined(this.activeObj.imageRatio)&&this.shapeModule.shape({prop:"updImgRatioForActObj",onPropertyChange:!1}),this.shapeModule.shape({prop:"pushActItemIntoObj"}),o=sf.base.extend({},this.cropObj,{},!0);var i={currObj:{}};this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),(r=i.currObj).objColl=sf.base.extend([],this.objColl,[],!0),r.pointColl=sf.base.extend([],this.pointColl,[],!0),r.afterCropActions=sf.base.extend([],this.afterCropActions,[],!0);var a={selPointColl:null};this.freeHandDrawModule.draw({prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),r.selPointColl=sf.base.extend([],a.selPointColl,[],!0),this.objColl.pop(),this.activeObj.opacity=e/100,this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.drawModule.draw({prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.objColl.push(this.activeObj),this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.selectionModule.selection({prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),this.updateFinetuneSpan(t,e.toString())}}else"straighten"===t.toLowerCase()?this.setStraighten(e,!1):(this.transform.zoomFactor&&this.transform.zoomFactor<0&&(this.isFinetuning=!0),this.selectionModule.selection({prop:"setSliding",value:{bool:!0}}),this.setCurrAdjustmentValue(t.toLowerCase(),e),this.updateFinetuneSpan(t,e.toString()),this.isFinetuning=!1);this.enableDisableToolbarBtn()},e.prototype.updateResizeTextbox=function(){var e=this.element.querySelector(".e-ie-toolbar-e-resize-width-input .e-textbox");e&&(e.addEventListener("input",(function(){e.value.length>4&&(e.value=e.value.slice(0,-1))})),e.addEventListener("keydown",(function(e){"-"===e.key&&(e.preventDefault(),e.stopPropagation())})));var t=this.element.querySelector(".e-ie-toolbar-e-resize-height-input .e-textbox");t&&(t.addEventListener("input",(function(){t.value.length>4&&(t.value=t.value.slice(0,-1))})),t.addEventListener("keydown",(function(e){"-"===e.key&&(e.preventDefault(),e.stopPropagation())})))},e.prototype.updateFinetuneSpan=function(e,t){var o=this.element.querySelector(".e-ie-finetune-value-span");if(o)if(t)o.innerHTML=t;else{var r={adjustmentLevel:null};this.filterModule.filter({prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:r}}),o.innerHTML=Math.round(r.adjustmentLevel[e]).toString()}},e.prototype.updateDialog=function(e){this.drawModule.draw({prop:e,onPropertyChange:!1})},e.prototype.getSliderValue=function(e){if("finetune"===e){if(this.currObjType.isFiltered&&this.okBtn(),this.currObjType.isFiltered=!0,this.setTempFilterProperties(),this.drawModule.draw({prop:"updateFinetune"}),"contextual-toolbar"===this.currentToolbar){this.currentToolbar="main-toolbar",this.updateContextualToolbar(this.element,!1);var t=this.element.querySelector(".e-ie-toolbar-filter-btn .e-btn");t&&t.classList.remove("e-selected-btn")}this.updateContextualToolbar(this.element,!0),this.element.querySelector(".e-ie-finetune-btn .e-selected-btn")&&this.element.querySelector(".e-ie-finetune-btn .e-selected-btn").classList.remove("e-selected-btn"),this.element.querySelector(".e-ie-toolbar-brightness-btn .e-btn").classList.add("e-selected-btn"),e="brightness"}if("transparency"===e)sf.base.Browser.isDevice&&this.element.querySelector(".e-ie-contextual-slider .e-slider-container")&&this.element.querySelector(".e-ie-contextual-slider .e-slider-container").classList.add("e-ie-device-transparency-slider"),this.updateFinetuneSpan(e),this.updateContextualToolbar(this.element,!0);else{if("crop"===e){var o=this.cropObj.straighten;return document.querySelector(".e-ie-straighten-value-span")&&(document.querySelector(".e-ie-straighten-value-span").innerHTML=o.toString()+"&#176"),parseInt(o.toString())}["brightness","contrast","opacity","blur","hue","saturation","exposure"].indexOf(e)>-1&&("exposure"===e&&(e="grain"),this.element.querySelector(".e-ie-finetune-btn .e-selected-btn")&&this.element.querySelector(".e-ie-finetune-btn .e-selected-btn").classList.remove("e-selected-btn"),this.element.querySelector(".e-ie-toolbar-"+e+"-btn .e-btn").classList.add("e-selected-btn"),"grain"===e&&(e="exposure"),this.updateFinetuneSpan(e))}return parseInt(this.getCurrAdjustmentValue(e).toString())},e.prototype.selectCrop=function(e,t,o,r,i,a){this.isCropTab=!0,this.performCropClick(!0),sf.base.isNullOrUndefined(this.transform.cropZoomFactor)&&(this.transform.cropZoomFactor=this.transform.zoomFactor,this.drawModule.draw({prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:this.transform.zoomFactor}})),this.transform.zoomFactor=this.transform.cropZoomFactor,this.currSelectionPoint=null,this.drawModule.draw({prop:"setIsCropSelect",value:{bool:!0}});var s={prevObj:null};this.cropModule.cropping({prop:"getPreviousCropCurrentObj",value:{obj:s}}),("custom"!==e||sf.base.Browser.isDevice)&&this.drawModule.draw({prop:"select",onPropertyChange:!1,value:{type:e,startX:o,startY:r,width:i,height:a}}),this.cropModule.cropping({prop:"setPreviousCropCurrentObj",value:{obj:s.prevObj}}),this.enableDisableToolbarBtn(),this.transformModule.transform({prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),t&&this.updateToolbar(this.element,"cropToolbar")},e.prototype.save=function(e,t,o){e=e||"Png",t=t||"",this.exportModule.export({prop:"setImageQuality",value:{value:o||this.currentQuality}}),this.export(e,t,o),this.isChangesSaved=!0,this.drawModule.draw({prop:"redrawDownScale"})},e.prototype.getImageDataUrl=function(){var e=this.getImageData(),t=sf.base.createElement("canvas",{id:"_canvas",attrs:{name:"canvasImage"}}),o=t.getContext("2d");t.width=e.width,t.height=e.height,o.putImageData(e,0,0);var r={fileType:""},i="";if(this.drawModule.draw({prop:"getFileName",onPropertyChange:!1,value:{obj:r}}),sf.base.isNullOrUndefined(r.fileType))return t.toDataURL();switch(r.fileType.toLowerCase()){case"svg":case"svg+xml":var a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("width",t.width.toString()),a.setAttribute("height",t.height.toString());var s=document.createElementNS("http://www.w3.org/2000/svg","image");s.setAttributeNS(null,"height",t.height.toString()),s.setAttributeNS(null,"width",t.width.toString()),s.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",t.toDataURL()),a.appendChild(s);var n='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+t.width+'" height="'+t.height+'">',l=a.innerHTML;i="data:image/svg+xml;base64,"+btoa(n+l+"</svg>");break;case"jpeg":case"jpg":i=t.toDataURL("image/jpeg");break;default:i=t.toDataURL()}return i},e.prototype.setInitialShapeSettings=function(e){this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.currObjType.shape=e,this.activeObj.shape=this.currObjType.shape.toLowerCase(),this.currObjType.isDragging=this.currObjType.isCustomCrop=!1,this.activeObj.shapeDegree=this.transform.degree,this.activeObj.shapeFlip=this.transform.currFlipState,this.activeObj.textFlip=this.transform.currFlipState,this.activeObj.flipObjColl=[];var t={order:null};this.shapeModule.shape({prop:"getNewOrder",onPropertyChange:!1,value:{obj:t}}),this.activeObj.order=t.order},e.prototype.drawShape=function(e,t){var o=this;this.noPushUndo=!1,this.okBtn(),this.events&&!0===this.events.toolbarUpdating.hasDelegate&&("line"===e?this.lineToolbar=t:"path"===e?this.pathToolbar=t:"arrow"===e?this.arrowToolbar=t:"rectangle"===e?this.rectangleToolbar=t:"ellipse"===e?this.ellipseToolbar=t:"pen"===e?this.penToolbar=t:"text"===e?this.textToolbar=t:"image"===e&&(this.imageToolbar=t));var i,a=!1;void 0!==this.activeObj.shape&&(i=this.activeObj.shape.split("-")),(void 0===i&&this.currObjType.isCustomCrop||void 0!==i&&"crop"===i[0])&&(a=!0),this.currObjType.isCustomCrop=!1,(a||this.togglePan)&&(this.shapeModule.shape({prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height));var s={currentFreehandDrawIndex:null};this.freeHandDrawModule.draw({prop:"getCurrentFreehandDrawIndex",value:{obj:s}});var n,l,h={shapeSettingsObj:{}};switch(this.drawModule.draw({prop:"updateTempObjColl"}),this.drawModule.draw({prop:"updateTempPointColl"}),e){case"text":this.drawingShape=e,this.setInitialShapeSettings(e),this.selectionModule.selection({prop:"annotate",value:{shape:e}}),this.updateToolbar(this.element,e),this.isFirstLoad&&this.activeObj&&this.activeObj.textSettings&&(this.activeObj.textSettings.fontFamily=this.defaultFontFamily,this.isFirstLoad=!1),this.getFontSizes();break;case"pen":this.drawingShape=null,this.drawModule.draw({prop:"setTempFreehandCounter",value:{tempFreehandCounter:this.freehandCounter}}),this.drawModule.draw({prop:"setTempCurrentFreehandDrawIndex",value:{tempCurrentFreehandDrawIndex:s.currentFreehandDrawIndex}}),this.freehandDraw(!0),this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:h}}),(n=h.shapeSettingsObj).type=r.FreehandDraw,l={cancel:!1,action:"insert",previousShapeSettings:n,currentShapeSettings:n},this.freeHandDrawModule.triggerShapeChanging(l);break;case"image":this.drawingShape=null,this.isInteracted=!0,this.element.querySelector(".e-image-upload .e-btn").click();break;default:this.drawingShape=e,this.setInitialShapeSettings(e),this.selectionModule.selection({prop:"annotate",value:{shape:e}}),this.updateToolbar(this.element,e),this.selectionModule.selection({prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:h}}),l={cancel:!1,action:"insert",previousShapeSettings:n=h.shapeSettingsObj,currentShapeSettings:n},this.events&&!0===this.events.shapeChanging.hasDelegate&&this.dotNetRef.invokeMethodAsync("ShapeEventAsync","OnShape",l,null).then((function(e){o.shapeModule.shape({prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings}}),o.updateColorToolbar(o.element,e.currentShapeSettings,e.currentShapeSettings.type),o.getShapeValue(e.currentShapeSettings.type.toLowerCase())}))}var p=this.togglePen;"pen"===e&&(this.togglePen=!1),this.drawModule.draw({prop:"redrawDownScale"}),this.togglePen=p;var d=this.element.querySelector(".e-ie-toolbar-annotation .e-dropdown-btn");return d&&!sf.base.Browser.isDevice&&this.isKeyDown&&d.focus(),this.isKeyDown=!1,this.getShapeValue(e,"get")},e.prototype.updateToolbarItem=function(e,t){this.updateToolbar(e,t);for(var o=0;o<Object.keys(window.sfBlazor.instances).length;o++)if(Object.keys(window.sfBlazor.instances)[o].includes("sfToolbar")){var r=Object.keys(window.sfBlazor.instances)[o];window.sfBlazor.getCompInstance(r).refreshOverflow(r)}},e.prototype.updateFillColorValue=function(e,t){if(e.querySelector(".e-fill")){if(""===this.activeObj.strokeSettings.fillColor){var o=document.querySelector("#"+this.element.id+"_shapeFillColor");o&&o.querySelector(".e-nocolor-item").classList.remove("e-selected"),e.querySelector(this.SHAPEFILLCLR+this.DDBPREVIEW).classList.remove("e-nocolor-item")}""==t?e.querySelector(this.SHAPEFILLCLR+this.DDBPREVIEW).classList.add("e-nocolor-item"):e.querySelector(this.SHAPEFILLCLR+this.DDBPREVIEW).style.background=t,this.updateFillColor(t),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1})}},e.prototype.updateStrokeColorValue=function(e,t){this.element.querySelector(e)&&(this.updateStrokeColor(t),this.updateColorToolbar(this.element,this.activeObj.strokeSettings),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",onPropertyChange:!1}))},e.prototype.updatePenStrokeColorValue=function(e,t){this.element.querySelector(e)&&(this.updatePenStrokeColor(t),this.updateColorToolbar(this.element,this.activeObj.strokeSettings),this.undoRedoModule.undoRedo({prop:"updateUndoRedoStack",value:{isPenDraw:!0}}))},e.prototype.updateFontColorValue=function(e,t){if(this.element.querySelector(e)){this.updateFontColor(t);var o=this.activeObj.strokeSettings;"block"!==this.textArea.style.display&&"inline-block"!==this.textArea.style.display||(o.strokeColor=t),this.updateColorToolbar(this.element,o)}},e.prototype.updateFrameValue=function(e,t){var o,r={currObj:{}},i=this.frameObj[e],a={frameChangeEventArgs:null};o={type:this.toPascalCase(this.frameObj.type),color:this.frameObj.color,gradientColor:this.frameObj.gradientColor,size:this.frameObj.size,inset:this.frameObj.inset,offset:this.frameObj.offset,borderRadius:this.frameObj.radius,frameLineStyle:this.toPascalCase(this.frameObj.border),lineCount:this.frameObj.amount},this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),this.frameObj[e]="border"===e?t:parseInt(t,10),this.drawModule.draw({prop:"triggerFrameChange",value:{prevFrameSettings:o,obj:a}}),null!=this.events&&!1!==this.events.frameChanging.hasDelegate||!a.frameChangeEventArgs||a.frameChangeEventArgs.cancel?this.frameObj[e]=i:(this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:r.currObj,previousObjColl:r.currObj.objColl,previousPointColl:r.currObj.pointColl,previousSelPointColl:r.currObj.selPointColl,previousCropObj:sf.base.extend({},this.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),this.drawModule.draw({prop:"redrawDownScale"}),this.isFrameBtnClick=!0,this.curFrameObjEvent={previousFrameSetting:a.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:a.frameChangeEventArgs.currentFrameSetting})},e.prototype.updateFrameColor=function(e,t,o){var r,i,a={currObj:{}},s={frameChangeEventArgs:null};if(i={type:this.toPascalCase(this.frameObj.type),color:this.frameObj.color,gradientColor:this.frameObj.gradientColor,size:this.frameObj.size,inset:this.frameObj.inset,offset:this.frameObj.offset,borderRadius:this.frameObj.radius,frameLineStyle:this.toPascalCase(this.frameObj.border),lineCount:this.frameObj.amount},this.filterModule.filter({prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}}),"color"==o?(r=this.frameObj.color,this.frameObj.color=t):(r=this.frameObj.gradientColor,this.frameObj.gradientColor=t),this.drawModule.draw({prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:s}}),null!=this.events&&!1!==this.events.frameChanging.hasDelegate||!s.frameChangeEventArgs||s.frameChangeEventArgs.cancel)"color"==o?this.frameObj.color=r:this.frameObj.gradientColor=r;else{if(this.undoRedoModule.undoRedo({prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:a.currObj,previousObjColl:a.currObj.objColl,previousPointColl:a.currObj.pointColl,previousSelPointColl:a.currObj.selPointColl,previousCropObj:sf.base.extend({},this.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),"color"==o)e.querySelector(".e-ie-toolbar-e-frame-color")&&(e.querySelector(".e-ie-toolbar-e-frame-color"+this.DDBPREVIEW).style.background=t,this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),this.drawModule.draw({prop:"redrawDownScale"}));else if(e.querySelector(".e-ie-toolbar-e-frame-gradient")){var n=document.querySelector(".e-dropdown-popup.e-frame-gradient-dd-btn");n&&n.querySelector(".e-nocolor-item").classList.remove("e-selected"),e.querySelector(".e-ie-toolbar-e-frame-gradient"+this.DDBPREVIEW).classList.remove("e-nocolor-item"),""==t?e.querySelector(".e-ie-toolbar-e-frame-gradient"+this.DDBPREVIEW).classList.add("e-nocolor-item"):e.querySelector(".e-ie-toolbar-e-frame-gradient"+this.DDBPREVIEW).style.background=t,this.drawModule.draw({prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),this.drawModule.draw({prop:"redrawDownScale"})}this.curFrameObjEvent={previousFrameSetting:s.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:s.frameChangeEventArgs.currentFrameSetting},this.isFrameBtnClick=!0}},e.prototype.imageResize=function(e,t,o){return this.aspectWidth=e,this.aspectHeight=t,this.resize(e,t,o)},e.prototype.getFrameSettings=function(){var e=this.frameObj;return e.borderRadius=this.frameObj.radius,e.lineCount=this.frameObj.amount,e.frameLineStyle=this.frameObj.border,e},e.prototype.triggerShapeChanged=function(e){if(this.events&&!0===this.events.shapeChanged.hasDelegate){var t={action:e.action,shapeSettings:e.currentShapeSettings};this.dotNetRef.invokeMethodAsync("ShapeEventAsync","ShapeChanged",null,t)}},e.prototype.triggerActionComplete=function(){var e=this.curFrameObjEvent,t=this.curFinetuneObjEvent,o=this.curFilterObjEvent;if(this.isFrameBtnClick&&this.events&&!0===this.events.frameChanged.hasDelegate){var r={frameSettings:e.currentFrameSetting};this.dotNetRef.invokeMethodAsync("OnFrameChangingAsync","FrameChanged",null,r)}if(this.isFinetuneBtnClick&&this.events&&!0===this.events.finetuneValueChanged.hasDelegate){var i={finetune:this.toPascalCase(t.finetune),value:parseInt(t.value.toString())};this.dotNetRef.invokeMethodAsync("OnFinetuneValueChangeAsync","FinetuneValueChanged",null,i)}if(this.isFilterCanvasClick&&this.events&&!0===this.events.imageFiltered.hasDelegate){var a={filter:this.toPascalCase(o.filter)};this.dotNetRef.invokeMethodAsync("OnImageFilterEventAsync","ImageFiltered",null,a)}this.isFilterCanvasClick=this.isFinetuneBtnClick=this.isFrameBtnClick=!1},e.prototype.getImageFile=function(){var e={canvas:null},t={fileName:"",fileType:""};this.drawModule.draw({prop:"getFileName",onPropertyChange:!1,value:{obj:t}}),this.exportModule.export({prop:"exportToCanvas",value:{object:e}});var o=e.canvas,r=document.getElementById(this.element.id+"_savePreviewCanvas");return r.width=o.width,r.height=o.height,this.updateImageSize(1,e.canvas),[t.fileName,t.fileType]},e.prototype.saveSliderCreated=function(){var e=this,t={canvas:null};this.exportModule.export({prop:"exportToCanvas",value:{object:t}});var o=t.canvas,r=document.getElementById(this.element.id+"_saveSliderWrapper");if(r&&r.parentElement){var i=r.parentElement.querySelector(".e-slider-input");i&&(i.addEventListener("custom-changed",(function(t){e.exportModule.export({prop:"setImageQuality",value:{value:parseFloat(t.target.value)}}),e.updateImageSize(parseFloat(t.target.value),o)})),i.addEventListener("custom-change",(function(t){e.isKeyDown&&(e.exportModule.export({prop:"setImageQuality",value:{value:parseFloat(t.target.value)}}),e.updateImageSize(parseFloat(t.target.value),o),e.isKeyDown=!1)})))}},e.prototype.updateImageSize=function(e,t){var o;this.currentQuality=e;var r=this.element.id;if(sf.base.isNullOrUndefined(t)){var i={canvas:null};this.exportModule.export({prop:"exportToCanvas",value:{object:i}}),t=i.canvas}var a=document.getElementById(r+"_savePreviewCanvas").getContext("2d"),s=document.getElementById(r+"_saveImgQuality");t.toBlob(function(e){if((o=Math.floor(e.size/1024))>1e3){var t=o/1024;s.innerHTML=t.toFixed(2)+" MB",o=+t.toFixed(2)}else s.innerHTML=o.toFixed(2)+" KB",o=+o.toFixed(2);var r=new Image;r.src=URL.createObjectURL(e),r.onload=function(){a.drawImage(r,0,0),URL.revokeObjectURL(r.src)},this.fileSize=o}.bind(this),"image/jpeg",e)},e.prototype.updateZOrderItem=function(){var e={freehandSelectedIndex:-1};this.freeHandDrawModule.draw({prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:e}});var t={order:null};this.shapeModule.shape({prop:"getHighestOrder",onPropertyChange:!1,value:{obj:t}});var o=this.activeObj.order?this.activeObj.order:this.getObjFromId(this.pointColl[e.freehandSelectedIndex].id).order,r=document.querySelector(".e-ie-zindex-ddb.e-dropdown-popup .e-dropdown-menu");sf.base.isNullOrUndefined(r)||(o&&o>=t.order?(r.children[0].classList.add("e-disabled"),r.children[2].classList.add("e-disabled")):(r.children[0].classList.remove("e-disabled"),r.children[2].classList.remove("e-disabled")),this.shapeModule.shape({prop:"getLowestOrder",onPropertyChange:!1,value:{obj:t}}),o&&o<=t.order?(r.children[1].classList.add("e-disabled"),r.children[3].classList.add("e-disabled")):(r.children[1].classList.remove("e-disabled"),r.children[3].classList.remove("e-disabled")))},e=j([sf.base.NotifyPropertyChanges],e)}());return{initialize:function(e,t,o,r,i){return new x(e,t,o,r,i),e&&window.sfBlazor.getCompInstance(e).initializeImageEditor(t,i),/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile/i.test(navigator.userAgent)},flip:function(e,t){e&&window.sfBlazor.getCompInstance(e).flip(t)},rotate:function(e,t,o){return e&&window.sfBlazor.getCompInstance(e).rotate(t,o)},zoom:function(e,t,o){return e&&window.sfBlazor.getCompInstance(e).zoom(t,o)},reset:function(e){e&&window.sfBlazor.getCompInstance(e).reset()},undo:function(e){e&&window.sfBlazor.getCompInstance(e).undo()},redo:function(e){e&&window.sfBlazor.getCompInstance(e).redo()},onPropertyChanged:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).onPropertyChanged(t,o)},destroy:function(e){e&&window.sfBlazor.getCompInstance(e).destroy()},toolbarCreated:function(e){e&&window.sfBlazor.getCompInstance(e).toolbarCreated()},bottomToolbarCreated:function(e){e&&window.sfBlazor.getCompInstance(e).bottomToolbarCreated()},canvasToolbarCreated:function(e){e&&window.sfBlazor.getCompInstance(e).canvasToolbarCreated()},toolbarClicked:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).toolbarClicked(t,o)},contextualToolbarClicked:function(e,t){e&&window.sfBlazor.getCompInstance(e).contextualToolbarClicked(t)},quickAccessToolbarClicked:function(e,t){e&&window.sfBlazor.getCompInstance(e).quickAccessToolbarClicked(t)},updateDialog:function(e,t){e&&window.sfBlazor.getCompInstance(e).updateDialog(t)},getSliderValue:function(e,t){return e&&window.sfBlazor.getCompInstance(e).getSliderValue(t)},select:function(e,t,o,r,i,a,s){e&&window.sfBlazor.getCompInstance(e).selectCrop(t,o,r,i,a,s)},clearSelection:function(e,t){e&&window.sfBlazor.getCompInstance(e).clearSelection(t)},crop:function(e){return e&&window.sfBlazor.getCompInstance(e).crop()},open:function(e,t){e&&window.sfBlazor.getCompInstance(e).open(t)},save:function(e,t,o,r){e&&window.sfBlazor.getCompInstance(e).save(t,o,r)},finetuneImage:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).finetuneImage(t,o)},applyImageFilter:function(e,t){e&&window.sfBlazor.getCompInstance(e).applyImageFilter(t)},drawEllipse:function(e,t,o,r,i,a,s,n,l,h){return e&&window.sfBlazor.getCompInstance(e).drawEllipse(t,o,r,i,a,s,n,l,h)},drawLine:function(e,t,o,r,i,a,s,n){return e&&window.sfBlazor.getCompInstance(e).drawLine(t,o,r,i,a,s,n)},drawArrow:function(e,t,o,r,i,a,s,n,l,h){return e&&window.sfBlazor.getCompInstance(e).drawArrow(t,o,r,i,a,s,n,l,h)},drawPath:function(e,t,o,r,i){return e&&window.sfBlazor.getCompInstance(e).drawPath(t,o,r,i)},drawRectangle:function(e,t,o,r,i,a,s,n,l,h){return e&&window.sfBlazor.getCompInstance(e).drawRectangle(t,o,r,i,a,s,n,l,h)},drawText:function(e,t,o,r,i,a,s,n,l,h,p){return e&&window.sfBlazor.getCompInstance(e).drawText(t,o,r,i,a,s,n,l,h,p)},getImageDimension:function(e){return e&&window.sfBlazor.getCompInstance(e).getImageDimension()},getImageDataUrl:function(e){return e&&window.sfBlazor.getCompInstance(e).getImageDataUrl()},selectShape:function(e,t){return e&&window.sfBlazor.getCompInstance(e).selectShape(t)},deleteShape:function(e,t){e&&window.sfBlazor.getCompInstance(e).deleteShape(t)},getShapeSettings:function(e,t){return e&&window.sfBlazor.getCompInstance(e).getShapeSettings(t)},drawShape:function(e,t,o){return e&&window.sfBlazor.getCompInstance(e).drawShape(t,o)},freehandDraw:function(e,t){e&&window.sfBlazor.getCompInstance(e).freehandDraw(t)},updateToolbar:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).updateToolbarItem(t,o)},updateArrow:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).updateArrow(t,o)},updateFillColor:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).updateFillColorValue(t,o)},selFillColor:function(e,t){t.querySelector(".e-nocolor-item").classList.add("e-selected"),t.id=e},updateStrokeColor:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).updateStrokeColorValue(t,o)},updateStrokeWidth:function(e,t){e&&window.sfBlazor.getCompInstance(e).updateStrokeWidth(t)},updateZOrder:function(e,t){e&&window.sfBlazor.getCompInstance(e).updateZOrder(t)},updatePenStrokeColor:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).updatePenStrokeColorValue(t,o)},updatePenStrokeWidth:function(e,t){e&&window.sfBlazor.getCompInstance(e).updatePenStrokeWidth(t)},updateFontColor:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).updateFontColorValue(t,o)},updateFontFamily:function(e,t){e&&window.sfBlazor.getCompInstance(e).updateFontFamily(t)},updateFontSize:function(e,t){e&&window.sfBlazor.getCompInstance(e).updateFontSize(t)},updateFrameValue:function(e,t,o){e&&window.sfBlazor.getCompInstance(e).updateFrameValue(t,o)},updateFrameColor:function(e,t,o,r){e&&window.sfBlazor.getCompInstance(e).updateFrameColor(t,o,r)},imageResize:function(e,t,o,r){return e&&window.sfBlazor.getCompInstance(e).imageResize(t,o,r)},drawImage:function(e,t,o,r,i,a,s,n,l,h){return e&&window.sfBlazor.getCompInstance(e).drawImage(t,o,r,i,a,s,n,l,h)},drawFrame:function(e,t,o,r,i,a,s,n,l,h){return e&&window.sfBlazor.getCompInstance(e).drawFrame(t,o,r,i,a,s,n,l,h)},getFrameSettings:function(e){return e&&window.sfBlazor.getCompInstance(e).getFrameSettings()},refresh:function(e){e&&window.sfBlazor.getCompInstance(e).update()},straightenImage:function(e,t){return e&&window.sfBlazor.getCompInstance(e).straightenImage(t)},cloneShape:function(e,t){return e&&window.sfBlazor.getCompInstance(e).cloneShape(t)},updateShape:function(e,t,o){return e&&window.sfBlazor.getCompInstance(e).updateShape(t,o)},enableTextEditing:function(e){e&&window.sfBlazor.getCompInstance(e).enableTextEditing()},canUndo:function(e){return e&&window.sfBlazor.getCompInstance(e).canUndo()},canRedo:function(e){return e&&window.sfBlazor.getCompInstance(e).canRedo()},getImageFilter:function(e,t){return e&&window.sfBlazor.getCompInstance(e).getImageFilter(t)},getImageFile:function(e){return e&&window.sfBlazor.getCompInstance(e).getImageFile()},updateImageQuality:function(e,t){e&&window.sfBlazor.getCompInstance(e).updateImageSize({Good:.8,Great:.9,Highest:1}[t])},saveSliderCreated:function(e){e&&window.sfBlazor.getCompInstance(e).saveSliderCreated()},apply:function(e){e&&window.sfBlazor.getCompInstance(e).apply()},discard:function(e){e&&window.sfBlazor.getCompInstance(e).discard()},enableActiveAnnotation:function(e,t){e&&window.sfBlazor.getCompInstance(e).enableShapeDrawing(t,!0)},disableActiveAnnotation:function(e){e&&window.sfBlazor.getCompInstance(e).enableShapeDrawing(null,!1)},bringToFront:function(e,t){e&&window.sfBlazor.getCompInstance(e).bringToFront(t)},bringForward:function(e,t){e&&window.sfBlazor.getCompInstance(e).bringForward(t)},sendToBack:function(e,t){e&&window.sfBlazor.getCompInstance(e).sendToBack(t)},sendBackward:function(e,t){e&&window.sfBlazor.getCompInstance(e).sendBackward(t)},clearImage:function(e){e&&window.sfBlazor.getCompInstance(e).clearImage()},updateZOrderItem:function(e){e&&window.sfBlazor.getCompInstance(e).updateZOrderItem()}}}()}}]);(async()=>{await import(`${document.baseURI}_content/Syncfusion.Blazor/scripts/syncfusion-blazor-base.min.js?v=26.2.undefined`).then(()=>{sfBlazor.loadDependencies('sfimageeditor');})})();